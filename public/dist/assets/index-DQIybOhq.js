import{j as e,a as Be,r as l,f as fe,i as He}from"./index-BS_BC2tr.js";import{M as Me,t as Oe,r as ot}from"./modal-CK3pldlK.js";import{F as Ve,a as Ge,b as ze}from"./main-BwxV9wcy.js";import{H as Je}from"./Header-DOCwOtvn.js";import{v as Z,T as v,j as Ee,q as it,a1 as K,a3 as X,a2 as te,y as Ae,x as ct}from"./TextField-fQlpn0uP.js";import{u as oe}from"./useApi-DCSO45YJ.js";import{u as _e}from"./useMediaQuery-CyLPc1mC.js";import{C as Re}from"./confirmationModal-BW1sOx-H.js";import{A as Ie}from"./actionButton-Cu0LWMWm.js";import{M as E}from"./MenuItem-CF61DAnp.js";import{w as dt}from"./dasboardPagesContainer-yho97Fx0.js";import"./IconButton-D2nNlubr.js";import"./index-BQvLIGJ0.js";import"./index-C6B4bUaP.js";import"./loadingButton-BtJ3fS50.js";import"./CircularProgress-CWhgGay0.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-DndnS7Ni.js";const ut=({open:c,onClose:x,timetable:a,classLevelData:o,subjectNamesCache:t,teacherData:f,showEditButton:m,showAttendance:T,userId:y})=>{var O,V,S;const C=_=>{var P,r;return((r=(P=o==null?void 0:o.data)==null?void 0:P.find(s=>s._id===_))==null?void 0:r.name)||"N/A"},N=_=>t[_]||"Unknown Subject",D=_=>{var r;const P=(r=f==null?void 0:f.data)==null?void 0:r.find(s=>s._id===_);return(P==null?void 0:P.name)||"No Teacher Assigned"},H=()=>{var P,r,s;if(!a||!T)return"N/A";const _=(s=(r=(P=a.periodAttendance)==null?void 0:P[0])==null?void 0:r.attendance)==null?void 0:s.find(G=>G.studentId.toString()===y);return(_==null?void 0:_.status)||"N/A"};return console.log(t),e.jsx(Me,{open:c,onClose:x,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:a?e.jsxs(Z,{sx:{display:"flex",flexDirection:"column",gap:"16px",mt:"10px"},children:[e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Class Level:"})," ",C(((O=a.classLevel)==null?void 0:O._id)||a.classLevel)]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Subject:"})," ",N(((V=a.subject)==null?void 0:V.name)||a.subject)]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Teacher:"})," ",D(((S=a.teacher)==null?void 0:S._id)||a.teacher)]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),T&&e.jsxs(v,{variant:"body1",children:[e.jsx("strong",{children:"Attendance Status:"})," ",H()]})]}):e.jsx(v,{variant:"body1",children:"No timetable details available."})})},et=Symbol.for("constructDateFrom");function mt(c,x){return typeof c=="function"?c(x):c&&typeof c=="object"&&et in c?c[et](x):c instanceof Date?new c.constructor(x):new Date(x)}function ft(c,x){return mt(x||c,c)}let ht={};function bt(){return ht}function rt(c,x){var T,y,C,N;const a=bt(),o=(x==null?void 0:x.weekStartsOn)??((y=(T=x==null?void 0:x.locale)==null?void 0:T.options)==null?void 0:y.weekStartsOn)??a.weekStartsOn??((N=(C=a.locale)==null?void 0:C.options)==null?void 0:N.weekStartsOn)??0,t=ft(c,x==null?void 0:x.in),f=t.getDay(),m=(f<o?7:0)+f-o;return t.setDate(t.getDate()-m),t.setHours(0,0,0,0),t}const tt=["Monday","Tuesday","Wednesday","Thursday","Friday"],xt=({userId:c})=>{var ae;const x=Ee();Oe(x.palette.mode);const a=Be(h=>h.users.user),[o,t]=l.useState([]),[f,m]=l.useState(!1),[T,y]=l.useState(!1),[C,N]=l.useState(""),[D,H]=l.useState(null),[O,V]=l.useState({}),{loading:S,error:_,callApi:P,data:r}=oe(),{loading:s,error:G,callApi:z}=oe(),R=l.useCallback(async(h,w)=>{var g;if(!h)return"Unknown";if(O[h])return O[h];try{const k=await z(`${fe.SUBJECT_NAME}/${h}`,"GET"),p=((g=k==null?void 0:k.data)==null?void 0:g.name)||"Unknown";return w()&&V(Y=>({...Y,[h]:p})),p}catch(k){return console.error(`Error fetching subject name for ID ${h}:`,k),"Unknown"}},[z,O]);l.useEffect(()=>{let h=!0;const w=async()=>{try{const g=await P(`${fe.TIMETABLE}/student/${a._id}`,"GET");h&&(g!=null&&g.data)&&g.status==="success"?t(g.data||[]):(console.error("Failed to fetch timetables:",g),h&&(N("Failed to load timetable data"),y(!0)))}catch(g){console.error("Error fetching timetables:",g),h&&(N("Error loading timetable: "+(g.message||"Unknown error")),y(!0))}};return a._id&&w(),()=>{h=!1}},[P,a._id]);const se=l.useMemo(()=>{if(!o||!o.length)return[];const w=rt(new Date("2025-07-25T12:13:00+01:00"),{weekStartsOn:1});let g=!0;return Promise.all(o.map(async p=>{var B,ie,Ce,Se,ne,Ne,Le,ge;if(!p||!p.dayOfWeek)return null;const Y=tt.indexOf(p.dayOfWeek);if(Y===-1)return null;const re=new Date(w);re.setDate(w.getDate()+Y);const[ve,be]=(p.startTime||"00:00").split(":").map(Number);re.setHours(ve,be,0,0);const he=new Date(re);he.setMinutes(he.getMinutes()+(p.numberOfPeriods||1)*45);const xe=((B=p.subject)==null?void 0:B.name)||p.subject,de=await R(xe,()=>g);return{id:p._id,title:`${de} (${p.location||"N/A"})`,start:re,end:he,extendedProps:{classLevel:((ie=p.classLevel)==null?void 0:ie._id)||p.classLevel||"",classLevelName:((Ce=p.classLevel)==null?void 0:Ce.name)||"N/A",subclassLetter:p.subclassLetter||"",subject:xe||"",subjectName:de,teacher:((Se=p.teacher)==null?void 0:Se._id)||p.teacher||null,teacherName:p.teacher&&`${p.teacher.firstName||""} ${p.teacher.lastName||""}`.trim()||"No Teacher Assigned",dayOfWeek:p.dayOfWeek,startTime:p.startTime||"",numberOfPeriods:p.numberOfPeriods||1,location:p.location||"",attendanceStatus:((ge=(Le=(Ne=(ne=p.periodAttendance)==null?void 0:ne[0])==null?void 0:Ne.attendance)==null?void 0:Le.find(je=>je.studentId.toString()===c))==null?void 0:ge.status)||"N/A"}}})).then(p=>p.filter(Y=>Y!==null)).catch(p=>(console.error("Error processing calendar events:",p),N("Failed to process timetable events"),y(!0),[]))},[o,c,R]),M=l.useCallback(h=>{const w=o.find(g=>g._id===h.event.id);w&&(H(w),m(!0))},[o]),J=S||s,u=(r==null?void 0:r.status)==="failed"?r.message:_||G,U=l.useMemo(()=>{var h;return{data:a.classLevelId?[{_id:a.classLevelId,name:((h=a.currentClassLevel)==null?void 0:h.className)||"N/A"}]:[]}},[a.classLevelId,(ae=a.currentClassLevel)==null?void 0:ae.className]),$=l.useMemo(()=>!o||!o.length?{data:[]}:{data:o.map(h=>{var w,g;return{_id:((w=h.subject)==null?void 0:w._id)||h.subject,name:O[((g=h.subject)==null?void 0:g._id)||h.subject]||"Unknown"}}).filter((h,w,g)=>g.findIndex(k=>{var p,Y;return((p=k._id)==null?void 0:p.toString())===((Y=h._id)==null?void 0:Y.toString())})===w)},[o,O]),ce=l.useMemo(()=>{if(!o||!o.length)return{data:[{_id:null,name:"No Teacher Assigned"}]};const h=o.map(k=>k.teacher?{_id:k.teacher._id||k.teacher,firstName:k.teacher.firstName||"N/A",lastName:k.teacher.lastName||"",name:`${k.teacher.firstName||"N/A"} ${k.teacher.lastName||""}`.trim()||"No Teacher Assigned"}:{_id:null,name:"No Teacher Assigned"}),w=[],g=new Set;for(const k of h){const p=k._id?k._id.toString():"no_teacher";g.has(p)||(g.add(p),w.push(k))}return{data:w}},[o]);return{calendarEvents:se,viewModalOpen:f,setViewModalOpen:m,confirmationModalOpen:T,setConfirmationModalOpen:y,confirmationMessage:C,setConfirmationMessage:N,selectedTimetable:D,setSelectedTimetable:H,handleEventClick:M,classLevelData:U,subjectData:$,teacherData:ce,subjectNamesCache:O,loading:J,error:u,daysOfWeek:tt}},gt=({user:c})=>{const x=Ee();Oe(x.palette.mode);const a=(c==null?void 0:c._id)||"",o=_e("(max-width: 768px)"),t=_e("(max-width: 375px)"),{calendarEvents:f,viewModalOpen:m,setViewModalOpen:T,confirmationModalOpen:y,setConfirmationModalOpen:C,confirmationMessage:N,selectedTimetable:D,setSelectedTimetable:H,handleEventClick:O,classLevelData:V,teacherData:S,subjectNamesCache:_,loading:P,error:r}=xt({userId:a}),[s,G]=l.useState([]),[z,R]=l.useState(!0),[se,M]=l.useState(null);return c!=null&&c._id?(l.useEffect(()=>{let J=!0;return R(!0),M(null),f&&typeof f.then=="function"?f.then(u=>{J&&(G(Array.isArray(u)?u:[]),R(!1))}).catch(u=>{console.error("Error resolving calendar events:",u),J&&(M("Failed to load calendar events"),R(!1))}):J&&(G(Array.isArray(f)?f:[]),R(!1)),()=>{J=!1}},[f]),console.log("calendarEvents (raw):",f),console.log("resolvedEvents:",s),e.jsxs(Z,{py:"20px",children:[e.jsx(Je,{title:"STUDENT TIMETABLE",subtitle:"View Your Weekly Schedule",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsx(Z,{children:P||z?e.jsx(He,{}):r||se?e.jsx(v,{variant:"h6",color:"error",children:r||se}):s.length>0?e.jsx(Ve,{height:t?"45vh":o?"50vh":"75vh",plugins:[Ge,ze],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:s,eventClick:O,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(v,{variant:"h6",children:"No schedule available."})}),e.jsx(ut,{open:m,onClose:()=>{T(!1),H(null)},timetable:D,classLevelData:V,subjectNamesCache:_,teacherData:S,showEditButton:!1,showAttendance:!0,userId:a}),e.jsx(Re,{open:y,onClose:()=>C(!1),title:"Timetable Operation",message:N,isLoading:P})]})):e.jsx(v,{variant:"h6",color:"error",children:"Error: User ID not found"})};var Ye={},jt=it;Object.defineProperty(Ye,"__esModule",{value:!0});var nt=Ye.default=void 0,pt=jt(ot()),vt=e;nt=Ye.default=(0,pt.default)((0,vt.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle");const Tt=({open:c,onClose:x,onConfirm:a,attendanceChanges:o,handleAttendanceChange:t,studentData:f,isLoading:m})=>{var T;return e.jsx(Me,{open:c,onClose:x,title:"Mark Attendance",onConfirm:a,confirmMessage:"Confirm",styleProps:{padding:"20px"},noConfirm:m,children:e.jsx(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:((T=f==null?void 0:f.data)==null?void 0:T.length)>0?f.data.map(y=>e.jsxs(Z,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(v,{children:[y.firstName," ",y.lastName]}),e.jsx(K,{sx:{minWidth:100},children:e.jsxs(X,{value:o[y._id]||"Absent",onChange:C=>t(y._id,C.target.value),children:[e.jsx(E,{value:"Present",children:"Present"}),e.jsx(E,{value:"Absent",children:"Absent"}),e.jsx(E,{value:"Late",children:"Late"}),e.jsx(E,{value:"Excused",children:"Excused"})]})})]},y._id)):e.jsx(v,{children:"No students available"})})})},yt=({open:c,onClose:x,timetable:a,classLevelData:o,subjectData:t,subjectNamesCache:f,showEditButton:m,onMarkAttendance:T})=>{var N,D,H;const y=O=>{var V,S;return((S=(V=o==null?void 0:o.data)==null?void 0:V.find(_=>_._id===O))==null?void 0:S.name)||"N/A"},C=O=>f[O]||"Unknown";return e.jsx(Me,{open:c,onClose:x,title:"Timetable Details",onConfirm:T,confirmMessage:"Mark Attendance",styleProps:{padding:"20px"},noConfirm:!T,additionalButton:T&&e.jsx(Ie,{content:"Mark Attendance",icon:e.jsx(nt,{}),onClick:T,sx:{mr:2}}),children:a?e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Class Level:"})," ",y(((N=a.classLevel)==null?void 0:N._id)||a.classLevel)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Section:"})," ",((D=a.classLevel)==null?void 0:D.section)||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subject:"})," ",C(((H=a.subject)==null?void 0:H._id)||a.subject)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"End Time:"})," ",a.endTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Teacher:"})," ",a.teacher&&`${a.teacher.firstName||""} ${a.teacher.lastName||""}`.trim()||"No Teacher"]})]}):e.jsx(v,{children:"No timetable details available"})})},st=["Monday","Tuesday","Wednesday","Thursday","Friday"],Ct=({userId:c})=>{const x=Ee();Oe(x.palette.mode);const[a,o]=l.useState([]),[t,f]=l.useState(""),[m,T]=l.useState(""),[y,C]=l.useState(!1),[N,D]=l.useState(!1),[H,O]=l.useState(!1),[V,S]=l.useState(""),[_,P]=l.useState(null),[r,s]=l.useState(null),[G,z]=l.useState({}),[R,se]=l.useState({}),{loading:M,error:J,callApi:u,data:U}=oe(),{loading:$,error:ce,callApi:ae,data:h}=oe(),{loading:w,error:g,callApi:k}=oe(),{loading:p,error:Y,data:re}=oe(),{loading:ve,error:be,data:he}=oe(),{loading:xe,error:de,callApi:B}=oe(),ie=l.useCallback(async(W,F)=>{var I;if(!W)return"Unknown";if(R[W])return R[W];try{const L=await B(`/subject-names/${W}`,"GET"),ee=((I=L==null?void 0:L.data)==null?void 0:I.name)||"Unknown";return F()&&se(A=>({...A,[W]:ee})),ee}catch(L){return console.error(`Error fetching subject name for ID ${W}:`,L),"Unknown"}},[B,R]);l.useEffect(()=>{u(`${fe.TIMETABLE}/teacher/${c}`,"GET")},[u,c]),l.useEffect(()=>{(U==null?void 0:U.status)==="success"&&o(U.data||[])},[U]);const Ce=l.useMemo(()=>{const W=[],F=new Set;return a.forEach(I=>{const L=I.classLevel;L&&L._id&&!F.has(L._id)&&(F.add(L._id),W.push({_id:L._id,name:L.name}))}),W},[a]),Se=l.useMemo(()=>{if(!t)return[];const W=[],F=new Set;return a.forEach(I=>{var L;((L=I.classLevel)==null?void 0:L._id)===t&&I.subclassLetter&&(F.has(I.subclassLetter)||(F.add(I.subclassLetter),W.push(I.subclassLetter)))}),W.sort()},[a,t]),ne=l.useMemo(()=>{let W=!0;if(!a||a.length===0)return Promise.resolve([]);const I=rt(new Date("2025-07-25T16:38:00+01:00"),{weekStartsOn:1}),L=a.filter(A=>{var n;const ue=!t||((n=A.classLevel)==null?void 0:n._id)===t,pe=!m||A.subclassLetter===m;return ue&&pe});return Promise.all(L.map(async A=>{var me,le,Te,ye;const ue=st.indexOf(A.dayOfWeek);if(ue===-1)return null;const pe=new Date(I);pe.setDate(I.getDate()+ue);const[n,d]=A.startTime.split(":").map(Number);pe.setHours(n,d,0,0);const i=new Date(I),[b,j]=A.endTime.split(":").map(Number);i.setDate(I.getDate()+ue),i.setHours(b,j,0,0);const q=((me=A.subject)==null?void 0:me._id)||A.subject,Q=await ie(q,()=>W);return{id:A._id,title:`${Q} (${A.location})`,start:pe,end:i,extendedProps:{classLevel:((le=A.classLevel)==null?void 0:le._id)||A.classLevel,classLevelName:((Te=A.classLevel)==null?void 0:Te.name)||"N/A",section:((ye=A.classLevel)==null?void 0:ye.section)||"N/A",subclassLetter:A.subclassLetter||"",subject:q||"",subjectName:Q,teacherName:A.teacher&&`${A.teacher.firstName||""} ${A.teacher.lastName||""}`.trim()||"No Teacher",dayOfWeek:A.dayOfWeek,startTime:A.startTime,numberOfPeriods:A.numberOfPeriods,location:A.location}}})).then(A=>A.filter(ue=>ue!==null)).catch(A=>(console.error("Error processing calendar events:",A),S("Failed to process timetable events"),O(!0),[]))},[a,t,m,ie]),[Ne,Le]=l.useState([]),[ge,je]=l.useState(!0),[De,Pe]=l.useState(null);l.useEffect(()=>{let W=!0;return je(!0),Pe(null),ne&&typeof ne.then=="function"?ne.then(F=>{W&&(Le(Array.isArray(F)?F:[]),je(!1))}).catch(F=>{console.error("Error resolving calendar events:",F),W&&(Pe("Failed to load calendar events"),je(!1))}):W&&(Le(Array.isArray(ne)?ne:[]),je(!1)),()=>{W=!1}},[ne]);const We=l.useCallback(async(W,F)=>{var L;const I=await ae(`${fe.CLASS_LEVEL}/${W}/subclasses/${F}/students`,"GET");return((L=I==null?void 0:I.data)==null?void 0:L.students)||[]},[ae]),$e=l.useCallback((W,F)=>{z(I=>({...I,[W]:F}))},[]),Fe=l.useCallback(async()=>{if(!a.find(L=>L._id===_))return;const F=Object.entries(G).map(([L,ee])=>({studentId:L,status:ee,notes:ee==="Absent"||ee==="Excused"?"Marked by instructor":""})),I={timetableId:_,periodIndex:0,attendanceData:F};try{const L=await k(`${fe.TIMETABLE}/${_}/attendance`,"PUT",I);(L==null?void 0:L.status)==="success"?(o(a.map(ee=>ee._id===_?{...ee,periodAttendance:L.data.periodAttendance}:ee)),S("Attendance marked successfully"),C(!1),O(!0),P(null),z({})):(S((L==null?void 0:L.message)||g||"Failed to mark attendance"),O(!0))}catch(L){S(g||L.message||"Failed to mark attendance"),O(!0)}},[a,_,G,k,g]),we=l.useCallback(async W=>{const F=a.find(I=>I._id===W);if(F){const L=(await We(F.classLevel._id,F.subclassLetter)).reduce((ee,A)=>{var pe,n;const ue=(n=(pe=F.periodAttendance)==null?void 0:pe[0])==null?void 0:n.attendance.find(d=>d.studentId.toString()===A._id.toString());return{...ee,[A._id]:(ue==null?void 0:ue.status)||"Absent"}},{});z(L),P(W),C(!0)}},[a,We]),Ue=l.useCallback(W=>{const F=a.find(I=>I._id===W.event.id);F&&(s(F),D(!0))},[a]),qe=M||$||w||p||ve||xe||ge,ke=(U==null?void 0:U.status)==="failed"?U.message:J||ce||g||Y||be||de||De;return{calendarEvents:Ne,selectedClassLevel:t,setSelectedClassLevel:f,selectedSubclass:m,setSelectedSubclass:T,classLevelOptions:Ce,subclassOptions:Se,attendanceModalOpen:y,setAttendanceModalOpen:C,viewModalOpen:N,setViewModalOpen:D,confirmationModalOpen:H,setConfirmationModalOpen:O,confirmationMessage:V,selectedScheduleId:_,selectedTimetable:r,attendanceChanges:G,setAttendanceChanges:z,handleAttendanceChange:$e,handleConfirmAttendance:Fe,openAttendanceModal:we,handleEventClick:Ue,classLevelData:re,subjectData:he,studentData:h,subjectNamesCache:R,loading:qe,error:ke,daysOfWeek:st}},Nt=({user:c})=>{const x=Ee();Oe(x.palette.mode);const a=(c==null?void 0:c._id)||"",o=_e("(max-width: 768px)"),t=_e("(max-width: 375px)"),{calendarEvents:f,selectedClassLevel:m,setSelectedClassLevel:T,selectedSubclass:y,setSelectedSubclass:C,classLevelOptions:N,subclassOptions:D,attendanceModalOpen:H,setAttendanceModalOpen:O,viewModalOpen:V,setViewModalOpen:S,confirmationModalOpen:_,setConfirmationModalOpen:P,confirmationMessage:r,selectedTimetable:s,handleAttendanceChange:G,handleConfirmAttendance:z,openAttendanceModal:R,handleEventClick:se,classLevelData:M,subjectData:J,subjectNamesCache:u,studentData:U,attendanceChanges:$,loading:ce,error:ae}=Ct({userId:a});return c!=null&&c._id?e.jsxs(Z,{py:"20px",children:[e.jsx(Je,{title:"TEACHER TIMETABLE",subtitle:"View Your Schedule and Mark Attendance",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(Z,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(K,{sx:{minWidth:150},children:[e.jsx(te,{children:"Class Level"}),e.jsxs(X,{value:m||"",onChange:h=>T(h.target.value),label:"Class Level",children:[e.jsx(E,{value:"",children:"All Classes"}),N.map(h=>e.jsx(E,{value:h._id,children:h.name},h._id))]})]}),e.jsxs(K,{sx:{minWidth:120},children:[e.jsx(te,{children:"Subclass"}),e.jsxs(X,{value:y||"",onChange:h=>C(h.target.value),label:"Subclass",disabled:!m,children:[e.jsx(E,{value:"",children:"All Subclasses"}),D.map(h=>e.jsx(E,{value:h,children:h},h))]})]})]}),e.jsx(Z,{children:ce?e.jsx(He,{}):ae?e.jsx(v,{color:"error",children:ae}):f.length>0?e.jsx(Ve,{height:t?"45vh":o?"50vh":"75vh",plugins:[Ge,ze],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:f,eventClick:se,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(v,{children:"No schedule available."})}),e.jsx(Tt,{open:H,onClose:()=>{O(!1),setSelectedScheduleId(null)},onConfirm:z,attendanceChanges:$,handleAttendanceChange:G,studentData:U,isLoading:ce}),e.jsx(yt,{open:V,onClose:()=>{S(!1),setSelectedTimetable(null)},timetable:s,classLevelData:M,subjectData:J,subjectNamesCache:u,showEditButton:!1,onMarkAttendance:()=>R(s==null?void 0:s._id)}),e.jsx(Re,{open:_,onClose:()=>P(!1),title:"Attendance Operation",message:r,isLoading:ce})]}):e.jsx(v,{variant:"h6",color:"error",children:"Error: User ID not found"})},Lt=({open:c,onClose:x,onConfirm:a,newSchedule:o,setNewSchedule:t,classLevelData:f,availableSubclasses:m,availableSubjects:T,availableTeachers:y,isLoading:C,daysOfWeek:N,handleClassLevelChange:D,handleSubclassChange:H,setConfirmationMessage:O,setConfirmationModalOpen:V})=>{var P;console.log(y);const S=()=>{const r=_(o);if(r){O(r),V(!0);return}a()},_=r=>r.classLevel?r.subclassLetter?r.subject?r.teacher?r.dayOfWeek?r.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(r.startTime)?!r.numberOfPeriods||r.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(r.numberOfPeriods))?r.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Me,{open:c,onClose:x,title:"Add New Timetable",onConfirm:S,confirmMessage:"Add",styleProps:{padding:"20px"},noConfirm:C,children:e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(X,{labelId:"class-level-modal-label",value:o.classLevel,label:"Class Level",onChange:r=>{t({...o,classLevel:r.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),D(r.target.value)},disabled:C,children:((P=f==null?void 0:f.data)==null?void 0:P.length)>0?f.data.map(r=>e.jsx(E,{value:r._id,children:r.name},r._id)):e.jsx(E,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(X,{labelId:"subclass-modal-label",value:o.subclassLetter,label:"Subclass",onChange:r=>{t({...o,subclassLetter:r.target.value,subject:"",teacher:"",teacherName:""}),H(r.target.value)},disabled:!o.classLevel||C,children:(m==null?void 0:m.length)>0?m.map(r=>e.jsx(E,{value:r,children:r},r)):e.jsx(E,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"subject-modal-label",children:"Subject"}),e.jsx(X,{labelId:"subject-modal-label",value:o.subject,label:"Subject",onChange:r=>t({...o,subject:r.target.value,teacher:"",teacherName:""}),disabled:C||!o.subclassLetter,children:(T==null?void 0:T.length)>0?T.map(r=>e.jsx(E,{value:r._id,children:r.displayName},r._id)):e.jsx(E,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(X,{labelId:"teacher-modal-label",value:o.teacher,label:"Teacher",onChange:r=>t({...o,teacher:r.target.value}),disabled:C||!o.subject,children:(y==null?void 0:y.length)>0?y.map(r=>e.jsx(E,{value:r._id,children:r.displayName},r._id)):e.jsx(E,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"day-modal-label",children:"Day of Week"}),e.jsx(X,{labelId:"day-modal-label",value:o.dayOfWeek,label:"Day of Week",onChange:r=>t({...o,dayOfWeek:r.target.value}),disabled:C,children:(N==null?void 0:N.length)>0?N.map(r=>e.jsx(E,{value:r,children:r},r)):e.jsx(E,{disabled:!0,children:"No days available"})})]}),e.jsx(Ae,{label:"Start Time (HH:MM)",value:o.startTime,onChange:r=>t({...o,startTime:r.target.value}),fullWidth:!0,disabled:C,error:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime),helperText:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(Ae,{label:"Number of Periods",type:"number",value:o.numberOfPeriods,onChange:r=>t({...o,numberOfPeriods:r.target.value}),fullWidth:!0,inputProps:{min:1},disabled:C,error:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1),helperText:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(Ae,{label:"Location",value:o.location,onChange:r=>t({...o,location:r.target.value}),fullWidth:!0,disabled:C})]})})},Mt=({open:c,onClose:x,onConfirm:a,onDelete:o,newSchedule:t,setNewSchedule:f,classLevelData:m,availableSubclasses:T,availableSubjects:y,availableTeachers:C,isLoading:N,daysOfWeek:D,handleClassLevelChange:H,handleSubclassChange:O,setConfirmationMessage:V,setConfirmationModalOpen:S})=>{var r;const _=()=>{const s=P(t);if(s){V(s),S(!0);return}a()},P=s=>s.classLevel?s.subclassLetter?s.subject?s.teacher?s.dayOfWeek?s.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(s.startTime)?!s.numberOfPeriods||s.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(s.numberOfPeriods))?s.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Me,{open:c,onClose:x,title:"Edit Timetable",onConfirm:_,confirmMessage:"Update",styleProps:{padding:"20px"},noConfirm:N,additionalButton:e.jsx(ct,{variant:"contained",color:"error",onClick:o,disabled:N,sx:{mr:2},children:"Delete"}),children:e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(X,{labelId:"class-level-modal-label",value:t.classLevel,label:"Class Level",onChange:s=>{f({...t,classLevel:s.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),H(s.target.value)},disabled:N,children:((r=m==null?void 0:m.data)==null?void 0:r.length)>0?m.data.map(s=>e.jsx(E,{value:s._id,children:s.name},s._id)):e.jsx(E,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(X,{labelId:"subclass-modal-label",value:t.subclassLetter,label:"Subclass",onChange:s=>{f({...t,subclassLetter:s.target.value,subject:"",teacher:"",teacherName:""}),O(s.target.value)},disabled:!t.classLevel||N,children:(T==null?void 0:T.length)>0?T.map(s=>e.jsx(E,{value:s,children:s},s)):e.jsx(E,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"subject-modal-label",children:"Subject"}),e.jsx(X,{labelId:"subject-modal-label",value:t.subject,label:"Subject",onChange:s=>f({...t,subject:s.target.value,teacher:"",teacherName:""}),disabled:N||!t.subclassLetter,children:(y==null?void 0:y.length)>0?y.map(s=>e.jsx(E,{value:s._id,children:s.displayName},s._id)):e.jsx(E,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(X,{labelId:"teacher-modal-label",value:t.teacher,label:"Teacher",onChange:s=>f({...t,teacher:s.target.value}),disabled:N||!t.subject,children:(C==null?void 0:C.length)>0?C.map(s=>e.jsx(E,{value:s._id,children:s.displayName},s._id)):e.jsx(E,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(K,{fullWidth:!0,children:[e.jsx(te,{id:"day-modal-label",children:"Day of Week"}),e.jsx(X,{labelId:"day-modal-label",value:t.dayOfWeek,label:"Day of Week",onChange:s=>f({...t,dayOfWeek:s.target.value}),disabled:N,children:(D==null?void 0:D.length)>0?D.map(s=>e.jsx(E,{value:s,children:s},s)):e.jsx(E,{disabled:!0,children:"No days available"})})]}),e.jsx(Ae,{label:"Start Time (HH:MM)",value:t.startTime,onChange:s=>f({...t,startTime:s.target.value}),fullWidth:!0,disabled:N,error:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime),helperText:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(Ae,{label:"Number of Periods",type:"number",value:t.numberOfPeriods,onChange:s=>f({...t,numberOfPeriods:s.target.value}),fullWidth:!0,inputProps:{min:1},disabled:N,error:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1),helperText:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(Ae,{label:"Location",value:t.location,onChange:s=>f({...t,location:s.target.value}),fullWidth:!0,disabled:N})]})})},Ot=({open:c,onClose:x,onEdit:a,onDelete:o,timetable:t,availableSubjects:f})=>{console.log(t);const m=Ee(),T=Oe(m.palette.mode);return e.jsxs(Me,{open:c,onClose:x,title:"Timetable Details",noConfirm:!0,confirmMessage:"Edit",styleProps:{padding:"20px"},children:[t?e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Class Level:"})," ",t.classLevel.name]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subclass:"})," ",t.subclassLetter]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subject:"})," ",t.subject]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Teacher:"})," ",t.teacher?`${t.teacher.firstName} ${t.teacher.lastName}`:"Unassigned"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Day of Week:"})," ",t.dayOfWeek]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Start Time:"})," ",t.startTime]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",t.numberOfPeriods]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Location:"})," ",t.location]})]}):e.jsx(v,{children:"No timetable details available"}),e.jsxs(Z,{display:"flex",justifyContent:"flex-end",mt:"16px",gap:"10px",children:[e.jsx(Ie,{content:"Edit Timetable",onClick:a,sx:{backgroundColor:T.greenAccent[500]}}),e.jsx(Ie,{content:"Delete Timetable",onClick:o,sx:{backgroundColor:T.redAccent[500]}})]})]})},Et=({open:c,onClose:x,onConfirm:a,isLoading:o})=>e.jsx(Me,{open:c,onClose:x,title:"Confirm Deletion",onConfirm:a,confirmMessage:"Delete",styleProps:{padding:"20px"},noConfirm:o,children:e.jsx(v,{children:"Are you sure you want to delete this timetable? This action cannot be undone."})}),at=["Monday","Tuesday","Wednesday","Thursday","Friday"],St=({userId:c})=>{const x=Ee();Oe(x.palette.mode);const[a,o]=l.useState(""),[t,f]=l.useState(""),[m,T]=l.useState(""),[y,C]=l.useState(!1),[N,D]=l.useState(!1),[H,O]=l.useState(!1),[V,S]=l.useState(!1),[_,P]=l.useState(!1),[r,s]=l.useState(""),[G,z]=l.useState([]),[R,se]=l.useState(!1),[M,J]=l.useState(null),[u,U]=l.useState({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),[$,ce]=l.useState([]),[ae,h]=l.useState([]),[w,g]=l.useState([]),{loading:k,error:p,callApi:Y}=oe(),{loading:re,error:ve,callApi:be}=oe(),{loading:he,error:xe,callApi:de}=oe(),{loading:B,error:ie,callApi:Ce}=oe(),{loading:Se,error:ne,callApi:Ne}=oe(),{loading:Le,error:ge,callApi:je}=oe();l.useEffect(()=>{(async()=>{var d,i;try{const b=await be(fe.CLASS_LEVEL,"GET");console.log("Class Levels fetched:",(d=b==null?void 0:b.data)==null?void 0:d.data),ce(((i=b==null?void 0:b.data)==null?void 0:i.data)||[])}catch(b){console.error("Error loading class levels:",b),s("Failed to load class levels: "+(b.message||"Unknown error")),S(!0)}})()},[be]),l.useEffect(()=>{if(!t||!m){console.log("Skipping subject fetch: missing classLevel or subclass"),h([]);return}(async()=>{const d=$.find(j=>j._id===t);if(!d){console.log("Class level not found:",t),h([]);return}const i=d.subclasses.find(j=>j.letter===m);if(!i){console.log("Subclass not found:",m),h([]);return}const b=i.subjects.map(j=>j.subject);console.log("Subject IDs to fetch:",b);try{const j=await de(`${fe.SUBJECT}?ids=${b.join(",")}`,"GET");console.log("Fetched subjects:",j==null?void 0:j.data),h((j==null?void 0:j.data)||[])}catch(j){console.error("Error fetching subjects:",j),s("Failed to load subjects: "+(j.message||"Unknown error")),S(!0)}})()},[t,m,$,de]),l.useEffect(()=>{if(!t||!m){console.log("Skipping timetable fetch: missing classLevel or subclass"),g([]);return}(async()=>{try{const d=await Y(`${fe.TIMETABLE}?classLevel=${t}&subclassLetter=${m}`,"GET");console.log("Timetables fetched:",d==null?void 0:d.data),g((d==null?void 0:d.data)||[])}catch(d){console.error("Error fetching timetables:",d),s("Failed to load timetables: "+(d.message||"Unknown error")),S(!0)}})()},[t,m,Y]);const De=l.useMemo(()=>{if(console.log("Filtering class levels with:",{classLevels:$,selectedSection:a}),!$.length)return{data:[]};if(!a)return{data:$};const n=$.filter(d=>d.section===a);return console.log("Filtered class levels:",n),{data:n}},[$,a]),Pe=l.useMemo(()=>{var i;if(console.log("Computing available subclasses:",{classLevels:$,selectedClassLevel:t}),!$.length||!t)return console.log("No classLevels or selectedClassLevel, returning empty subclasses"),[];const n=$.find(b=>b._id===t);if(!n)return console.log("Selected class level not found in classLevels"),[];const d=[...new Set((i=n.subclasses)==null?void 0:i.map(b=>b.letter).filter(Boolean))];return console.log("Computed subclasses:",d),d},[$,t]);l.useEffect(()=>{(async()=>{if(console.log("Computing available subjects:",{classLevels:$,selectedClassLevel:t,selectedSubclass:m}),!$.length||!t||!m){z([]);return}const d=$.find(j=>j._id===t);if(!d){console.log("Class level not found:",t),z([]);return}const i=d.subclasses.find(j=>j.letter===m);if(!i){console.log("Subclass not found:",m),z([]);return}const b=i.subjects.map(j=>j.subject);console.log("Subject IDs to fetch:",b);try{se(!0);const j=b.map(async me=>{var Te,ye;const le=await de(`${fe.SUBJECT}/${me}`,"GET");return console.log(`Fetched subject ${me}:`,le==null?void 0:le.data),le!=null&&le.data?{_id:((Te=le.data.name)==null?void 0:Te._id)||le.data._id,displayName:((ye=le.data.name)==null?void 0:ye.name)||"Unknown"}:null}),Q=(await Promise.all(j)).filter(Boolean);console.log("Final availableSubjects:",Q),z(Q)}catch(j){console.error("Error fetching subjects:",j),z([])}finally{se(!1)}})()},[$,t,m,de]);const We=l.useMemo(()=>{if(console.log("Computing available teachers:",{classLevels:$,selectedClassLevel:t,selectedSubclass:m}),!$.length||!t||!m)return console.log("Missing required data for teachers, returning empty teachers"),[];const n=$.filter(i=>i._id===t).flatMap(i=>{const b=i.subclasses.find(q=>q.letter===m);if(!b)return console.log("Subclass not found:",m),[];const j=b.subjects.flatMap(q=>q.teachers||[]).filter(Boolean);return console.log("Teacher IDs from subclass subjects:",j),i.teachers.filter(q=>j.includes(q.teacherId)).map(q=>({_id:q.teacherId,displayName:`${q.firstName} ${q.lastName}`.trim()}))}),d=Array.from(new Map(n.map(i=>[i._id,i])).values());return console.log("Computed unique teachers:",d),d},[$,t,m]);l.useEffect(()=>{if(!u.teacher||!$.length){U(b=>({...b,teacherName:""}));return}const n=$.find(b=>b._id===u.classLevel);if(!n){U(b=>({...b,teacherName:""}));return}const d=n.teachers.find(b=>b.teacherId===u.teacher),i=d?`${d.firstName} ${d.lastName}`.trim():"";console.log("Setting teacherName:",{teacherId:u.teacher,teacherName:i}),U(b=>({...b,teacherName:i}))},[u.teacher,$,u.classLevel]);const $e=l.useCallback((n,d)=>{const[i,b]=n.split(":").map(Number),j=i*60+b+d*45,q=Math.floor(j/60),Q=j%60;return`${q.toString().padStart(2,"0")}:${Q.toString().padStart(2,"0")}`},[]),Fe=l.useMemo(()=>(console.log("Processing calendarEvents, timetables:",w,"subjects:",ae),w.length?w.map(n=>{var ye,Qe,Ke,Xe,Ze;const d=at.indexOf(n.dayOfWeek);if(d===-1)return console.log("Invalid dayOfWeek:",n.dayOfWeek),null;const i=d+1;console.log(`Mapping ${n.dayOfWeek} to daysOfWeek: [${i}]`);const b=`${n.startTime}:00`,j=`${n.endTime}:00`,q=((ye=n.subject)==null?void 0:ye._id)||n.subject,Q=ae.find(lt=>lt._id===q),me=((Qe=Q==null?void 0:Q.name)==null?void 0:Qe.name)||"Unknown";console.log(`Subject name for ${q}: ${me}`);const le=n.teacher?`${n.teacher.firstName} ${n.teacher.lastName}`.trim():"Unassigned",Te={id:n._id,title:`${me} (${n.location})`,daysOfWeek:[i],startTime:b,endTime:j,extendedProps:{classLevel:((Ke=n.classLevel)==null?void 0:Ke._id)||n.classLevel,classLevelName:((Xe=n.classLevel)==null?void 0:Xe.name)||"N/A",subclassLetter:n.subclassLetter,subject:q,subjectName:me,teacher:((Ze=n.teacher)==null?void 0:Ze._id)||null,teacherName:le,dayOfWeek:n.dayOfWeek,startTime:n.startTime,numberOfPeriods:n.numberOfPeriods,location:n.location}};return console.log("Generated event:",JSON.stringify(Te,null,2)),Te}).filter(Boolean):(console.log("No timetables, returning empty events"),[])),[w,ae]),we=l.useCallback(n=>{console.log("Setting section:",n),o(n),f(""),T("")},[]),Ue=l.useCallback(n=>{console.log("Setting class level:",n),f(n),T(""),U(d=>({...d,classLevel:n,subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),qe=l.useCallback(n=>{console.log("Setting subclass:",n),T(n),U(d=>({...d,subclassLetter:n,subject:"",teacher:"",teacherName:""}))},[]),ke=l.useCallback(()=>{if(!c)return"User not authenticated. Please log in.";if(!u.classLevel)return"Class level is required";if(!u.subclassLetter)return"Subclass is required";if(!u.subject)return"Subject is required";if(!u.teacher)return"Teacher is required";if(!u.dayOfWeek)return"Day of week is required";if(!u.startTime)return"Start time is required";if(!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(u.startTime))return"Start time must be in HH:MM format (00:00-23:59)";const[n,d]=u.startTime.split(":").map(Number),i=n*60+d;if(i<7*60||i>18*60)return"Start time must be between 07:00 AM and 06:00 PM";if(!u.numberOfPeriods||u.numberOfPeriods<1)return"Number of periods must be at least 1";if(!Number.isInteger(Number(u.numberOfPeriods)))return"Number of periods must be an integer";const b=$e(u.startTime,Number(u.numberOfPeriods)),[j,q]=b.split(":").map(Number);return j*60+q>18*60?"End time cannot exceed 06:00 PM":u.location?"":"Location is required"},[u,c,$e]),W=l.useCallback(async()=>{const n=ke();if(n){s(n),S(!0);return}const d={classLevel:u.classLevel,subclassLetter:u.subclassLetter,subject:u.subject,teacher:u.teacher,teacherName:u.teacherName,dayOfWeek:u.dayOfWeek,startTime:u.startTime,numberOfPeriods:parseInt(u.numberOfPeriods,10),location:u.location,createdBy:c};try{const i=await Ce(fe.TIMETABLE,"POST",d);(i==null?void 0:i.status)==="success"?(g(b=>[i.data,...b].slice(0,10)),s("Timetable added successfully"),C(!1),U({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})):s((i==null?void 0:i.message)||ie||"Failed to add timetable")}catch(i){console.error("Error adding timetable:",i),s(ie||i.message||"Failed to add timetable")}S(!0)},[Ce,ie,ke,c]),F=l.useCallback(async()=>{if(!M){s("No timetable selected for update"),S(!0);return}const n=ke();if(n){s(n),S(!0);return}const d={classLevel:u.classLevel,subclassLetter:u.subclassLetter,subject:u.subject,teacher:u.teacher,teacherName:u.teacherName,dayOfWeek:u.dayOfWeek,startTime:u.startTime,numberOfPeriods:parseInt(u.numberOfPeriods,10),location:u.location,createdBy:c};try{const i=await Ne(`${fe.TIMETABLE}/${M._id}`,"PUT",d);(i==null?void 0:i.status)==="success"?(g(b=>b.map(j=>j._id===M._id?{...j,...i.data}:j)),s("Timetable updated successfully"),D(!1),O(!1),U({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),J(null)):s((i==null?void 0:i.message)||ne||"Failed to update timetable")}catch(i){console.error("Error updating timetable:",i),s(ne||i.message||"Failed to update timetable")}S(!0)},[Ne,ne,M,ke,c]),I=l.useCallback(()=>{if(!M){s("No timetable selected for deletion"),S(!0);return}P(!0)},[M]),L=l.useCallback(async()=>{try{const n=await je(`${fe.TIMETABLE}/${M._id}`,"DELETE");(n==null?void 0:n.status)==="success"?(g(d=>d.filter(i=>i._id!==M._id)),s("Timetable deleted successfully"),D(!1),O(!1),P(!1),J(null)):s((n==null?void 0:n.message)||ge||"Failed to delete timetable")}catch(n){console.error("Error deleting timetable:",n),s(ge||n.message||"Failed to delete timetable")}S(!0)},[je,ge,M]);console.log(G);const ee=l.useCallback(n=>{var q;const d=w.find(Q=>Q._id===n.event.id);if(!d){s("Timetable not found"),S(!0);return}const i=G.find(Q=>{var me;return Q._id===((me=d.subject)==null?void 0:me.name)}),b=(i==null?void 0:i.displayName)||((q=d.subject)==null?void 0:q.name)||d.subject||"Unknown",j={...d,subject:b};console.log("Transformed timetable:",j),J(j),O(!0)},[w,G]),A=l.useCallback(()=>{var n,d,i;M&&(U({classLevel:((n=M.classLevel)==null?void 0:n._id)||M.classLevel,subclassLetter:M.subclassLetter,subject:((d=M.subject)==null?void 0:d._id)||M.subject,teacher:((i=M.teacher)==null?void 0:i._id)||"",teacherName:M.teacher?`${M.teacher.firstName} ${M.teacher.lastName}`.trim():"",dayOfWeek:M.dayOfWeek,startTime:M.startTime,numberOfPeriods:M.numberOfPeriods,location:M.location}),O(!1),D(!0))},[M]);return{calendarEvents:Fe,selectedSection:a,setSelectedSection:we,selectedClassLevel:t,setSelectedClassLevel:Ue,selectedSubclass:m,setSelectedSubclass:qe,addModalOpen:y,setAddModalOpen:C,editModalOpen:N,setEditModalOpen:D,viewModalOpen:H,setViewModalOpen:O,confirmationModalOpen:V,setConfirmationModalOpen:S,deleteConfirmationOpen:_,setDeleteConfirmationOpen:P,confirmationMessage:r,setConfirmationMessage:s,newSchedule:u,setNewSchedule:U,selectedTimetable:M,handleAddSchedule:W,handleUpdateSchedule:F,handleInitiateDelete:I,handleDeleteSchedule:L,handleEventClick:ee,handleOpenEditModal:A,classLevelData:De,availableSubclasses:Pe,availableSubjects:G,availableTeachers:We,loading:k||re||he||B||Se||Le,error:p||ve||xe||ie||ne||ge,daysOfWeek:at,weeksPerTerm:12,setSelectedTimetable:J}},kt=()=>{var xe,de;const c=Ee(),x=Oe(c.palette.mode),a=Be(B=>{var ie;return((ie=B.users.user)==null?void 0:ie._id)||""}),o=_e("(max-width: 768px)"),t=_e("(max-width: 375px)"),{calendarEvents:f,selectedSection:m,setSelectedSection:T,selectedClassLevel:y,setSelectedClassLevel:C,selectedSubclass:N,setSelectedSubclass:D,addModalOpen:H,setAddModalOpen:O,editModalOpen:V,setEditModalOpen:S,viewModalOpen:_,setViewModalOpen:P,confirmationModalOpen:r,setConfirmationModalOpen:s,deleteConfirmationOpen:G,setDeleteConfirmationOpen:z,confirmationMessage:R,setConfirmationMessage:se,newSchedule:M,setNewSchedule:J,selectedTimetable:u,handleAddSchedule:U,handleUpdateSchedule:$,handleInitiateDelete:ce,handleDeleteSchedule:ae,handleEventClick:h,handleOpenEditModal:w,classLevelData:g,availableSubclasses:k,availableSubjects:p,availableTeachers:Y,loading:re,error:ve,daysOfWeek:be,setSelectedTimetable:he}=St({userId:a});return console.log("CalendarEvents:",f),e.jsxs(Z,{py:"20px",children:[e.jsx(Je,{title:"ADMIN TIMETABLE",subtitle:"Manage Class and Subclass Timetables",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(Z,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(K,{sx:{minWidth:150},children:[e.jsx(te,{id:"section-select-label",children:"Section"}),e.jsxs(X,{labelId:"section-select-label",value:m,label:"Section",onChange:B=>T(B.target.value),children:[e.jsx(E,{value:"",children:"All"}),e.jsx(E,{value:"Primary",children:"Primary"}),e.jsx(E,{value:"Secondary",children:"Secondary"})]})]}),e.jsxs(K,{sx:{minWidth:150},children:[e.jsx(te,{id:"class-level-select-label",children:"Class Level"}),e.jsxs(X,{labelId:"class-level-select-label",value:y,label:"Class Level",onChange:B=>C(B.target.value),disabled:!((xe=g==null?void 0:g.data)!=null&&xe.length),children:[e.jsx(E,{value:"",children:"Select Class Level"}),(de=g==null?void 0:g.data)==null?void 0:de.map(B=>e.jsx(E,{value:B._id,children:B.name},B._id))]})]}),e.jsxs(K,{sx:{minWidth:150},children:[e.jsx(te,{id:"subclass-select-label",children:"Subclass"}),e.jsxs(X,{labelId:"subclass-select-label",value:N,label:"Subclass",onChange:B=>D(B.target.value),disabled:!y||!(k!=null&&k.length),children:[e.jsx(E,{value:"",children:"Select Subclass"}),(k==null?void 0:k.length)>0?k.map(B=>e.jsx(E,{value:B,children:B},B)):e.jsx(E,{disabled:!0,children:"No subclasses available"})]})]}),e.jsx(Ie,{content:"Add Timetable",onClick:()=>O(!0),disabled:!y||!N,sx:{backgroundColor:x.greenAccent[500]}})]}),e.jsx(Z,{sx:{"& .fc-event":{cursor:"pointer"}},children:re?e.jsx(He,{}):ve?e.jsx(v,{color:"error",children:ve}):f.length>0?e.jsx(Ve,{height:t?"45vh":o?"50vh":"75vh",plugins:[Ge,ze],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:f,eventClick:h,slotMinTime:"00:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(v,{children:"No timetable available for selected time table."})}),e.jsx(Lt,{open:H,onClose:()=>{O(!1),J({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})},onConfirm:U,newSchedule:M,setNewSchedule:J,classLevelData:g,availableSubclasses:k,availableSubjects:p,availableTeachers:Y,isLoading:re,daysOfWeek:be,handleClassLevelChange:C,handleSubclassChange:D,setConfirmationMessage:se,setConfirmationModalOpen:s}),e.jsx(Mt,{open:V,onClose:()=>{S(!1),he(null)},onConfirm:$,onDelete:ce,newSchedule:M,setNewSchedule:J,classLevelData:g,availableSubclasses:k,availableSubjects:p,availableTeachers:Y,isLoading:re,daysOfWeek:be,handleClassLevelChange:C,handleSubclassChange:D,setConfirmationMessage:se,setConfirmationModalOpen:s}),e.jsx(Ot,{open:_,onClose:()=>{P(!1),he(null)},onEdit:w,onDelete:ce,timetable:u,classLevelData:g,availableSubjects:p}),e.jsx(Et,{open:G,onClose:()=>z(!1),onConfirm:ae,isLoading:re}),e.jsx(Re,{open:r,onClose:()=>s(!1),title:"Timetable Operation",message:R,isLoading:re})]})},At=()=>{const c=Be(a=>a.users.user),x=c.role;return e.jsx("div",{children:x==="student"?e.jsx(gt,{user:c}):x==="teacher"?e.jsx(Nt,{user:c}):e.jsx(kt,{})})},Qt=dt(At);export{Qt as default};
