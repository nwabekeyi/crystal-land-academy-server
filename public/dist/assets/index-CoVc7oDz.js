import{r as N,a as X,e as Y,N as be,O as pe,j as g,q as ge}from"./index-qmmqHzY5.js";import{u as fe}from"./useApi-CFpppkIv.js";import{u as he,M as Ne}from"./MenuItem-CyVMp_O5.js";import{A as Ae,C as qe}from"./confirmationModal-35_TUgti.js";import{t as Ce}from"./modal-Bx1kEpp4.js";import{j as ve,w as K,T as xe,$ as De,a0 as Se,a1 as Le,z as je}from"./TextField-Cs2SSotF.js";import{A as k}from"./Alert-BkFJQwic.js";const y=m=>/^[0-9a-fA-F]{24}$/.test(m),Be=({role:m,selectedUser:s})=>{const[H,p]=N.useState(""),{callApi:_}=fe(),[z,O]=N.useState(!1),[W,v]=N.useState(""),[J,f]=N.useState(!1),Q=he(),L=X(r=>{var t;return((t=r.adminData)==null?void 0:t.usersData)||{students:[],teachers:[],admins:[]}}),x=X(r=>{var t;return((t=r.adminData)==null?void 0:t.classLevels)||[]}),D=X(r=>{var t;return((t=r.adminData)==null?void 0:t.subjects)||[]});console.log(x),N.useEffect(()=>{console.log("Redux state - users:",L,"classLevels:",x,"subjects:",D)},[L,x,D]);const[j,o]=N.useState({sections:[],classNames:[],subclasses:[]}),[B,q]=N.useState([]);N.useEffect(()=>{q(D.map(r=>({value:r._id,label:r.name})))},[D]);const h=(r={},t="currentClassLevel")=>{var e,c,A,I,T,R;const b=[...new Set(x.map(P=>P.section))],C=P=>x.filter(M=>M.section===P).map(M=>M.name),d=(P,M)=>{var $;return(($=x.find(F=>F.section===P&&F.name===M))==null?void 0:$.subclasses.map(F=>F.letter))||[]},u=t==="currentClassLevel"?((e=r.currentClassLevel)==null?void 0:e.section)||b[0]||"":((A=(c=r.teachingAssignments)==null?void 0:c[0])==null?void 0:A.section)||b[0]||"",n=t==="currentClassLevel"?((I=r.currentClassLevel)==null?void 0:I.className)||C(u)[0]||"":((R=(T=r.teachingAssignments)==null?void 0:T[0])==null?void 0:R.className)||C(u)[0]||"";return{sections:b,classNames:C(u),subclasses:d(u,n)}};N.useEffect(()=>{console.log("selectedUser:",s),s&&!y(s)&&(console.warn("Invalid selectedUser ID format:",s),p("Invalid user ID format"))},[s]);const[a,E]=N.useState({}),[G,U]=N.useState(null),ee=N.useRef(null),ae=r=>{var b,C,d,u;const t={};if(!V[r])return console.error("Invalid role:",r),t;if(V[r].forEach(n=>{if(n.name.includes("currentClassLevel")||n.name.includes("guardians")||n.name.includes("bankAccountDetails")||n.name.includes("teachingAssignments")){const[e,c,A]=n.name.split(/\.|\[|\]/).filter(Boolean);e==="guardians"||e==="teachingAssignments"?(t[e]=t[e]||[{}],t[e][0][c]=""):(t[e]=t[e]||{},t[e][c]="")}else t[n.name]=(n.type==="select","")}),r==="student"){const{sections:n,classNames:e,subclasses:c}=h(t,"currentClassLevel");t.currentClassLevel={section:n[0]||"",className:e[0]||"",subclass:c[0]||""},t.boardingStatus="Day Student"}else if(r==="teacher"){const{sections:n,classNames:e,subclasses:c}=h(t,"teachingAssignments");t.teachingAssignments=[{section:n[0]||"",className:e[0]||"",subclasses:[c[0]],subject:((b=D[0])==null?void 0:b._id)||""}]}if(s&&L&&y(s)){const n=r==="student"?(C=L.students)==null?void 0:C.find(e=>e._id===s):r==="teacher"?(d=L.teachers)==null?void 0:d.find(e=>e._id===s):(u=L.admins)==null?void 0:u.find(e=>e._id===s);n&&Object.keys(t).forEach(e=>{var c,A,I;e==="currentClassLevel"&&n[e]?t[e]={section:n[e].section||t.currentClassLevel.section,className:n[e].className||t.currentClassLevel.className,subclass:n[e].subclass||t.currentClassLevel.subclass}:e==="boardingDetails"&&n[e]?t[e]={hall:n[e].hall||"",roomNumber:n[e].roomNumber||"",bedNumber:n[e].bedNumber||"",houseMaster:n[e].houseMaster||""}:e==="guardians"&&((c=n[e])!=null&&c.length)?t[e]=[{name:n[e][0].name||"",relationship:n[e][0].relationship||"",phone:n[e][0].phone||"",email:n[e][0].email||"",address:n[e][0].address||""}]:e==="bankAccountDetails"&&n[e]?t[e]={accountName:n[e].accountName||"",accountNumber:n[e].accountNumber||"",bank:n[e].bank||""}:e==="teachingAssignments"&&((A=n[e])!=null&&A.length)?t[e]=[{section:n[e][0].section||t.teachingAssignments[0].section,className:n[e][0].className||t.teachingAssignments[0].className,subclasses:n[e][0].subclasses||t.teachingAssignments[0].subclasses,subject:((I=n[e][0].subject)==null?void 0:I._id)||t.teachingAssignments[0].subject}]:t[e]=n[e]||t[e]})}return t};N.useEffect(()=>{const r=ae(m);E(r),o(m==="student"?h(r,"currentClassLevel"):h(r,"teachingAssignments"))},[m,s,x,D]),N.useEffect(()=>{a&&o(m==="student"?h(a,"currentClassLevel"):h(a,"teachingAssignments"))},[a]);const V={student:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!s,options:j.sections},{label:"Class Name",name:"currentClassLevel.className",type:"select",required:!s,options:j.classNames},{label:"Subclass",name:"currentClassLevel.subclass",type:"select",required:!s,options:j.subclasses},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!s,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!s},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!s},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!s},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!s},{label:"Address",name:"address",type:"text",required:!s},{label:"Qualification",name:"qualification",type:"select",required:!s,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!s},{label:"Tribe",name:"tribe",type:"text",required:!s},{label:"Religion",name:"religion",type:"select",required:!s,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!s,options:j.sections},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"select",required:!s,options:j.classNames},{label:"Teaching Subclasses",name:"teachingAssignments[0].subclasses",type:"select",required:!s,options:j.subclasses},{label:"Subject",name:"teachingAssignments[0].subject",type:"select",required:!s,options:B.map(r=>r.label)},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!s},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!s},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!s},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s}].filter(Boolean)};return{formRef:ee,formData:a,error:H,loading:J,handleChange:r=>{const{name:t,value:b,files:C}=r.target;if(t==="profilePicture")U(C[0]);else if(t.includes("currentClassLevel")){const[,d]=t.split(".");E(u=>{const n={...u.currentClassLevel,[d]:b};if(d==="section"){const{classNames:e,subclasses:c}=h({currentClassLevel:n},"currentClassLevel");n.className=e[0]||"",n.subclass=c[0]||""}else if(d==="className"){const{subclasses:e}=h({currentClassLevel:n},"currentClassLevel");n.subclass=e[0]||""}return{...u,currentClassLevel:n}})}else if(t.includes("teachingAssignments")){const[,d,u]=t.split(/\.|\[|\]/).filter(Boolean);E(n=>{const e=[...n.teachingAssignments||[{}]];if(u==="subclasses")e[0]={...e[0],[u]:[b]};else if(u==="subject"){const c=B.find(A=>A.label===b);e[0]={...e[0],[u]:(c==null?void 0:c.value)||""}}else e[0]={...e[0],[u]:b};if(u==="section"){const{classNames:c,subclasses:A}=h({teachingAssignments:[{...e[0],section:b}]},"teachingAssignments");e[0].className=c[0]||"",e[0].subclasses=[A[0]]}else if(u==="className"){const{subclasses:c}=h({teachingAssignments:[{...e[0],className:b}]},"teachingAssignments");e[0].subclasses=[c[0]]}return{...n,teachingAssignments:e}})}else if(t.includes("boardingDetails")){const[,d]=t.split(".");E(u=>({...u,boardingDetails:{...u.boardingDetails,[d]:b}}))}else if(t.includes("guardians")||t.includes("bankAccountDetails")){const[d,u]=t.split(".");E(n=>({...n,[d]:{...n[d],[u]:b}}))}else E(t==="boardingStatus"?d=>({...d,boardingStatus:b,boardingDetails:b==="Boarder"?d.boardingDetails||{}:void 0}):d=>({...d,[t]:b}))},handleSubmit:async r=>{var t,b,C,d,u,n,e,c,A,I,T,R,P,M,$,F,se,te,ne,ie,re,le,ue,oe,ce,me;if(r.preventDefault(),f(!0),p(""),s&&!y(s)){p("Invalid user ID format"),f(!1);return}if(s&&ee.current.querySelectorAll("[required]").forEach(l=>{l.removeAttribute("required")}),!s){if(!a.firstName||!a.lastName||!a.email||!a.gender){p("First name, last name, email, and gender are required"),f(!1);return}if(m==="student"){if(!((t=a.currentClassLevel)!=null&&t.section)||!((b=a.currentClassLevel)!=null&&b.className)||!((C=a.currentClassLevel)!=null&&C.subclass)){p("Class level section, class name, and subclass are required"),f(!1);return}if(!((u=(d=a.guardians)==null?void 0:d[0])!=null&&u.name)||!((e=(n=a.guardians)==null?void 0:n[0])!=null&&e.relationship)||!((A=(c=a.guardians)==null?void 0:c[0])!=null&&A.phone)){p("Guardian name, relationship, and phone are required"),f(!1);return}if(!["Boarder","Day Student"].includes(a.boardingStatus)){p("Boarding status must be 'Boarder' or 'Day Student'"),f(!1);return}if(a.boardingStatus==="Boarder"&&(!((I=a.boardingDetails)!=null&&I.hall)||!((T=a.boardingDetails)!=null&&T.roomNumber))){p("Boarding Hall and Room Number are required for Boarder students"),f(!1);return}}else if(m==="teacher"){if(!a.NIN||!a.address||!a.qualification||!a.phoneNumber||!a.tribe||!a.religion||!((P=(R=a.teachingAssignments)==null?void 0:R[0])!=null&&P.subject)||!((M=a.bankAccountDetails)!=null&&M.accountName)||!(($=a.bankAccountDetails)!=null&&$.accountNumber)||!((F=a.bankAccountDetails)!=null&&F.bank)||!((te=(se=a.teachingAssignments)==null?void 0:se[0])!=null&&te.section)||!((ie=(ne=a.teachingAssignments)==null?void 0:ne[0])!=null&&ie.className)||!((ue=(le=(re=a.teachingAssignments)==null?void 0:re[0])==null?void 0:le.subclasses)!=null&&ue.length)){p("All required teacher fields must be filled"),f(!1);return}if(!/^\d{11}$/.test(a.NIN)){p("NIN must be 11 digits"),f(!1);return}if(!/^\d{10}$/.test(a.bankAccountDetails.accountNumber)){p("Bank account number must be 10 digits"),f(!1);return}if(!a.teachingAssignments[0].subclasses.every(l=>/^[A-Z]$/.test(l))){p("Subclasses must be single uppercase letters"),f(!1);return}if(!y(a.teachingAssignments[0].subject)){p("Invalid subject ID"),f(!1);return}}if(!G){p("Profile picture is required"),f(!1);return}}try{const l=new FormData;Object.keys(a).forEach(i=>{var w,de;i==="currentClassLevel"&&a[i]?(l.append("currentClassLevel[section]",a[i].section||""),l.append("currentClassLevel[className]",a[i].className||""),l.append("currentClassLevel[subclass]",a[i].subclass||"")):i==="boardingDetails"&&a[i]&&a.boardingStatus==="Boarder"?(l.append("boardingDetails[hall]",a[i].hall||""),l.append("boardingDetails[roomNumber]",a[i].roomNumber||""),l.append("boardingDetails[bedNumber]",a[i].bedNumber||""),l.append("boardingDetails[houseMaster]",a[i].houseMaster||"")):i==="guardians"&&((w=a[i])!=null&&w.length)?(l.append("guardians[0][name]",a[i][0].name||""),l.append("guardians[0][relationship]",a[i][0].relationship||""),l.append("guardians[0][phone]",a[i][0].phone||""),l.append("guardians[0][email]",a[i][0].email||""),l.append("guardians[0][address]",a[i][0].address||"")):i==="bankAccountDetails"&&a[i]?(l.append("bankAccountDetails[accountName]",a[i].accountName||""),l.append("bankAccountDetails[accountNumber]",a[i].accountNumber||""),l.append("bankAccountDetails[bank]",a[i].bank||"")):i==="teachingAssignments"&&((de=a[i])!=null&&de.length)&&a[i][0].section?(l.append("teachingAssignments[0][section]",a[i][0].section||""),l.append("teachingAssignments[0][className]",a[i][0].className||""),l.append("teachingAssignments[0][subclasses]",JSON.stringify(a[i][0].subclasses||[])),l.append("subject",a[i][0].subject||"")):(!s||a[i]&&a[i]!==""&&i!=="boardingDetails")&&l.append(i,a[i])}),G&&l.append("profilePicture",G);for(let[i,w]of l.entries())console.log(`${i}: ${w}`);let Z;s&&y(s)?Z=m==="student"?`/api/students/${s}/update/admin`:`/api/teachers/teacher/${s}/update`:Z=m==="student"?Y.CREATE_STUDENT:m==="teacher"?Y.CREATE_TEACHER:Y.CREATE_ADMIN;const S=await _(Z,s?"PATCH":"POST",l,{"Content-Type":"multipart/form-data"});S&&S.data?(Q(s?be({id:s,user:S.data,role:m}):pe({user:S.data,role:m})),v(`${S.data.firstName} ${S.data.lastName} has been successfully ${s?"updated":"registered"}`),E(ae(m)),U(null)):v(((oe=S==null?void 0:S.data)==null?void 0:oe.message)||"An error occurred"),O(!0)}catch(l){console.error("Error submitting form:",l),p(((me=(ce=l.response)==null?void 0:ce.data)==null?void 0:me.message)||"Failed to submit the form. Please try again.")}finally{f(!1)}},roleFields:V,profilePicture:G,modalOpen:z,modalMessage:W,setModalOpen:O}},ye=({role:m,selectedUser:s})=>{const H=ve();Ce(H.palette.mode);const{roleFields:p,error:_,loading:z,handleChange:O,handleSubmit:W,formData:v,formRef:J,modalOpen:f,modalMessage:Q,setModalOpen:L}=Be({role:m,selectedUser:s});console.log("SignUpForm - role:",m,"selectedUser:",s,"formData:",v);const x=()=>{L(!1)};if(z)return g.jsx(ge,{});if(!v||Object.keys(v).length===0)return g.jsx(k,{severity:"error",children:"Form data is not initialized. Please try again or check Redux configuration."});const D=o=>{if(!v)return"";if(o.includes(".")){const B=o.split(/\.|\[|\]/).filter(Boolean);let q=v;for(const h of B)if(Array.isArray(q)&&h.match(/^\d+$/)?q=q[parseInt(h)]:q=q==null?void 0:q[h],q===void 0)return"";return q}return v[o]||""};if(!p[m])return g.jsx(k,{severity:"error",children:"Invalid role specified"});const j=p[m].filter(o=>m==="student"&&o.name.includes("boardingDetails")?v.boardingStatus==="Boarder":!0);return g.jsxs(K,{children:[g.jsxs(xe,{variant:"h4",children:[s?"Update":"Sign Up"," (",m.charAt(0).toUpperCase()+m.slice(1),")"]}),g.jsxs("form",{onSubmit:W,ref:J,children:[j.map(o=>g.jsx(K,{mb:2,children:o.type==="select"?g.jsxs(De,{fullWidth:!0,children:[g.jsx(Se,{children:o.label}),g.jsx(Le,{name:o.name,value:D(o.name),onChange:O,required:o.required,children:o.options.map(B=>g.jsx(Ne,{value:B,children:B},B))})]}):o.type==="file"?g.jsx(K,{mb:2,children:g.jsx("input",{type:"file",name:o.name,id:o.name,onChange:O,required:o.required,accept:"image/*",style:{display:"block",width:"100%"}})}):g.jsx(je,{label:o.label,name:o.name,type:o.type,value:D(o.name),onChange:O,required:o.required,fullWidth:!0})},o.name)),_&&g.jsx(k,{severity:"error",children:_}),g.jsx(Ae,{content:s?"Update":"Sign Up",submit:!0})]}),g.jsx(qe,{open:f,message:Q,title:"User Registration Confirmation",onClose:x})]})};export{ye as S};
