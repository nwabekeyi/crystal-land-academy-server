import{r,e as y,j as e,a as Ue,i as Le}from"./index-CmongNqj.js";import{t as Ne,M as je}from"./modal-DOkj5b5S.js";import{H as Be}from"./Header-C-IOg9fy.js";import{T as qe}from"./table-POZbbwRY.js";import{u as Z}from"./useApi-DRHDw2QR.js";import{C as ie}from"./customIconButton-BhwbxGgW.js";import{m as De,j as Ge,l as _e,n as Ae}from"./index-CYDaGODW.js";import{w as Re}from"./dasboardPagesContainer-Dlct0AZS.js";import{A as Oe}from"./confirmationModal-DmU1e-AI.js";import{j as We,v as P,a1 as oe,a2 as de,a3 as ue,T,y as D,x as Ee}from"./TextField-BRCl01nD.js";import{M as Y}from"./MenuItem-CBa9F7RL.js";import"./IconButton-BxixnWx-.js";import"./index-DlEtA_4g.js";import"./index-Cdxudna_.js";import"./loadingButton-Cu9NSFum.js";import"./CircularProgress-CJ7ctfkv.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-Ctrqk4ly.js";import"./useMediaQuery-GijD3KK4.js";const He=({userId:F})=>{var xe,pe;const[M,G]=r.useState(!1),[p,z]=r.useState("create"),[R,L]=r.useState(null),[d,C]=r.useState({name:"",description:"",academicYear:"",classLevelSubclasses:[]}),[O,$]=r.useState(""),[ee,I]=r.useState(!1),[j,U]=r.useState(null),[S,B]=r.useState(""),[m,k]=r.useState(""),[f,se]=r.useState(""),[h,q]=r.useState(0),[x,W]=r.useState(5),[K,N]=r.useState(0),{data:i,loading:ae,error:H,callApi:A}=Z(),{data:u,loading:a,error:o,callApi:n}=Z(),{data:b,loading:v,error:w,callApi:me}=Z(),{data:le,loading:Te,error:ke,callApi:be}=Z(),{callApi:J,loading:we,error:V}=Z();r.useEffect(()=>{var s,t;if(((s=u==null?void 0:u.data)==null?void 0:s.length)>0&&!S){const l=((t=u.data.find(c=>c.isCurrent))==null?void 0:t._id)||u.data[0]._id;B(l)}},[u,S]),r.useEffect(()=>{if(S){const s=new URLSearchParams({page:h+1,limit:x,academicYear:S,...m&&{classLevel:m},...f&&{subclassLetter:f}}).toString();A(`${y.SUBJECT}?${s}`,"GET")}n(y.ACADEMIC_YEARS,"GET"),me(y.CLASS_LEVEL,"GET")},[A,n,me,h,x,S,m,f]),r.useEffect(()=>{M&&(p==="create"||p==="edit")&&be(y.TEACHERS,"GET")},[M,p,be]),r.useEffect(()=>{var s,t;(s=i==null?void 0:i.data)!=null&&s.totalPages?(N(i.data.totalPages),h>=i.data.totalPages&&q(0)):(t=i==null?void 0:i.data)!=null&&t.length&&N(1)},[i,h]),r.useEffect(()=>{var s,t;if(((s=u==null?void 0:u.data)==null?void 0:s.length)>0&&!d.academicYear&&p==="create"){const l=((t=u.data.find(c=>c.isCurrent))==null?void 0:t._id)||u.data[0]._id;C(c=>({...c,academicYear:l}))}},[u,d.academicYear,p]);const te=((xe=i==null?void 0:i.data)==null?void 0:xe.data)||(i==null?void 0:i.data)||[],Q=(u==null?void 0:u.data)||[],re=((pe=b==null?void 0:b.data)==null?void 0:pe.data)||(b==null?void 0:b.data)||[],ne=(le==null?void 0:le.data)||[],X=r.useCallback((s,t=null)=>{var l,c,g,E;z(s),L(t),s==="create"?C({name:"",description:"",academicYear:((l=Q.find(_=>_.isCurrent))==null?void 0:l._id)||((c=Q[0])==null?void 0:c._id)||"",classLevelSubclasses:[]}):t&&C({name:t.name||"",description:t.description||"",academicYear:((g=t.academicYear)==null?void 0:g._id)||t.academicYear||"",classLevelSubclasses:((E=t.classLevelSubclasses)==null?void 0:E.map(_=>{var Ce,Se;return{classLevel:((Ce=_.classLevel)==null?void 0:Ce._id)||_.classLevel,subclassLetter:_.subclassLetter||"",teachers:((Se=_.teachers)==null?void 0:Se.map(ge=>ge._id||ge))||[]}}))||[]}),G(!0)},[Q]),he=r.useCallback(s=>{U(s),I(!0)},[]),ce=r.useCallback(()=>{U(null),I(!1)},[]),Pe=r.useCallback(async()=>{if(!j||!F){$("User not authenticated or no subject selected for deletion");return}try{await J(`${y.SUBJECT}/${j._id}`,"DELETE");const s=new URLSearchParams({page:h+1,limit:x,academicYear:S,...m&&{classLevel:m},...f&&{subclassLetter:f}}).toString();await A(`${y.SUBJECT}?${s}`,"GET"),$(""),ce()}catch(s){$(s.statusCode===404?"Subject not found":s.statusCode===409?"Subject cannot be deleted due to dependencies":V||s.message||"Failed to delete subject")}},[j,F,J,A,V,ce,h,x,S,m,f]),Ye=r.useCallback(s=>{const{name:t,value:l}=s.target;C(c=>({...c,[t]:l}))},[]),Me=r.useCallback((s,t,l)=>{C(c=>{const g=[...c.classLevelSubclasses];return g[s]={...g[s],[t]:l},t==="classLevel"?(g[s].subclassLetter="",g[s].teachers=[]):t==="subclassLetter"&&(g[s].teachers=[]),{...c,classLevelSubclasses:g}})},[]),ye=r.useCallback(()=>{C(s=>({...s,classLevelSubclasses:[...s.classLevelSubclasses,{classLevel:"",subclassLetter:"",teachers:[]}]}))},[]),Fe=r.useCallback(s=>{C(t=>({...t,classLevelSubclasses:t.classLevelSubclasses.filter((l,c)=>c!==s)}))},[]),fe=r.useCallback(()=>{var s,t;if(!F)return"User not authenticated. Please log in.";if(!d.name)return"Subject name is required";if(!d.academicYear)return"Academic year is required";if(d.classLevelSubclasses.length===0)return"At least one class level and subclass is required";for(const l of d.classLevelSubclasses){if(!l.classLevel)return"Class level is required for all entries";if(!l.subclassLetter)return"Subclass is required for all entries";if(!/^[A-Z]$/.test(l.subclassLetter))return`Subclass ${l.subclassLetter} must be a single capital letter (A-Z)`;const c=re.find(E=>E._id===l.classLevel);if(!c)return`Class level ID ${l.classLevel} does not exist`;if(!((s=c.subclasses)==null?void 0:s.some(E=>E.letter===l.subclassLetter)))return`Subclass ${l.subclassLetter} does not exist in class level ${c.name}`;if(((t=l.teachers)==null?void 0:t.length)>0){for(const E of l.teachers)if(!ne.find(_=>_._id===E))return`Invalid teacher ID: ${E} for class level ${c.name}`}}return""},[d,re,ne,F]),$e=r.useCallback(async()=>{const s=fe();if(s){$(s);return}const t={name:d.name,description:d.description,academicYear:d.academicYear,classLevelSubclasses:d.classLevelSubclasses.map(l=>({classLevel:l.classLevel,subclassLetter:l.subclassLetter,teachers:l.teachers||[]})),createdBy:F};try{p==="create"?await J(y.SUBJECT,"POST",t):p==="edit"&&await J(`${y.SUBJECT}/${R._id}`,"PATCH",t);const l=new URLSearchParams({page:h+1,limit:x,academicYear:S,...m&&{classLevel:m},...f&&{subclassLetter:f}}).toString();await A(`${y.SUBJECT}?${l}`,"GET"),G(!1),$("")}catch(l){$(l.statusCode===409?"Subject already exists for this Academic Year":l.statusCode===400?l.message||"Invalid data provided":V||l.message||"Failed to process request")}},[p,d,R,J,A,V,fe,F,h,x,S,m,f]),ve=r.useMemo(()=>Array.isArray(te)?te.map((s,t)=>{var l,c;return{...s,sn:t+1+h*x,displayName:s.name,classLevelSubclassesCount:((l=s.classLevelSubclasses)==null?void 0:l.length)||0,teacherCount:((c=s.classLevelSubclasses)==null?void 0:c.reduce((g,E)=>{var _;return g+(((_=E.teachers)==null?void 0:_.length)||0)},0))||0}}):[],[te,h,x]);return{tableProps:{columns:r.useMemo(()=>[{id:"sn",label:"S/N",width:90},{id:"displayName",label:"Subject Name",flex:1,renderCell:s=>s.displayName},{id:"description",label:"Description",flex:1},{id:"classLevelSubclassesCount",label:"Classes Assigned",flex:1,renderCell:s=>s.classLevelSubclassesCount},{id:"teacherCount",label:"Teachers Assigned",flex:1,renderCell:s=>s.teacherCount},{id:"actions",label:"Actions",flex:1,renderCell:s=>e.jsxs(e.Fragment,{children:[e.jsx(ie,{icon:e.jsx(De,{}),title:"View Subject",onClick:()=>X("view",s),sx:{mx:.5}}),e.jsx(ie,{icon:e.jsx(Ge,{}),title:"Edit Subject",onClick:()=>X("edit",s),sx:{mx:.5}}),e.jsx(ie,{icon:e.jsx(_e,{}),title:"Delete Subject",onClick:()=>he(s),sx:{mx:.5}})]})}],[X,he]),tableHeader:"Subject Management",data:ve,sortBy:"name",sortDirection:"asc",onSortChange:()=>{},hiddenColumnsSmallScreen:["description"],hiddenColumnsTabScreen:[],page:h,rowsPerPage:x,count:K*x||ve.length,onPageChange:(s,t)=>q(t),onRowsPerPageChange:s=>{W(parseInt(s.target.value,10)),q(0)}},modalOpen:M,setModalOpen:G,modalMode:p,setModalMode:z,formData:d,setFormData:C,handleFormChange:Ye,handleClassLevelChange:Me,addClassLevel:ye,removeClassLevel:Fe,handleSubmit:$e,error:H||o||w||ke||V||O,loading:ae||a||v||Te||we,openModal:X,academicYears:Q,classLevels:re,teachers:ne,selectedSubject:R,deleteConfirmOpen:ee,subjectToDelete:j,handleDelete:Pe,closeDeleteConfirm:ce,academicYearFilter:S,setAcademicYearFilter:B,classLevelFilter:m,setClassLevelFilter:k,subclassLetterFilter:f,setSubclassLetterFilter:se,page:h,setPage:q,rowsPerPage:x,setRowsPerPage:W,totalPages:K}},Je=()=>{var u;const F=We(),M=Ne(F.palette.mode),G=Ue(a=>{var o;return(o=a.users.user)==null?void 0:o._id})||"",{tableProps:p,modalOpen:z,setModalOpen:R,modalMode:L,formData:d,handleFormChange:C,handleClassLevelChange:O,addClassLevel:$,removeClassLevel:ee,handleSubmit:I,error:j,loading:U,openModal:S,academicYears:B,classLevels:m,teachers:k,selectedSubject:f,deleteConfirmOpen:se,subjectToDelete:h,handleDelete:q,closeDeleteConfirm:x,academicYearFilter:W,setAcademicYearFilter:K,classLevelFilter:N,setClassLevelFilter:i,subclassLetterFilter:ae,setSubclassLetterFilter:H}=He({userId:G});r.useEffect(()=>{i(""),H("")},[W,i,H]);const A=a=>{var n;const o=m.find(b=>b._id===a);return((n=o==null?void 0:o.subclasses)==null?void 0:n.map(b=>b.letter))||[]};return e.jsxs(P,{children:[e.jsx(Be,{title:"Subject Management",subtitle:"Manage subjects and their details"}),e.jsxs(P,{sx:{mt:3,mb:3},children:[e.jsxs(P,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(Oe,{icon:e.jsx(Ae,{}),content:"Add Subject",onClick:()=>S("create"),sx:{mb:2}}),e.jsxs(oe,{sx:{minWidth:200},disabled:U||B.length===0,children:[e.jsx(de,{children:"Academic Year"}),e.jsx(ue,{value:W,onChange:a=>K(a.target.value),label:"Academic Year",children:B.map(a=>e.jsx(Y,{value:a._id,children:a.name||"Unknown Year"},a._id))})]}),e.jsxs(oe,{sx:{minWidth:200},disabled:U||m.length===0,children:[e.jsx(de,{children:"Class Level"}),e.jsxs(ue,{value:N,onChange:a=>i(a.target.value),label:"Class Level",children:[e.jsx(Y,{value:"",children:"All Class Levels"}),m.map(a=>e.jsx(Y,{value:a._id,children:a.name||"Unknown Class"},a._id))]})]}),e.jsxs(oe,{sx:{minWidth:120},disabled:!N||A(N).length===0,children:[e.jsx(de,{children:"Subclass"}),e.jsxs(ue,{value:ae,onChange:a=>H(a.target.value),label:"Subclass",children:[e.jsx(Y,{value:"",children:"All Subclasses"}),A(N).map(a=>e.jsx(Y,{value:a,children:a},a))]})]})]}),U?e.jsx(Le,{}):j?e.jsx(T,{color:"error",children:j}):p.data.length===0?e.jsx(T,{children:"No subjects available"}):e.jsx(P,{height:"75vh",sx:{"& .MuiDataGrid-root":{border:"none"},"& .MuiDataGrid-cell":{borderBottom:"none"},"& .MuiDataGrid-columnHeaders":{backgroundColor:M.blueAccent[700],borderBottom:"none"},"& .MuiDataGrid-virtualScroller":{backgroundColor:M.primary[400]},"& .MuiDataGrid-footerContainer":{borderTop:"none",backgroundColor:M.blueAccent[700]},"& .MuiCheckbox-root":{color:`${M.blueAccent[200]} !important`}},children:e.jsx(qe,{...p,tableHeader:"Subjects"})})]}),e.jsx(je,{open:z,onClose:()=>R(!1),title:L==="create"?"Create Subject":L==="edit"?"Edit Subject":"View Subject",onConfirm:L!=="view"?I:null,confirmMessage:L==="create"?"Create":"Save",styleProps:{padding:"20px"},children:e.jsxs(P,{sx:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsx(D,{label:"Subject Name",name:"name",value:d.name||"",onChange:C,required:!0,fullWidth:!0,disabled:L==="view"}),e.jsx(D,{label:"Description",name:"description",value:d.description||"",onChange:C,multiline:!0,rows:4,fullWidth:!0,disabled:L==="view"}),e.jsx(D,{select:!0,label:"Academic Year",name:"academicYear",value:d.academicYear||"",onChange:C,required:!0,fullWidth:!0,disabled:L==="view",children:B.map(a=>e.jsx(Y,{value:a._id,children:a.name||"Unknown Year"},a._id))}),L!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx(P,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(Ee,{variant:"contained",onClick:$,startIcon:e.jsx(Ae,{}),sx:{backgroundColor:M.blueAccent[700]},children:"Add Class Level and Subclass"})}),d.classLevelSubclasses.map((a,o)=>e.jsxs(P,{sx:{display:"flex",gap:"16px",alignItems:"center",mb:2,flexWrap:"wrap"},children:[e.jsx(D,{select:!0,label:`Class Level ${o+1}`,value:a.classLevel||"",onChange:n=>O(o,"classLevel",n.target.value),required:!0,sx:{flex:1},disabled:m.length===0,children:m.map(n=>e.jsx(Y,{value:n._id,children:n.name||"Unknown Class"},n._id))}),e.jsx(D,{select:!0,label:`Subclass ${o+1}`,value:a.subclassLetter||"",onChange:n=>O(o,"subclassLetter",n.target.value),required:!0,sx:{flex:1},disabled:!a.classLevel||A(a.classLevel).length===0,children:A(a.classLevel).map(n=>e.jsx(Y,{value:n,children:n},n))}),e.jsx(D,{select:!0,label:`Teachers for Class Level ${o+1}`,value:a.teachers||[],onChange:n=>O(o,"teachers",n.target.value),SelectProps:{multiple:!0,renderValue:n=>n.length>0?n.map(b=>k.find(v=>v._id===b)?`${k.find(v=>v._id===b).firstName} ${k.find(v=>v._id===b).lastName}`:"Unknown").join(", "):"Select teachers"},sx:{flex:1},disabled:!a.classLevel||!a.subclassLetter,children:k.length>0?k.map(n=>e.jsx(Y,{value:n._id,children:`${n.firstName} ${n.lastName}`},n._id)):e.jsx(Y,{disabled:!0,children:"No teachers available"})}),e.jsx(Ee,{variant:"contained",color:"error",onClick:()=>ee(o),startIcon:e.jsx(_e,{}),children:"Remove"})]},o))]}),L==="view"&&e.jsxs(P,{sx:{mt:2},children:[e.jsx(T,{variant:"h6",children:"Assigned Class Levels and Subclasses"}),((u=f==null?void 0:f.classLevelSubclasses)==null?void 0:u.length)>0?f.classLevelSubclasses.map((a,o)=>{var n,b;return e.jsxs(P,{sx:{mb:2},children:[e.jsxs(T,{variant:"subtitle1",children:[((n=m.find(v=>{var w;return v._id===(((w=a.classLevel)==null?void 0:w._id)||a.classLevel)}))==null?void 0:n.name)||"Unknown Class Level"," ","- Subclass ",a.subclassLetter]}),e.jsx(T,{variant:"subtitle2",children:"Teachers:"}),((b=a.teachers)==null?void 0:b.length)>0?a.teachers.map(v=>e.jsxs(T,{sx:{ml:2},children:["-"," ",k.find(w=>w._id===v)?`${k.find(w=>w._id===v).firstName} ${k.find(w=>w._id===v).lastName}`:"Unknown Teacher"]},v)):e.jsx(T,{sx:{ml:2},children:"No teachers assigned"})]},o)}):e.jsx(T,{children:"No class levels or subclasses assigned"})]}),j&&e.jsx(T,{color:"error",children:j})]})}),e.jsx(je,{open:se,onClose:x,title:"Delete Subject",onConfirm:q,confirmMessage:"Delete",styleProps:{padding:"20px"},children:e.jsxs(P,{children:[e.jsxs(T,{children:['Are you sure you want to delete the subject "',(h==null?void 0:h.name)||"Unknown",'"? This action cannot be undone.']}),U&&e.jsx(Le,{}),j&&e.jsx(T,{color:"error",children:j})]})})]})},hs=Re(Je);export{hs as default};
