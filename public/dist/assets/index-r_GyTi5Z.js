import{r as A,a as ue,e as J,N as oe,O as ce,j as g,q as me}from"./index-BKlc4Mb3.js";import{u as de}from"./useApi-CmAUaqmj.js";import{u as be,M as pe}from"./MenuItem-BNprT_Ft.js";import{A as ge,C as fe}from"./confirmationModal-28gerj7s.js";import{t as he}from"./modal-B5Du0kGU.js";import{j as Ne,w as X,T as Ae,$ as qe,a0 as Ce,a1 as xe,z as Se}from"./TextField-BiP_6l0O.js";import{A as Y}from"./Alert-CZfW9qGA.js";const y=m=>/^[0-9a-fA-F]{24}$/.test(m),ve=({role:m,selectedUser:s})=>{const[G,p]=A.useState(""),{callApi:I}=de(),[w,P]=A.useState(!1),[H,q]=A.useState(""),[_,f]=A.useState(!1),[z,W]=A.useState([]),Q=be(),x=ue(u=>{var n;return((n=u.adminData)==null?void 0:n.usersData)||{students:[],teachers:[],admins:[]}}),v=ue(u=>{var n;return((n=u.adminData)==null?void 0:n.classLevels)||[]});A.useEffect(()=>{console.log("Redux state - users:",x,"classLevels:",v)},[x,v]);const[r,D]=A.useState({sections:[],classNames:[],subclasses:[]}),b=(u={},n="currentClassLevel")=>{var l,h,C,F,M,T;const c=[...new Set(v.map(j=>j.section))],N=j=>v.filter(B=>B.section===j).map(B=>B.name),d=(j,B)=>{var O;return((O=v.find(E=>E.section===j&&E.name===B))==null?void 0:O.subclasses.map(E=>E.letter))||[]},t=n==="currentClassLevel"?((l=u.currentClassLevel)==null?void 0:l.section)||c[0]||"":((C=(h=u.teachingAssignments)==null?void 0:h[0])==null?void 0:C.section)||c[0]||"",e=n==="currentClassLevel"?((F=u.currentClassLevel)==null?void 0:F.className)||N(t)[0]||"":((T=(M=u.teachingAssignments)==null?void 0:M[0])==null?void 0:T.className)||N(t)[0]||"";return{sections:c,classNames:N(t),subclasses:d(t,e)}};A.useEffect(()=>{console.log("selectedUser:",s),s&&!y(s)&&(console.warn("Invalid selectedUser ID format:",s),p("Invalid user ID format"))},[s]),A.useEffect(()=>{(async()=>{var n;try{const c=await I("/api/subjects","GET");W(((n=c.data)==null?void 0:n.map(N=>({id:N._id,name:N.data.name})))||[])}catch(c){console.error("Error fetching subjects:",c),p("Failed to load subjects")}})()},[I]);const[a,L]=A.useState({}),[R,K]=A.useState(null),k=A.useRef(null),U=u=>{var c,N,d;const n={};if(!V[u])return console.error("Invalid role:",u),n;if(V[u].forEach(t=>{if(t.name.includes("currentClassLevel")||t.name.includes("guardians")||t.name.includes("bankAccountDetails")||t.name.includes("teachingAssignments")){const[e,l,h]=t.name.split(/\.|\[|\]/).filter(Boolean);e==="guardians"||e==="teachingAssignments"?(n[e]=n[e]||[{}],n[e][0][l]=""):(n[e]=n[e]||{},n[e][l]="")}else n[t.name]=(t.type==="select","")}),u==="student"){const{sections:t,classNames:e,subclasses:l}=b(n,"currentClassLevel");n.currentClassLevel={section:t[0]||"",className:e[0]||"",subclass:l[0]||""},n.boardingStatus="Day Student"}else if(u==="teacher"){const{sections:t,classNames:e,subclasses:l}=b(n,"teachingAssignments");n.teachingAssignments=[{section:t[0]||"",className:e[0]||"",subclasses:l[0]||""}]}if(s&&x&&y(s)){const t=u==="student"?(c=x.students)==null?void 0:c.find(e=>e._id===s):u==="teacher"?(N=x.teachers)==null?void 0:N.find(e=>e._id===s):(d=x.admins)==null?void 0:d.find(e=>e._id===s);t&&Object.keys(n).forEach(e=>{var l,h,C;e==="currentClassLevel"&&t[e]?n[e]={section:t[e].section||n.currentClassLevel.section,className:t[e].className||n.currentClassLevel.className,subclass:t[e].subclass||n.currentClassLevel.subclass}:e==="boardingDetails"&&t[e]?n[e]={hall:t[e].hall||"",roomNumber:t[e].roomNumber||"",bedNumber:t[e].bedNumber||"",houseMaster:t[e].houseMaster||""}:e==="guardians"&&((l=t[e])!=null&&l.length)?n[e]=[{name:t[e][0].name||"",relationship:t[e][0].relationship||"",phone:t[e][0].phone||"",email:t[e][0].email||"",address:t[e][0].address||""}]:e==="bankAccountDetails"&&t[e]?n[e]={accountName:t[e].accountName||"",accountNumber:t[e].accountNumber||"",bank:t[e].bank||""}:e==="teachingAssignments"&&((h=t[e])!=null&&h.length)?n[e]=[{section:t[e][0].section||n.teachingAssignments[0].section,className:t[e][0].className||n.teachingAssignments[0].className,subclasses:((C=t[e][0].subclasses)==null?void 0:C.join(","))||n.teachingAssignments[0].subclasses}]:n[e]=t[e]||n[e]})}return n};A.useEffect(()=>{const u=U(m);L(u),D(m==="student"?b(u,"currentClassLevel"):b(u,"teachingAssignments"))},[m,s,v]),A.useEffect(()=>{a&&D(m==="student"?b(a,"currentClassLevel"):b(a,"teachingAssignments"))},[a]);const V={student:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!s,options:r.sections},{label:"Class Name",name:"currentClassLevel.className",type:"select",required:!s,options:r.classNames},{label:"Subclass",name:"currentClassLevel.subclass",type:"select",required:!s,options:r.subclasses},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!s,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!s},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!s},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!s},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!s},{label:"Address",name:"address",type:"text",required:!s},{label:"Qualification",name:"qualification",type:"select",required:!s,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!s},{label:"Tribe",name:"tribe",type:"text",required:!s},{label:"Religion",name:"religion",type:"select",required:!s,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Subject",name:"subject",type:"select",required:!s,options:z.map(u=>u.name)},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!s},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!s},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!s},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!s,options:r.sections},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"select",required:!s,options:r.classNames},{label:"Teaching Subclasses",name:"teachingAssignments[0].subclasses",type:"select",required:!s,options:r.subclasses},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s}].filter(Boolean)};return{formRef:k,formData:a,error:G,loading:_,handleChange:u=>{const{name:n,value:c,files:N}=u.target;if(n==="profilePicture")K(N[0]);else if(n.includes("currentClassLevel")){const[,d]=n.split(".");L(t=>{const e={...t.currentClassLevel,[d]:c};if(d==="section"){const{classNames:l,subclasses:h}=b({currentClassLevel:e},"currentClassLevel");e.className=l[0]||"",e.subclass=h[0]||""}else if(d==="className"){const{subclasses:l}=b({currentClassLevel:e},"currentClassLevel");e.subclass=l[0]||""}return{...t,currentClassLevel:e}})}else if(n.includes("teachingAssignments")){const[,d,t]=n.split(/\.|\[|\]/).filter(Boolean);L(e=>{const l=[...e.teachingAssignments||[{}]];if(l[0]={...l[0],[t]:c},t==="section"){const{classNames:h,subclasses:C}=b({teachingAssignments:[{...l[0],section:c}]},"teachingAssignments");l[0].className=h[0]||"",l[0].subclasses=C[0]||""}else if(t==="className"){const{subclasses:h}=b({teachingAssignments:[{...l[0],className:c}]},"teachingAssignments");l[0].subclasses=h[0]||""}return{...e,teachingAssignments:l}})}else if(n.includes("boardingDetails")){const[,d]=n.split(".");L(t=>({...t,boardingDetails:{...t.boardingDetails,[d]:c}}))}else if(n.includes("guardians")||n.includes("bankAccountDetails")){const[d,t]=n.split(".");L(e=>({...e,[d]:{...e[d],[t]:c}}))}else L(n==="boardingStatus"?d=>({...d,boardingStatus:c,boardingDetails:c==="Boarder"?d.boardingDetails||{}:void 0}):d=>({...d,[n]:c}))},handleSubmit:async u=>{var n,c,N,d,t,e,l,h,C,F,M,T,j,B,O,E,ee,ae,se,te,ne,ie,re;if(u.preventDefault(),f(!0),p(""),s&&!y(s)){p("Invalid user ID format"),f(!1);return}if(s&&k.current.querySelectorAll("[required]").forEach(o=>{o.removeAttribute("required")}),!s){if(!a.firstName||!a.lastName||!a.email||!a.gender){p("First name, last name, email, and gender are required"),f(!1);return}if(m==="student"){if(!((n=a.currentClassLevel)!=null&&n.section)||!((c=a.currentClassLevel)!=null&&c.className)||!((N=a.currentClassLevel)!=null&&N.subclass)){p("Class level section, class name, and subclass are required"),f(!1);return}if(!((t=(d=a.guardians)==null?void 0:d[0])!=null&&t.name)||!((l=(e=a.guardians)==null?void 0:e[0])!=null&&l.relationship)||!((C=(h=a.guardians)==null?void 0:h[0])!=null&&C.phone)){p("Guardian name, relationship, and phone are required"),f(!1);return}if(!["Boarder","Day Student"].includes(a.boardingStatus)){p("Boarding status must be 'Boarder' or 'Day Student'"),f(!1);return}if(a.boardingStatus==="Boarder"&&(!((F=a.boardingDetails)!=null&&F.hall)||!((M=a.boardingDetails)!=null&&M.roomNumber))){p("Boarding Hall and Room Number are required for Boarder students"),f(!1);return}}else if(m==="teacher"){if(!a.NIN||!a.address||!a.qualification||!a.phoneNumber||!a.tribe||!a.religion||!a.subject||!((T=a.bankAccountDetails)!=null&&T.accountName)||!((j=a.bankAccountDetails)!=null&&j.accountNumber)||!((B=a.bankAccountDetails)!=null&&B.bank)||!((E=(O=a.teachingAssignments)==null?void 0:O[0])!=null&&E.section)||!((ae=(ee=a.teachingAssignments)==null?void 0:ee[0])!=null&&ae.className)||!((te=(se=a.teachingAssignments)==null?void 0:se[0])!=null&&te.subclasses)){p("All required teacher fields must be filled"),f(!1);return}if(!/^\d{11}$/.test(a.NIN)){p("NIN must be 11 digits"),f(!1);return}if(!/^\d{10}$/.test(a.bankAccountDetails.accountNumber)){p("Bank account number must be 10 digits"),f(!1);return}if(!/^[A-Z]$/.test(a.teachingAssignments[0].subclasses)){p("Subclasses must be a single uppercase letter"),f(!1);return}}if(!R){p("Profile picture is required"),f(!1);return}}try{const o=new FormData;Object.keys(a).forEach(i=>{var $,le;i==="currentClassLevel"&&a[i]?(o.append("currentClassLevel[section]",a[i].section||""),o.append("currentClassLevel[className]",a[i].className||""),o.append("currentClassLevel[subclass]",a[i].subclass||"")):i==="boardingDetails"&&a[i]&&a.boardingStatus==="Boarder"?(o.append("boardingDetails[hall]",a[i].hall||""),o.append("boardingDetails[roomNumber]",a[i].roomNumber||""),o.append("boardingDetails[bedNumber]",a[i].bedNumber||""),o.append("boardingDetails[houseMaster]",a[i].houseMaster||"")):i==="guardians"&&(($=a[i])!=null&&$.length)?(o.append("guardians[0][name]",a[i][0].name||""),o.append("guardians[0][relationship]",a[i][0].relationship||""),o.append("guardians[0][phone]",a[i][0].phone||""),o.append("guardians[0][email]",a[i][0].email||""),o.append("guardians[0][address]",a[i][0].address||"")):i==="bankAccountDetails"&&a[i]?(o.append("bankAccountDetails[accountName]",a[i].accountName||""),o.append("bankAccountDetails[accountNumber]",a[i].accountNumber||""),o.append("bankAccountDetails[bank]",a[i].bank||"")):i==="teachingAssignments"&&((le=a[i])!=null&&le.length)&&a[i][0].section?(o.append("teachingAssignments[0][section]",a[i][0].section||""),o.append("teachingAssignments[0][className]",a[i][0].className||""),o.append("teachingAssignments[0][subclasses]",a[i][0].subclasses||"")):(!s||a[i]&&a[i]!==""&&i!=="boardingDetails")&&o.append(i,a[i])}),R&&o.append("profilePicture",R);for(let[i,$]of o.entries())console.log(`${i}: ${$}`);let Z;s&&y(s)?Z=m==="student"?`/api/students/${s}/update/admin`:`/api/teachers/teacher/${s}/update`:Z=m==="student"?J.CREATE_STUDENT:m==="teacher"?J.CREATE_TEACHER:J.CREATE_ADMIN;const S=await I(Z,s?"PATCH":"POST",o,{"Content-Type":"multipart/form-data"});S&&S.data?(Q(s?oe({id:s,user:S.data,role:m}):ce({user:S.data,role:m})),q(`${S.data.firstName} ${S.data.lastName} has been successfully ${s?"updated":"registered"}`),L(U(m)),K(null)):q(((ne=S==null?void 0:S.data)==null?void 0:ne.message)||"An error occurred"),P(!0)}catch(o){console.error("Error submitting form:",o),p(((re=(ie=o.response)==null?void 0:ie.data)==null?void 0:re.message)||"Failed to submit the form. Please try again.")}finally{f(!1)}},roleFields:V,profilePicture:R,modalOpen:w,modalMessage:H,setModalOpen:P}},Te=({role:m,selectedUser:s})=>{const G=Ne();he(G.palette.mode);const{roleFields:p,error:I,loading:w,handleChange:P,handleSubmit:H,formData:q,formRef:_,modalOpen:f,modalMessage:z,setModalOpen:W}=ve({role:m,selectedUser:s});console.log("SignUpForm - role:",m,"selectedUser:",s,"formData:",q);const Q=()=>{W(!1)};if(w)return g.jsx(me,{});if(!q||Object.keys(q).length===0)return g.jsx(Y,{severity:"error",children:"Form data is not initialized. Please try again or check Redux configuration."});const x=r=>{if(!q)return"";if(r.includes(".")){const D=r.split(/\.|\[|\]/).filter(Boolean);let b=q;for(const a of D)if(Array.isArray(b)&&a.match(/^\d+$/)?b=b[parseInt(a)]:b=b==null?void 0:b[a],b===void 0)return"";return b}return q[r]||""};if(!p[m])return g.jsx(Y,{severity:"error",children:"Invalid role specified"});const v=p[m].filter(r=>m==="student"&&r.name.includes("boardingDetails")?q.boardingStatus==="Boarder":!0);return g.jsxs(X,{children:[g.jsxs(Ae,{variant:"h4",children:[s?"Update":"Sign Up"," (",m.charAt(0).toUpperCase()+m.slice(1),")"]}),g.jsxs("form",{onSubmit:H,ref:_,children:[v.map(r=>g.jsx(X,{mb:2,children:r.type==="select"?g.jsxs(qe,{fullWidth:!0,children:[g.jsx(Ce,{children:r.label}),g.jsx(xe,{name:r.name,value:x(r.name),onChange:P,required:r.required,children:r.options.map(D=>g.jsx(pe,{value:D,children:D},D))})]}):r.type==="file"?g.jsx(X,{mb:2,children:g.jsx("input",{type:"file",name:r.name,id:r.name,onChange:P,required:r.required,accept:"image/*",style:{display:"block",width:"100%"}})}):g.jsx(Se,{label:r.label,name:r.name,type:r.type,value:x(r.name),onChange:P,required:r.required,fullWidth:!0})},r.name)),I&&g.jsx(Y,{severity:"error",children:I}),g.jsx(ge,{content:s?"Update":"Sign Up",submit:!0})]}),g.jsx(fe,{open:f,message:z,title:"User Registration Confirmation",onClose:Q})]})};export{Te as S};
