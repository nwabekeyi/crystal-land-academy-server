import{r as f,a as Q,Q as W,S as z,j as m,n as V}from"./index-22HUb1_z.js";import{u as J}from"./useApi-BivKV4bK.js";import{A as O,j as K,w as y,T as X,a1 as Z,a2 as U,a3 as k,z as ee}from"./constants-BJW4J9P5.js";import{u as ae,M as te}from"./MenuItem-38XN_-vW.js";import{A as ne,C as ie}from"./confirmationModal-BxJ-28ob.js";import{t as re}from"./modal-CFzM2TvC.js";import{A as $}from"./Alert-Bl6PSDrU.js";const P=l=>/^[0-9a-fA-F]{24}$/.test(l),se=({role:l,selectedUser:a})=>{const[B,g]=f.useState(""),{data:M,error:G,callApi:N}=J(),[T,A]=f.useState(!1),[F,C]=f.useState(""),[v,q]=f.useState(!1),[I,j]=f.useState([]),[L,s]=f.useState([]),x=ae(),u=Q(c=>c.adminData.usersData);u.user,u.teachers,f.useEffect(()=>{console.log("selectedUser:",a),a&&!P(a)&&(console.warn("Invalid selectedUser ID format:",a),g("Invalid user ID format"))},[a]),f.useEffect(()=>{(async()=>{var r,p;try{const[h,d]=await Promise.all([N("/api/subjects","GET"),N("/api/academic-years","GET")]);j(((r=h.data)==null?void 0:r.map(t=>({id:t._id,name:t.data.name})))||[]),s(((p=d.data)==null?void 0:p.map(t=>({id:t._id,name:t.name})))||[])}catch(h){console.error("Error fetching options:",h),g("Failed to load dropdown options")}})()},[]);const S={student:[{label:"First Name",name:"firstName",type:"text",required:!a},{label:"Last Name",name:"lastName",type:"text",required:!a},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!a},{label:"Profile Picture",name:"profilePicture",type:"file",required:!a},{label:"Gender",name:"gender",type:"select",required:!a,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!a,options:["Primary","Secondary"]},{label:"Class Name",name:"currentClassLevel.className",type:"text",required:!a},{label:"Subclass",name:"currentClassLevel.subclass",type:"text",required:!a},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!a,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!a},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!a},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!a},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!a},{label:"Last Name",name:"lastName",type:"text",required:!a},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!a},{label:"Profile Picture",name:"profilePicture",type:"file",required:!a},{label:"Gender",name:"gender",type:"select",required:!a,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!a},{label:"Address",name:"address",type:"text",required:!a},{label:"Qualification",name:"qualification",type:"select",required:!a,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!a},{label:"Tribe",name:"tribe",type:"text",required:!a},{label:"Religion",name:"religion",type:"select",required:!a,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Subject",name:"subject",type:"select",required:!a,options:I.map(c=>c.name)},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!a},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!a},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!a},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!1,options:["Primary","Secondary"]},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"text",required:!1},{label:"Teaching Subclasses",name:"teachingAssignments[0].subclasses",type:"text",required:!1},{label:"Teaching Academic Year",name:"teachingAssignments[0].academicYear",type:"select",required:!1,options:L.map(c=>c.name)},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!a},{label:"Last Name",name:"lastName",type:"text",required:!a},{label:"Email",name:"email",type:"email",required:!a},{label:"Profile Picture",name:"profilePicture",type:"file",required:!a}].filter(Boolean)},R=c=>{var p,h,d;const r={};if(S[c].forEach(t=>{if(t.name.includes("currentClassLevel")||t.name.includes("boardingDetails")||t.name.includes("guardians")||t.name.includes("bankAccountDetails")||t.name.includes("teachingAssignments")){const[e,b,o]=t.name.split(/\.|\[|\]/).filter(Boolean);e==="guardians"||e==="teachingAssignments"?(r[e]=r[e]||[{}],r[e][0][b]=""):(r[e]=r[e]||{},r[e][b]="")}else r[t.name]=(t.type==="select","")}),a&&u&&P(a)){console.log("Fetching user data for:",a);const t=c==="student"?(p=u.students)==null?void 0:p.find(e=>e._id===a):c==="teacher"?(h=u.teachers)==null?void 0:h.find(e=>e._id===a):(d=u.admins)==null?void 0:d.find(e=>e._id===a);console.log("Found user:",t),t?Object.keys(r).forEach(e=>{var b,o,n;e==="currentClassLevel"&&t[e]?r[e]={section:t[e].section||"",className:t[e].className||"",subclass:t[e].subclass||""}:e==="boardingDetails"&&t[e]?r[e]={hall:t[e].hall||"",roomNumber:t[e].roomNumber||"",bedNumber:t[e].bedNumber||"",houseMaster:t[e].houseMaster||""}:e==="guardians"&&((b=t[e])!=null&&b.length)?r[e]=[{name:t[e][0].name||"",relationship:t[e][0].relationship||"",phone:t[e][0].phone||"",email:t[e][0].email||"",address:t[e][0].address||""}]:e==="bankAccountDetails"&&t[e]?r[e]={accountName:t[e].accountName||"",accountNumber:t[e].accountNumber||"",bank:t[e].bank||""}:e==="teachingAssignments"&&((o=t[e])!=null&&o.length)?r[e]=[{section:t[e][0].section||"",className:t[e][0].className||"",subclasses:((n=t[e][0].subclasses)==null?void 0:n.join(","))||"",academicYear:t[e][0].academicYear||""}]:r[e]=t[e]||r[e]}):console.warn("User not found for ID:",a)}return r},[i,D]=f.useState(R(l)),[E,w]=f.useState(null),Y=f.useRef(null);return f.useEffect(()=>{D(R(l))},[l,a]),{formRef:Y,formData:i,error:B,loading:v,handleChange:c=>{const{name:r,value:p,files:h}=c.target;if(r==="profilePicture")w(h[0]);else if(r.includes("currentClassLevel")||r.includes("boardingDetails")||r.includes("bankAccountDetails")){const[d,t]=r.split(".");D(e=>({...e,[d]:{...e[d],[t]:p}}))}else if(r.includes("guardians")||r.includes("teachingAssignments")){const[d,t,e]=r.split(/\.|\[|\]/).filter(Boolean);D(b=>{const o=[...b[d]||[{}]];return o[0]={...o[0],[e]:p},{...b,[d]:o}})}else D(d=>({...d,[r]:p}))},handleSubmit:async c=>{var r,p,h,d,t;if(c.preventDefault(),q(!0),g(""),a&&!P(a)){g("Invalid user ID format"),q(!1);return}if(a&&Y.current.querySelectorAll("[required]").forEach(e=>{e.removeAttribute("required")}),!a&&!E){g("Profile picture is required"),q(!1);return}if(l==="student"&&i.boardingStatus==="Boarder"&&(!((r=i.boardingDetails)!=null&&r.hall)||!((p=i.boardingDetails)!=null&&p.roomNumber))){g("Boarding Hall and Room Number are required for Boarder students"),q(!1);return}try{const e=new FormData;Object.keys(i).forEach(n=>{var _,H;n==="currentClassLevel"&&i[n]?(e.append("currentClassLevel[section]",i[n].section||""),e.append("currentClassLevel[className]",i[n].className||""),e.append("currentClassLevel[subclass]",i[n].subclass||"")):n==="boardingDetails"&&i[n]&&i.boardingStatus==="Boarder"?(e.append("boardingDetails[hall]",i[n].hall||""),e.append("boardingDetails[roomNumber]",i[n].roomNumber||""),e.append("boardingDetails[bedNumber]",i[n].bedNumber||""),e.append("boardingDetails[houseMaster]",i[n].houseMaster||"")):n==="guardians"&&((_=i[n])!=null&&_.length)?(e.append("guardians[0][name]",i[n][0].name||""),e.append("guardians[0][relationship]",i[n][0].relationship||""),e.append("guardians[0][phone]",i[n][0].phone||""),e.append("guardians[0][email]",i[n][0].email||""),e.append("guardians[0][address]",i[n][0].address||"")):n==="bankAccountDetails"&&i[n]?(e.append("bankAccountDetails[accountName]",i[n].accountName||""),e.append("bankAccountDetails[accountNumber]",i[n].accountNumber||""),e.append("bankAccountDetails[bank]",i[n].bank||"")):n==="teachingAssignments"&&((H=i[n])!=null&&H.length)&&i[n][0].section?(e.append("teachingAssignments[0][section]",i[n][0].section||""),e.append("teachingAssignments[0][className]",i[n][0].className||""),e.append("teachingAssignments[0][subclasses]",i[n][0].subclasses||""),e.append("teachingAssignments[0][academicYear]",i[n][0].academicYear||"")):(!a||i[n]&&i[n]!=="")&&e.append(n,i[n])}),E&&e.append("profilePicture",E);let b;a&&P(a)?b=l==="student"?`/api/students/${a}/update/admin`:`/api/teachers/teacher/${a}/update`:b=l==="student"?O.CREATE_STUDENT:l==="teacher"?O.CREATE_TEACHER:O.CREATE_ADMIN;const o=await N(b,a?"PATCH":"POST",e,{"Content-Type":"multipart/form-data"});o&&o.data?(x(a?W({id:a,user:o.data,role:l}):z({user:o.data,role:l})),C(`${o.data.firstName} ${o.data.lastName} has been successfully ${a?"updated":"registered"}`),D(R(l)),w(null)):C(((h=o==null?void 0:o.data)==null?void 0:h.message)||"An error occurred"),A(!0)}catch(e){console.error("Error submitting form:",e),g(((t=(d=e.response)==null?void 0:d.data)==null?void 0:t.message)||"Failed to submit the form. Please try again.")}finally{q(!1)}},roleFields:S,profilePicture:E,modalOpen:T,modalMessage:F,setModalOpen:A}},he=({role:l,selectedUser:a})=>{const B=K();re(B.palette.mode);const{roleFields:g,error:M,loading:G,handleChange:N,handleSubmit:T,formData:A,formRef:F,modalOpen:C,modalMessage:v,setModalOpen:q}=se({role:l,selectedUser:a});console.log("SignUpForm - role:",l,"selectedUser:",a);const I=()=>{q(!1)};if(G)return m.jsx(V,{});const j=s=>{if(s.includes(".")){const x=s.split(/\.|\[|\]/).filter(Boolean);let u=A;for(const S of x)if(Array.isArray(u)&&S.match(/^\d+$/)?u=u[parseInt(S)]:u=u==null?void 0:u[S],u===void 0)return"";return u}return A[s]||""};if(!g[l])return m.jsx($,{severity:"error",children:"Invalid role specified"});const L=g[l].filter(s=>l==="student"&&s.name.includes("boardingDetails")?A.boardingStatus==="Boarder":!0);return m.jsxs(y,{children:[m.jsxs(X,{variant:"h4",children:[a?"Update":"Sign Up"," (",l.charAt(0).toUpperCase()+l.slice(1),")"]}),m.jsxs("form",{onSubmit:T,ref:F,children:[L.map(s=>m.jsx(y,{mb:2,children:s.type==="select"?m.jsxs(Z,{fullWidth:!0,children:[m.jsx(U,{children:s.label}),m.jsx(k,{name:s.name,value:j(s.name),onChange:N,required:s.required,children:s.options.map(x=>m.jsx(te,{value:x,children:x},x))})]}):s.type==="file"?m.jsx(y,{mb:2,children:m.jsx("input",{type:"file",name:s.name,id:s.name,onChange:N,required:s.required,accept:"image/*",style:{display:"block",width:"100%"}})}):m.jsx(ee,{label:s.label,name:s.name,type:s.type,value:j(s.name),onChange:N,required:s.required,fullWidth:!0})},s.name)),M&&m.jsx($,{severity:"error",children:M}),m.jsx(ne,{content:a?"Update":"Sign Up",submit:!0})]}),m.jsx(ie,{open:C,message:v,title:"User Registration Confirmation",onClose:I})]})};export{he as S};
