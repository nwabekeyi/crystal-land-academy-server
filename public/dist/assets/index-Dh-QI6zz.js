import{a as k,r as i,j as t,f as p}from"./index-CUx_BIfb.js";import{t as q,M as U}from"./modal-D-FEyCwe.js";import{C as G}from"./accordion-Dz4OcIMH.js";import{H as B}from"./Header-C6ewtNOz.js";import{C as V}from"./confirmationModal-C7esu7_Z.js";import{u as W}from"./useApi-B5A5LOF2.js";import{j as z,v as f,T as u,y as $}from"./TextField-CnJy6qLH.js";import{A as J}from"./index-Ci-mqblD.js";import{M as K}from"./MenuItem-Y8p8i8nN.js";import"./IconButton-CSIbz2lV.js";import"./useSlot-BurnVOpP.js";import"./CircularProgress-BgN2WNYl.js";import"./index-Dn2bJmhV.js";import"./loadingButton-BcWtTSRw.js";import"./crystal-land-log-removebg-DVF-nlbN.js";function me(){const s=k(e=>{var r;return(r=e.users)==null?void 0:r.user}),_=z(),h=q(_.palette.mode),{loading:x,error:w,callApi:d}=W(),[C,L]=i.useState([]),[o,I]=i.useState(null),[Y,y]=i.useState(!1),[c,R]=i.useState({reviewText:"",rating:""}),[N,m]=i.useState(!1),[S,l]=i.useState({error:null,message:null}),[v,F]=i.useState(null);i.useEffect(()=>{(async()=>{try{const r=await d(`${p.ACADEMICYEARS_ID}/current`,"GET");console.log("Academic Year Response:",r),r&&r.data&&r.data._id?F(r.data._id):(console.error("Invalid response structure:",r),l({error:"Failed to fetch academic year",message:null}))}catch(r){console.error("Error fetching academic year:",r),l({error:"Failed to fetch academic year",message:null})}})()},[d]),i.useEffect(()=>{(async()=>{if(!s||!s.classLevelId){console.error("Class level ID not found in Redux state"),l({error:"Class level ID not found",message:null});return}const r=s.classLevelId;console.log("Class Level ID:",r);try{const a=await d(`${p.TEACHERS}/class/${r}`,"GET");console.log("Teachers Response:",a),a&&a.data?L(a.data):(console.error("Invalid response structure:",a),l({error:"Failed to fetch teachers",message:null}))}catch(a){console.error("Error fetching teachers:",a),l({error:"Failed to fetch teachers",message:null})}})()},[d,s]);const O=e=>{I(e),console.log("üõ† Setting selected teacher:",e),y(!0)},P=()=>{m(!1),l({error:null,message:null})},j=()=>{y(!1),R({reviewText:"",rating:""}),I(null)},T=e=>{const{name:r,value:a}=e.target;R(g=>({...g,[r]:a}))},H=async()=>{var E,A,D,M;if(!c.reviewText||!c.rating){l({error:"Please provide both review text and rating",message:null}),m(!0);return}const e=s==null?void 0:s._id,r=s==null?void 0:s.studentId,a=s==null?void 0:s.classLevelId,g=`${(E=s==null?void 0:s.currentClassLevel)==null?void 0:E.section}_${(D=(A=s==null?void 0:s.currentClassLevel)==null?void 0:A.className)==null?void 0:D.replace(/\s+/g,"")}_${(M=s==null?void 0:s.currentClassLevel)==null?void 0:M.subclass}`;if(console.log("üß† Selected Teacher:",o),console.log("üß† Selected Teacher Mongo _id:",o==null?void 0:o._id),console.log("üß† Academic Year ID:",v),console.log("üß† Student Mongo _id:",e),console.log("üß† Student ID:",r),console.log("üß† Class ID:",a),console.log("üß† Constructed Class ID:",g),!e||!v||!a||!(o!=null&&o._id)||!r){l({error:"Missing required data for review submission",message:null}),m(!0);return}const b={id:`review_${Date.now()}`,studentId:r,teacherId:o._id,classId:g,rating:Number(c.rating),reviewText:c.reviewText,academicYearId:v};console.log("üì¶ Payload to submit:",b);try{const n=await d(p.REVIEW,"POST",b);console.log("‚úÖ Review Submission Response:",n),(n==null?void 0:n.status)==="success"&&l({error:null,message:"Teacher review submitted successfully!"}),n.status==="already reviewed"&&l({error:(n==null?void 0:n.message)||"Failed to submit review. Please try again.",message:null})}catch(n){console.error("‚ùå Error during review submission:",n),l({error:"Unexpected error occurred while submitting review.",message:null})}m(!0),j()};return t.jsxs(f,{m:"30px",children:[t.jsx(B,{title:"YOUR TEACHERS",subtitle:""}),x&&t.jsx(u,{children:"Loading..."}),w&&t.jsx(u,{color:"error",children:w}),!x&&C.length<1&&t.jsx(u,{children:"Your class has not been assigned a teacher yet."}),C.map((e,r)=>t.jsx(G,{title:`${e.firstName} ${e.lastName}`,details:t.jsxs(f,{display:"flex",alignItems:"center",justifyContent:"center",gap:"10px",children:[t.jsx(J,{src:e.profilePictureUrl,alt:`${e.firstName} ${e.lastName}`,sx:{width:120,height:120,mb:2}}),t.jsxs(f,{children:[t.jsx(u,{variant:"body2",color:h.grey[100],children:e.role}),t.jsx(u,{variant:"body2",color:h.grey[100],mt:"5px",children:e.program})]})]}),actions:[{label:"Review",onClick:()=>O(e)}]},r)),t.jsx(U,{open:Y,onClose:j,title:`Review ${o==null?void 0:o.firstName} ${o==null?void 0:o.lastName}`,onConfirm:H,children:t.jsxs(f,{display:"flex",flexDirection:"column",gap:"16px",children:[t.jsx($,{name:"reviewText",label:"Review",variant:"outlined",multiline:!0,rows:4,value:c.reviewText,onChange:T,required:!0}),t.jsx($,{name:"rating",label:"Rating",variant:"outlined",select:!0,value:c.rating,onChange:T,required:!0,children:[1,2,3,4,5].map(e=>t.jsx(K,{value:e,children:e},e))})]})}),t.jsx(V,{open:N,onClose:P,isLoading:!1,title:"Teacher Review Confirmation",message:S.message||S.error})]})}export{me as default};
