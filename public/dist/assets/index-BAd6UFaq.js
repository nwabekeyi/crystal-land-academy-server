import{j as e,r as n,a as Z,e as G}from"./index-CeJqQt67.js";import{T as ee}from"./table-DcMb6AsZ.js";import{r as te,M as B,t as se}from"./modal-CWrsGmPw.js";import{D as V,G as r,h as ae,E as ne}from"./index-BG6wCPD7.js";import{c as re,v as h,T as s,x as oe,q as ie,y as ce,j as le}from"./TextField-CQQTvPbq.js";import{H as de}from"./Header-C9JBMvsB.js";import{w as ue}from"./dasboardPagesContainer-BYUuQigG.js";import{A as me}from"./confirmationModal-DZkXcdoz.js";import{u as q}from"./useApi-DGN0ddUE.js";import{C as he}from"./CircularProgress-CObE2qYY.js";import{L as xe}from"./LinearProgress-xeMVlVbM.js";import{I as pe}from"./IconButton-WNpSLIu_.js";import"./useMediaQuery-Dw2_h2Ss.js";import"./index-9yRw9VkQ.js";import"./loadingButton-DhYhvGRr.js";import"./MenuItem-0HapAoKS.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-OTOZFPwB.js";const ge=re(e.jsx("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility"),fe=({receipt:a})=>{const p=n.useRef(),g=async()=>{if(p.current)try{const u=await ae(p.current,{useCORS:!0}),f=u.toDataURL("image/png"),m=new ne("portrait","px","a4"),y=m.internal.pageSize.getWidth(),x=u.height*y/u.width;m.addImage(f,"PNG",0,0,y,x),m.save(`receipt_${a.transactionId}.pdf`)}catch(u){console.error("Error generating PDF:",u)}};return e.jsxs(h,{ref:p,sx:{padding:"20px",maxWidth:"500px",margin:"auto",backgroundColor:"#fff",color:"#000",borderRadius:"10px",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",fontFamily:"Arial, sans-serif"},children:[e.jsx(s,{variant:"h6",align:"center",gutterBottom:!0,children:"Crystal land academy"}),e.jsx(s,{variant:"subtitle2",align:"center",gutterBottom:!0,children:"Payment Receipt"}),e.jsx(V,{sx:{my:2}}),e.jsxs(r,{container:!0,spacing:2,children:[e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Transaction ID:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:a.transactionId})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Student Name:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:a.userName})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Program:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:a.program})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Amount Paid:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsxs(s,{children:["₦",a.amount.toFixed(2)]})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Status:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:a.status})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Date:"})}),e.jsx(r,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:a.date})})]}),e.jsx(V,{sx:{my:2}}),e.jsx(s,{variant:"body2",align:"center",children:"Thank you for your payment!"}),e.jsx(oe,{variant:"contained",color:"primary",fullWidth:!0,onClick:g,sx:{mt:2},children:"Download Receipt"})]})};var F={},ye=ie;Object.defineProperty(F,"__esModule",{value:!0});var J=F.default=void 0,Pe=ye(te()),je=e;J=F.default=(0,Pe.default)((0,je.jsx)("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"Payment");const be=({onSuccess:a=()=>{},studentId:p,classLevelId:g,academicYear:u,termName:f,subclassLetter:m,section:y})=>{const[x,A]=n.useState(!1),[P,I]=n.useState(!1),[o,w]=n.useState(""),N="pk_test_8293ca0c4f5b0e4b8da1dad753cbc602cebade30",{callApi:L}=q(),M=()=>{I(!0)},T=()=>{I(!1)},D=()=>{R(),T()},R=()=>{A(!0);try{window.PaystackPop.setup({key:N,email:"user@example.com",currency:"NGN",amount:parseFloat(o)*100,metadata:{custom_fields:[{display_name:"Payment Purpose",variable_name:"payment_purpose",value:"School Fees"}]},onClose:function(){console.log("Payment dialog closed")},callback:function(b){console.log("Paystack callback triggered:",b);const C=b.reference;if(!o||isNaN(o)){console.error("Invalid payment amount:",o);return}if(!C){console.error("Missing transaction reference:",b);return}const v={studentId:p,classLevelId:g,academicYear:u,section:y,termPayments:[{termName:f,subclassLetter:m,payments:[{amountPaid:parseFloat(o),method:"Card",reference:C,status:"success"}]}]};console.log("Payload being sent to backend:",JSON.stringify(v,null,2)),L("http://localhost:5000/api/v1/payment","POST",v).then(c=>{console.log("Transaction registered successfully:",c),a(v)}).catch(c=>{console.error("Failed to register transaction:",c.response||c.message),c.response&&console.error("Backend error details:",c.response.data)}),w("")}}).openIframe()}catch(j){console.error("Error initializing Paystack payment:",j)}finally{A(!1)}};return e.jsxs(h,{children:[e.jsx(me,{icon:e.jsx(J,{}),disabled:x,onClick:M,content:x?e.jsx(he,{size:24}):"Pay Now"}),e.jsx(B,{open:P,onClose:T,title:"Enter Payment Amount",onConfirm:D,confirmMessage:"Proceed with Payment",children:e.jsx(ce,{label:"Amount (Naira)",type:"number",value:o,onChange:j=>w(j.target.value),fullWidth:!0})})]})},Ce=()=>{var H,$,Y,z;const a=Z(t=>t.users.user),p=le(),g=se(p.palette.mode),[u,f]=n.useState([]),[m,y]=n.useState(0),[x,A]=n.useState(10),[P,I]=n.useState("datePaid"),[o,w]=n.useState("asc"),[N,L]=n.useState(!1),[M,T]=n.useState(null),[D,R]=n.useState(!1),[j,b]=n.useState(0),[C,v]=n.useState(0),{callApi:c}=q();n.useEffect(()=>{(async()=>{const i=`${G.PAYMENT}?studentId=${a._id}&page=${m+1}&limit=${x}&sortBy=${P}&sortDirection=${o}`;console.log(`Calling API: ${i}`);try{const l=await c(i,"GET");if(console.log("API Response:",l),l){const _=l.data.flatMap(S=>{var k;return((((k=S.termPayments)==null?void 0:k[0])||{}).payments||[]).map(d=>({reference:d.reference,amountPaid:d.amountPaid,datePaid:d.datePaid,status:d.status||S.status,originalReceipt:S}))});f(_),b(l.totalOutstanding||0),v(l.totalPaid||0)}}catch(l){console.error("Error fetching payment records:",l)}})()},[m,x,P,o,c,a._id]);const O=j+C,E=O>0?C/O*100:0,U=t=>{const i=P===t&&o==="asc";I(t),w(i?"desc":"asc")},K=t=>{T(t),L(!0)},Q=async t=>{var _,S,W,k;console.log("Payment details:",t),R(!0);const i={studentId:a._id,classLevelId:a.classLevelId,academicYear:(S=(_=a.currentClassLevel)==null?void 0:_.academicYear)==null?void 0:S._id,section:(W=a.currentClassLevel)==null?void 0:W.section,termPayments:[{termName:"1st Term",subclassLetter:(k=a.currentClassLevel)==null?void 0:k.subclass,payments:[{amountPaid:t.amount,method:"Card",reference:t.reference,status:"success"}]}]};console.log("Payload being sent to backend:",JSON.stringify(i,null,2));const l=await c(G.createPayment,"POST",i);l&&(f(d=>[l.data,...d]),v(d=>d+t.amount),b(d=>d-t.amount),R(!0))},X={columns:[{id:"sn",label:"S/N",flex:.3,renderCell:(t,i)=>e.jsx(s,{children:i+1})},{id:"reference",label:"Transaction ID",flex:1,renderCell:t=>e.jsx(s,{children:t.reference||"N/A"})},{id:"amountPaid",label:"Amount (₦)",flex:1,renderCell:t=>e.jsxs(s,{children:["₦",t.amountPaid]})},{id:"status",label:"Status",flex:1,renderCell:t=>e.jsx(s,{children:t.status?t.status.charAt(0).toUpperCase()+t.status.slice(1):"N/A"})},{id:"datePaid",label:"Date",flex:1,renderCell:t=>e.jsx(s,{children:t.datePaid?new Date(t.datePaid).toLocaleDateString():"N/A"})},{id:"actions",label:"Actions",flex:1,renderCell:t=>e.jsx(h,{display:"flex",gap:"10px",children:e.jsx(pe,{onClick:()=>K(t.originalReceipt),children:e.jsx(ge,{})})})}],tableHeader:"Payment Records",data:u,sortBy:P,sortDirection:o,onSortChange:U,page:m,rowsPerPage:x,onPageChange:(t,i)=>y(i),onRowsPerPageChange:t=>A(parseInt(t.target.value,10)),onRowClick:t=>console.log("Row clicked:",t),hiddenColumnsSmallScreen:["status","reference"]};return e.jsxs(h,{children:[e.jsx(de,{title:"Payment History",subtitle:"Overview of Payments Made"}),e.jsxs(h,{backgroundColor:g.primary[400],p:"20px",borderRadius:"4px",children:[e.jsx(s,{variant:"h5",fontWeight:"600",mb:"15px",children:"Payment Summary"}),e.jsxs(h,{mb:"20px",children:[e.jsxs(h,{sx:{display:"flex",alignItems:"end",marginBottom:"15px",justifyContent:"space-between",width:"100%"},children:[e.jsxs(h,{children:[e.jsxs(s,{variant:"h6",mb:"5px",children:["Total Amount Due: ₦",(O/100).toFixed(2)]}),e.jsxs(s,{variant:"h6",mb:"5px",children:["Total Paid: ₦",(C/100).toFixed(2)]}),e.jsxs(s,{variant:"h6",children:["Payment Percentage: ",E.toFixed(2),"%"]})]}),e.jsx(h,{children:e.jsx(be,{onSuccess:Q,studentId:a._id,classLevelId:a.classLevelId,academicYear:($=(H=a.currentClassLevel)==null?void 0:H.academicYear)==null?void 0:$._id,section:(Y=a.currentClassLevel)==null?void 0:Y.section,termName:"1st Term",subclassLetter:(z=a.currentClassLevel)==null?void 0:z.subclass})})]}),e.jsx(xe,{variant:"determinate",value:E,sx:{height:10,borderRadius:5,backgroundColor:g.grey[300],"& .MuiLinearProgress-bar":{backgroundColor:g.greenAccent[500]}}})]}),e.jsx(ee,{...X}),e.jsx(B,{open:D,onClose:()=>R(!1),title:"Payment Successful",noConfirm:!0,children:e.jsx(s,{variant:"h6",align:"center",color:"green",children:"Your payment was successful!"})}),e.jsx(B,{open:N,onClose:()=>L(!1),title:"Receipt Details",noConfirm:!0,children:M&&e.jsx(fe,{receipt:M})})]})]})},$e=ue(Ce);export{$e as default};
