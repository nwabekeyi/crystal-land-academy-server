import{r as N,a as K,e as k,G as ge,H as fe,j as p,i as he}from"./index-D_kDwTfs.js";import{u as Ne}from"./useApi-CbGRypPa.js";import{u as Ae,M as U}from"./MenuItem-C1-m6Bfh.js";import{A as ve,C as Se}from"./confirmationModal-BB-Svlb_.js";import{t as qe}from"./modal-BxlCeH0G.js";import{j as Ce,v as ee,T as xe,Z as De,$ as je,a0 as Le,y as Be}from"./TextField-BjozRPlS.js";import{A as se}from"./Alert-BY5JfeUh.js";const Z=m=>/^[0-9a-fA-F]{24}$/.test(m),Ee=({role:m,selectedUser:t})=>{const[y,g]=N.useState(""),{error:_,callApi:Q}=Ne(),[R,w]=N.useState(!1),[j,H]=N.useState(""),[V,h]=N.useState(!1),J=Ae(),P=K(l=>{var n;return((n=l.adminData)==null?void 0:n.usersData)||{students:[],teachers:[],admins:[]}}),v=K(l=>{var n;return((n=l.adminData)==null?void 0:n.classLevels)||[]}),F=K(l=>{var n;return((n=l.adminData)==null?void 0:n.subjects)||[]}),[O,o]=N.useState({sections:[],classNames:[],subclasses:[]}),[x,q]=N.useState([]),[e,L]=N.useState({}),[W,ae]=N.useState(null),pe=N.useRef(null),[te,ne]=N.useState([]);N.useEffect(()=>{q(F.map(l=>({value:l._id,label:l.name})))},[F]),N.useEffect(()=>{var l,n,d,A,b,a,s;if(m==="teacher"&&((n=(l=e.teachingAssignments)==null?void 0:l[0])!=null&&n.section)&&((A=(d=e.teachingAssignments)==null?void 0:d[0])!=null&&A.className)&&((s=(a=(b=e.teachingAssignments)==null?void 0:b[0])==null?void 0:a.subclasses)!=null&&s[0])){const u=v.find(S=>S.section===e.teachingAssignments[0].section&&S.name===e.teachingAssignments[0].className),c=e.teachingAssignments[0].subclasses[0],f=u==null?void 0:u.subclasses.find(S=>S.letter===c),B=(f==null?void 0:f.subjects)||[];ne(B.map(S=>({value:S._id.toString(),label:S.name})))}else ne([])},[e.teachingAssignments,v,F,m]);const D=(l={},n="currentClassLevel")=>{var c,f,B,S,$,G;console.log("getClassLevelOptions called with:",{formData:l,parentKey:n,classLevels:v});const d=[...new Set(v.map(E=>E.section))],A=E=>v.filter(I=>I.section===E).map(I=>I.name),b=(E,I)=>{const M=v.find(T=>T.section===E&&T.name===I);return console.log("getSubclasses:",{section:E,className:I,classLevel:M}),(M==null?void 0:M.subclasses.map(T=>T.letter))||[]},a=n==="currentClassLevel"?((c=l.currentClassLevel)==null?void 0:c.section)||d[0]||"":((B=(f=l.teachingAssignments)==null?void 0:f[0])==null?void 0:B.section)||d[0]||"",s=n==="currentClassLevel"?((S=l.currentClassLevel)==null?void 0:S.className)||A(a)[0]||"":((G=($=l.teachingAssignments)==null?void 0:$[0])==null?void 0:G.className)||A(a)[0]||"",u={sections:d,classNames:A(a),subclasses:b(a,s)};return console.log("getClassLevelOptions result:",u),u};N.useEffect(()=>{console.log("selectedUser:",t),t&&!Z(t)&&(console.warn("Invalid selectedUser ID format:",t),g("Invalid user ID format"))},[t]);const ie=l=>{var d,A,b;const n={};if(!X[l])return console.error("Invalid role:",l),n;if(X[l].forEach(a=>{if(a.name.includes("currentClassLevel")||a.name.includes("guardians")||a.name.includes("bankAccountDetails")||a.name.includes("teachingAssignments")){const[s,u,c]=a.name.split(/\.|\[|\]/).filter(Boolean);s==="guardians"||s==="teachingAssignments"?(n[s]=n[s]||[{}],n[s][0][u]=""):(n[s]=n[s]||{},n[s][u]="")}else n[a.name]=(a.type==="select","")}),l==="student"){const{sections:a,classNames:s,subclasses:u}=D(n,"currentClassLevel");n.currentClassLevel={section:a[0]||"",className:s[0]||"",subclass:u[0]||""},n.boardingStatus="Day Student"}else if(l==="teacher"){const{sections:a,classNames:s,subclasses:u}=D(n,"teachingAssignments");n.teachingAssignments=[{section:a[0]||"",className:s[0]||"",subclasses:[u[0]||""],subject:""}]}if(t&&P&&Z(t)){const a=l==="student"?(d=P.students)==null?void 0:d.find(s=>s._id===t):l==="teacher"?(A=P.teachers)==null?void 0:A.find(s=>s._id===t):(b=P.admins)==null?void 0:b.find(s=>s._id===t);a&&Object.keys(n).forEach(s=>{var u,c,f;s==="currentClassLevel"&&a[s]?n[s]={section:a[s].section||n.currentClassLevel.section,className:a[s].className||n.currentClassLevel.className,subclass:a[s].subclass||n.currentClassLevel.subclass}:s==="boardingDetails"&&a[s]?n[s]={hall:a[s].hall||"",roomNumber:a[s].roomNumber||"",bedNumber:a[s].bedNumber||"",houseMaster:a[s].houseMaster||""}:s==="guardians"&&((u=a[s])!=null&&u.length)?n[s]=[{name:a[s][0].name||"",relationship:a[s][0].relationship||"",phone:a[s][0].phone||"",email:a[s][0].email||"",address:a[s][0].address||""}]:s==="bankAccountDetails"&&a[s]?n[s]={accountName:a[s].accountName||"",accountNumber:a[s].accountNumber||"",bank:a[s].bank||""}:s==="teachingAssignments"&&((c=a[s])!=null&&c.length)?n[s]=[{section:a[s][0].section||n.teachingAssignments[0].section,className:a[s][0].className||n.teachingAssignments[0].className,subclasses:a[s][0].subclasses||n.teachingAssignments[0].subclasses,subject:((f=a[s][0].subject)==null?void 0:f._id)||""}]:n[s]=a[s]||n[s]})}return n};N.useEffect(()=>{if(v.length===0){console.log("classLevels not loaded yet");return}console.log("Initializing formData with classLevels:",v);const l=ie(m);L(l),o(m==="student"?D(l,"currentClassLevel"):D(l,"teachingAssignments"))},[m,t,v,F]),N.useEffect(()=>{console.log("formData updated:",e),e&&o(m==="student"?D(e,"currentClassLevel"):D(e,"teachingAssignments"))},[e,m,v]);const X={student:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t},{label:"Gender",name:"gender",type:"select",required:!t,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!t,options:O.sections},{label:"Class Name",name:"currentClassLevel.className",type:"select",required:!t,options:O.classNames},{label:"Subclass",name:"currentClassLevel.subclass",type:"select",required:!t,options:O.subclasses},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!t,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!t},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!t},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!t},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t},{label:"Gender",name:"gender",type:"select",required:!t,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!t},{label:"Address",name:"address",type:"text",required:!t},{label:"Qualification",name:"qualification",type:"select",required:!t,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!t},{label:"Tribe",name:"tribe",type:"text",required:!t},{label:"Religion",name:"religion",type:"select",required:!t,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!t,options:O.sections},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"select",required:!t,options:O.classNames},{label:"Teaching Subclass",name:"teachingAssignments[0].subclasses[0]",type:"select",required:!t,options:O.subclasses},{label:"Subclass Subject",name:"teachingAssignments[0].subject",type:"select",required:!1,options:te},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!t},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!t},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!t},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t}].filter(Boolean)};return{formRef:pe,formData:e,error:y,loading:V,handleChange:l=>{const{name:n,value:d,files:A}=l.target;if(n==="profilePicture")ae(A[0]);else if(n.includes("currentClassLevel")){const[,b]=n.split(".");L(a=>{const s={...a.currentClassLevel,[b]:d};if(b==="section"){const{classNames:u,subclasses:c}=D({currentClassLevel:s},"currentClassLevel");s.className=u[0]||"",s.subclass=c[0]||""}else if(b==="className"){const{subclasses:u}=D({currentClassLevel:s},"currentClassLevel");s.subclass=u[0]||""}return{...a,currentClassLevel:s}})}else if(n.includes("teachingAssignments")){const[,b,a,s]=n.split(/\.|\[|\]/).filter(Boolean);L(u=>{const c=[...u.teachingAssignments||[{}]];if(a==="subclasses"&&s==="0"?c[0]={...c[0],subclasses:[d],subject:""}:a==="subject"?c[0]={...c[0],subject:d}:c[0]={...c[0],[a]:d},a==="section"){const{classNames:f,subclasses:B}=D({teachingAssignments:[{...c[0],section:d}]},"teachingAssignments");c[0].className=f[0]||"",c[0].subclasses=[B[0]||""],c[0].subject=""}else if(a==="className"){const{subclasses:f}=D({teachingAssignments:[{...c[0],className:d}]},"teachingAssignments");c[0].subclasses=[f[0]||""],c[0].subject=""}return{...u,teachingAssignments:c}})}else if(n.includes("boardingDetails")){const[,b]=n.split(".");L(a=>({...a,boardingDetails:{...a.boardingDetails,[b]:d}}))}else if(n.includes("guardians")){const[,b,a]=n.split(/\.|\[|\]/).filter(Boolean);L(s=>{const u=[...s.guardians||[{}]];return u[0]={...u[0],[a]:d},{...s,guardians:u}})}else if(n.includes("bankAccountDetails")){const[,b]=n.split(".");L(a=>({...a,bankAccountDetails:{...a.bankAccountDetails,[b]:d}}))}else L(n==="boardingStatus"?b=>({...b,boardingStatus:d,boardingDetails:d==="Boarder"?b.boardingDetails||{}:void 0}):b=>({...b,[n]:d}))},handleSubmit:async l=>{var n,d,A,b,a,s,u,c,f,B,S,$,G,E,I,M,T,le,re,ue,ce,oe;if(l.preventDefault(),h(!0),g(""),t&&!Z(t)){g("Invalid user ID format"),h(!1);return}if(!t){if(!e.firstName||!e.lastName||!e.email||!e.gender){g("First name, last name, email, and gender are required"),h(!1);return}if(m==="student"){if(!((n=e.currentClassLevel)!=null&&n.section)||!((d=e.currentClassLevel)!=null&&d.className)||!((A=e.currentClassLevel)!=null&&A.subclass)){g("Class level section, class name, and subclass are required"),h(!1);return}if(!((a=(b=e.guardians)==null?void 0:b[0])!=null&&a.name)||!((u=(s=e.guardians)==null?void 0:s[0])!=null&&u.relationship)||!((f=(c=e.guardians)==null?void 0:c[0])!=null&&f.phone)){g("Guardian name, relationship, and phone are required"),h(!1);return}if(!["Boarder","Day Student"].includes(e.boardingStatus)){g("Boarding status must be 'Boarder' or 'Day Student'"),h(!1);return}if(e.boardingStatus==="Boarder"&&(!((B=e.boardingDetails)!=null&&B.hall)||!((S=e.boardingDetails)!=null&&S.roomNumber))){g("Boarding Hall and Room Number are required for Boarder students"),h(!1);return}}else if(m==="teacher"){if(!e.NIN||!e.address||!e.qualification||!e.phoneNumber||!e.tribe||!e.religion||!(($=e.bankAccountDetails)!=null&&$.accountName)||!((G=e.bankAccountDetails)!=null&&G.accountNumber)||!((E=e.bankAccountDetails)!=null&&E.bank)||!((M=(I=e.teachingAssignments)==null?void 0:I[0])!=null&&M.section)||!((le=(T=e.teachingAssignments)==null?void 0:T[0])!=null&&le.className)||!((ce=(ue=(re=e.teachingAssignments)==null?void 0:re[0])==null?void 0:ue.subclasses)!=null&&ce.length)){g("All required teacher fields must be filled"),h(!1);return}if(!/^\d{11}$/.test(e.NIN)){g("NIN must be 11 digits"),h(!1);return}if(!/^\d{10}$/.test(e.bankAccountDetails.accountNumber)){g("Bank account number must be 10 digits"),h(!1);return}if(!e.teachingAssignments[0].subclasses.every(r=>/^[A-Z]$/.test(r))){g("Subclasses must be single uppercase letters"),h(!1);return}}if(!W){g("Profile picture is required"),h(!1);return}}try{const r=new FormData;Object.keys(e).forEach(i=>{var z,me;if(i==="currentClassLevel"&&e[i])r.append("currentClassLevel[section]",e[i].section||""),r.append("currentClassLevel[className]",e[i].className||""),r.append("currentClassLevel[subclass]",e[i].subclass||"");else if(i==="boardingDetails"&&e[i]&&e.boardingStatus==="Boarder")r.append("boardingDetails[hall]",e[i].hall||""),r.append("boardingDetails[roomNumber]",e[i].roomNumber||""),r.append("boardingDetails[bedNumber]",e[i].bedNumber||""),r.append("boardingDetails[houseMaster]",e[i].houseMaster||"");else if(i==="guardians"&&((z=e[i])!=null&&z.length))r.append("guardians[0][name]",e[i][0].name||""),r.append("guardians[0][relationship]",e[i][0].relationship||""),r.append("guardians[0][phone]",e[i][0].phone||""),r.append("guardians[0][email]",e[i][0].email||""),r.append("guardians[0][address]",e[i][0].address||"");else if(i==="bankAccountDetails"&&e[i])r.append("bankAccountDetails[accountName]",e[i].accountName||""),r.append("bankAccountDetails[accountNumber]",e[i].accountNumber||""),r.append("bankAccountDetails[bank]",e[i].bank||"");else if(i==="teachingAssignments"&&((me=e[i])!=null&&me.length)&&e[i][0].section){if(r.append("section",e[i][0].section||""),r.append("className",e[i][0].className||""),r.append("subclassLetter",e[i][0].subclasses[0]||""),e[i][0].subject){r.append("subject",e[i][0].subject);const de=v.find(be=>be.section===e[i][0].section&&be.name===e[i][0].className);de&&r.append("classLevel",de._id||"")}}else i==="isWithdrawn"||i==="isSuspended"?r.append(i,value==="true"):i==="applicationStatus"&&value?r.append(i,value):(!t||e[i]&&e[i]!==""&&i!=="boardingDetails")&&r.append(i,e[i])}),W&&r.append("profilePicture",W);for(let[i,z]of r.entries())console.log(`${i}: ${z}`);let Y;t&&Z(t)?Y=m==="student"?`/api/students/${t}/update/admin`:`/api/teachers/subject/${t}/update`:Y=m==="student"?k.CREATE_STUDENT:m==="teacher"?k.CREATE_TEACHER:k.CREATE_ADMIN;const C=await Q(Y,t?"PATCH":"POST",r,{"Content-Type":"multipart/form-data"});C&&C.status==="success"?(J(t?ge({id:t,user:C.data,role:m}):fe({user:C.data,role:m})),H(`${C.data.firstName} ${C.data.lastName} has been successfully ${t?"updated":"registered"}`),L(ie(m)),ae(null)):C&&C.status==="failed"&&(console.log(_),H((C==null?void 0:C.message)||"An error occurred")),w(!0)}catch(r){console.error("Error submitting form:",r),g(((oe=r.response)==null?void 0:oe.message)||"Failed to submit the form. Please try again.")}finally{h(!1)}},roleFields:X,profilePicture:W,modalOpen:R,modalMessage:j,setModalOpen:w,subclassSubjectOptions:te}},_e=({role:m,selectedUser:t})=>{const y=Ce();qe(y.palette.mode);const{roleFields:g,error:_,loading:Q,handleChange:R,handleSubmit:w,formData:j,formRef:H,modalOpen:V,modalMessage:h,setModalOpen:J,subclassSubjectOptions:P}=Ee({role:m,selectedUser:t});console.log("SignUpForm - role:",m,"selectedUser:",t,"formData:",j,"subclassSubjectOptions:",P);const v=()=>{J(!1)};if(Q)return p.jsx(he,{});if(!j||Object.keys(j).length===0)return p.jsx(se,{severity:"error",children:"Form data is not initialized. Please try again or check Redux configuration."});const F=o=>{if(!j)return"";if(o.includes(".")){const x=o.split(/\.|\[|\]/).filter(Boolean);let q=j;for(const e of x)if(Array.isArray(q)&&e.match(/^\d+$/)?q=q[parseInt(e)]:q=q==null?void 0:q[e],q==null)return"";return q}return j[o]||""};if(!g[m])return p.jsx(se,{severity:"error",children:"Invalid role specified"});const O=g[m].filter(o=>m==="student"&&o.name.includes("boardingDetails")?j.boardingStatus==="Boarder":!0);return p.jsxs(ee,{children:[p.jsxs(xe,{variant:"h4",children:[t?"Update":"Sign Up"," (",m.charAt(0).toUpperCase()+m.slice(1),")"]}),p.jsxs("form",{onSubmit:w,ref:H,children:[O.map(o=>p.jsx(ee,{mb:2,children:o.type==="select"?p.jsxs(De,{fullWidth:!0,children:[p.jsx(je,{children:o.label}),p.jsxs(Le,{name:o.name,value:F(o.name)||"",onChange:R,required:o.required,children:[!o.required&&p.jsx(U,{value:"",children:"None"}),o.name==="teachingAssignments[0].subject"?P.map(x=>p.jsx(U,{value:x.value,children:x.label},x.value)):o.options.map(x=>p.jsx(U,{value:x,children:x},x))]})]}):o.type==="file"?p.jsx(ee,{children:p.jsx("input",{type:"file",name:o.name,id:o.name,onChange:R,required:o.required,accept:"image/*",style:{display:"block",width:"100%"}})}):p.jsx(Be,{label:o.label,name:o.name,type:o.type,value:F(o.name),onChange:R,required:o.required,fullWidth:!0})},o.name)),_&&p.jsx(se,{severity:"error",children:_}),p.jsx(ve,{content:t?"Update":"Sign Up",submit:!0})]}),p.jsx(Se,{open:V,message:h,title:"User Registration Confirmation",onClose:v})]})};export{_e as S};
