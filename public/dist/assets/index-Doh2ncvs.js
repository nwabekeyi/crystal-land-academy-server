import{r as N,a as X,e as Y,G as be,H as pe,j as g,i as ge}from"./index-D_BFJj-0.js";import{u as fe}from"./useApi-DAb_JD3N.js";import{u as he,M as Ne}from"./MenuItem-i_3gn4dc.js";import{A as Ae,C as qe}from"./confirmationModal-JfczPszj.js";import{t as Ce}from"./modal-DeOsfxrp.js";import{j as ve,v as K,T as xe,Z as De,$ as Se,a0 as Le,y as je}from"./TextField-CTJJbsxV.js";import{A as k}from"./Alert-F-QKvef6.js";const y=m=>/^[0-9a-fA-F]{24}$/.test(m),Be=({role:m,selectedUser:s})=>{const[w,p]=N.useState(""),{callApi:G}=fe(),[W,O]=N.useState(!1),[Z,v]=N.useState(""),[z,f]=N.useState(!1),J=he(),j=X(l=>{var t;return((t=l.adminData)==null?void 0:t.usersData)||{students:[],teachers:[],admins:[]}}),x=X(l=>{var t;return((t=l.adminData)==null?void 0:t.classLevels)||[]}),D=X(l=>{var t;return((t=l.adminData)==null?void 0:t.subjects)||[]});console.log(x),N.useEffect(()=>{console.log("Redux state - users:",j,"classLevels:",x,"subjects:",D)},[j,x,D]);const[B,o]=N.useState({sections:[],classNames:[],subclasses:[]}),[E,q]=N.useState([]);N.useEffect(()=>{q(D.map(l=>({value:l._id,label:l.name})))},[D]);const h=(l={},t="currentClassLevel")=>{var e,c,A,I,T,R;const d=[...new Set(x.map(P=>P.section))],C=P=>x.filter(M=>M.section===P).map(M=>M.name),b=(P,M)=>{var $;return(($=x.find(F=>F.section===P&&F.name===M))==null?void 0:$.subclasses.map(F=>F.letter))||[]},u=t==="currentClassLevel"?((e=l.currentClassLevel)==null?void 0:e.section)||d[0]||"":((A=(c=l.teachingAssignments)==null?void 0:c[0])==null?void 0:A.section)||d[0]||"",n=t==="currentClassLevel"?((I=l.currentClassLevel)==null?void 0:I.className)||C(u)[0]||"":((R=(T=l.teachingAssignments)==null?void 0:T[0])==null?void 0:R.className)||C(u)[0]||"";return{sections:d,classNames:C(u),subclasses:b(u,n)}};N.useEffect(()=>{console.log("selectedUser:",s),s&&!y(s)&&(console.warn("Invalid selectedUser ID format:",s),p("Invalid user ID format"))},[s]);const[a,S]=N.useState({}),[_,U]=N.useState(null),ee=N.useRef(null),ae=l=>{var d,C,b,u;const t={};if(!Q[l])return console.error("Invalid role:",l),t;if(Q[l].forEach(n=>{if(n.name.includes("currentClassLevel")||n.name.includes("guardians")||n.name.includes("bankAccountDetails")||n.name.includes("teachingAssignments")){const[e,c,A]=n.name.split(/\.|\[|\]/).filter(Boolean);e==="guardians"||e==="teachingAssignments"?(t[e]=t[e]||[{}],t[e][0][c]=""):(t[e]=t[e]||{},t[e][c]="")}else t[n.name]=(n.type==="select","")}),l==="student"){const{sections:n,classNames:e,subclasses:c}=h(t,"currentClassLevel");t.currentClassLevel={section:n[0]||"",className:e[0]||"",subclass:c[0]||""},t.boardingStatus="Day Student"}else if(l==="teacher"){const{sections:n,classNames:e,subclasses:c}=h(t,"teachingAssignments");t.teachingAssignments=[{section:n[0]||"",className:e[0]||"",subclasses:[c[0]],subject:((d=D[0])==null?void 0:d._id)||""}]}if(s&&j&&y(s)){const n=l==="student"?(C=j.students)==null?void 0:C.find(e=>e._id===s):l==="teacher"?(b=j.teachers)==null?void 0:b.find(e=>e._id===s):(u=j.admins)==null?void 0:u.find(e=>e._id===s);n&&Object.keys(t).forEach(e=>{var c,A,I;e==="currentClassLevel"&&n[e]?t[e]={section:n[e].section||t.currentClassLevel.section,className:n[e].className||t.currentClassLevel.className,subclass:n[e].subclass||t.currentClassLevel.subclass}:e==="boardingDetails"&&n[e]?t[e]={hall:n[e].hall||"",roomNumber:n[e].roomNumber||"",bedNumber:n[e].bedNumber||"",houseMaster:n[e].houseMaster||""}:e==="guardians"&&((c=n[e])!=null&&c.length)?t[e]=[{name:n[e][0].name||"",relationship:n[e][0].relationship||"",phone:n[e][0].phone||"",email:n[e][0].email||"",address:n[e][0].address||""}]:e==="bankAccountDetails"&&n[e]?t[e]={accountName:n[e].accountName||"",accountNumber:n[e].accountNumber||"",bank:n[e].bank||""}:e==="teachingAssignments"&&((A=n[e])!=null&&A.length)?t[e]=[{section:n[e][0].section||t.teachingAssignments[0].section,className:n[e][0].className||t.teachingAssignments[0].className,subclasses:n[e][0].subclasses||t.teachingAssignments[0].subclasses,subject:((I=n[e][0].subject)==null?void 0:I._id)||t.teachingAssignments[0].subject}]:t[e]=n[e]||t[e]})}return t};N.useEffect(()=>{const l=ae(m);S(l),o(m==="student"?h(l,"currentClassLevel"):h(l,"teachingAssignments"))},[m,s,x,D]),N.useEffect(()=>{a&&o(m==="student"?h(a,"currentClassLevel"):h(a,"teachingAssignments"))},[a]);const Q={student:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!s,options:B.sections},{label:"Class Name",name:"currentClassLevel.className",type:"select",required:!s,options:B.classNames},{label:"Subclass",name:"currentClassLevel.subclass",type:"select",required:!s,options:B.subclasses},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!s,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!s},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!s},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!s},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s},{label:"Gender",name:"gender",type:"select",required:!s,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!s},{label:"Address",name:"address",type:"text",required:!s},{label:"Qualification",name:"qualification",type:"select",required:!s,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!s},{label:"Tribe",name:"tribe",type:"text",required:!s},{label:"Religion",name:"religion",type:"select",required:!s,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!s,options:B.sections},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"select",required:!s,options:B.classNames},{label:"Teaching Subclasses",name:"teachingAssignments[0].subclasses",type:"select",required:!s,options:B.subclasses},{label:"Subject",name:"teachingAssignments[0].subject",type:"select",required:!s,options:E.map(l=>l.label)},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!s},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!s},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!s},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!s},{label:"Last Name",name:"lastName",type:"text",required:!s},{label:"Email",name:"email",type:"email",required:!s},{label:"Profile Picture",name:"profilePicture",type:"file",required:!s}].filter(Boolean)};return{formRef:ee,formData:a,error:w,loading:z,handleChange:l=>{const{name:t,value:d,files:C}=l.target;if(t==="profilePicture")U(C[0]);else if(t.includes("currentClassLevel")){const[,b]=t.split(".");S(u=>{const n={...u.currentClassLevel,[b]:d};if(b==="section"){const{classNames:e,subclasses:c}=h({currentClassLevel:n},"currentClassLevel");n.className=e[0]||"",n.subclass=c[0]||""}else if(b==="className"){const{subclasses:e}=h({currentClassLevel:n},"currentClassLevel");n.subclass=e[0]||""}return{...u,currentClassLevel:n}})}else if(t.includes("teachingAssignments")){const[,b,u]=t.split(/\.|\[|\]/).filter(Boolean);S(n=>{const e=[...n.teachingAssignments||[{}]];if(u==="subclasses")e[0]={...e[0],[u]:[d]};else if(u==="subject"){const c=E.find(A=>A.label===d);e[0]={...e[0],[u]:(c==null?void 0:c.value)||""}}else e[0]={...e[0],[u]:d};if(u==="section"){const{classNames:c,subclasses:A}=h({teachingAssignments:[{...e[0],section:d}]},"teachingAssignments");e[0].className=c[0]||"",e[0].subclasses=[A[0]]}else if(u==="className"){const{subclasses:c}=h({teachingAssignments:[{...e[0],className:d}]},"teachingAssignments");e[0].subclasses=[c[0]]}return{...n,teachingAssignments:e}})}else if(t.includes("boardingDetails")){const[,b]=t.split(".");S(u=>({...u,boardingDetails:{...u.boardingDetails,[b]:d}}))}else if(t.includes("guardians")){const[,b,u]=t.split(/\.|\[|\]/).filter(Boolean);S(n=>{const e=[...n.guardians||[{}]];return e[0]={...e[0],[u]:d},{...n,guardians:e}})}else if(t.includes("bankAccountDetails")){const[,b]=t.split(".");S(u=>({...u,bankAccountDetails:{...u.bankAccountDetails,[b]:d}}))}else S(t==="boardingStatus"?b=>({...b,boardingStatus:d,boardingDetails:d==="Boarder"?b.boardingDetails||{}:void 0}):b=>({...b,[t]:d}))},handleSubmit:async l=>{var t,d,C,b,u,n,e,c,A,I,T,R,P,M,$,F,se,te,ne,ie,le,re,ue,oe,ce,me;if(l.preventDefault(),f(!0),p(""),s&&!y(s)){p("Invalid user ID format"),f(!1);return}if(s&&ee.current.querySelectorAll("[required]").forEach(r=>{r.removeAttribute("required")}),!s){if(!a.firstName||!a.lastName||!a.email||!a.gender){p("First name, last name, email, and gender are required"),f(!1);return}if(m==="student"){if(!((t=a.currentClassLevel)!=null&&t.section)||!((d=a.currentClassLevel)!=null&&d.className)||!((C=a.currentClassLevel)!=null&&C.subclass)){p("Class level section, class name, and subclass are required"),f(!1);return}if(!((u=(b=a.guardians)==null?void 0:b[0])!=null&&u.name)||!((e=(n=a.guardians)==null?void 0:n[0])!=null&&e.relationship)||!((A=(c=a.guardians)==null?void 0:c[0])!=null&&A.phone)){p("Guardian name, relationship, and phone are required"),f(!1);return}if(!["Boarder","Day Student"].includes(a.boardingStatus)){p("Boarding status must be 'Boarder' or 'Day Student'"),f(!1);return}if(a.boardingStatus==="Boarder"&&(!((I=a.boardingDetails)!=null&&I.hall)||!((T=a.boardingDetails)!=null&&T.roomNumber))){p("Boarding Hall and Room Number are required for Boarder students"),f(!1);return}}else if(m==="teacher"){if(!a.NIN||!a.address||!a.qualification||!a.phoneNumber||!a.tribe||!a.religion||!((P=(R=a.teachingAssignments)==null?void 0:R[0])!=null&&P.subject)||!((M=a.bankAccountDetails)!=null&&M.accountName)||!(($=a.bankAccountDetails)!=null&&$.accountNumber)||!((F=a.bankAccountDetails)!=null&&F.bank)||!((te=(se=a.teachingAssignments)==null?void 0:se[0])!=null&&te.section)||!((ie=(ne=a.teachingAssignments)==null?void 0:ne[0])!=null&&ie.className)||!((ue=(re=(le=a.teachingAssignments)==null?void 0:le[0])==null?void 0:re.subclasses)!=null&&ue.length)){p("All required teacher fields must be filled"),f(!1);return}if(!/^\d{11}$/.test(a.NIN)){p("NIN must be 11 digits"),f(!1);return}if(!/^\d{10}$/.test(a.bankAccountDetails.accountNumber)){p("Bank account number must be 10 digits"),f(!1);return}if(!a.teachingAssignments[0].subclasses.every(r=>/^[A-Z]$/.test(r))){p("Subclasses must be single uppercase letters"),f(!1);return}if(!y(a.teachingAssignments[0].subject)){p("Invalid subject ID"),f(!1);return}}if(!_){p("Profile picture is required"),f(!1);return}}try{const r=new FormData;Object.keys(a).forEach(i=>{var H,de;i==="currentClassLevel"&&a[i]?(r.append("currentClassLevel[section]",a[i].section||""),r.append("currentClassLevel[className]",a[i].className||""),r.append("currentClassLevel[subclass]",a[i].subclass||"")):i==="boardingDetails"&&a[i]&&a.boardingStatus==="Boarder"?(r.append("boardingDetails[hall]",a[i].hall||""),r.append("boardingDetails[roomNumber]",a[i].roomNumber||""),r.append("boardingDetails[bedNumber]",a[i].bedNumber||""),r.append("boardingDetails[houseMaster]",a[i].houseMaster||"")):i==="guardians"&&((H=a[i])!=null&&H.length)?(r.append("guardians[0][name]",a[i][0].name||""),r.append("guardians[0][relationship]",a[i][0].relationship||""),r.append("guardians[0][phone]",a[i][0].phone||""),r.append("guardians[0][email]",a[i][0].email||""),r.append("guardians[0][address]",a[i][0].address||"")):i==="bankAccountDetails"&&a[i]?(r.append("bankAccountDetails[accountName]",a[i].accountName||""),r.append("bankAccountDetails[accountNumber]",a[i].accountNumber||""),r.append("bankAccountDetails[bank]",a[i].bank||"")):i==="teachingAssignments"&&((de=a[i])!=null&&de.length)&&a[i][0].section?(r.append("teachingAssignments[0][section]",a[i][0].section||""),r.append("teachingAssignments[0][className]",a[i][0].className||""),r.append("teachingAssignments[0][subclasses]",JSON.stringify(a[i][0].subclasses||[])),r.append("subject",a[i][0].subject||"")):(!s||a[i]&&a[i]!==""&&i!=="boardingDetails")&&r.append(i,a[i])}),_&&r.append("profilePicture",_);for(let[i,H]of r.entries())console.log(`${i}: ${H}`);let V;s&&y(s)?V=m==="student"?`/api/students/${s}/update/admin`:`/api/teachers/teacher/${s}/update`:V=m==="student"?Y.CREATE_STUDENT:m==="teacher"?Y.CREATE_TEACHER:Y.CREATE_ADMIN;const L=await G(V,s?"PATCH":"POST",r,{"Content-Type":"multipart/form-data"});L&&L.data?(J(s?be({id:s,user:L.data,role:m}):pe({user:L.data,role:m})),v(`${L.data.firstName} ${L.data.lastName} has been successfully ${s?"updated":"registered"}`),S(ae(m)),U(null)):v(((oe=L==null?void 0:L.data)==null?void 0:oe.message)||"An error occurred"),O(!0)}catch(r){console.error("Error submitting form:",r),p(((me=(ce=r.response)==null?void 0:ce.data)==null?void 0:me.message)||"Failed to submit the form. Please try again.")}finally{f(!1)}},roleFields:Q,profilePicture:_,modalOpen:W,modalMessage:Z,setModalOpen:O}},ye=({role:m,selectedUser:s})=>{const w=ve();Ce(w.palette.mode);const{roleFields:p,error:G,loading:W,handleChange:O,handleSubmit:Z,formData:v,formRef:z,modalOpen:f,modalMessage:J,setModalOpen:j}=Be({role:m,selectedUser:s});console.log("SignUpForm - role:",m,"selectedUser:",s,"formData:",v);const x=()=>{j(!1)};if(W)return g.jsx(ge,{});if(!v||Object.keys(v).length===0)return g.jsx(k,{severity:"error",children:"Form data is not initialized. Please try again or check Redux configuration."});const D=o=>{if(!v)return"";if(o.includes(".")){const E=o.split(/\.|\[|\]/).filter(Boolean);let q=v;for(const h of E)if(Array.isArray(q)&&h.match(/^\d+$/)?q=q[parseInt(h)]:q=q==null?void 0:q[h],q===void 0)return"";return q}return v[o]||""};if(!p[m])return g.jsx(k,{severity:"error",children:"Invalid role specified"});const B=p[m].filter(o=>m==="student"&&o.name.includes("boardingDetails")?v.boardingStatus==="Boarder":!0);return g.jsxs(K,{children:[g.jsxs(xe,{variant:"h4",children:[s?"Update":"Sign Up"," (",m.charAt(0).toUpperCase()+m.slice(1),")"]}),g.jsxs("form",{onSubmit:Z,ref:z,children:[B.map(o=>g.jsx(K,{mb:2,children:o.type==="select"?g.jsxs(De,{fullWidth:!0,children:[g.jsx(Se,{children:o.label}),g.jsx(Le,{name:o.name,value:D(o.name),onChange:O,required:o.required,children:o.options.map(E=>g.jsx(Ne,{value:E,children:E},E))})]}):o.type==="file"?g.jsx(K,{mb:2,children:g.jsx("input",{type:"file",name:o.name,id:o.name,onChange:O,required:o.required,accept:"image/*",style:{display:"block",width:"100%"}})}):g.jsx(je,{label:o.label,name:o.name,type:o.type,value:D(o.name),onChange:O,required:o.required,fullWidth:!0})},o.name)),G&&g.jsx(k,{severity:"error",children:G}),g.jsx(Ae,{content:s?"Update":"Sign Up",submit:!0})]}),g.jsx(qe,{open:f,message:J,title:"User Registration Confirmation",onClose:x})]})};export{ye as S};
