import{r as l,a as q,j as s,f as p}from"./index-BgVW12L4.js";import{H as J}from"./Header-CogA_8fZ.js";import{C as K}from"./accordion-D5e2Uz4A.js";import{G as T,U as Q}from"./index-CjZWgTm8.js";import{t as X,D as Z,a as ee,b as se,c as te}from"./modal-BA-eVLt_.js";import{w as ae}from"./dasboardPagesContainer-p6UpWRgj.js";import{u as oe}from"./useApi-TIUFMcqH.js";import{j as ne,v as x,T as f,a1 as re,a2 as le,a3 as ce,y as ie,x as U}from"./TextField-NDbbILhh.js";import{M as L}from"./MenuItem-B4LKlkvK.js";import"./useSlot-DfBjlVf_.js";import"./confirmationModal-CMKhpNuH.js";import"./CircularProgress-ELwt6FEm.js";import"./IconButton-4sz3Qd6x.js";import"./index-D41-9XSs.js";import"./loadingButton-DGhAAS35.js";import"./crystal-land-log-removebg-DVF-nlbN.js";const de=()=>{const G=ne();X(G.palette.mode);const{loading:D,callApi:u}=oe(),[C,Y]=l.useState([]),[W,h]=l.useState([]),[n,k]=l.useState(""),[i,v]=l.useState(null),[H,R]=l.useState(!1),[A,w]=l.useState(""),[b,$]=l.useState(""),[M,o]=l.useState(""),[d,F]=l.useState(""),[m,B]=l.useState(""),c=q(e=>{var t,a;return((a=(t=e.users)==null?void 0:t.user)==null?void 0:a._id)||""});l.useEffect(()=>{(async()=>{if(!c){o("Teacher ID not found. Please log in again.");return}try{const t=await u(p.CURRENT_ACADEMIC_YEAR,"GET");t.status==="success"?F(t.data._id):o("Error fetching academic year");const a=await u(p.CURRENT_ACADEMIC_TERM,"GET");a.status==="success"?B(a.data._id):o("Error fetching academic term")}catch(t){o(`Error fetching academic data: ${t.message}`)}})()},[u,c]),l.useEffect(()=>{(async()=>{if(!(!d||!m||!c))try{const t=await u(`${p.CLASS_LEVEL}/teacher/${c}?academicYearId=${d}&academicTermId=${m}`,"GET");t.status==="success"&&Array.isArray(t.data.assignedClasses)?(Y(t.data.assignedClasses.map(a=>{var I,E,j,y,S;const r=a.name.split(" ")[1]||a.name;return{classId:a._id,name:`${a.section} ${r}${((I=a.subclasses[0])==null?void 0:I.letter)||""}`,session:((E=a.academicYear)==null?void 0:E.name)||"2024-2025",term:((S=(y=(j=a.academicTerm)==null?void 0:j.terms)==null?void 0:y.find(g=>g.isCurrent))==null?void 0:S.name)||"First Term"}})),console.log("classes:",t.data.assignedClasses)):o("Error fetching classes or no classes found")}catch(t){o(`Error fetching classes: ${t.message}`)}})()},[u,d,m,c]),l.useEffect(()=>{(async()=>{if(!n||!d||!m||!c){h([]),o("Please select a valid class"),console.log("Missing dependencies:",{selectedClass:n,academicYearId:d,academicTermId:m,teacherId:c});return}try{const t=C.find(V=>V.classId===n);if(!t){o("Selected class not found in classes list"),h([]),console.log("Class not found for classId:",n);return}const a=t.name;console.log("selectedClass:",n,"classNameString:",a);const r=a.match(/([\w\s-]+)\s(\d+)(\w*)/);if(console.log("match result:",r),!r){o("Invalid class format. Expected format: 'Section Number[Letter]' (e.g., 'Primary 6A')"),h([]);return}const[I,E,j]=r.slice(1),y=I.replace(/\s+/g,"-"),S=`${p.GET_A_TEACHER}/students/${y}/${I}%20${E}/${j}?academicYearId=${d}&academicTermId=${m}&teacherId=${c}`;console.log("API URL:",S);const g=await u(S,"GET");g.status==="success"&&Array.isArray(g.data.students)?(h(g.data.students),console.log("API called, students:",g.data.students),o("")):o("Error fetching students: Invalid response format")}catch(t){o(`Error fetching students: ${t.message}`),h([])}})()},[n,C,u,d,m,c]);const O=async()=>{if(!b.trim()){o("Comment cannot be empty");return}if(!i||i.classId!==n){o("Selected student is not in the chosen class"),console.log("Validation failed:",{selectedStudent:i,selectedClass:n});return}if(!i.studentId){o("Student ID not found"),console.log("Missing studentId in selectedStudent:",i);return}try{const e={studentId:i.studentId,classLevelId:n,comment:b};console.log("Comment API payload:",e),console.log("Comment API URL:",`${p.GET_A_TEACHER}/comment?academicYearId=${d}&academicTermId=${m}&teacherId=${c}`),console.log("Selected student full object:",i);const t=await u(`${p.GET_A_TEACHER}/comment?academicYearId=${d}&academicTermId=${m}&teacherId=${c}`,"POST",e);t.status==="success"?(h(a=>a.map(r=>r.studentId===i.studentId?{...r,comment:t.data.comment}:r)),o("Comment posted successfully!"),N()):(o(`Error posting comment: ${t.message||"Unknown error"}`),console.log("Comment API response:",t))}catch(e){o(`Error posting comment: ${e.message}`),console.log("Comment API error:",e)}},z=e=>{var t,a;return{role:"student",firstName:e.firstName,lastName:e.lastName,email:e.email,phoneNumber:e.phoneNumber||"N/A",profilePictureUrl:e.profilePicture,studentId:e.studentId,currentClassLevel:{className:((t=C.find(r=>r.classId===n))==null?void 0:t.name)||"Unknown",subclass:((a=C.find(r=>r.classId===n))==null?void 0:a.name.split(" ")[2])||""},rating:parseFloat(e.activityRate)||0,viewedByRole:"teacher",address:e.address||"N/A",gender:e.gender||"N/A",tribe:e.tribe||"N/A",religion:e.religion||"N/A",dob:e.dob||"N/A",boardingStatus:e.boardingStatus||"N/A",boardingDetails:e.boardingDetails||null}},P=W.filter(e=>!n||e.classId===n),_=(e,t)=>{v(e),w(t),$(e.comment||""),R(!0)},N=()=>{R(!1),v(null),w(""),$("")};return s.jsxs(x,{children:[s.jsx(T,{item:!0,xs:12,children:s.jsx(J,{title:"TEACHER STUDENT MANAGEMENT",subtitle:"Manage Students in Your Classes"})}),M&&s.jsx(f,{color:"error",mb:"20px",children:M}),D&&s.jsx(f,{children:"Loading..."}),s.jsx(x,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",children:s.jsxs(re,{sx:{minWidth:150},children:[s.jsx(le,{id:"class-select-label",children:"Class"}),s.jsxs(ce,{labelId:"class-select-label",value:n,label:"Class",onChange:e=>k(e.target.value),children:[s.jsx(L,{value:"",children:"All Classes"}),C.filter(e=>e.session==="2024-2025"&&e.term==="First Term").map(e=>s.jsx(L,{value:e.classId,children:e.name},e.classId))]})]})}),s.jsx(T,{container:!0,spacing:2,children:P.length?P.map(e=>s.jsx(T,{item:!0,xs:12,md:6,children:s.jsx(K,{title:`${e.firstName} ${e.lastName}`,details:s.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",width:"100%"},children:[s.jsx(x,{sx:{flex:1,pr:2},children:s.jsx("img",{src:e.profilePicture,alt:"Profile",style:{maxWidth:"100%",height:"100%",borderRadius:"10px",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)"}})}),s.jsxs(x,{sx:{flex:2,textAlign:"left"},children:[s.jsx(f,{variant:"h4",fontWeight:"bold",color:"text.primary",gutterBottom:!0,children:`${e.firstName} ${e.lastName}`}),s.jsxs(f,{variant:"body1",color:"text.secondary",sx:{fontSize:"0.8rem",mt:1},children:[s.jsxs("span",{style:{fontWeight:"bold",color:"#555"},children:["Student ID:"," "]}),e.studentId]}),s.jsxs(f,{variant:"body1",color:"text.secondary",sx:{fontSize:"0.8rem",mt:1},children:[s.jsxs("span",{style:{fontWeight:"bold",color:"#555"},children:["Email:"," "]}),e.email]}),s.jsxs(f,{variant:"body1",color:"text.secondary",sx:{fontSize:"0.8rem",mt:1},children:[s.jsxs("span",{style:{fontWeight:"bold",color:"#555"},children:["Comment:"," "]}),e.comment||"No comment"]})]})]}),actions:[{label:"View Details",onClick:()=>_(e,"details")},{label:"Add Comment",onClick:()=>_(e,"comment")}],defaultExpanded:!1})},e.studentId)):s.jsx(T,{item:!0,xs:12,children:s.jsx(f,{children:"No students found for the selected class."})})}),s.jsxs(Z,{open:H,onClose:N,children:[s.jsx(ee,{children:A==="details"?"Student Details":"Add Comment"}),s.jsx(se,{children:i&&s.jsxs(x,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[A==="details"&&s.jsx(Q,{userDetails:z(i)}),A==="comment"&&s.jsx(ie,{label:"Comment",value:b,onChange:e=>$(e.target.value),multiline:!0,rows:4,fullWidth:!0})]})}),s.jsxs(te,{children:[s.jsx(U,{onClick:N,children:"Cancel"}),A==="comment"&&s.jsx(U,{onClick:O,color:"primary",disabled:!b||D,children:"Save"})]})]})]})},$e=ae(de);export{$e as default};
