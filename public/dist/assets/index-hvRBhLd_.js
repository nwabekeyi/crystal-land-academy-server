import{j as e,r as s,a as Q,f as W}from"./index-DXxzwwbK.js";import{T as ge}from"./table-B5qBbUP7.js";import{r as fe,M as X,t as he}from"./modal-Ci5iPumC.js";import{D as ie,G as g,h as xe,E as ye}from"./index-F6-XIzxz.js";import{c as Pe,v,T as r,x as je,q as Ce,y as be,a1 as Se,a2 as ve,a3 as Ae,j as Ie}from"./TextField-C1UIQ2nv.js";import{H as ce}from"./Header-Dfg-LaqG.js";import{w as De}from"./dasboardPagesContainer-tlH_EIyF.js";import{A as Ne}from"./actionButton-DwAij9aY.js";import{u as de}from"./useApi-DVdT1N_3.js";import{C as we}from"./CircularProgress-BGFInVhb.js";import{M as le}from"./MenuItem-DEndFJiM.js";import{L as Ee}from"./LinearProgress-DQWGhAPI.js";import{I as Re}from"./IconButton-DhOWqksS.js";import"./useMediaQuery-Dk1-EYYS.js";import"./index-Bd97VqvA.js";import"./loadingButton-B9XNayDD.js";import"./confirmationModal-HQTZ8uES.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-B3K9JRnK.js";const Me=Pe(e.jsx("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility"),ke=({receipt:t})=>{const o=s.useRef(),R=async()=>{if(o.current)try{const i=await xe(o.current,{useCORS:!0}),m=i.toDataURL("image/png"),y=new ye("portrait","px","a4"),A=y.internal.pageSize.getWidth(),M=i.height*A/i.width;y.addImage(m,"PNG",0,0,A,M),y.save(`receipt_${t.transactionId}.pdf`)}catch(i){console.error("Error generating PDF:",i)}};return e.jsxs(v,{ref:o,sx:{padding:"20px",maxWidth:"500px",margin:"auto",backgroundColor:"#fff",color:"#000",borderRadius:"10px",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",fontFamily:"Arial, sans-serif"},children:[e.jsx(r,{variant:"h6",align:"center",gutterBottom:!0,children:"Crystal land academy"}),e.jsx(r,{variant:"subtitle2",align:"center",gutterBottom:!0,children:"Payment Receipt"}),e.jsx(ie,{sx:{my:2}}),e.jsxs(g,{container:!0,spacing:2,children:[e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Transaction ID:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsx(r,{children:t.transactionId})}),e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Student Name:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsx(r,{children:t.userName})}),e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Program:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsx(r,{children:t.program})}),e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Amount Paid:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsxs(r,{children:["â‚¦",t.amount.toFixed(2)]})}),e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Status:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsx(r,{children:t.status})}),e.jsx(g,{item:!0,xs:6,children:e.jsx(r,{fontWeight:"bold",children:"Date:"})}),e.jsx(g,{item:!0,xs:6,align:"right",children:e.jsx(r,{children:t.date})})]}),e.jsx(ie,{sx:{my:2}}),e.jsx(r,{variant:"body2",align:"center",children:"Thank you for your payment!"}),e.jsx(je,{variant:"contained",color:"primary",fullWidth:!0,onClick:R,sx:{mt:2},children:"Download Receipt"})]})};var Z={},_e=Ce;Object.defineProperty(Z,"__esModule",{value:!0});var me=Z.default=void 0,Ye=_e(fe()),Oe=e;me=Z.default=(0,Ye.default)((0,Oe.jsx)("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"Payment");const Te=({onSuccess:t=()=>{},studentId:o,classLevelId:R,academicYears:i=[],defaultAcademicYear:m,termName:y,subclassLetter:A,section:M,email:k})=>{const[L,f]=s.useState(!1),[q,w]=s.useState(!1),[u,H]=s.useState(""),[P,Y]=s.useState(m||""),[O,_]=s.useState("Current Academic Year"),J="pk_test_8293ca0c4f5b0e4b8da1dad753cbc602cebade30",{callApi:T}=de(),j=Q(d=>d.adminData.currentAcademicYear);if(s.useEffect(()=>{const d=async()=>{var C;if(!i.length&&m)try{const c=await T(`${W.ACADEMICYEARS_ID}/${m}`,"GET");console.log("Default academic year response:",JSON.stringify(c,null,2)),c&&c.data&&c.data.name?_(c.data.name):(console.warn("Invalid default academic year response:",c),_("Current Academic Year"))}catch(c){console.error("Error fetching default academic year name:",((C=c.response)==null?void 0:C.data)||c.message),_("Current Academic Year")}};!i.length&&m&&(j==null?void 0:j._id)===m?_(j.name||"Current Academic Year"):!i.length&&m&&d()},[i,m,j,T]),console.log("PaystackButton props:",JSON.stringify({studentId:o,classLevelId:R,academicYears:i,defaultAcademicYear:m,defaultAcademicYearName:O,selectedAcademicYear:P,termName:y,subclassLetter:A,section:M,email:k},null,2)),!i.length&&!m)return console.error("PaystackButton: academicYears prop is empty and no defaultAcademicYear"),e.jsx(r,{color:"error",children:"Error: No academic years available"});const F=()=>{w(!0)},E=()=>{w(!1)},I=()=>{if(!u||parseFloat(u)<=0){alert("Please enter a valid amount");return}if(!P){alert("Please select an academic year");return}B(),E()},B=()=>{var d;f(!0);try{window.PaystackPop.setup({key:J,email:k||"user@example.com",currency:"NGN",amount:parseFloat(u)*100,metadata:{custom_fields:[{display_name:"Payment Purpose",variable_name:"payment_purpose",value:"School Fees"},{display_name:"Academic Year",variable_name:"academic_year",value:((d=i.find(c=>c.academicYearId===P))==null?void 0:d.name)||O||"Unknown"}]},onClose:()=>{console.log("Payment dialog closed"),f(!1)},callback:c=>{console.log("Paystack callback triggered:",c);const b=c.reference;if(!u||isNaN(u)){console.error("Invalid payment amount:",u),alert("Invalid payment amount"),f(!1);return}if(!b){console.error("Missing transaction reference:",c),alert("Missing transaction reference"),f(!1);return}if(!P){console.error("Missing selected academic year"),alert("Please select an academic year"),f(!1);return}const S={studentId:o,classLevelId:R,academicYear:P,section:M,termPayments:[{termName:y,subclassLetter:A,payments:[{amountPaid:parseFloat(u)*100,method:"Card",reference:b,status:"success",datePaid:new Date().toISOString()}]}]};console.log("Payload being sent to backend:",JSON.stringify(S,null,2)),console.log("Payload academicYear:",S.academicYear),T(W.PAYMENT,"POST",S).then(h=>{if(console.log("Transaction registered successfully:",h),h&&h.data)t({...h.data,amount:parseFloat(u)*100,reference:b,academicYear:P});else throw new Error("Invalid backend response")}).catch(h=>{var $,G,U;console.error("Failed to register transaction:",(($=h.response)==null?void 0:$.data)||h.message),alert(`Payment failed: ${((U=(G=h.response)==null?void 0:G.data)==null?void 0:U.message)||"Unknown error"}`)}).finally(()=>{f(!1),H(""),Y(m||"")})}}).openIframe()}catch(C){console.error("Error initializing Paystack payment:",C),alert("Failed to initialize payment. Please try again."),f(!1)}};return e.jsxs(v,{children:[e.jsx(Ne,{icon:e.jsx(me,{}),disabled:L,onClick:F,content:L?e.jsx(we,{size:24}):"Pay Now"}),e.jsxs(X,{open:q,onClose:E,title:"Enter Payment Details",onConfirm:I,confirmMessage:"Proceed with Payment",children:[e.jsx(be,{label:"Amount (Naira)",type:"number",value:u,onChange:d=>H(d.target.value),fullWidth:!0,error:!u||parseFloat(u)<=0,helperText:u?parseFloat(u)<=0?"Amount must be greater than 0":"":"Amount is required",sx:{mb:2}}),e.jsxs(Se,{fullWidth:!0,children:[e.jsx(ve,{id:"academic-year-label",children:"Academic Year"}),e.jsx(Ae,{labelId:"academic-year-label",value:P,label:"Academic Year",onChange:d=>Y(d.target.value),children:i.length>0?i.map(d=>e.jsx(le,{value:d.academicYearId,children:d.name},d.academicYearId)):e.jsx(le,{value:m,children:O})})]})]})]})},Fe=()=>{var ae,te,re,se,ne;const t=Q(a=>a.users.user),o=Q(a=>a.adminData.currentAcademicYear),R=Ie(),i=he(R.palette.mode),[m,y]=s.useState([]),[A,M]=s.useState(0),[k,L]=s.useState(10),[f,q]=s.useState("datePaid"),[w,u]=s.useState("asc"),[H,P]=s.useState(!1),[Y,O]=s.useState(null),[_,J]=s.useState(!1),[T,j]=s.useState(0),[F,E]=s.useState(0),[I,B]=s.useState([]),[d,C]=s.useState("Current Academic Year"),[c,b]=s.useState(""),{callApi:S}=de();s.useEffect(()=>{console.log("User object:",JSON.stringify(t,null,2)),console.log("Current academic year from Redux:",JSON.stringify(o,null,2)),console.log("Academic years endpoint:",W.ACADEMICYEARS_ID),(async()=>{var n,D,N;try{const l=await S(W.ACADEMICYEARS_ID,"GET");console.log("Academic years response:",JSON.stringify(l,null,2)),l&&Array.isArray(l.data)?(B(l.data),l.data.length===0&&(console.warn("Academic years response is empty"),b("No academic years available. Using default academic year."))):(console.warn("Invalid academic years response:",l),b("Failed to load academic years. Using default academic year."),B([]))}catch(l){console.error("Error fetching academic years:",((n=l.response)==null?void 0:n.data)||l.message),b(`Error fetching academic years: ${((N=(D=l.response)==null?void 0:D.data)==null?void 0:N.message)||l.message}`),B([])}})()},[S]),s.useEffect(()=>{const a=async()=>{var D,N,l,p;const n=((D=I.find(x=>x.isCurrent))==null?void 0:D.academicYearId)||(o==null?void 0:o._id)||((l=(N=t==null?void 0:t.currentClassLevel)==null?void 0:N.academicYear)==null?void 0:l.academicYearId)||"";if(!I.length&&n)try{const x=await S(`${endpoint.ACADEMICYEARS_ID}/${n}`,"GET");console.log("Default academic year response:",JSON.stringify(x,null,2)),x&&x.data&&x.data.name?C(x.data.name):C("Current Academic Year")}catch(x){console.error("Error fetching default academic year name:",((p=x.response)==null?void 0:p.data)||x.message),C("Current Academic Year")}};!I.length&&(o!=null&&o.name)?C(o.name):!I.length&&V&&a()},[I,o,t,S]),s.useEffect(()=>{(async()=>{var D,N,l;if(!(t!=null&&t._id)){console.warn("No user ID available, skipping payment records fetch"),b("User not authenticated. Please log in again.");return}const n=`${W.PAYMENT}?studentId=${t._id}&page=${A+1}&limit=${k}&sortBy=${f}&sortDirection=${w}`;console.log(`Fetching payment records from: ${n}`);try{const p=await S(n,"GET");if(console.log("Payment records response:",JSON.stringify(p,null,2)),p&&Array.isArray(p.data)){const x=p.data.flatMap(K=>{var oe;return((((oe=K.termPayments)==null?void 0:oe[0])||{}).payments||[]).map(z=>({reference:z.reference,amountPaid:z.amountPaid,datePaid:z.datePaid,status:z.status||K.status,originalReceipt:K}))});y(x),j(p.totalOutstanding||0),E(p.totalPaid||0)}else console.warn("Invalid payment records response:",p),b("No payment records found."),y([]),j(0),E(0)}catch(p){console.error("Error fetching payment records:",((D=p.response)==null?void 0:D.data)||p.message),b(`Error fetching payment records: ${((l=(N=p.response)==null?void 0:N.data)==null?void 0:l.message)||p.message}`),y([]),j(0),E(0)}})()},[A,k,f,w,S,t==null?void 0:t._id]);const h=T+F,$=h>0?F/h*100:0,G=a=>{const n=f===a&&w==="asc";q(a),u(n?"desc":"asc")},U=a=>{O(a),P(!0)},ue=a=>{console.log("Payment details:",JSON.stringify(a,null,2)),y(n=>[a,...n]),E(n=>n+a.amount),j(n=>n-a.amount),J(!0)},V=((ae=I.find(a=>a.isCurrent))==null?void 0:ae.academicYearId)||(o==null?void 0:o._id)||((re=(te=t==null?void 0:t.currentClassLevel)==null?void 0:te.academicYear)==null?void 0:re.academicYearId)||"";if(!V)return console.error("Cannot render PaystackButton: No default academicYearId found"),e.jsxs(v,{children:[e.jsx(ce,{title:"Payment History",subtitle:"Overview of Payments Made"}),e.jsx(r,{color:"error",children:c||"Error: Academic year information is missing. Please contact support."})]});const ee={onSuccess:ue,studentId:t._id,classLevelId:t.classLevelId,academicYears:I,defaultAcademicYear:V,defaultAcademicYearName:d,section:(se=t.currentClassLevel)==null?void 0:se.section,termName:"1st Term",subclassLetter:(ne=t.currentClassLevel)==null?void 0:ne.subclass,email:t.email||"user@example.com"};console.log("PaystackButton props:",JSON.stringify(ee,null,2));const pe={columns:[{id:"sn",label:"S/N",flex:.3,renderCell:(a,n)=>e.jsx(r,{children:n+1})},{id:"reference",label:"Transaction ID",flex:1,renderCell:a=>e.jsx(r,{children:a.reference||"N/A"})},{id:"amountPaid",label:"Amount (â‚¦)",flex:1,renderCell:a=>e.jsxs(r,{children:["â‚¦",(a.amountPaid/100).toFixed(2)]})},{id:"status",label:"Status",flex:1,renderCell:a=>e.jsx(r,{children:a.status?a.status.charAt(0).toUpperCase()+a.status.slice(1):"N/A"})},{id:"datePaid",label:"Date",flex:1,renderCell:a=>e.jsx(r,{children:a.datePaid?new Date(a.datePaid).toLocaleDateString():"N/A"})},{id:"actions",label:"Actions",flex:1,renderCell:a=>e.jsx(v,{display:"flex",gap:"10px",children:e.jsx(Re,{onClick:()=>U(a.originalReceipt),children:e.jsx(Me,{})})})}],tableHeader:"Payment Records",data:m,sortBy:f,sortDirection:w,onSortChange:G,page:A,rowsPerPage:k,onPageChange:(a,n)=>M(n),onRowsPerPageChange:a=>L(parseInt(a.target.value,10)),onRowClick:a=>console.log("Row clicked:",a),hiddenColumnsSmallScreen:["status","reference"]};return e.jsxs(v,{children:[e.jsx(ce,{title:"Payment History",subtitle:"Overview of Payments Made"}),e.jsxs(v,{backgroundColor:i.primary[400],p:"20px",borderRadius:"4px",children:[e.jsx(r,{variant:"h5",fontWeight:"600",mb:"15px",children:"Payment Summary"}),c&&e.jsx(r,{color:"error",mb:"15px",children:c}),e.jsxs(v,{mb:"20px",children:[e.jsxs(v,{sx:{display:"flex",alignItems:"end",marginBottom:"15px",justifyContent:"space-between",width:"100%"},children:[e.jsxs(v,{children:[e.jsxs(r,{variant:"h6",mb:"5px",children:["Total Amount Due: â‚¦",(h/100).toFixed(2)]}),e.jsxs(r,{variant:"h6",mb:"5px",children:["Total Paid: â‚¦",(F/100).toFixed(2)]}),e.jsxs(r,{variant:"h6",children:["Payment Percentage: ",$.toFixed(2),"%"]})]}),e.jsx(v,{children:e.jsx(Te,{...ee})})]}),e.jsx(Ee,{variant:"determinate",value:$,sx:{height:10,borderRadius:5,backgroundColor:i.grey[300],"& .MuiLinearProgress-bar":{backgroundColor:i.greenAccent[500]}}})]}),e.jsx(ge,{...pe}),e.jsx(X,{open:_,onClose:()=>J(!1),title:"Payment Successful",noConfirm:!0,children:e.jsx(r,{variant:"h6",align:"center",color:"green",children:"Your payment was successful!"})}),e.jsx(X,{open:H,onClose:()=>P(!1),title:"Receipt Details",noConfirm:!0,children:Y&&e.jsx(ke,{receipt:Y})})]})]})},oa=De(Fe);export{oa as default};
