import{j as e,a as Ye,r,f as ce,i as Qe}from"./index-BgVW12L4.js";import{M as Ce,t as Se}from"./modal-BA-eVLt_.js";import{F as Ke,a as Xe,b as et}from"./main-C3qW2AYZ.js";import{H as tt}from"./Header-CogA_8fZ.js";import{A as Fe}from"./actionButton-Bx_NG6Vl.js";import{d as ft}from"./CheckCircle-gUBwIDHI.js";import{v as ee,T as v,j as Ee,a1 as ne,a3 as ae,a2 as re,y as $e,x as ht}from"./TextField-NDbbILhh.js";import{u as se}from"./useApi-TIUFMcqH.js";import{u as Pe}from"./useMediaQuery-DmlQxk2V.js";import{C as st}from"./confirmationModal-CMKhpNuH.js";import{A as gt}from"./index-CjZWgTm8.js";import{M as O}from"./MenuItem-B4LKlkvK.js";import{w as bt}from"./dasboardPagesContainer-p6UpWRgj.js";import"./IconButton-4sz3Qd6x.js";import"./index-D41-9XSs.js";import"./loadingButton-DGhAAS35.js";import"./CircularProgress-ELwt6FEm.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-DfBjlVf_.js";const xt=({open:j,onClose:U,timetable:n,classLevelData:o,subjectNamesCache:t,onMarkAttendance:p})=>{const h=new Date("2025-08-03T21:13:00+01:00"),W=()=>{if(!n||!n.start)return console.warn("Missing timetable or start date:",n),!1;try{const s=new Date(n.start);return isNaN(s.getTime())?(console.warn("Invalid start date:",n.start),!1):s<=h}catch(s){return console.warn("Error parsing start date:",n.start,s),!1}},$=s=>{var y,b;return s?typeof s=="string"?((b=(y=o==null?void 0:o.data)==null?void 0:y.find(q=>q._id.toString()===s.toString()))==null?void 0:b.name)||"N/A":s.name||"N/A":"N/A"},N=s=>{var y,b;return s?typeof s=="string"?((b=(y=o==null?void 0:o.data)==null?void 0:y.find(q=>q._id.toString()===s.toString()))==null?void 0:b.section)||"N/A":s.section||"N/A":"N/A"},S=s=>{var y;return s?typeof s=="string"?t[s]||"Unknown":t[s.name]||((y=s.name)==null?void 0:y.name)||"Unknown":"Unknown"},g=s=>!s||typeof s=="string"?"No Teacher":`${s.firstName||""} ${s.lastName||""}`.trim()||"No Teacher";console.log("ViewTimetableModal timetable:",n);const P=W();return e.jsx(Ce,{open:j,onClose:U,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:n?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Class Level:"})," ",$(n.classLevel)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Section:"})," ",N(n.classLevel)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subclass:"})," ",n.subclassLetter||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subject:"})," ",S(n.subject)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Day of Week:"})," ",n.dayOfWeek||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Start Time:"})," ",n.startTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"End Time:"})," ",n.endTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",n.numberOfPeriods||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Location:"})," ",n.location||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Teacher:"})," ",g(n.teacher)]}),n.start&&e.jsxs(v,{children:[e.jsx("strong",{children:"Event Date:"})," ",new Date(n.start).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:"Africa/Lagos"})]}),p&&e.jsx(Fe,{content:"Mark Attendance",icon:e.jsx(ft,{}),onClick:p,disabled:!P})]}):e.jsx(v,{children:"No timetable details available"})})},ct=["Monday","Tuesday","Wednesday","Thursday","Friday"],jt=({userId:j})=>{var I;const U=Ee();Se(U.palette.mode);const n=Ye(_=>_.users.user),[o,t]=r.useState([]),[p,h]=r.useState(!1),[W,$]=r.useState(!1),[N,S]=r.useState(""),[g,P]=r.useState(null),[s,y]=r.useState({}),{loading:b,error:q,callApi:H,data:i}=se(),{loading:a,error:te}=se();r.useEffect(()=>{let _=!0;const u=async()=>{try{const C=await H(`${ce.TIMETABLE}/student/${n._id}`,"GET");_&&(C!=null&&C.data)&&C.status==="success"?t(C.data||[]):(console.error("Failed to fetch timetables:",C),_&&(S("Failed to load timetable data"),$(!0)))}catch(C){console.error("Error fetching timetables:",C),_&&(S("Error loading timetable: "+(C.message||"Unknown error")),$(!0))}};return n._id&&u(),()=>{_=!1}},[H,n._id]);const V=r.useMemo(()=>!o||!o.length?[]:Promise.all(o.map(async u=>{var R,be,Te,Me,Ae,ye,Le,ue;if(!u||!u.dayOfWeek)return console.warn(`Invalid timetable or dayOfWeek for ID: ${u==null?void 0:u._id}`),null;const C=ct.indexOf(u.dayOfWeek);if(C===-1)return console.warn(`Invalid dayOfWeek: ${u.dayOfWeek} for timetable ID: ${u._id}`),null;const D=C+1,Y=`${u.startTime||"00:00"}:00`,fe=u.endTime?`${u.endTime}:00`:`${new Date(`1970-01-01T${u.startTime}:00Z`).setMinutes(new Date(`1970-01-01T${u.startTime}:00Z`).getMinutes()+(u.numberOfPeriods||1)*45).toISOString().slice(11,16)}:00`,pe=(R=u.subject)==null?void 0:R.name._id,me=u.subject.name.name;return{id:u._id,title:`${me} (${u.location||"N/A"})`,daysOfWeek:[D],startTime:Y,endTime:fe,extendedProps:{classLevel:((be=u.classLevel)==null?void 0:be._id)||u.classLevel||"",classLevelName:((Te=u.classLevel)==null?void 0:Te.name)||"N/A",subclassLetter:u.subclassLetter||"",subject:pe||"",subjectName:me,teacher:((Me=u.teacher)==null?void 0:Me._id)||u.teacher||null,teacherName:u.teacher&&`${u.teacher.firstName||""} ${u.teacher.lastName||""}`.trim()||"No Teacher Assigned",dayOfWeek:u.dayOfWeek,startTime:u.startTime||"",numberOfPeriods:u.numberOfPeriods||1,location:u.location||"",attendanceStatus:((ue=(Le=(ye=(Ae=u.periodAttendance)==null?void 0:Ae[0])==null?void 0:ye.attendance)==null?void 0:Le.find(Ne=>Ne.studentId.toString()===j))==null?void 0:ue.status)||"N/A"}}})).then(u=>u.filter(C=>C!==null)).catch(u=>(console.error("Error processing calendar events:",u),S("Failed to process timetable events"),$(!0),[])),[o,j]),[X,le]=r.useState([]),[E,G]=r.useState(!0),[m,Z]=r.useState(null);r.useEffect(()=>{let _=!0;return G(!0),Z(null),V&&typeof V.then=="function"?V.then(u=>{_&&(le(Array.isArray(u)?u:[]),G(!1))}).catch(u=>{console.error("Error resolving calendar events:",u),_&&(Z("Failed to load calendar events"),G(!1))}):_&&(le(Array.isArray(V)?V:[]),G(!1)),()=>{_=!1}},[V]);const oe=r.useCallback(_=>{const u=o.find(C=>C._id===_.event.id);u&&(P(u),h(!0))},[o]),ie=b||a||E,ge=(i==null?void 0:i.status)==="failed"?i.message:q||te||m,J=r.useMemo(()=>{var _;return{data:n.classLevelId?[{_id:n.classLevelId,name:((_=n.currentClassLevel)==null?void 0:_.className)||"N/A"}]:[]}},[n.classLevelId,(I=n.currentClassLevel)==null?void 0:I.className]),je=r.useMemo(()=>!o||!o.length?{data:[]}:{data:o.map(_=>{var u,C;return{_id:((u=_.subject)==null?void 0:u._id)||_.subject,name:s[((C=_.subject)==null?void 0:C._id)||_.subject]||"Unknown"}}).filter((_,u,C)=>C.findIndex(D=>{var Y,fe;return((Y=D._id)==null?void 0:Y.toString())===((fe=_._id)==null?void 0:fe.toString())})===u)},[o,s]),k=r.useMemo(()=>{if(!o||!o.length)return{data:[{_id:null,name:"No Teacher Assigned"}]};const _=o.map(D=>D.teacher?{_id:D.teacher._id||D.teacher,firstName:D.teacher.firstName||"N/A",lastName:D.teacher.lastName||"",name:`${D.teacher.firstName||"N/A"} ${D.teacher.lastName||""}`.trim()||"No Teacher Assigned"}:{_id:null,name:"No Teacher Assigned"}),u=[],C=new Set;for(const D of _){const Y=D._id?D._id.toString():"no_teacher";C.has(Y)||(C.add(Y),u.push(D))}return{data:u}},[o]);return{calendarEvents:X,viewModalOpen:p,setViewModalOpen:h,confirmationModalOpen:W,setConfirmationModalOpen:$,confirmationMessage:N,setConfirmationMessage:S,selectedTimetable:g,setSelectedTimetable:P,handleEventClick:oe,classLevelData:J,subjectData:je,teacherData:k,subjectNamesCache:s,loading:ie,error:ge,daysOfWeek:ct}},pt=({user:j})=>{const U=Ee();Se(U.palette.mode);const n=(j==null?void 0:j._id)||"",o=Pe("(max-width: 768px)"),t=Pe("(max-width: 375px)"),{calendarEvents:p,viewModalOpen:h,setViewModalOpen:W,confirmationModalOpen:$,setConfirmationModalOpen:N,confirmationMessage:S,selectedTimetable:g,setSelectedTimetable:P,handleEventClick:s,classLevelData:y,teacherData:b,subjectNamesCache:q,loading:H,error:i}=jt({userId:n}),[a,te]=r.useState([]),[V,X]=r.useState(!0),[le,E]=r.useState(null);return j!=null&&j._id?(r.useEffect(()=>{let G=!0;return X(!0),E(null),p&&typeof p.then=="function"?p.then(m=>{G&&(te(Array.isArray(m)?m:[]),X(!1))}).catch(m=>{console.error("Error resolving calendar events:",m),G&&(E("Failed to load calendar events"),X(!1))}):G&&(te(Array.isArray(p)?p:[]),X(!1)),()=>{G=!1}},[p]),console.log("calendarEvents (raw):",p),console.log("resolvedEvents:",a),e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"STUDENT TIMETABLE",subtitle:"View Your Weekly Schedule",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsx(ee,{children:H||V?e.jsx(Qe,{}):i||le?e.jsx(v,{variant:"h6",color:"error",children:i||le}):a.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:a,eventClick:s,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1,eventClassNames:"cursor-pointer"}):e.jsx(v,{variant:"h6",children:"No schedule available."})}),e.jsx(xt,{open:h,onClose:()=>{W(!1),P(null)},timetable:g,classLevelData:y,subjectNamesCache:q,teacherData:b,showEditButton:!1,showAttendance:!0,userId:n}),e.jsx(st,{open:$,onClose:()=>N(!1),title:"Timetable Operation",message:S,isLoading:H})]})):e.jsx(v,{variant:"h6",color:"error",children:"Error: User ID not found"})},vt=({open:j,onClose:U,onConfirm:n,attendanceChanges:o={},handleAttendanceChange:t,studentData:p=[],attendanceData:h=[],isLoading:W})=>{console.log("AttendanceModal props:",{studentData:p,attendanceChanges:o,attendanceData:h});const $=(g,P)=>{const s=g?g[0]:"",y=P?P[0]:"";return`${s}${y}`.toUpperCase()},N=g=>{const P=h.find(s=>!s.date||typeof s.date!="string"?(console.warn("Invalid or missing date in attendance period:",s),!1):s.periodIndex===0&&s.date.startsWith("2025-08-02"));return P==null?void 0:P.attendance.some(s=>s.studentId.toString()===g.toString())},S=g=>{const P=h.find(y=>!y.date||typeof y.date!="string"?(console.warn("Invalid or missing date in attendance period:",y),!1):y.periodIndex===0&&y.date.startsWith("2025-08-02")),s=P==null?void 0:P.attendance.find(y=>y.studentId.toString()===g.toString());return s?s.status:null};return e.jsx(Ce,{open:j,onClose:U,title:"Mark Attendance",onConfirm:n,confirmMessage:"Confirm",styleProps:{padding:"20px"},noConfirm:W,children:e.jsx(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:p.length>0?p.map(g=>e.jsxs(ee,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(ee,{display:"flex",alignItems:"center",gap:"10px",children:[e.jsx(gt,{src:g.profilePictureUrl||"",alt:`${g.firstName} ${g.lastName}`,sx:{width:40,height:40},children:!g.profilePictureUrl&&$(g.firstName,g.lastName)}),e.jsxs(v,{children:[g.firstName," ",g.lastName]})]}),N(g._id)?e.jsxs(v,{color:"textSecondary",children:["Attendance already marked for student (",S(g._id),")"]}):e.jsx(ne,{sx:{minWidth:100},children:e.jsxs(ae,{value:o[g._id]||"Absent",onChange:P=>t(g._id,P.target.value),children:[e.jsx(O,{value:"Present",children:"Present"}),e.jsx(O,{value:"Absent",children:"Absent"}),e.jsx(O,{value:"Late",children:"Late"}),e.jsx(O,{value:"Excused",children:"Excused"})]})})]},g._id)):e.jsx(v,{children:"No students available"})})})},Tt=({open:j,onClose:U,timetable:n,classLevelData:o,subjectNamesCache:t,onMarkAttendance:p})=>{const h=new Date("2025-08-03T21:13:00+01:00"),W=()=>{if(!n||!n.start)return console.warn("Missing timetable or start date:",n),!1;try{const s=new Date(n.start);return isNaN(s.getTime())?(console.warn("Invalid start date:",n.start),!1):s<=h}catch(s){return console.warn("Error parsing start date:",n.start,s),!1}},$=s=>{var y,b;return s?typeof s=="string"?((b=(y=o==null?void 0:o.data)==null?void 0:y.find(q=>q._id.toString()===s.toString()))==null?void 0:b.name)||"N/A":s.name||"N/A":"N/A"},N=s=>{var y,b;return s?typeof s=="string"?((b=(y=o==null?void 0:o.data)==null?void 0:y.find(q=>q._id.toString()===s.toString()))==null?void 0:b.section)||"N/A":s.section||"N/A":"N/A"},S=s=>{var y;return s?typeof s=="string"?t[s]||"Unknown":t[s.name]||((y=s.name)==null?void 0:y.name)||"Unknown":"Unknown"},g=s=>!s||typeof s=="string"?"No Teacher":`${s.firstName||""} ${s.lastName||""}`.trim()||"No Teacher";console.log("ViewTimetableModal timetable:",n);const P=W();return e.jsx(Ce,{open:j,onClose:U,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:n?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Class Level:"})," ",$(n.classLevel)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Section:"})," ",N(n.classLevel)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subclass:"})," ",n.subclassLetter||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subject:"})," ",S(n.subject)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Day of Week:"})," ",n.dayOfWeek||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Start Time:"})," ",n.startTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"End Time:"})," ",n.endTime||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",n.numberOfPeriods||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Location:"})," ",n.location||"N/A"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Teacher:"})," ",g(n.teacher)]}),n.start&&e.jsxs(v,{children:[e.jsx("strong",{children:"Event Date:"})," ",new Date(n.start).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:"Africa/Lagos"})]}),p&&e.jsx(Fe,{content:"Mark Attendance",icon:e.jsx(ft,{}),onClick:p,disabled:!P})]}):e.jsx(v,{children:"No timetable details available"})})},dt=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],yt=({userId:j})=>{const U=Ee();Se(U.palette.mode);const[n,o]=r.useState([]),[t,p]=r.useState(""),[h,W]=r.useState(""),[$,N]=r.useState(!1),[S,g]=r.useState(!1),[P,s]=r.useState(!1),[y,b]=r.useState(""),[q,H]=r.useState(null),[i,a]=r.useState(null),[te,V]=r.useState({}),[X,le]=r.useState({}),[E,G]=r.useState([]),[m,Z]=r.useState({}),[oe,ie]=r.useState([]),{loading:ge,error:J,callApi:je,data:k}=se(),{loading:I,error:_,callApi:u}=se(),{loading:C,error:D,callApi:Y}=se(),{loading:fe,error:pe,callApi:me,data:R}=se(),{loading:be,error:Te,data:Me}=se(),{loading:Ae,error:ye}=se(),{loading:Le,error:ue,callApi:Ne}=se(),De=r.useCallback(async(A,M)=>A?X[A]?X[A]:A.name.name:"Unknown",[X]);r.useEffect(()=>{je(`${ce.TIMETABLE}/teacher/${j}`,"GET"),me(`${ce.CLASS_LEVEL}`,"GET")},[je,me,j]),r.useEffect(()=>{let A=!0;const M=async()=>{if(!(k!=null&&k.status)==="success"||!(k!=null&&k.data))return;const w=[],c=new Set;k.data.forEach(F=>{var de,K;const z=`${(de=F.classLevel)==null?void 0:de._id}_${F.subclassLetter}`;!c.has(z)&&((K=F.classLevel)!=null&&K._id)&&F.subclassLetter&&(c.add(z),w.push({classLevelId:F.classLevel._id,subclassLetter:F.subclassLetter}))});const L=w.map(async({classLevelId:F,subclassLetter:z})=>{var de;try{const K=await u(`${ce.CLASS_LEVEL}/${F}/subclasses/${z}/students`,"GET");return console.log(`fetchStudents for ${F}_${z}:`,K.data),{key:`${F}_${z}`,students:((de=K==null?void 0:K.data)==null?void 0:de.students)||[]}}catch(K){return console.error(`Error fetching students for ${F}_${z}:`,K),{key:`${F}_${z}`,students:[]}}}),Q=await Promise.all(L);if(A){const F=Q.reduce((z,{key:de,students:K})=>(z[de]=K,z),{});Z(F),console.log("allStudents:",F)}};return(k==null?void 0:k.status)==="success"&&M(),()=>{A=!1}},[k,u]),r.useEffect(()=>{(k==null?void 0:k.status)==="success"&&o(k.data||[])},[k]);const Oe=r.useMemo(()=>{const A=[],M=new Set;return n.forEach(w=>{const c=w.classLevel;c&&c._id&&!M.has(c._id)&&(M.add(c._id),A.push({_id:c._id,name:c.name}))}),A},[n]),we=r.useMemo(()=>{if(!t)return[];const A=[],M=new Set;return n.forEach(w=>{var c;((c=w.classLevel)==null?void 0:c._id)===t&&w.subclassLetter&&(M.has(w.subclassLetter)||(M.add(w.subclassLetter),A.push(w.subclassLetter)))}),A.sort()},[n,t]),ve=r.useMemo(()=>{let A=!0;if(!n||n.length===0)return[];const M=n.filter(c=>{var F;const L=!t||((F=c.classLevel)==null?void 0:F._id)===t,Q=!h||c.subclassLetter===h;return L&&Q});return Promise.all(M.map(async c=>{var l,d,f,x;const L=dt.indexOf(c.dayOfWeek);if(L===-1)return console.warn(`Invalid dayOfWeek: ${c.dayOfWeek} for timetable ID: ${c._id}`),null;const Q=L,F=`${c.startTime}:00`,z=`${c.endTime}:00`,de=((l=c.subject)==null?void 0:l.name._id)||c.subject,K=await De(de,()=>A);return{id:c._id,title:`${K} (${c.location})`,daysOfWeek:[Q],startTime:F,endTime:z,extendedProps:{classLevel:((d=c.classLevel)==null?void 0:d._id)||c.classLevel,classLevelName:((f=c.classLevel)==null?void 0:f.name)||"N/A",section:((x=c.classLevel)==null?void 0:x.section)||"N/A",subclassLetter:c.subclassLetter||"",subject:de||"",subjectName:K,teacherName:c.teacher&&`${c.teacher.firstName||""} ${c.teacher.lastName||""}`.trim()||"No Teacher",dayOfWeek:c.dayOfWeek,startTime:c.startTime,numberOfPeriods:c.numberOfPeriods,location:c.location}}})).then(c=>c.filter(L=>L!==null)).catch(c=>(console.error("Error processing calendar events:",c),b("Failed to process timetable events"),s(!0),[]))},[n,t,h,De]),[ke,Ie]=r.useState([]),[He,xe]=r.useState(!0),[Ue,qe]=r.useState(null);r.useEffect(()=>{let A=!0;return xe(!0),qe(null),ve&&typeof ve.then=="function"?ve.then(M=>{A&&(Ie(Array.isArray(M)?M:[]),xe(!1))}).catch(M=>{console.error("Error resolving calendar events:",M),A&&(qe("Failed to load calendar events"),xe(!1))}):A&&(Ie(Array.isArray(ve)?ve:[]),xe(!1)),()=>{A=!1}},[ve]);const We=r.useCallback(async(A,M,w="2025-08-02")=>{try{const c=w?`periodIndex=${M}&date=${encodeURIComponent(w)}`:`periodIndex=${M}`;console.log(`Fetching attendance for URL: ${ce.TIMETABLE}/${A}/attendance?${c}`);const L=await Ne(`${ce.TIMETABLE}/${A}/attendance?${c}`,"GET");return console.log("fetchAttendanceForPeriod response:",L==null?void 0:L.data),(L==null?void 0:L.status)==="success"?(ie(L.data.attendance||[]),o(Q=>Q.map(F=>F._id===A?{...F,...L.data.timetable}:F)),L.data.attendance||[]):(console.warn("fetchAttendanceForPeriod failed:",L==null?void 0:L.message),b((L==null?void 0:L.message)||ue||"Failed to fetch attendance"),s(!0),[])}catch(c){return console.error("Error fetching attendance:",c),b(ue||c.message||"Failed to fetch attendance"),s(!0),[]}},[Ne,ue]),Ve=r.useCallback((A,M)=>{console.log("handleAttendanceChange:",{studentId:A,newAttendance:M}),V(w=>({...w,[A]:M}))},[]),Ge=r.useCallback(async()=>{if(!n.find(c=>c._id===q)){b("Timetable not found"),s(!0);return}const M=Object.entries(te).filter(([c])=>!oe.find(Q=>{var F;return Q.periodIndex===0&&((F=Q.date)==null?void 0:F.startsWith("2025-08-02"))&&Q.attendance.some(z=>z.studentId.toString()===c.toString())})).map(([c,L])=>({studentId:c,status:L,notes:L==="Absent"||L==="Excused"?"Marked by instructor":""}));if(M.length===0){b("No new attendance to mark; all students already marked"),s(!0),N(!1),H(null);return}const w={timetableId:q,periodIndex:0,attendanceData:M,date:"2025-08-02"};try{const c=await Y(`${ce.TIMETABLE}/${q}/attendance`,"PUT",w);(c==null?void 0:c.status)==="success"?(o(L=>L.map(Q=>Q._id===q?{...Q,periodAttendance:c.data.periodAttendance}:Q)),b("Attendance marked successfully"),N(!1),s(!0),H(null),V({})):(b((c==null?void 0:c.message)||D||"Failed to mark attendance"),s(!0))}catch(c){b(D||c.message||"Failed to mark attendance"),s(!0)}},[n,q,te,Y,D,oe]),Re=r.useCallback(async A=>{const M=n.find(w=>w._id===A);if(M){const w=`${M.classLevel._id}_${M.subclassLetter}`,c=m[w]||[];if(G(c),console.log(`Using cached students for ${w}:`,c),c.length===0){b("No students found for this class"),s(!0);return}V(L=>{const Q=c.reduce((F,z)=>{const de=oe.find(K=>{var l;return K.periodIndex===0&&((l=K.date)==null?void 0:l.startsWith("2025-08-02"))&&K.attendance.some(d=>d.studentId.toString()===z._id.toString())});return{...F,[z._id]:de?null:L[z._id]||"Absent"}},{});return console.log("openAttendanceModal initialAttendance:",Q),{...L,...Q}}),H(A),N(!0)}},[n,m,oe]),ze=r.useCallback(async A=>{const M=n.find(w=>w._id===A.event.id);if(M){const w=new Date(A.event.start);await We(M._id,0,"2025-08-02"),a({...M,start:w.toISOString()}),g(!0)}},[n,We]),Ze=ge||I||C||fe||be||Ae||He||Le,Je=(k==null?void 0:k.status)==="failed"?k.message:J||_||D||pe||Te||ye||Ue||ue;return{calendarEvents:ke,selectedClassLevel:t,setSelectedClassLevel:p,selectedSubclass:h,setSelectedSubclass:W,classLevelOptions:Oe,subclassOptions:we,attendanceModalOpen:$,setAttendanceModalOpen:N,viewModalOpen:S,setViewModalOpen:g,confirmationModalOpen:P,setConfirmationModalOpen:s,confirmationMessage:y,selectedScheduleId:q,selectedTimetable:i,handleAttendanceChange:Ve,handleConfirmAttendance:Ge,openAttendanceModal:Re,handleEventClick:ze,classLevelData:R,subjectData:Me,studentData:E,subjectNamesCache:X,loading:Ze,error:Je,daysOfWeek:dt,attendanceChanges:te,attendanceData:oe}},Nt=({user:j})=>{const U=Ee();Se(U.palette.mode);const n=(j==null?void 0:j._id)||"",o=Pe("(max-width: 768px)"),t=Pe("(max-width: 375px)"),{calendarEvents:p,selectedClassLevel:h,setSelectedClassLevel:W,selectedSubclass:$,setSelectedSubclass:N,classLevelOptions:S,subclassOptions:g,attendanceModalOpen:P,setAttendanceModalOpen:s,viewModalOpen:y,setViewModalOpen:b,confirmationModalOpen:q,setConfirmationModalOpen:H,confirmationMessage:i,selectedTimetable:a,handleAttendanceChange:te,handleConfirmAttendance:V,openAttendanceModal:X,handleEventClick:le,classLevelData:E,subjectNamesCache:G,studentData:m,attendanceChanges:Z,attendanceData:oe,loading:ie,error:ge}=yt({userId:n});return console.log("Instructor attendanceChanges:",Z),console.log("Instructor attendanceData:",oe),j!=null&&j._id?e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"TEACHER TIMETABLE",subtitle:"View Your Schedule and Mark Attendance",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(ee,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ne,{sx:{minWidth:150},children:[e.jsx(re,{children:"Class Level"}),e.jsxs(ae,{value:h||"",onChange:J=>W(J.target.value),label:"Class Level",children:[e.jsx(O,{value:"",children:"All Classes"}),S.map(J=>e.jsx(O,{value:J._id,children:J.name},J._id))]})]}),e.jsxs(ne,{sx:{minWidth:120},children:[e.jsx(re,{children:"Subclass"}),e.jsxs(ae,{value:$||"",onChange:J=>N(J.target.value),label:"Subclass",disabled:!h,children:[e.jsx(O,{value:"",children:"All Subclasses"}),g.map(J=>e.jsx(O,{value:J,children:J},J))]})]})]}),e.jsx(ee,{children:ie?e.jsx(Qe,{}):ge?e.jsx(v,{color:"error",children:ge}):p.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:p,eventClick:le,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1,eventClassNames:"cursor-pointer"}):e.jsx(v,{children:"No schedule available."})}),e.jsx(vt,{open:P,onClose:()=>{s(!1),setSelectedScheduleId(null)},onConfirm:V,attendanceChanges:Z,handleAttendanceChange:te,studentData:m,attendanceData:oe,isLoading:ie}),e.jsx(Tt,{open:y,onClose:()=>{b(!1),setSelectedTimetable(null)},timetable:a,classLevelData:E,subjectNamesCache:G,onMarkAttendance:()=>X(a==null?void 0:a._id)}),e.jsx(st,{open:q,onClose:()=>H(!1),title:"Attendance Operation",message:i,isLoading:ie})]}):e.jsx(v,{variant:"h6",color:"error",children:"Error: User ID not found"})},Ct=({open:j,onClose:U,onConfirm:n,newSchedule:o,setNewSchedule:t,classLevelData:p,availableSubclasses:h,availableSubjects:W,availableTeachers:$,isLoading:N,daysOfWeek:S,handleClassLevelChange:g,handleSubclassChange:P,setConfirmationMessage:s,setConfirmationModalOpen:y})=>{var H;console.log($);const b=()=>{const i=q(o);if(i){s(i),y(!0);return}n()},q=i=>i.classLevel?i.subclassLetter?i.subject?i.teacher?i.dayOfWeek?i.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(i.startTime)?!i.numberOfPeriods||i.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(i.numberOfPeriods))?i.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Ce,{open:j,onClose:U,title:"Add New Timetable",onConfirm:b,confirmMessage:"Add",styleProps:{padding:"20px"},noConfirm:N,children:e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(ae,{labelId:"class-level-modal-label",value:o.classLevel,label:"Class Level",onChange:i=>{t({...o,classLevel:i.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),g(i.target.value)},disabled:N,children:((H=p==null?void 0:p.data)==null?void 0:H.length)>0?p.data.map(i=>e.jsx(O,{value:i._id,children:i.name},i._id)):e.jsx(O,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(ae,{labelId:"subclass-modal-label",value:o.subclassLetter,label:"Subclass",onChange:i=>{t({...o,subclassLetter:i.target.value,subject:"",teacher:"",teacherName:""}),P(i.target.value)},disabled:!o.classLevel||N,children:(h==null?void 0:h.length)>0?h.map(i=>e.jsx(O,{value:i,children:i},i)):e.jsx(O,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"subject-modal-label",children:"Subject"}),e.jsx(ae,{labelId:"subject-modal-label",value:o.subject,label:"Subject",onChange:i=>t({...o,subject:i.target.value,teacher:"",teacherName:""}),disabled:N||!o.subclassLetter,children:(W==null?void 0:W.length)>0?W.map(i=>e.jsx(O,{value:i._id,children:i.displayName},i._id)):e.jsx(O,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(ae,{labelId:"teacher-modal-label",value:o.teacher,label:"Teacher",onChange:i=>t({...o,teacher:i.target.value}),disabled:N||!o.subject,children:($==null?void 0:$.length)>0?$.map(i=>e.jsx(O,{value:i._id,children:i.displayName},i._id)):e.jsx(O,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"day-modal-label",children:"Day of Week"}),e.jsx(ae,{labelId:"day-modal-label",value:o.dayOfWeek,label:"Day of Week",onChange:i=>t({...o,dayOfWeek:i.target.value}),disabled:N,children:(S==null?void 0:S.length)>0?S.map(i=>e.jsx(O,{value:i,children:i},i)):e.jsx(O,{disabled:!0,children:"No days available"})})]}),e.jsx($e,{label:"Start Time (HH:MM)",value:o.startTime,onChange:i=>t({...o,startTime:i.target.value}),fullWidth:!0,disabled:N,error:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime),helperText:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx($e,{label:"Number of Periods",type:"number",value:o.numberOfPeriods,onChange:i=>t({...o,numberOfPeriods:i.target.value}),fullWidth:!0,inputProps:{min:1},disabled:N,error:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1),helperText:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx($e,{label:"Location",value:o.location,onChange:i=>t({...o,location:i.target.value}),fullWidth:!0,disabled:N})]})})},St=({open:j,onClose:U,onConfirm:n,onDelete:o,newSchedule:t,setNewSchedule:p,classLevelData:h,availableSubclasses:W,availableSubjects:$,availableTeachers:N,isLoading:S,daysOfWeek:g,handleClassLevelChange:P,handleSubclassChange:s,setConfirmationMessage:y,setConfirmationModalOpen:b})=>{var i;const q=()=>{const a=H(t);if(a){y(a),b(!0);return}n()},H=a=>a.classLevel?a.subclassLetter?a.subject?a.teacher?a.dayOfWeek?a.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(a.startTime)?!a.numberOfPeriods||a.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(a.numberOfPeriods))?a.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Ce,{open:j,onClose:U,title:"Edit Timetable",onConfirm:q,confirmMessage:"Update",styleProps:{padding:"20px"},noConfirm:S,additionalButton:e.jsx(ht,{variant:"contained",color:"error",onClick:o,disabled:S,sx:{mr:2},children:"Delete"}),children:e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(ae,{labelId:"class-level-modal-label",value:t.classLevel,label:"Class Level",onChange:a=>{p({...t,classLevel:a.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),P(a.target.value)},disabled:S,children:((i=h==null?void 0:h.data)==null?void 0:i.length)>0?h.data.map(a=>e.jsx(O,{value:a._id,children:a.name},a._id)):e.jsx(O,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(ae,{labelId:"subclass-modal-label",value:t.subclassLetter,label:"Subclass",onChange:a=>{p({...t,subclassLetter:a.target.value,subject:"",teacher:"",teacherName:""}),s(a.target.value)},disabled:!t.classLevel||S,children:(W==null?void 0:W.length)>0?W.map(a=>e.jsx(O,{value:a,children:a},a)):e.jsx(O,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"subject-modal-label",children:"Subject"}),e.jsx(ae,{labelId:"subject-modal-label",value:t.subject,label:"Subject",onChange:a=>p({...t,subject:a.target.value,teacher:"",teacherName:""}),disabled:S||!t.subclassLetter,children:($==null?void 0:$.length)>0?$.map(a=>e.jsx(O,{value:a._id,children:a.displayName},a._id)):e.jsx(O,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(ae,{labelId:"teacher-modal-label",value:t.teacher,label:"Teacher",onChange:a=>p({...t,teacher:a.target.value}),disabled:S||!t.subject,children:(N==null?void 0:N.length)>0?N.map(a=>e.jsx(O,{value:a._id,children:a.displayName},a._id)):e.jsx(O,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(re,{id:"day-modal-label",children:"Day of Week"}),e.jsx(ae,{labelId:"day-modal-label",value:t.dayOfWeek,label:"Day of Week",onChange:a=>p({...t,dayOfWeek:a.target.value}),disabled:S,children:(g==null?void 0:g.length)>0?g.map(a=>e.jsx(O,{value:a,children:a},a)):e.jsx(O,{disabled:!0,children:"No days available"})})]}),e.jsx($e,{label:"Start Time (HH:MM)",value:t.startTime,onChange:a=>p({...t,startTime:a.target.value}),fullWidth:!0,disabled:S,error:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime),helperText:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx($e,{label:"Number of Periods",type:"number",value:t.numberOfPeriods,onChange:a=>p({...t,numberOfPeriods:a.target.value}),fullWidth:!0,inputProps:{min:1},disabled:S,error:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1),helperText:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx($e,{label:"Location",value:t.location,onChange:a=>p({...t,location:a.target.value}),fullWidth:!0,disabled:S})]})})},Et=({open:j,onClose:U,onEdit:n,onDelete:o,timetable:t,availableSubjects:p})=>{console.log(t);const h=Ee(),W=Se(h.palette.mode);return e.jsxs(Ce,{open:j,onClose:U,title:"Timetable Details",noConfirm:!0,confirmMessage:"Edit",styleProps:{padding:"20px"},children:[t?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Class Level:"})," ",t.classLevel.name]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subclass:"})," ",t.subclassLetter]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Subject:"})," ",t.subject.name]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Teacher:"})," ",t.teacher?`${t.teacher.firstName} ${t.teacher.lastName}`:"Unassigned"]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Day of Week:"})," ",t.dayOfWeek]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Start Time:"})," ",t.startTime]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",t.numberOfPeriods]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Location:"})," ",t.location]})]}):e.jsx(v,{children:"No timetable details available"}),e.jsxs(ee,{display:"flex",justifyContent:"flex-end",mt:"16px",gap:"10px",children:[e.jsx(Fe,{content:"Edit Timetable",onClick:n,sx:{backgroundColor:W.greenAccent[500]}}),e.jsx(Fe,{content:"Delete Timetable",onClick:o,sx:{backgroundColor:W.redAccent[500]}})]})]})},Mt=({open:j,onClose:U,onConfirm:n,isLoading:o})=>e.jsx(Ce,{open:j,onClose:U,title:"Confirm Deletion",onConfirm:n,confirmMessage:"Delete",styleProps:{padding:"20px"},noConfirm:o,children:e.jsx(v,{children:"Are you sure you want to delete this timetable? This action cannot be undone."})}),ut=["Monday","Tuesday","Wednesday","Thursday","Friday"],At=({userId:j})=>{const U=Ee();Se(U.palette.mode);const[n,o]=r.useState(""),[t,p]=r.useState(""),[h,W]=r.useState(""),[$,N]=r.useState(!1),[S,g]=r.useState(!1),[P,s]=r.useState(!1),[y,b]=r.useState(!1),[q,H]=r.useState(!1),[i,a]=r.useState(""),[te,V]=r.useState([]),[X,le]=r.useState(!1),[E,G]=r.useState(null),[m,Z]=r.useState({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),[oe,ie]=r.useState([]),[ge,J]=r.useState(!1),[je,k]=r.useState(null),[I,_]=r.useState([]),[u,C]=r.useState([]),[D,Y]=r.useState([]),{loading:fe,error:pe,callApi:me}=se(),{loading:R,error:be,callApi:Te}=se(),{loading:Me,error:Ae,callApi:ye}=se(),{loading:Le,error:ue,callApi:Ne}=se(),{loading:De,error:Oe,callApi:we}=se(),{loading:ve,error:ke,callApi:Ie}=se(),{loading:He,error:xe,callApi:Ue}=se();r.useEffect(()=>{(async()=>{var d,f;try{const x=await Te(ce.CLASS_LEVEL,"GET");console.log("Class Levels fetched:",(d=x==null?void 0:x.data)==null?void 0:d.data),_(((f=x==null?void 0:x.data)==null?void 0:f.data)||[])}catch(x){console.error("Error loading class levels:",x),a("Failed to load class levels: "+(x.message||"Unknown error")),b(!0)}})()},[Te]),r.useEffect(()=>{if(!t||!h){console.log("Skipping subject fetch: missing classLevel or subclass"),C([]),V([]);return}(async()=>{const d=I.find(T=>T._id===t);if(!d){console.log("Class level not found:",t),C([]),V([]);return}const f=d.subclasses.find(T=>T.letter===h);if(!f){console.log("Subclass not found:",h),C([]),V([]);return}const x=f.subjects.map(T=>T.subject);console.log("Subject IDs to fetch:",x);try{le(!0);const T=await ye(`${ce.SUBJECT}?ids=${x.join(",")}`,"GET");console.log("Fetched subjects:",T==null?void 0:T.data);const B=(T==null?void 0:T.data)||[];C(B);const he=B.map(_e=>{var Be;return{_id:_e._id,displayName:((Be=_e.name)==null?void 0:Be.name)||"Unknown"}});V(he)}catch(T){console.error("Error fetching subjects:",T),a("Failed to load subjects: "+(T.message||"Unknown error")),b(!0),C([]),V([])}finally{le(!1)}})()},[t,h,I,ye]),r.useEffect(()=>{if(!n||!t||!h){console.log("Skipping timetable fetch: missing section, classLevel, or subclass",{selectedSection:n,selectedClassLevel:t,selectedSubclass:h}),Y([]);return}(async()=>{try{const d=await me(`${ce.TIMETABLE}?classLevel=${t}&subclassLetter=${h}`,"GET");console.log("Timetables fetched:",d==null?void 0:d.data),Y((d==null?void 0:d.data)||[])}catch(d){console.error("Error fetching timetables:",d),a("Failed to load timetables: "+(d.message||"Unknown error")),b(!0),Y([])}})()},[n,t,h,me]);const qe=r.useMemo(()=>{if(console.log("Computing available teachers:",{classLevels:I,selectedClassLevel:t,selectedSubclass:h}),!I.length||!t||!h)return console.log("Missing required data for teachers, returning empty teachers"),[];const l=I.filter(f=>f._id===t).flatMap(f=>{const x=f.subclasses.find(B=>B.letter===h);if(!x)return console.log("Subclass not found:",h),[];const T=x.subjects.flatMap(B=>B.teachers||[]).filter(Boolean);return console.log("Teacher IDs from subclass subjects:",T),f.teachers.filter(B=>T.includes(B.teacherId)).map(B=>({_id:B.teacherId,displayName:`${B.firstName} ${B.lastName}`.trim()}))}),d=Array.from(new Map(l.map(f=>[f._id,f])).values());return console.log("Computed unique teachers:",d),d},[I,t,h]);r.useEffect(()=>{if(!m.teacher||!I.length){Z(x=>({...x,teacherName:""}));return}const l=I.find(x=>x._id===m.classLevel);if(!l){Z(x=>({...x,teacherName:""}));return}const d=l.teachers.find(x=>x.teacherId===m.teacher),f=d?`${d.firstName} ${d.lastName}`.trim():"";console.log("Setting teacherName:",{teacherId:m.teacher,teacherName:f}),Z(x=>({...x,teacherName:f}))},[m.teacher,I,m.classLevel]);const We=r.useCallback((l,d)=>{const[f,x]=l.split(":").map(Number),T=f*60+x+d*45,B=Math.floor(T/60),he=T%60;return`${B.toString().padStart(2,"0")}:${he.toString().padStart(2,"0")}`},[]),Ve=r.useCallback(async(l,d,f=null)=>{if(!l||d===void 0||d===null){console.log("Invalid parameters for fetching attendance:",{timetableId:l,periodIndex:d}),a("Invalid timetable or period index"),b(!0);return}try{J(!0),k(null);const x=`${ce.TIMETABLE}/${l}/attendance?periodIndex=${d}${f?`&date=${f}`:""}`,T=await Ue(x,"GET");console.log("Attendance fetched:",T==null?void 0:T.data),(T==null?void 0:T.status)==="success"?ie(T.data.attendance||[]):(a((T==null?void 0:T.message)||xe||"Failed to fetch attendance"),b(!0),ie([]))}catch(x){console.error("Error fetching attendance:",x),a(xe||x.message||"Failed to fetch attendance"),b(!0),ie([])}finally{J(!1)}},[Ue,xe]),Ge=r.useMemo(()=>(console.log("Processing calendarEvents, timetables:",D,"subjects:",u),D.length?D.map(l=>{var at,rt,lt,ot,it;const d=ut.indexOf(l.dayOfWeek);if(d===-1)return console.log("Invalid dayOfWeek:",l.dayOfWeek),null;const f=d+1;console.log(`Mapping ${l.dayOfWeek} to daysOfWeek: [${f}]`);const x=`${l.startTime}:00`,T=`${l.endTime}:00`,B=((at=l.subject)==null?void 0:at._id)||l.subject,he=u.find(mt=>mt._id===B),_e=((rt=he==null?void 0:he.name)==null?void 0:rt.name)||l.subjectName||"Unknown";console.log(`Subject name for ${B}: ${_e}`);const Be=l.teacher?`${l.teacher.firstName} ${l.teacher.lastName}`.trim():"Unassigned",nt={id:l._id,title:`${_e} (${l.location})`,daysOfWeek:[f],startTime:x,endTime:T,extendedProps:{classLevel:((lt=l.classLevel)==null?void 0:lt._id)||l.classLevel,classLevelName:((ot=l.classLevel)==null?void 0:ot.name)||"N/A",subclassLetter:l.subclassLetter,subject:B,subjectName:_e,teacher:((it=l.teacher)==null?void 0:it._id)||null,teacherName:Be,dayOfWeek:l.dayOfWeek,startTime:l.startTime,numberOfPeriods:l.numberOfPeriods,location:l.location,periods:l.periods||[]}};return console.log("Generated event:",JSON.stringify(nt,null,2)),nt}).filter(Boolean):(console.log("No timetables, returning empty events"),[])),[D,u]),Re=r.useMemo(()=>{if(console.log("Filtering class levels with:",{classLevels:I,selectedSection:n}),!I.length)return{data:[]};if(!n)return{data:I};const l=I.filter(d=>d.section===n);return console.log("Filtered class levels:",l),{data:l}},[I,n]),ze=r.useMemo(()=>{var f;if(console.log("Computing available subclasses:",{classLevels:I,selectedClassLevel:t}),!I.length||!t)return console.log("No classLevels or selectedClassLevel, returning empty subclasses"),[];const l=I.find(x=>x._id===t);if(!l)return console.log("Selected class level not found in classLevels"),[];const d=[...new Set((f=l.subclasses)==null?void 0:f.map(x=>x.letter).filter(Boolean))];return console.log("Computed subclasses:",d),d},[I,t]),Ze=r.useCallback(l=>{console.log("Setting section:",l),o(l),p(""),W(""),Z(d=>({...d,classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),Je=r.useCallback(l=>{console.log("Setting class level:",l),p(l),W(""),Z(d=>({...d,classLevel:l,subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),A=r.useCallback(l=>{console.log("Setting subclass:",l),W(l),Z(d=>({...d,subclassLetter:l,subject:"",teacher:"",teacherName:""}))},[]),M=r.useCallback(()=>{if(!j)return"User not authenticated. Please log in.";if(!m.classLevel)return"Class level is required";if(!m.subclassLetter)return"Subclass is required";if(!m.subject)return"Subject is required";if(!m.teacher)return"Teacher is required";if(!m.dayOfWeek)return"Day of week is required";if(!m.startTime)return"Start time is required";if(!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(m.startTime))return"Start time must be in HH:MM format (00:00-23:59)";const[l,d]=m.startTime.split(":").map(Number),f=l*60+d;if(f<7*60||f>18*60)return"Start time must be between 07:00 AM and 06:00 PM";if(!m.numberOfPeriods||m.numberOfPeriods<1)return"Number of periods must be at least 1";if(!Number.isInteger(Number(m.numberOfPeriods)))return"Number of periods must be an integer";const x=We(m.startTime,Number(m.numberOfPeriods)),[T,B]=x.split(":").map(Number);return T*60+B>18*60?"End time cannot exceed 06:00 PM":m.location?"":"Location is required"},[m,j,We]),w=r.useCallback(async()=>{const l=M();if(l){a(l),b(!0);return}const d={classLevel:m.classLevel,subclassLetter:m.subclassLetter,subject:m.subject,teacher:m.teacher,dayOfWeek:m.dayOfWeek,startTime:m.startTime,numberOfPeriods:parseInt(m.numberOfPeriods,10),location:m.location,createdBy:j};try{const f=await Ne(ce.TIMETABLE,"POST",d);(f==null?void 0:f.status)==="success"?(Y(x=>[f.data,...x].slice(0,10)),a("Timetable added successfully"),N(!1),Z({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})):a((f==null?void 0:f.message)||ue||"Failed to add timetable")}catch(f){console.error("Error adding timetable:",f),a(ue||f.message||"Failed to add timetable")}b(!0)},[Ne,ue,M,j]),c=r.useCallback(async()=>{if(!E){a("No timetable selected for update"),b(!0);return}const l=M();if(l){a(l),b(!0);return}const d={classLevel:m.classLevel,subclassLetter:m.subclassLetter,subject:m.subject,teacher:m.teacher,dayOfWeek:m.dayOfWeek,startTime:m.startTime,numberOfPeriods:parseInt(m.numberOfPeriods,10),location:m.location,createdBy:j};try{const f=await we(`${ce.TIMETABLE}/${E._id}`,"PUT",d);(f==null?void 0:f.status)==="success"?(Y(x=>x.map(T=>T._id===E._id?{...T,...f.data}:T)),a("Timetable updated successfully"),g(!1),s(!1),Z({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),G(null)):a((f==null?void 0:f.message)||Oe||"Failed to update timetable")}catch(f){console.error("Error updating timetable:",f),a(Oe||f.message||"Failed to update timetable")}b(!0)},[we,Oe,E,M,j]),L=r.useCallback(()=>{if(!E){a("No timetable selected for deletion"),b(!0);return}H(!0)},[E]),Q=r.useCallback(async()=>{try{const l=await Ie(`${ce.TIMETABLE}/${E._id}`,"DELETE");(l==null?void 0:l.status)==="success"?(Y(d=>d.filter(f=>f._id!==E._id)),a("Timetable deleted successfully"),g(!1),s(!1),H(!1),G(null)):a((l==null?void 0:l.message)||ke||"Failed to delete timetable")}catch(l){console.error("Error deleting timetable:",l),a(ke||l.message||"Failed to delete timetable")}b(!0)},[Ie,ke,E]),F=r.useCallback(l=>{const d=D.find(B=>B._id===l.event.id);if(!d){a("Timetable not found"),b(!0);return}const f=te.find(B=>{var he;return B._id===((he=d.subject)==null?void 0:he._id)||d.subject}),x=(f==null?void 0:f.displayName)||d.subjectName||"Unknown",T={...d,subject:x};console.log("Transformed timetable:",T),G(T),s(!0)},[D,te]),z=r.useCallback(()=>{var l,d,f;E&&(Z({classLevel:((l=E.classLevel)==null?void 0:l._id)||E.classLevel,subclassLetter:E.subclassLetter,subject:((d=E.subject)==null?void 0:d._id)||E.subject,teacher:((f=E.teacher)==null?void 0:f._id)||"",teacherName:E.teacher?`${E.teacher.firstName} ${E.teacher.lastName}`.trim():"",dayOfWeek:E.dayOfWeek,startTime:E.startTime,numberOfPeriods:E.numberOfPeriods,location:E.location}),s(!1),g(!0))},[E]);return{calendarEvents:Ge,selectedSection:n,setSelectedSection:Ze,selectedClassLevel:t,setSelectedClassLevel:Je,selectedSubclass:h,setSelectedSubclass:A,addModalOpen:$,setAddModalOpen:N,editModalOpen:S,setEditModalOpen:g,viewModalOpen:P,setViewModalOpen:s,confirmationModalOpen:y,setConfirmationModalOpen:b,deleteConfirmationOpen:q,setDeleteConfirmationOpen:H,confirmationMessage:i,setConfirmationMessage:a,newSchedule:m,setNewSchedule:Z,selectedTimetable:E,handleAddSchedule:w,handleUpdateSchedule:c,handleInitiateDelete:L,handleDeleteSchedule:Q,handleEventClick:F,handleOpenEditModal:z,classLevelData:Re,availableSubclasses:ze,availableSubjects:te,availableTeachers:qe,attendanceData:oe,fetchAttendanceForPeriod:Ve,loading:fe||R||Me||Le||De||ve||He||X,error:pe||be||Ae||ue||Oe||ke||xe||je,daysOfWeek:ut,weeksPerTerm:12,setSelectedTimetable:G}},Lt=()=>{var pe,me;const j=Ee(),U=Se(j.palette.mode),n=Ye(R=>{var be;return((be=R.users.user)==null?void 0:be._id)||""}),o=Pe("(max-width: 768px)"),t=Pe("(max-width: 375px)"),{calendarEvents:p,selectedSection:h,setSelectedSection:W,selectedClassLevel:$,setSelectedClassLevel:N,selectedSubclass:S,setSelectedSubclass:g,addModalOpen:P,setAddModalOpen:s,editModalOpen:y,setEditModalOpen:b,viewModalOpen:q,setViewModalOpen:H,confirmationModalOpen:i,setConfirmationModalOpen:a,deleteConfirmationOpen:te,setDeleteConfirmationOpen:V,confirmationMessage:X,setConfirmationMessage:le,newSchedule:E,setNewSchedule:G,selectedTimetable:m,handleAddSchedule:Z,handleUpdateSchedule:oe,handleInitiateDelete:ie,handleDeleteSchedule:ge,handleEventClick:J,handleOpenEditModal:je,classLevelData:k,availableSubclasses:I,availableSubjects:_,availableTeachers:u,loading:C,error:D,daysOfWeek:Y,setSelectedTimetable:fe}=At({userId:n});return console.log("CalendarEvents:",p),e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"ADMIN TIMETABLE",subtitle:"Manage Class and Subclass Timetables",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(ee,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ne,{sx:{minWidth:150},children:[e.jsx(re,{id:"section-select-label",children:"Section"}),e.jsxs(ae,{labelId:"section-select-label",value:h,label:"Section",onChange:R=>W(R.target.value),children:[e.jsx(O,{value:"",children:"All"}),e.jsx(O,{value:"Primary",children:"Primary"}),e.jsx(O,{value:"Secondary",children:"Secondary"})]})]}),e.jsxs(ne,{sx:{minWidth:150},children:[e.jsx(re,{id:"class-level-select-label",children:"Class Level"}),e.jsxs(ae,{labelId:"class-level-select-label",value:$,label:"Class Level",onChange:R=>N(R.target.value),disabled:!((pe=k==null?void 0:k.data)!=null&&pe.length),children:[e.jsx(O,{value:"",children:"Select Class Level"}),(me=k==null?void 0:k.data)==null?void 0:me.map(R=>e.jsx(O,{value:R._id,children:R.name},R._id))]})]}),e.jsxs(ne,{sx:{minWidth:150},children:[e.jsx(re,{id:"subclass-select-label",children:"Subclass"}),e.jsxs(ae,{labelId:"subclass-select-label",value:S,label:"Subclass",onChange:R=>g(R.target.value),disabled:!$||!(I!=null&&I.length),children:[e.jsx(O,{value:"",children:"Select Subclass"}),(I==null?void 0:I.length)>0?I.map(R=>e.jsx(O,{value:R,children:R},R)):e.jsx(O,{disabled:!0,children:"No subclasses available"})]})]}),e.jsx(Fe,{content:"Add Timetable",onClick:()=>s(!0),disabled:!$||!S,sx:{backgroundColor:U.greenAccent[500]}})]}),e.jsx(ee,{sx:{"& .fc-event":{cursor:"pointer"}},children:C?e.jsx(Qe,{}):D?e.jsx(v,{color:"error",children:D}):p.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:p,eventClick:J,slotMinTime:"00:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(v,{children:"No timetable available for selected time table."})}),e.jsx(Ct,{open:P,onClose:()=>{s(!1),G({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})},onConfirm:Z,newSchedule:E,setNewSchedule:G,classLevelData:k,availableSubclasses:I,availableSubjects:_,availableTeachers:u,isLoading:C,daysOfWeek:Y,handleClassLevelChange:N,handleSubclassChange:g,setConfirmationMessage:le,setConfirmationModalOpen:a}),e.jsx(St,{open:y,onClose:()=>{b(!1),fe(null)},onConfirm:oe,onDelete:ie,newSchedule:E,setNewSchedule:G,classLevelData:k,availableSubclasses:I,availableSubjects:_,availableTeachers:u,isLoading:C,daysOfWeek:Y,handleClassLevelChange:N,handleSubclassChange:g,setConfirmationMessage:le,setConfirmationModalOpen:a}),e.jsx(Et,{open:q,onClose:()=>{H(!1),fe(null)},onEdit:je,onDelete:ie,timetable:m,classLevelData:k,availableSubjects:_}),e.jsx(Mt,{open:te,onClose:()=>V(!1),onConfirm:ge,isLoading:C}),e.jsx(st,{open:i,onClose:()=>a(!1),title:"Timetable Operation",message:X,isLoading:C})]})},Ot=()=>{const j=Ye(n=>n.users.user),U=j.role;return e.jsx("div",{children:U==="student"?e.jsx(pt,{user:j}):U==="teacher"?e.jsx(Nt,{user:j}):e.jsx(Lt,{})})},Yt=bt(Ot);export{Yt as default};
