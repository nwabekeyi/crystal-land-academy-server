import{j as e,a as Ye,r as l,f as se,i as Qe}from"./index-CUx_BIfb.js";import{M as Ee,t as Ae}from"./modal-D-FEyCwe.js";import{F as Ke,a as Xe,b as et}from"./main-CIzsiP8V.js";import{H as tt}from"./Header-C6ewtNOz.js";import{A as Fe}from"./actionButton-CH_DOheE.js";import{d as ft}from"./CheckCircle-CRXPeP0X.js";import{v as ee,T as y,j as Me,a1 as ae,a3 as re,a2 as ie,y as Pe,x as ht}from"./TextField-CnJy6qLH.js";import{u as ne}from"./useApi-B5A5LOF2.js";import{u as Ie}from"./useMediaQuery-BkgNzubS.js";import{C as st}from"./confirmationModal-C7esu7_Z.js";import{A as gt}from"./index-Ci-mqblD.js";import{M as L}from"./MenuItem-Y8p8i8nN.js";import{w as bt}from"./dasboardPagesContainer-MMQB9i4e.js";import"./IconButton-CSIbz2lV.js";import"./index-Dn2bJmhV.js";import"./loadingButton-BcWtTSRw.js";import"./CircularProgress-BgN2WNYl.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-BurnVOpP.js";const xt=({open:v,onClose:U,timetable:a,classLevelData:o,subjectNamesCache:t,onMarkAttendance:T})=>{const h=new Date("2025-08-03T21:13:00+01:00"),I=()=>{if(!a||!a.start)return console.warn("Missing timetable or start date:",a),!1;try{const s=new Date(a.start);return isNaN(s.getTime())?(console.warn("Invalid start date:",a.start),!1):s<=h}catch(s){return console.warn("Error parsing start date:",a.start,s),!1}},$=s=>{var N,b;return s?typeof s=="string"?((b=(N=o==null?void 0:o.data)==null?void 0:N.find(q=>q._id.toString()===s.toString()))==null?void 0:b.name)||"N/A":s.name||"N/A":"N/A"},E=s=>{var N,b;return s?typeof s=="string"?((b=(N=o==null?void 0:o.data)==null?void 0:N.find(q=>q._id.toString()===s.toString()))==null?void 0:b.section)||"N/A":s.section||"N/A":"N/A"},A=s=>{var N;return s?typeof s=="string"?t[s]||"Unknown":t[s.name]||((N=s.name)==null?void 0:N.name)||"Unknown":"Unknown"},g=s=>!s||typeof s=="string"?"No Teacher":`${s.firstName||""} ${s.lastName||""}`.trim()||"No Teacher";console.log("ViewTimetableModal timetable:",a);const P=I();return e.jsx(Ee,{open:v,onClose:U,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:a?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(y,{children:[e.jsx("strong",{children:"Class Level:"})," ",$(a.classLevel)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Section:"})," ",E(a.classLevel)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subject:"})," ",A(a.subject)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"End Time:"})," ",a.endTime||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Teacher:"})," ",g(a.teacher)]}),a.start&&e.jsxs(y,{children:[e.jsx("strong",{children:"Event Date:"})," ",new Date(a.start).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:"Africa/Lagos"})]}),T&&e.jsx(Fe,{content:"Mark Attendance",icon:e.jsx(ft,{}),onClick:T,disabled:!P})]}):e.jsx(y,{children:"No timetable details available"})})},ct=["Monday","Tuesday","Wednesday","Thursday","Friday"],jt=({userId:v})=>{var ue;const U=Me();Ae(U.palette.mode);const a=Ye(j=>j.users.user),[o,t]=l.useState([]),[T,h]=l.useState(!1),[I,$]=l.useState(!1),[E,A]=l.useState(""),[g,P]=l.useState(null),[s,N]=l.useState({}),{loading:b,error:q,callApi:H,data:c}=ne(),{loading:r,error:te,callApi:Q}=ne(),K=l.useCallback(async(j,O)=>{var d;if(!j)return"Unknown";if(s[j])return s[j];try{const D=await Q(`${se.SUBJECT_NAME}/${j}`,"GET"),X=((d=D==null?void 0:D.data)==null?void 0:d.name)||"Unknown";return O()&&N(oe=>({...oe,[j]:X})),X}catch(D){return console.error(`Error fetching subject name for ID ${j}:`,D),"Unknown"}},[Q,s]);l.useEffect(()=>{let j=!0;const O=async()=>{try{const d=await H(`${se.TIMETABLE}/student/${a._id}`,"GET");j&&(d!=null&&d.data)&&d.status==="success"?t(d.data||[]):(console.error("Failed to fetch timetables:",d),j&&(A("Failed to load timetable data"),$(!0)))}catch(d){console.error("Error fetching timetables:",d),j&&(A("Error loading timetable: "+(d.message||"Unknown error")),$(!0))}};return a._id&&O(),()=>{j=!1}},[H,a._id]);const Y=l.useMemo(()=>{let j=!0;return!o||!o.length?[]:Promise.all(o.map(async d=>{var Le,Oe,ye,Ne,pe,he,Ce,ge;if(!d||!d.dayOfWeek)return console.warn(`Invalid timetable or dayOfWeek for ID: ${d==null?void 0:d._id}`),null;const D=ct.indexOf(d.dayOfWeek);if(D===-1)return console.warn(`Invalid dayOfWeek: ${d.dayOfWeek} for timetable ID: ${d._id}`),null;const X=D+1,oe=`${d.startTime||"00:00"}:00`,R=d.endTime?`${d.endTime}:00`:`${new Date(`1970-01-01T${d.startTime}:00Z`).setMinutes(new Date(`1970-01-01T${d.startTime}:00Z`).getMinutes()+(d.numberOfPeriods||1)*45).toISOString().slice(11,16)}:00`,je=(Le=d.subject)==null?void 0:Le.name._id,Te=await K(je,()=>j);return{id:d._id,title:`${Te} (${d.location||"N/A"})`,daysOfWeek:[X],startTime:oe,endTime:R,extendedProps:{classLevel:((Oe=d.classLevel)==null?void 0:Oe._id)||d.classLevel||"",classLevelName:((ye=d.classLevel)==null?void 0:ye.name)||"N/A",subclassLetter:d.subclassLetter||"",subject:je||"",subjectName:Te,teacher:((Ne=d.teacher)==null?void 0:Ne._id)||d.teacher||null,teacherName:d.teacher&&`${d.teacher.firstName||""} ${d.teacher.lastName||""}`.trim()||"No Teacher Assigned",dayOfWeek:d.dayOfWeek,startTime:d.startTime||"",numberOfPeriods:d.numberOfPeriods||1,location:d.location||"",attendanceStatus:((ge=(Ce=(he=(pe=d.periodAttendance)==null?void 0:pe[0])==null?void 0:he.attendance)==null?void 0:Ce.find(ke=>ke.studentId.toString()===v))==null?void 0:ge.status)||"N/A"}}})).then(d=>d.filter(D=>D!==null)).catch(d=>(console.error("Error processing calendar events:",d),A("Failed to process timetable events"),$(!0),[]))},[o,v,K]),[M,z]=l.useState([]),[m,V]=l.useState(!0),[ce,le]=l.useState(null);l.useEffect(()=>{let j=!0;return V(!0),le(null),Y&&typeof Y.then=="function"?Y.then(O=>{j&&(z(Array.isArray(O)?O:[]),V(!1))}).catch(O=>{console.error("Error resolving calendar events:",O),j&&(le("Failed to load calendar events"),V(!1))}):j&&(z(Array.isArray(Y)?Y:[]),V(!1)),()=>{j=!1}},[Y]);const be=l.useCallback(j=>{const O=o.find(d=>d._id===j.event.id);O&&(P(O),h(!0))},[o]),J=b||r||m,ve=(c==null?void 0:c.status)==="failed"?c.message:q||te||ce,_=l.useMemo(()=>{var j;return{data:a.classLevelId?[{_id:a.classLevelId,name:((j=a.currentClassLevel)==null?void 0:j.className)||"N/A"}]:[]}},[a.classLevelId,(ue=a.currentClassLevel)==null?void 0:ue.className]),W=l.useMemo(()=>!o||!o.length?{data:[]}:{data:o.map(j=>{var O,d;return{_id:((O=j.subject)==null?void 0:O._id)||j.subject,name:s[((d=j.subject)==null?void 0:d._id)||j.subject]||"Unknown"}}).filter((j,O,d)=>d.findIndex(D=>{var X,oe;return((X=D._id)==null?void 0:X.toString())===((oe=j._id)==null?void 0:oe.toString())})===O)},[o,s]),xe=l.useMemo(()=>{if(!o||!o.length)return{data:[{_id:null,name:"No Teacher Assigned"}]};const j=o.map(D=>D.teacher?{_id:D.teacher._id||D.teacher,firstName:D.teacher.firstName||"N/A",lastName:D.teacher.lastName||"",name:`${D.teacher.firstName||"N/A"} ${D.teacher.lastName||""}`.trim()||"No Teacher Assigned"}:{_id:null,name:"No Teacher Assigned"}),O=[],d=new Set;for(const D of j){const X=D._id?D._id.toString():"no_teacher";d.has(X)||(d.add(X),O.push(D))}return{data:O}},[o]);return{calendarEvents:M,viewModalOpen:T,setViewModalOpen:h,confirmationModalOpen:I,setConfirmationModalOpen:$,confirmationMessage:E,setConfirmationMessage:A,selectedTimetable:g,setSelectedTimetable:P,handleEventClick:be,classLevelData:_,subjectData:W,teacherData:xe,subjectNamesCache:s,loading:J,error:ve,daysOfWeek:ct}},pt=({user:v})=>{const U=Me();Ae(U.palette.mode);const a=(v==null?void 0:v._id)||"",o=Ie("(max-width: 768px)"),t=Ie("(max-width: 375px)"),{calendarEvents:T,viewModalOpen:h,setViewModalOpen:I,confirmationModalOpen:$,setConfirmationModalOpen:E,confirmationMessage:A,selectedTimetable:g,setSelectedTimetable:P,handleEventClick:s,classLevelData:N,teacherData:b,subjectNamesCache:q,loading:H,error:c}=jt({userId:a}),[r,te]=l.useState([]),[Q,K]=l.useState(!0),[Y,M]=l.useState(null);return v!=null&&v._id?(l.useEffect(()=>{let z=!0;return K(!0),M(null),T&&typeof T.then=="function"?T.then(m=>{z&&(te(Array.isArray(m)?m:[]),K(!1))}).catch(m=>{console.error("Error resolving calendar events:",m),z&&(M("Failed to load calendar events"),K(!1))}):z&&(te(Array.isArray(T)?T:[]),K(!1)),()=>{z=!1}},[T]),console.log("calendarEvents (raw):",T),console.log("resolvedEvents:",r),e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"STUDENT TIMETABLE",subtitle:"View Your Weekly Schedule",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsx(ee,{children:H||Q?e.jsx(Qe,{}):c||Y?e.jsx(y,{variant:"h6",color:"error",children:c||Y}):r.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:r,eventClick:s,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1,eventClassNames:"cursor-pointer"}):e.jsx(y,{variant:"h6",children:"No schedule available."})}),e.jsx(xt,{open:h,onClose:()=>{I(!1),P(null)},timetable:g,classLevelData:N,subjectNamesCache:q,teacherData:b,showEditButton:!1,showAttendance:!0,userId:a}),e.jsx(st,{open:$,onClose:()=>E(!1),title:"Timetable Operation",message:A,isLoading:H})]})):e.jsx(y,{variant:"h6",color:"error",children:"Error: User ID not found"})},vt=({open:v,onClose:U,onConfirm:a,attendanceChanges:o={},handleAttendanceChange:t,studentData:T=[],attendanceData:h=[],isLoading:I})=>{console.log("AttendanceModal props:",{studentData:T,attendanceChanges:o,attendanceData:h});const $=(g,P)=>{const s=g?g[0]:"",N=P?P[0]:"";return`${s}${N}`.toUpperCase()},E=g=>{const P=h.find(s=>!s.date||typeof s.date!="string"?(console.warn("Invalid or missing date in attendance period:",s),!1):s.periodIndex===0&&s.date.startsWith("2025-08-02"));return P==null?void 0:P.attendance.some(s=>s.studentId.toString()===g.toString())},A=g=>{const P=h.find(N=>!N.date||typeof N.date!="string"?(console.warn("Invalid or missing date in attendance period:",N),!1):N.periodIndex===0&&N.date.startsWith("2025-08-02")),s=P==null?void 0:P.attendance.find(N=>N.studentId.toString()===g.toString());return s?s.status:null};return e.jsx(Ee,{open:v,onClose:U,title:"Mark Attendance",onConfirm:a,confirmMessage:"Confirm",styleProps:{padding:"20px"},noConfirm:I,children:e.jsx(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:T.length>0?T.map(g=>e.jsxs(ee,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(ee,{display:"flex",alignItems:"center",gap:"10px",children:[e.jsx(gt,{src:g.profilePictureUrl||"",alt:`${g.firstName} ${g.lastName}`,sx:{width:40,height:40},children:!g.profilePictureUrl&&$(g.firstName,g.lastName)}),e.jsxs(y,{children:[g.firstName," ",g.lastName]})]}),E(g._id)?e.jsxs(y,{color:"textSecondary",children:["Attendance already marked for student (",A(g._id),")"]}):e.jsx(ae,{sx:{minWidth:100},children:e.jsxs(re,{value:o[g._id]||"Absent",onChange:P=>t(g._id,P.target.value),children:[e.jsx(L,{value:"Present",children:"Present"}),e.jsx(L,{value:"Absent",children:"Absent"}),e.jsx(L,{value:"Late",children:"Late"}),e.jsx(L,{value:"Excused",children:"Excused"})]})})]},g._id)):e.jsx(y,{children:"No students available"})})})},Tt=({open:v,onClose:U,timetable:a,classLevelData:o,subjectNamesCache:t,onMarkAttendance:T})=>{const h=new Date("2025-08-03T21:13:00+01:00"),I=()=>{if(!a||!a.start)return console.warn("Missing timetable or start date:",a),!1;try{const s=new Date(a.start);return isNaN(s.getTime())?(console.warn("Invalid start date:",a.start),!1):s<=h}catch(s){return console.warn("Error parsing start date:",a.start,s),!1}},$=s=>{var N,b;return s?typeof s=="string"?((b=(N=o==null?void 0:o.data)==null?void 0:N.find(q=>q._id.toString()===s.toString()))==null?void 0:b.name)||"N/A":s.name||"N/A":"N/A"},E=s=>{var N,b;return s?typeof s=="string"?((b=(N=o==null?void 0:o.data)==null?void 0:N.find(q=>q._id.toString()===s.toString()))==null?void 0:b.section)||"N/A":s.section||"N/A":"N/A"},A=s=>{var N;return s?typeof s=="string"?t[s]||"Unknown":t[s.name]||((N=s.name)==null?void 0:N.name)||"Unknown":"Unknown"},g=s=>!s||typeof s=="string"?"No Teacher":`${s.firstName||""} ${s.lastName||""}`.trim()||"No Teacher";console.log("ViewTimetableModal timetable:",a);const P=I();return e.jsx(Ee,{open:v,onClose:U,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:a?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(y,{children:[e.jsx("strong",{children:"Class Level:"})," ",$(a.classLevel)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Section:"})," ",E(a.classLevel)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subject:"})," ",A(a.subject)]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"End Time:"})," ",a.endTime||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Teacher:"})," ",g(a.teacher)]}),a.start&&e.jsxs(y,{children:[e.jsx("strong",{children:"Event Date:"})," ",new Date(a.start).toLocaleString("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:"Africa/Lagos"})]}),T&&e.jsx(Fe,{content:"Mark Attendance",icon:e.jsx(ft,{}),onClick:T,disabled:!P})]}):e.jsx(y,{children:"No timetable details available"})})},dt=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],yt=({userId:v})=>{const U=Me();Ae(U.palette.mode);const[a,o]=l.useState([]),[t,T]=l.useState(""),[h,I]=l.useState(""),[$,E]=l.useState(!1),[A,g]=l.useState(!1),[P,s]=l.useState(!1),[N,b]=l.useState(""),[q,H]=l.useState(null),[c,r]=l.useState(null),[te,Q]=l.useState({}),[K,Y]=l.useState({}),[M,z]=l.useState([]),[m,V]=l.useState({}),[ce,le]=l.useState([]),{loading:be,error:J,callApi:ve,data:_}=ne(),{loading:W,error:xe,callApi:ue}=ne(),{loading:j,error:O,callApi:d}=ne(),{loading:D,error:X,callApi:oe,data:R}=ne(),{loading:je,error:Te,data:Le}=ne(),{loading:Oe,error:ye,callApi:Ne}=ne(),{loading:pe,error:he,callApi:Ce}=ne(),ge=l.useCallback(async(C,k)=>{var F;if(!C)return"Unknown";if(K[C])return K[C];try{const i=await Ne(`${se.SUBJECT_NAME}/${C}`,"GET"),S=((F=i==null?void 0:i.data)==null?void 0:F.name)||"Unknown";return k()&&Y(G=>({...G,[C]:S})),S}catch(i){return console.error(`Error fetching subject name for ID ${C}:`,i),"Unknown"}},[Ne,K]);l.useEffect(()=>{ve(`${se.TIMETABLE}/teacher/${v}`,"GET"),oe(`${se.CLASS_LEVEL}`,"GET")},[ve,oe,v]),l.useEffect(()=>{let C=!0;const k=async()=>{if(!(_!=null&&_.status)==="success"||!(_!=null&&_.data))return;const F=[],i=new Set;_.data.forEach(w=>{var de,n;const Z=`${(de=w.classLevel)==null?void 0:de._id}_${w.subclassLetter}`;!i.has(Z)&&((n=w.classLevel)!=null&&n._id)&&w.subclassLetter&&(i.add(Z),F.push({classLevelId:w.classLevel._id,subclassLetter:w.subclassLetter}))});const S=F.map(async({classLevelId:w,subclassLetter:Z})=>{var de;try{const n=await ue(`${se.CLASS_LEVEL}/${w}/subclasses/${Z}/students`,"GET");return console.log(`fetchStudents for ${w}_${Z}:`,n.data),{key:`${w}_${Z}`,students:((de=n==null?void 0:n.data)==null?void 0:de.students)||[]}}catch(n){return console.error(`Error fetching students for ${w}_${Z}:`,n),{key:`${w}_${Z}`,students:[]}}}),G=await Promise.all(S);if(C){const w=G.reduce((Z,{key:de,students:n})=>(Z[de]=n,Z),{});V(w),console.log("allStudents:",w)}};return(_==null?void 0:_.status)==="success"&&k(),()=>{C=!1}},[_,ue]),l.useEffect(()=>{(_==null?void 0:_.status)==="success"&&o(_.data||[])},[_]);const ke=l.useMemo(()=>{const C=[],k=new Set;return a.forEach(F=>{const i=F.classLevel;i&&i._id&&!k.has(i._id)&&(k.add(i._id),C.push({_id:i._id,name:i.name}))}),C},[a]),Be=l.useMemo(()=>{if(!t)return[];const C=[],k=new Set;return a.forEach(F=>{var i;((i=F.classLevel)==null?void 0:i._id)===t&&F.subclassLetter&&(k.has(F.subclassLetter)||(k.add(F.subclassLetter),C.push(F.subclassLetter)))}),C.sort()},[a,t]),fe=l.useMemo(()=>{let C=!0;if(!a||a.length===0)return[];const k=a.filter(i=>{var w;const S=!t||((w=i.classLevel)==null?void 0:w._id)===t,G=!h||i.subclassLetter===h;return S&&G});return Promise.all(k.map(async i=>{var u,f,x,p;const S=dt.indexOf(i.dayOfWeek);if(S===-1)return console.warn(`Invalid dayOfWeek: ${i.dayOfWeek} for timetable ID: ${i._id}`),null;const G=S,w=`${i.startTime}:00`,Z=`${i.endTime}:00`,de=((u=i.subject)==null?void 0:u.name._id)||i.subject,n=await ge(de,()=>C);return{id:i._id,title:`${n} (${i.location})`,daysOfWeek:[G],startTime:w,endTime:Z,extendedProps:{classLevel:((f=i.classLevel)==null?void 0:f._id)||i.classLevel,classLevelName:((x=i.classLevel)==null?void 0:x.name)||"N/A",section:((p=i.classLevel)==null?void 0:p.section)||"N/A",subclassLetter:i.subclassLetter||"",subject:de||"",subjectName:n,teacherName:i.teacher&&`${i.teacher.firstName||""} ${i.teacher.lastName||""}`.trim()||"No Teacher",dayOfWeek:i.dayOfWeek,startTime:i.startTime,numberOfPeriods:i.numberOfPeriods,location:i.location}}})).then(i=>i.filter(S=>S!==null)).catch(i=>(console.error("Error processing calendar events:",i),b("Failed to process timetable events"),s(!0),[]))},[a,t,h,ge]),[De,we]=l.useState([]),[_e,Se]=l.useState(!0),[He,We]=l.useState(null);l.useEffect(()=>{let C=!0;return Se(!0),We(null),fe&&typeof fe.then=="function"?fe.then(k=>{C&&(we(Array.isArray(k)?k:[]),Se(!1))}).catch(k=>{console.error("Error resolving calendar events:",k),C&&(We("Failed to load calendar events"),Se(!1))}):C&&(we(Array.isArray(fe)?fe:[]),Se(!1)),()=>{C=!1}},[fe]);const Ue=l.useCallback(async(C,k,F="2025-08-02")=>{try{const i=F?`periodIndex=${k}&date=${encodeURIComponent(F)}`:`periodIndex=${k}`;console.log(`Fetching attendance for URL: ${se.TIMETABLE}/${C}/attendance?${i}`);const S=await Ce(`${se.TIMETABLE}/${C}/attendance?${i}`,"GET");return console.log("fetchAttendanceForPeriod response:",S==null?void 0:S.data),(S==null?void 0:S.status)==="success"?(le(S.data.attendance||[]),o(G=>G.map(w=>w._id===C?{...w,...S.data.timetable}:w)),S.data.attendance||[]):(console.warn("fetchAttendanceForPeriod failed:",S==null?void 0:S.message),b((S==null?void 0:S.message)||he||"Failed to fetch attendance"),s(!0),[])}catch(i){return console.error("Error fetching attendance:",i),b(he||i.message||"Failed to fetch attendance"),s(!0),[]}},[Ce,he]),Ve=l.useCallback((C,k)=>{console.log("handleAttendanceChange:",{studentId:C,newAttendance:k}),Q(F=>({...F,[C]:k}))},[]),Ge=l.useCallback(async()=>{if(!a.find(i=>i._id===q)){b("Timetable not found"),s(!0);return}const k=Object.entries(te).filter(([i])=>!ce.find(G=>{var w;return G.periodIndex===0&&((w=G.date)==null?void 0:w.startsWith("2025-08-02"))&&G.attendance.some(Z=>Z.studentId.toString()===i.toString())})).map(([i,S])=>({studentId:i,status:S,notes:S==="Absent"||S==="Excused"?"Marked by instructor":""}));if(k.length===0){b("No new attendance to mark; all students already marked"),s(!0),E(!1),H(null);return}const F={timetableId:q,periodIndex:0,attendanceData:k,date:"2025-08-02"};try{const i=await d(`${se.TIMETABLE}/${q}/attendance`,"PUT",F);(i==null?void 0:i.status)==="success"?(o(S=>S.map(G=>G._id===q?{...G,periodAttendance:i.data.periodAttendance}:G)),b("Attendance marked successfully"),E(!1),s(!0),H(null),Q({})):(b((i==null?void 0:i.message)||O||"Failed to mark attendance"),s(!0))}catch(i){b(O||i.message||"Failed to mark attendance"),s(!0)}},[a,q,te,d,O,ce]),Re=l.useCallback(async C=>{const k=a.find(F=>F._id===C);if(k){const F=`${k.classLevel._id}_${k.subclassLetter}`,i=m[F]||[];if(z(i),console.log(`Using cached students for ${F}:`,i),i.length===0){b("No students found for this class"),s(!0);return}Q(S=>{const G=i.reduce((w,Z)=>{const de=ce.find(n=>{var u;return n.periodIndex===0&&((u=n.date)==null?void 0:u.startsWith("2025-08-02"))&&n.attendance.some(f=>f.studentId.toString()===Z._id.toString())});return{...w,[Z._id]:de?null:S[Z._id]||"Absent"}},{});return console.log("openAttendanceModal initialAttendance:",G),{...S,...G}}),H(C),E(!0)}},[a,m,ce]),ze=l.useCallback(async C=>{const k=a.find(F=>F._id===C.event.id);if(k){const F=new Date(C.event.start);await Ue(k._id,0,"2025-08-02"),r({...k,start:F.toISOString()}),g(!0)}},[a,Ue]),Je=be||W||j||D||je||Oe||_e||pe,Ze=(_==null?void 0:_.status)==="failed"?_.message:J||xe||O||X||Te||ye||He||he;return{calendarEvents:De,selectedClassLevel:t,setSelectedClassLevel:T,selectedSubclass:h,setSelectedSubclass:I,classLevelOptions:ke,subclassOptions:Be,attendanceModalOpen:$,setAttendanceModalOpen:E,viewModalOpen:A,setViewModalOpen:g,confirmationModalOpen:P,setConfirmationModalOpen:s,confirmationMessage:N,selectedScheduleId:q,selectedTimetable:c,handleAttendanceChange:Ve,handleConfirmAttendance:Ge,openAttendanceModal:Re,handleEventClick:ze,classLevelData:R,subjectData:Le,studentData:M,subjectNamesCache:K,loading:Je,error:Ze,daysOfWeek:dt,attendanceChanges:te,attendanceData:ce}},Nt=({user:v})=>{const U=Me();Ae(U.palette.mode);const a=(v==null?void 0:v._id)||"",o=Ie("(max-width: 768px)"),t=Ie("(max-width: 375px)"),{calendarEvents:T,selectedClassLevel:h,setSelectedClassLevel:I,selectedSubclass:$,setSelectedSubclass:E,classLevelOptions:A,subclassOptions:g,attendanceModalOpen:P,setAttendanceModalOpen:s,viewModalOpen:N,setViewModalOpen:b,confirmationModalOpen:q,setConfirmationModalOpen:H,confirmationMessage:c,selectedTimetable:r,handleAttendanceChange:te,handleConfirmAttendance:Q,openAttendanceModal:K,handleEventClick:Y,classLevelData:M,subjectNamesCache:z,studentData:m,attendanceChanges:V,attendanceData:ce,loading:le,error:be}=yt({userId:a});return console.log("Instructor attendanceChanges:",V),console.log("Instructor attendanceData:",ce),v!=null&&v._id?e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"TEACHER TIMETABLE",subtitle:"View Your Schedule and Mark Attendance",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(ee,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ae,{sx:{minWidth:150},children:[e.jsx(ie,{children:"Class Level"}),e.jsxs(re,{value:h||"",onChange:J=>I(J.target.value),label:"Class Level",children:[e.jsx(L,{value:"",children:"All Classes"}),A.map(J=>e.jsx(L,{value:J._id,children:J.name},J._id))]})]}),e.jsxs(ae,{sx:{minWidth:120},children:[e.jsx(ie,{children:"Subclass"}),e.jsxs(re,{value:$||"",onChange:J=>E(J.target.value),label:"Subclass",disabled:!h,children:[e.jsx(L,{value:"",children:"All Subclasses"}),g.map(J=>e.jsx(L,{value:J,children:J},J))]})]})]}),e.jsx(ee,{children:le?e.jsx(Qe,{}):be?e.jsx(y,{color:"error",children:be}):T.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:T,eventClick:Y,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1,eventClassNames:"cursor-pointer"}):e.jsx(y,{children:"No schedule available."})}),e.jsx(vt,{open:P,onClose:()=>{s(!1),setSelectedScheduleId(null)},onConfirm:Q,attendanceChanges:V,handleAttendanceChange:te,studentData:m,attendanceData:ce,isLoading:le}),e.jsx(Tt,{open:N,onClose:()=>{b(!1),setSelectedTimetable(null)},timetable:r,classLevelData:M,subjectNamesCache:z,onMarkAttendance:()=>K(r==null?void 0:r._id)}),e.jsx(st,{open:q,onClose:()=>H(!1),title:"Attendance Operation",message:c,isLoading:le})]}):e.jsx(y,{variant:"h6",color:"error",children:"Error: User ID not found"})},Ct=({open:v,onClose:U,onConfirm:a,newSchedule:o,setNewSchedule:t,classLevelData:T,availableSubclasses:h,availableSubjects:I,availableTeachers:$,isLoading:E,daysOfWeek:A,handleClassLevelChange:g,handleSubclassChange:P,setConfirmationMessage:s,setConfirmationModalOpen:N})=>{var H;console.log($);const b=()=>{const c=q(o);if(c){s(c),N(!0);return}a()},q=c=>c.classLevel?c.subclassLetter?c.subject?c.teacher?c.dayOfWeek?c.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(c.startTime)?!c.numberOfPeriods||c.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(c.numberOfPeriods))?c.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Ee,{open:v,onClose:U,title:"Add New Timetable",onConfirm:b,confirmMessage:"Add",styleProps:{padding:"20px"},noConfirm:E,children:e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(re,{labelId:"class-level-modal-label",value:o.classLevel,label:"Class Level",onChange:c=>{t({...o,classLevel:c.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),g(c.target.value)},disabled:E,children:((H=T==null?void 0:T.data)==null?void 0:H.length)>0?T.data.map(c=>e.jsx(L,{value:c._id,children:c.name},c._id)):e.jsx(L,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(re,{labelId:"subclass-modal-label",value:o.subclassLetter,label:"Subclass",onChange:c=>{t({...o,subclassLetter:c.target.value,subject:"",teacher:"",teacherName:""}),P(c.target.value)},disabled:!o.classLevel||E,children:(h==null?void 0:h.length)>0?h.map(c=>e.jsx(L,{value:c,children:c},c)):e.jsx(L,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"subject-modal-label",children:"Subject"}),e.jsx(re,{labelId:"subject-modal-label",value:o.subject,label:"Subject",onChange:c=>t({...o,subject:c.target.value,teacher:"",teacherName:""}),disabled:E||!o.subclassLetter,children:(I==null?void 0:I.length)>0?I.map(c=>e.jsx(L,{value:c._id,children:c.displayName},c._id)):e.jsx(L,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(re,{labelId:"teacher-modal-label",value:o.teacher,label:"Teacher",onChange:c=>t({...o,teacher:c.target.value}),disabled:E||!o.subject,children:($==null?void 0:$.length)>0?$.map(c=>e.jsx(L,{value:c._id,children:c.displayName},c._id)):e.jsx(L,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"day-modal-label",children:"Day of Week"}),e.jsx(re,{labelId:"day-modal-label",value:o.dayOfWeek,label:"Day of Week",onChange:c=>t({...o,dayOfWeek:c.target.value}),disabled:E,children:(A==null?void 0:A.length)>0?A.map(c=>e.jsx(L,{value:c,children:c},c)):e.jsx(L,{disabled:!0,children:"No days available"})})]}),e.jsx(Pe,{label:"Start Time (HH:MM)",value:o.startTime,onChange:c=>t({...o,startTime:c.target.value}),fullWidth:!0,disabled:E,error:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime),helperText:o.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(Pe,{label:"Number of Periods",type:"number",value:o.numberOfPeriods,onChange:c=>t({...o,numberOfPeriods:c.target.value}),fullWidth:!0,inputProps:{min:1},disabled:E,error:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1),helperText:o.numberOfPeriods&&(!Number.isInteger(Number(o.numberOfPeriods))||Number(o.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(Pe,{label:"Location",value:o.location,onChange:c=>t({...o,location:c.target.value}),fullWidth:!0,disabled:E})]})})},St=({open:v,onClose:U,onConfirm:a,onDelete:o,newSchedule:t,setNewSchedule:T,classLevelData:h,availableSubclasses:I,availableSubjects:$,availableTeachers:E,isLoading:A,daysOfWeek:g,handleClassLevelChange:P,handleSubclassChange:s,setConfirmationMessage:N,setConfirmationModalOpen:b})=>{var c;const q=()=>{const r=H(t);if(r){N(r),b(!0);return}a()},H=r=>r.classLevel?r.subclassLetter?r.subject?r.teacher?r.dayOfWeek?r.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(r.startTime)?!r.numberOfPeriods||r.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(r.numberOfPeriods))?r.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(Ee,{open:v,onClose:U,title:"Edit Timetable",onConfirm:q,confirmMessage:"Update",styleProps:{padding:"20px"},noConfirm:A,additionalButton:e.jsx(ht,{variant:"contained",color:"error",onClick:o,disabled:A,sx:{mr:2},children:"Delete"}),children:e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(re,{labelId:"class-level-modal-label",value:t.classLevel,label:"Class Level",onChange:r=>{T({...t,classLevel:r.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),P(r.target.value)},disabled:A,children:((c=h==null?void 0:h.data)==null?void 0:c.length)>0?h.data.map(r=>e.jsx(L,{value:r._id,children:r.name},r._id)):e.jsx(L,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(re,{labelId:"subclass-modal-label",value:t.subclassLetter,label:"Subclass",onChange:r=>{T({...t,subclassLetter:r.target.value,subject:"",teacher:"",teacherName:""}),s(r.target.value)},disabled:!t.classLevel||A,children:(I==null?void 0:I.length)>0?I.map(r=>e.jsx(L,{value:r,children:r},r)):e.jsx(L,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"subject-modal-label",children:"Subject"}),e.jsx(re,{labelId:"subject-modal-label",value:t.subject,label:"Subject",onChange:r=>T({...t,subject:r.target.value,teacher:"",teacherName:""}),disabled:A||!t.subclassLetter,children:($==null?void 0:$.length)>0?$.map(r=>e.jsx(L,{value:r._id,children:r.displayName},r._id)):e.jsx(L,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(re,{labelId:"teacher-modal-label",value:t.teacher,label:"Teacher",onChange:r=>T({...t,teacher:r.target.value}),disabled:A||!t.subject,children:(E==null?void 0:E.length)>0?E.map(r=>e.jsx(L,{value:r._id,children:r.displayName},r._id)):e.jsx(L,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ae,{fullWidth:!0,children:[e.jsx(ie,{id:"day-modal-label",children:"Day of Week"}),e.jsx(re,{labelId:"day-modal-label",value:t.dayOfWeek,label:"Day of Week",onChange:r=>T({...t,dayOfWeek:r.target.value}),disabled:A,children:(g==null?void 0:g.length)>0?g.map(r=>e.jsx(L,{value:r,children:r},r)):e.jsx(L,{disabled:!0,children:"No days available"})})]}),e.jsx(Pe,{label:"Start Time (HH:MM)",value:t.startTime,onChange:r=>T({...t,startTime:r.target.value}),fullWidth:!0,disabled:A,error:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime),helperText:t.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(t.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(Pe,{label:"Number of Periods",type:"number",value:t.numberOfPeriods,onChange:r=>T({...t,numberOfPeriods:r.target.value}),fullWidth:!0,inputProps:{min:1},disabled:A,error:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1),helperText:t.numberOfPeriods&&(!Number.isInteger(Number(t.numberOfPeriods))||Number(t.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(Pe,{label:"Location",value:t.location,onChange:r=>T({...t,location:r.target.value}),fullWidth:!0,disabled:A})]})})},Et=({open:v,onClose:U,onEdit:a,onDelete:o,timetable:t,availableSubjects:T})=>{console.log(t);const h=Me(),I=Ae(h.palette.mode);return e.jsxs(Ee,{open:v,onClose:U,title:"Timetable Details",noConfirm:!0,confirmMessage:"Edit",styleProps:{padding:"20px"},children:[t?e.jsxs(ee,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(y,{children:[e.jsx("strong",{children:"Class Level:"})," ",t.classLevel.name]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subclass:"})," ",t.subclassLetter]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Subject:"})," ",t.subject.name]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Teacher:"})," ",t.teacher?`${t.teacher.firstName} ${t.teacher.lastName}`:"Unassigned"]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Day of Week:"})," ",t.dayOfWeek]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Start Time:"})," ",t.startTime]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",t.numberOfPeriods]}),e.jsxs(y,{children:[e.jsx("strong",{children:"Location:"})," ",t.location]})]}):e.jsx(y,{children:"No timetable details available"}),e.jsxs(ee,{display:"flex",justifyContent:"flex-end",mt:"16px",gap:"10px",children:[e.jsx(Fe,{content:"Edit Timetable",onClick:a,sx:{backgroundColor:I.greenAccent[500]}}),e.jsx(Fe,{content:"Delete Timetable",onClick:o,sx:{backgroundColor:I.redAccent[500]}})]})]})},At=({open:v,onClose:U,onConfirm:a,isLoading:o})=>e.jsx(Ee,{open:v,onClose:U,title:"Confirm Deletion",onConfirm:a,confirmMessage:"Delete",styleProps:{padding:"20px"},noConfirm:o,children:e.jsx(y,{children:"Are you sure you want to delete this timetable? This action cannot be undone."})}),ut=["Monday","Tuesday","Wednesday","Thursday","Friday"],Mt=({userId:v})=>{const U=Me();Ae(U.palette.mode);const[a,o]=l.useState(""),[t,T]=l.useState(""),[h,I]=l.useState(""),[$,E]=l.useState(!1),[A,g]=l.useState(!1),[P,s]=l.useState(!1),[N,b]=l.useState(!1),[q,H]=l.useState(!1),[c,r]=l.useState(""),[te,Q]=l.useState([]),[K,Y]=l.useState(!1),[M,z]=l.useState(null),[m,V]=l.useState({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),[ce,le]=l.useState([]),[be,J]=l.useState(!1),[ve,_]=l.useState(null),[W,xe]=l.useState([]),[ue,j]=l.useState([]),[O,d]=l.useState([]),{loading:D,error:X,callApi:oe}=ne(),{loading:R,error:je,callApi:Te}=ne(),{loading:Le,error:Oe,callApi:ye}=ne(),{loading:Ne,error:pe,callApi:he}=ne(),{loading:Ce,error:ge,callApi:ke}=ne(),{loading:Be,error:fe,callApi:De}=ne(),{loading:we,error:_e,callApi:Se}=ne();l.useEffect(()=>{(async()=>{var u,f;try{const x=await Te(se.CLASS_LEVEL,"GET");console.log("Class Levels fetched:",(u=x==null?void 0:x.data)==null?void 0:u.data),xe(((f=x==null?void 0:x.data)==null?void 0:f.data)||[])}catch(x){console.error("Error loading class levels:",x),r("Failed to load class levels: "+(x.message||"Unknown error")),b(!0)}})()},[Te]),l.useEffect(()=>{if(!t||!h){console.log("Skipping subject fetch: missing classLevel or subclass"),j([]),Q([]);return}(async()=>{const u=W.find(p=>p._id===t);if(!u){console.log("Class level not found:",t),j([]),Q([]);return}const f=u.subclasses.find(p=>p.letter===h);if(!f){console.log("Subclass not found:",h),j([]),Q([]);return}const x=f.subjects.map(p=>p.subject);console.log("Subject IDs to fetch:",x);try{Y(!0);const p=await ye(`${se.SUBJECT}?ids=${x.join(",")}`,"GET");console.log("Fetched subjects:",p==null?void 0:p.data);const B=(p==null?void 0:p.data)||[];j(B);const me=B.map($e=>{var qe;return{_id:$e._id,displayName:((qe=$e.name)==null?void 0:qe.name)||"Unknown"}});Q(me)}catch(p){console.error("Error fetching subjects:",p),r("Failed to load subjects: "+(p.message||"Unknown error")),b(!0),j([]),Q([])}finally{Y(!1)}})()},[t,h,W,ye]),l.useEffect(()=>{if(!a||!t||!h){console.log("Skipping timetable fetch: missing section, classLevel, or subclass",{selectedSection:a,selectedClassLevel:t,selectedSubclass:h}),d([]);return}(async()=>{try{const u=await oe(`${se.TIMETABLE}?classLevel=${t}&subclassLetter=${h}`,"GET");console.log("Timetables fetched:",u==null?void 0:u.data),d((u==null?void 0:u.data)||[])}catch(u){console.error("Error fetching timetables:",u),r("Failed to load timetables: "+(u.message||"Unknown error")),b(!0),d([])}})()},[a,t,h,oe]);const He=l.useMemo(()=>{if(console.log("Computing available teachers:",{classLevels:W,selectedClassLevel:t,selectedSubclass:h}),!W.length||!t||!h)return console.log("Missing required data for teachers, returning empty teachers"),[];const n=W.filter(f=>f._id===t).flatMap(f=>{const x=f.subclasses.find(B=>B.letter===h);if(!x)return console.log("Subclass not found:",h),[];const p=x.subjects.flatMap(B=>B.teachers||[]).filter(Boolean);return console.log("Teacher IDs from subclass subjects:",p),f.teachers.filter(B=>p.includes(B.teacherId)).map(B=>({_id:B.teacherId,displayName:`${B.firstName} ${B.lastName}`.trim()}))}),u=Array.from(new Map(n.map(f=>[f._id,f])).values());return console.log("Computed unique teachers:",u),u},[W,t,h]);l.useEffect(()=>{if(!m.teacher||!W.length){V(x=>({...x,teacherName:""}));return}const n=W.find(x=>x._id===m.classLevel);if(!n){V(x=>({...x,teacherName:""}));return}const u=n.teachers.find(x=>x.teacherId===m.teacher),f=u?`${u.firstName} ${u.lastName}`.trim():"";console.log("Setting teacherName:",{teacherId:m.teacher,teacherName:f}),V(x=>({...x,teacherName:f}))},[m.teacher,W,m.classLevel]);const We=l.useCallback((n,u)=>{const[f,x]=n.split(":").map(Number),p=f*60+x+u*45,B=Math.floor(p/60),me=p%60;return`${B.toString().padStart(2,"0")}:${me.toString().padStart(2,"0")}`},[]),Ue=l.useCallback(async(n,u,f=null)=>{if(!n||u===void 0||u===null){console.log("Invalid parameters for fetching attendance:",{timetableId:n,periodIndex:u}),r("Invalid timetable or period index"),b(!0);return}try{J(!0),_(null);const x=`${se.TIMETABLE}/${n}/attendance?periodIndex=${u}${f?`&date=${f}`:""}`,p=await Se(x,"GET");console.log("Attendance fetched:",p==null?void 0:p.data),(p==null?void 0:p.status)==="success"?le(p.data.attendance||[]):(r((p==null?void 0:p.message)||_e||"Failed to fetch attendance"),b(!0),le([]))}catch(x){console.error("Error fetching attendance:",x),r(_e||x.message||"Failed to fetch attendance"),b(!0),le([])}finally{J(!1)}},[Se,_e]),Ve=l.useMemo(()=>(console.log("Processing calendarEvents, timetables:",O,"subjects:",ue),O.length?O.map(n=>{var at,rt,lt,ot,it;const u=ut.indexOf(n.dayOfWeek);if(u===-1)return console.log("Invalid dayOfWeek:",n.dayOfWeek),null;const f=u+1;console.log(`Mapping ${n.dayOfWeek} to daysOfWeek: [${f}]`);const x=`${n.startTime}:00`,p=`${n.endTime}:00`,B=((at=n.subject)==null?void 0:at._id)||n.subject,me=ue.find(mt=>mt._id===B),$e=((rt=me==null?void 0:me.name)==null?void 0:rt.name)||n.subjectName||"Unknown";console.log(`Subject name for ${B}: ${$e}`);const qe=n.teacher?`${n.teacher.firstName} ${n.teacher.lastName}`.trim():"Unassigned",nt={id:n._id,title:`${$e} (${n.location})`,daysOfWeek:[f],startTime:x,endTime:p,extendedProps:{classLevel:((lt=n.classLevel)==null?void 0:lt._id)||n.classLevel,classLevelName:((ot=n.classLevel)==null?void 0:ot.name)||"N/A",subclassLetter:n.subclassLetter,subject:B,subjectName:$e,teacher:((it=n.teacher)==null?void 0:it._id)||null,teacherName:qe,dayOfWeek:n.dayOfWeek,startTime:n.startTime,numberOfPeriods:n.numberOfPeriods,location:n.location,periods:n.periods||[]}};return console.log("Generated event:",JSON.stringify(nt,null,2)),nt}).filter(Boolean):(console.log("No timetables, returning empty events"),[])),[O,ue]),Ge=l.useMemo(()=>{if(console.log("Filtering class levels with:",{classLevels:W,selectedSection:a}),!W.length)return{data:[]};if(!a)return{data:W};const n=W.filter(u=>u.section===a);return console.log("Filtered class levels:",n),{data:n}},[W,a]),Re=l.useMemo(()=>{var f;if(console.log("Computing available subclasses:",{classLevels:W,selectedClassLevel:t}),!W.length||!t)return console.log("No classLevels or selectedClassLevel, returning empty subclasses"),[];const n=W.find(x=>x._id===t);if(!n)return console.log("Selected class level not found in classLevels"),[];const u=[...new Set((f=n.subclasses)==null?void 0:f.map(x=>x.letter).filter(Boolean))];return console.log("Computed subclasses:",u),u},[W,t]),ze=l.useCallback(n=>{console.log("Setting section:",n),o(n),T(""),I(""),V(u=>({...u,classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),Je=l.useCallback(n=>{console.log("Setting class level:",n),T(n),I(""),V(u=>({...u,classLevel:n,subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),Ze=l.useCallback(n=>{console.log("Setting subclass:",n),I(n),V(u=>({...u,subclassLetter:n,subject:"",teacher:"",teacherName:""}))},[]),C=l.useCallback(()=>{if(!v)return"User not authenticated. Please log in.";if(!m.classLevel)return"Class level is required";if(!m.subclassLetter)return"Subclass is required";if(!m.subject)return"Subject is required";if(!m.teacher)return"Teacher is required";if(!m.dayOfWeek)return"Day of week is required";if(!m.startTime)return"Start time is required";if(!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(m.startTime))return"Start time must be in HH:MM format (00:00-23:59)";const[n,u]=m.startTime.split(":").map(Number),f=n*60+u;if(f<7*60||f>18*60)return"Start time must be between 07:00 AM and 06:00 PM";if(!m.numberOfPeriods||m.numberOfPeriods<1)return"Number of periods must be at least 1";if(!Number.isInteger(Number(m.numberOfPeriods)))return"Number of periods must be an integer";const x=We(m.startTime,Number(m.numberOfPeriods)),[p,B]=x.split(":").map(Number);return p*60+B>18*60?"End time cannot exceed 06:00 PM":m.location?"":"Location is required"},[m,v,We]),k=l.useCallback(async()=>{const n=C();if(n){r(n),b(!0);return}const u={classLevel:m.classLevel,subclassLetter:m.subclassLetter,subject:m.subject,teacher:m.teacher,dayOfWeek:m.dayOfWeek,startTime:m.startTime,numberOfPeriods:parseInt(m.numberOfPeriods,10),location:m.location,createdBy:v};try{const f=await he(se.TIMETABLE,"POST",u);(f==null?void 0:f.status)==="success"?(d(x=>[f.data,...x].slice(0,10)),r("Timetable added successfully"),E(!1),V({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})):r((f==null?void 0:f.message)||pe||"Failed to add timetable")}catch(f){console.error("Error adding timetable:",f),r(pe||f.message||"Failed to add timetable")}b(!0)},[he,pe,C,v]),F=l.useCallback(async()=>{if(!M){r("No timetable selected for update"),b(!0);return}const n=C();if(n){r(n),b(!0);return}const u={classLevel:m.classLevel,subclassLetter:m.subclassLetter,subject:m.subject,teacher:m.teacher,dayOfWeek:m.dayOfWeek,startTime:m.startTime,numberOfPeriods:parseInt(m.numberOfPeriods,10),location:m.location,createdBy:v};try{const f=await ke(`${se.TIMETABLE}/${M._id}`,"PUT",u);(f==null?void 0:f.status)==="success"?(d(x=>x.map(p=>p._id===M._id?{...p,...f.data}:p)),r("Timetable updated successfully"),g(!1),s(!1),V({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),z(null)):r((f==null?void 0:f.message)||ge||"Failed to update timetable")}catch(f){console.error("Error updating timetable:",f),r(ge||f.message||"Failed to update timetable")}b(!0)},[ke,ge,M,C,v]),i=l.useCallback(()=>{if(!M){r("No timetable selected for deletion"),b(!0);return}H(!0)},[M]),S=l.useCallback(async()=>{try{const n=await De(`${se.TIMETABLE}/${M._id}`,"DELETE");(n==null?void 0:n.status)==="success"?(d(u=>u.filter(f=>f._id!==M._id)),r("Timetable deleted successfully"),g(!1),s(!1),H(!1),z(null)):r((n==null?void 0:n.message)||fe||"Failed to delete timetable")}catch(n){console.error("Error deleting timetable:",n),r(fe||n.message||"Failed to delete timetable")}b(!0)},[De,fe,M]),G=l.useCallback(n=>{const u=O.find(B=>B._id===n.event.id);if(!u){r("Timetable not found"),b(!0);return}const f=te.find(B=>{var me;return B._id===((me=u.subject)==null?void 0:me._id)||u.subject}),x=(f==null?void 0:f.displayName)||u.subjectName||"Unknown",p={...u,subject:x};console.log("Transformed timetable:",p),z(p),s(!0)},[O,te]),w=l.useCallback(()=>{var n,u,f;M&&(V({classLevel:((n=M.classLevel)==null?void 0:n._id)||M.classLevel,subclassLetter:M.subclassLetter,subject:((u=M.subject)==null?void 0:u._id)||M.subject,teacher:((f=M.teacher)==null?void 0:f._id)||"",teacherName:M.teacher?`${M.teacher.firstName} ${M.teacher.lastName}`.trim():"",dayOfWeek:M.dayOfWeek,startTime:M.startTime,numberOfPeriods:M.numberOfPeriods,location:M.location}),s(!1),g(!0))},[M]);return{calendarEvents:Ve,selectedSection:a,setSelectedSection:ze,selectedClassLevel:t,setSelectedClassLevel:Je,selectedSubclass:h,setSelectedSubclass:Ze,addModalOpen:$,setAddModalOpen:E,editModalOpen:A,setEditModalOpen:g,viewModalOpen:P,setViewModalOpen:s,confirmationModalOpen:N,setConfirmationModalOpen:b,deleteConfirmationOpen:q,setDeleteConfirmationOpen:H,confirmationMessage:c,setConfirmationMessage:r,newSchedule:m,setNewSchedule:V,selectedTimetable:M,handleAddSchedule:k,handleUpdateSchedule:F,handleInitiateDelete:i,handleDeleteSchedule:S,handleEventClick:G,handleOpenEditModal:w,classLevelData:Ge,availableSubclasses:Re,availableSubjects:te,availableTeachers:He,attendanceData:ce,fetchAttendanceForPeriod:Ue,loading:D||R||Le||Ne||Ce||Be||we||K,error:X||je||Oe||pe||ge||fe||_e||ve,daysOfWeek:ut,weeksPerTerm:12,setSelectedTimetable:z}},Lt=()=>{var X,oe;const v=Me(),U=Ae(v.palette.mode),a=Ye(R=>{var je;return((je=R.users.user)==null?void 0:je._id)||""}),o=Ie("(max-width: 768px)"),t=Ie("(max-width: 375px)"),{calendarEvents:T,selectedSection:h,setSelectedSection:I,selectedClassLevel:$,setSelectedClassLevel:E,selectedSubclass:A,setSelectedSubclass:g,addModalOpen:P,setAddModalOpen:s,editModalOpen:N,setEditModalOpen:b,viewModalOpen:q,setViewModalOpen:H,confirmationModalOpen:c,setConfirmationModalOpen:r,deleteConfirmationOpen:te,setDeleteConfirmationOpen:Q,confirmationMessage:K,setConfirmationMessage:Y,newSchedule:M,setNewSchedule:z,selectedTimetable:m,handleAddSchedule:V,handleUpdateSchedule:ce,handleInitiateDelete:le,handleDeleteSchedule:be,handleEventClick:J,handleOpenEditModal:ve,classLevelData:_,availableSubclasses:W,availableSubjects:xe,availableTeachers:ue,loading:j,error:O,daysOfWeek:d,setSelectedTimetable:D}=Mt({userId:a});return console.log("CalendarEvents:",T),e.jsxs(ee,{py:"20px",children:[e.jsx(tt,{title:"ADMIN TIMETABLE",subtitle:"Manage Class and Subclass Timetables",sx:{"& h1":{fontSize:t?"20px":"24px"},"& h2":{fontSize:t?"14px":"16px"}}}),e.jsxs(ee,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ae,{sx:{minWidth:150},children:[e.jsx(ie,{id:"section-select-label",children:"Section"}),e.jsxs(re,{labelId:"section-select-label",value:h,label:"Section",onChange:R=>I(R.target.value),children:[e.jsx(L,{value:"",children:"All"}),e.jsx(L,{value:"Primary",children:"Primary"}),e.jsx(L,{value:"Secondary",children:"Secondary"})]})]}),e.jsxs(ae,{sx:{minWidth:150},children:[e.jsx(ie,{id:"class-level-select-label",children:"Class Level"}),e.jsxs(re,{labelId:"class-level-select-label",value:$,label:"Class Level",onChange:R=>E(R.target.value),disabled:!((X=_==null?void 0:_.data)!=null&&X.length),children:[e.jsx(L,{value:"",children:"Select Class Level"}),(oe=_==null?void 0:_.data)==null?void 0:oe.map(R=>e.jsx(L,{value:R._id,children:R.name},R._id))]})]}),e.jsxs(ae,{sx:{minWidth:150},children:[e.jsx(ie,{id:"subclass-select-label",children:"Subclass"}),e.jsxs(re,{labelId:"subclass-select-label",value:A,label:"Subclass",onChange:R=>g(R.target.value),disabled:!$||!(W!=null&&W.length),children:[e.jsx(L,{value:"",children:"Select Subclass"}),(W==null?void 0:W.length)>0?W.map(R=>e.jsx(L,{value:R,children:R},R)):e.jsx(L,{disabled:!0,children:"No subclasses available"})]})]}),e.jsx(Fe,{content:"Add Timetable",onClick:()=>s(!0),disabled:!$||!A,sx:{backgroundColor:U.greenAccent[500]}})]}),e.jsx(ee,{sx:{"& .fc-event":{cursor:"pointer"}},children:j?e.jsx(Qe,{}):O?e.jsx(y,{color:"error",children:O}):T.length>0?e.jsx(Ke,{height:t?"45vh":o?"50vh":"75vh",plugins:[Xe,et],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:T,eventClick:J,slotMinTime:"00:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(y,{children:"No timetable available for selected time table."})}),e.jsx(Ct,{open:P,onClose:()=>{s(!1),z({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})},onConfirm:V,newSchedule:M,setNewSchedule:z,classLevelData:_,availableSubclasses:W,availableSubjects:xe,availableTeachers:ue,isLoading:j,daysOfWeek:d,handleClassLevelChange:E,handleSubclassChange:g,setConfirmationMessage:Y,setConfirmationModalOpen:r}),e.jsx(St,{open:N,onClose:()=>{b(!1),D(null)},onConfirm:ce,onDelete:le,newSchedule:M,setNewSchedule:z,classLevelData:_,availableSubclasses:W,availableSubjects:xe,availableTeachers:ue,isLoading:j,daysOfWeek:d,handleClassLevelChange:E,handleSubclassChange:g,setConfirmationMessage:Y,setConfirmationModalOpen:r}),e.jsx(Et,{open:q,onClose:()=>{H(!1),D(null)},onEdit:ve,onDelete:le,timetable:m,classLevelData:_,availableSubjects:xe}),e.jsx(At,{open:te,onClose:()=>Q(!1),onConfirm:be,isLoading:j}),e.jsx(st,{open:c,onClose:()=>r(!1),title:"Timetable Operation",message:K,isLoading:j})]})},Ot=()=>{const v=Ye(a=>a.users.user),U=v.role;return e.jsx("div",{children:U==="student"?e.jsx(pt,{user:v}):U==="teacher"?e.jsx(Nt,{user:v}):e.jsx(Lt,{})})},Yt=bt(Ot);export{Yt as default};
