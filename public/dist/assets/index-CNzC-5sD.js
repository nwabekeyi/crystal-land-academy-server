import{a as De,P as Le,r as i,e as W,O as we,j as s,i as fe}from"./index-D_kDwTfs.js";import{t as ke,M as pe}from"./modal-BxlCeH0G.js";import{H as Me}from"./Header--K5xCYHz.js";import{a as xe,b as ge,T as Ae}from"./table-CgRA7PAF.js";import{u as je}from"./useApi-CbGRypPa.js";import{C as Ce}from"./customIconButton-C0ithWsK.js";import{h as Pe,e as Be,g as Te,i as ve}from"./index.esm-WJ1mnu2y.js";import{u as Ee,M as Q}from"./MenuItem-C1-m6Bfh.js";import{w as ye}from"./dasboardPagesContainer-BVoh5IGI.js";import{A as Fe}from"./confirmationModal-BB-Svlb_.js";import{j as Ye,v as S,T as _,y as H,x as _e}from"./TextField-BjozRPlS.js";import{I as $e}from"./IconButton-BWguZOxP.js";import"./index-NEecTaUU.js";import"./index-BddYBctM.js";import"./loadingButton-C8yTBzap.js";import"./CircularProgress-xlKSzPfm.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-ambHsR5D.js";import"./useMediaQuery-CPtOszEa.js";const Ne=()=>{const Y=Ee(),{subjects:c,academicYears:x,classLevels:f,usersData:X}=De(Le),[p,$]=i.useState("name"),[A,N]=i.useState("asc"),[ne,J]=i.useState(!1),[O,V]=i.useState("create"),[R,re]=i.useState(null),[b,u]=i.useState({name:"",description:"",academicYear:"",classLevelSubclasses:[]}),[m,j]=i.useState(""),[oe,q]=i.useState(!1),[U,Z]=i.useState(null),[ie,I]=i.useState(!1),{data:T,loading:ee,callApi:w}=je(),{callApi:k,loading:ae,error:P}=je();i.useEffect(()=>{w(W.SUBJECT,"GET")},[w]),i.useEffect(()=>{T&&Array.isArray(T.data)&&Y(we(T.data))},[T,Y]);const B=i.useCallback(t=>{const l=f.find(o=>o._id===t);return((l==null?void 0:l.teachers)||[]).map(o=>({_id:o.teacherId,name:o.name||"Unknown Teacher"}))},[f]),E=i.useCallback(t=>{p===t?N(A==="asc"?"desc":"asc"):($(t),N("asc"))},[p,A]),D=i.useCallback((t,l=null)=>{var o,d,h;V(t),re(l),t==="create"?u({name:"",description:"",academicYear:((o=x.find(v=>v.isCurrent))==null?void 0:o._id)||"",classLevelSubclasses:[]}):l&&u({name:l.name||"",description:l.description||"",academicYear:((d=l.academicYear)==null?void 0:d._id)||"",classLevelSubclasses:((h=l.classLevelSubclasses)==null?void 0:h.map(v=>{var F,L;return{classLevel:((F=v.classLevel)==null?void 0:F._id)||v.classLevel,subclassLetter:v.subclassLetter||"",teachers:((L=v.teachers)==null?void 0:L.map(G=>G._id||G))||[]}}))||[]}),J(!0)},[x]),se=i.useCallback(t=>{Z(t),q(!0)},[]),z=i.useCallback(()=>{Z(null),q(!1)},[]),ce=i.useCallback(async()=>{if(U)try{await k(`${W.SUBJECT}/${U._id}`,"DELETE"),w(W.SUBJECT,"GET"),j("")}catch{j(P||"Failed to delete subject")}finally{z()}},[U,k,w,P,z]),de=i.useCallback(t=>{const{name:l,value:o}=t.target;u(d=>({...d,[l]:o}))},[]),ue=i.useCallback((t,l,o)=>{u(d=>{const h=[...d.classLevelSubclasses];return h[t]={...h[t],[l]:o},l==="classLevel"&&(h[t].subclassLetter="",h[t].teachers=[]),l==="subclassLetter"&&(h[t].teachers=[]),{...d,classLevelSubclasses:h}})},[]),be=i.useCallback(()=>{u(t=>({...t,classLevelSubclasses:[...t.classLevelSubclasses,{classLevel:"",subclassLetter:"",teachers:[]}]}))},[]),y=i.useCallback(t=>{u(l=>({...l,classLevelSubclasses:l.classLevelSubclasses.filter((o,d)=>d!==t)}))},[]),te=i.useCallback(()=>{if(!b.name)return"Subject name is required";if(!b.description)return"Description is required";if(!b.academicYear)return"Academic year is required";if(b.classLevelSubclasses.length===0)return"At least one class level and subclass is required";for(const t of b.classLevelSubclasses){if(!t.classLevel)return"Class level is required for all entries";if(!t.subclassLetter)return"Subclass is required for all entries";const l=B(t.classLevel);for(const o of t.teachers)if(!l.find(d=>d._id===o))return`Invalid teacher ID: ${o} for class level`}return""},[b,B]),le=i.useCallback(async()=>{const t=te();if(t){j(t);return}const l={name:b.name,description:b.description,academicYear:b.academicYear,classLevelSubclasses:b.classLevelSubclasses};console.log("Submitting payload:",l);try{O==="create"?await k(`${W.SUBJECT}/create`,"POST",l):O==="edit"&&await k(`${W.SUBJECT}/${R._id}`,"PATCH",l),w(W.SUBJECT,"GET"),J(!1),j("")}catch{j(P||"Failed to process request")}},[O,b,R,k,w,P,te]),e=i.useMemo(()=>Array.isArray(c)?c.map(t=>({...t,displayName:t.name})):[],[c]),n=i.useMemo(()=>{const t={};return x.forEach(l=>{t[l._id]=e.filter(o=>{var d;return((d=o.academicYear)==null?void 0:d._id)===l._id})}),t},[e,x]);return{tableProps:{columns:i.useMemo(()=>[{id:"sn",label:"S/N",width:90},{id:"displayName",label:"Subject Name",flex:1,renderCell:t=>t.displayName},{id:"description",label:"Description",flex:1},{id:"actions",label:"Actions",flex:1,renderCell:t=>s.jsxs(s.Fragment,{children:[s.jsx(Ce,{icon:s.jsx(Pe,{}),title:"View Subject",onClick:()=>D("view",t),sx:{mx:.5}}),s.jsx(Ce,{icon:s.jsx(Be,{}),title:"Edit Subject",onClick:()=>D("edit",t),sx:{mx:.5}}),s.jsx(Ce,{icon:s.jsx(Te,{}),title:"Delete Subject",onClick:()=>se(t),sx:{mx:.5}})]})}],[D,se]),tableHeader:"Subject Management",data:e,subjects:n,sortBy:p,sortDirection:A,onSortChange:E,hiddenColumnsSmallScreen:["description"],hiddenColumnsTabScreen:[],academicYears:x},modalOpen:ne,setModalOpen:J,modalMode:O,setModalMode:V,formData:b,setFormData:u,handleFormChange:de,handleClassLevelChange:ue,addClassLevel:be,removeClassLevel:y,handleSubmit:le,error:m,loadingSubjects:ee,loadingSubmit:ae,openModal:D,academicYears:x,classLevels:f,selectedSubject:R,deleteConfirmOpen:oe,subjectToDelete:U,handleDelete:ce,closeDeleteConfirm:z,classLevelsModalOpen:ie,setClassLevelsModalOpen:I,getTeachersForClassLevel:B}};function Se(Y){const{children:c,value:x,index:f,...X}=Y;return s.jsx("div",{role:"tabpanel",hidden:x!==f,id:`tabpanel-${f}`,"aria-labelledby":`tab-${f}`,...X,children:x===f&&s.jsx(S,{sx:{p:3},children:c})})}const Oe=()=>{var le;const Y=Ye(),c=ke(Y.palette.mode),{tableProps:x,modalOpen:f,setModalOpen:X,modalMode:p,formData:$,handleFormChange:A,handleClassLevelChange:N,addClassLevel:ne,removeClassLevel:J,handleSubmit:O,error:V,loadingSubjects:R,loadingSubmit:re,openModal:b,academicYears:u,classLevels:m,selectedSubject:j,deleteConfirmOpen:oe,subjectToDelete:q,handleDelete:U,closeDeleteConfirm:Z,classLevelsModalOpen:ie,setClassLevelsModalOpen:I,getTeachersForClassLevel:T}=Ne(),[ee,w]=i.useState(0),[k,ae]=i.useState({}),[P,B]=i.useState({}),[E,D]=i.useState(u.reduce((e,n)=>({...e,[n._id]:m.reduce((a,r)=>({...a,[r._id]:{selectedSubclass:0,page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"}}),{})}),{}));i.useEffect(()=>{D(e=>u.reduce((a,r)=>({...a,[r._id]:m.reduce((t,l)=>{var o;return{...t,[l._id]:((o=e[r._id])==null?void 0:o[l._id])||{selectedSubclass:0,page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"}}},{})}),{})),ae(e=>u.reduce((n,a)=>({...n,[a._id]:e[a._id]||0}),{})),B(e=>u.reduce((n,a)=>({...n,[a._id]:m.reduce((r,t)=>{var l;return{...r,[t._id]:((l=e[a._id])==null?void 0:l[t._id])||0}},{})}),{}))},[u,m]);const se=(e,n)=>{w(n)},z=(e,n)=>{ae(a=>({...a,[e]:n})),B(a=>({...a,[e]:{...a[e],[m[n]._id]:0}}))},ce=(e,n,a)=>{B(r=>({...r,[e]:{...r[e],[n]:a}}))},de=(e,n,a)=>{D(r=>({...r,[e]:{...r[e],[n]:{...r[e][n],page:a}}}))},ue=(e,n,a)=>{D(r=>({...r,[e]:{...r[e],[n]:{...r[e][n],page:0,rowsPerPage:parseInt(a.target.value,10)}}}))},be=(e,n,a)=>{D(r=>{const t=r[e][n],l=t.sortBy===a&&t.sortDirection==="asc"?"desc":"asc";return{...r,[e]:{...r[e],[n]:{...t,sortBy:a,sortDirection:l}}}})},y=e=>{var a;const n=m.find(r=>r._id===e);return((a=n==null?void 0:n.subclasses)==null?void 0:a.map(r=>r.letter))||[]},te=(e,n,a)=>{var K;const{page:r,rowsPerPage:t,sortBy:l,sortDirection:o}=((K=E[e])==null?void 0:K[n])||{page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"},d=x.subjects[e]||[];m.find(C=>C._id===n);const h=y(n)[a],F=[...d.filter(C=>C.classLevelSubclasses.some(g=>{var M;return((M=g.classLevel)==null?void 0:M._id)===n&&g.subclassLetter===h}))].sort((C,g)=>{let M=C[l]||"",he=g[l]||"";return l==="displayName"&&(M=C.displayName||"",he=g.displayName||""),M<he?o==="asc"?-1:1:M>he?o==="asc"?1:-1:0}),L=r*t;return F.slice(L,L+t).map((C,g)=>({...C,sn:L+g+1}))};return s.jsxs(S,{children:[s.jsx(Me,{title:"Subject Management",subtitle:"Manage subjects and their details"}),s.jsxs(S,{sx:{mt:3,mb:3},children:[s.jsx(Fe,{icon:s.jsx(ve,{}),content:"Add Subject",onClick:()=>b("create"),sx:{mb:2}}),R?s.jsx(fe,{}):s.jsx(S,{height:"75vh",sx:{"& .MuiDataGrid-root":{border:"none"},"& .MuiDataGrid-cell":{borderBottom:"none"},"& .MuiDataGrid-columnHeaders":{backgroundColor:c.blueAccent[700],borderBottom:"none"},"& .MuiDataGrid-virtualScroller":{backgroundColor:c.primary[400]},"& .MuiDataGrid-footerContainer":{borderTop:"none",backgroundColor:c.blueAccent[700]},"& .MuiCheckbox-root":{color:`${c.blueAccent[200]} !important`}},children:u.length>0?s.jsxs(s.Fragment,{children:[s.jsx(xe,{value:ee,onChange:se,"aria-label":"academic year tabs",sx:{backgroundColor:c.primary[400],"& .MuiTabs-indicator":{backgroundColor:c.blueAccent[700]}},children:u.map((e,n)=>s.jsx(ge,{label:e.name,sx:{color:"white !important",textTransform:"none",fontWeight:"bold","&.Mui-selected":{color:"white !important",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.3)",backgroundColor:c.blueAccent[700]},boxShadow:"0px 1px 4px rgba(0, 0, 0, 0.1)",backgroundColor:c.primary[400]}},e._id))}),u.map((e,n)=>s.jsx(Se,{value:ee,index:n,children:m.length>0?s.jsxs(s.Fragment,{children:[s.jsx(xe,{value:k[e._id]||0,onChange:(a,r)=>z(e._id,r),"aria-label":"class level tabs",sx:{backgroundColor:c.primary[400],"& .MuiTabs-indicator":{backgroundColor:c.blueAccent[700]},mt:2},children:m.map((a,r)=>s.jsx(ge,{label:a.name,sx:{color:"white !important",textTransform:"none",fontWeight:"bold","&.Mui-selected":{color:"white !important",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.3)",backgroundColor:c.blueAccent[700]},boxShadow:"0px 1px 4px rgba(0, 0, 0, 0.1)",backgroundColor:c.primary[400]}},a._id))}),m.map((a,r)=>{var t;return s.jsx(Se,{value:k[e._id]||0,index:r,children:y(a._id).length>0?s.jsxs(s.Fragment,{children:[s.jsx(xe,{value:((t=P[e._id])==null?void 0:t[a._id])||0,onChange:(l,o)=>ce(e._id,a._id,o),"aria-label":"subclass tabs",sx:{backgroundColor:c.primary[400],"& .MuiTabs-indicator":{backgroundColor:c.blueAccent[700]},mt:2},children:y(a._id).map((l,o)=>s.jsx(ge,{label:`Subclass ${l}`,sx:{color:"white !important",textTransform:"none",fontWeight:"bold","&.Mui-selected":{color:"white !important",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.3)",backgroundColor:c.blueAccent[700]},boxShadow:"0px 1px 4px rgba(0, 0, 0, 0.1)",backgroundColor:c.primary[400]}},l))}),y(a._id).map((l,o)=>{var d,h,v,F,L,G,me,K,C;return s.jsx(Se,{value:((d=P[e._id])==null?void 0:d[a._id])||0,index:o,children:s.jsx(Ae,{...x,data:te(e._id,a._id,o),tableHeader:`Subjects for ${e.name}, ${a.name}, Subclass ${l}`,page:((v=(h=E[e._id])==null?void 0:h[a._id])==null?void 0:v.page)||0,rowsPerPage:((L=(F=E[e._id])==null?void 0:F[a._id])==null?void 0:L.rowsPerPage)||5,sortBy:((me=(G=E[e._id])==null?void 0:G[a._id])==null?void 0:me.sortBy)||"name",sortDirection:((C=(K=E[e._id])==null?void 0:K[a._id])==null?void 0:C.sortDirection)||"asc",onSortChange:g=>be(e._id,a._id,g),onPageChange:(g,M)=>de(e._id,a._id,M),onRowsPerPageChange:g=>ue(e._id,a._id,g)})},l)})]}):s.jsxs(_,{children:["No subclasses available for ",a.name]})},a._id)})]}):s.jsx(_,{children:"No class levels available"})},e._id))]}):s.jsx(_,{children:"No academic years available"})})]}),s.jsx(pe,{open:f,onClose:()=>X(!1),title:p==="create"?"Create Subject":p==="edit"?"Edit Subject":"View Subject",onConfirm:p!=="view"?O:null,confirmMessage:p==="create"?"Create":"Save",styleProps:{padding:"20px"},children:s.jsxs(S,{sx:{display:"flex",flexDirection:"column",gap:"16px"},children:[s.jsx(H,{label:"Subject Name",name:"name",value:$.name||"",onChange:A,required:!0,fullWidth:!0,disabled:p==="view"}),s.jsx(H,{label:"Description",name:"description",value:$.description||"",onChange:A,multiline:!0,rows:4,fullWidth:!0,disabled:p==="view"}),s.jsx(H,{select:!0,label:"Academic Year",name:"academicYear",value:$.academicYear||"",onChange:A,required:!0,fullWidth:!0,disabled:p==="view",children:u.map(e=>s.jsx(Q,{value:e._id,children:e.name},e._id))}),p!=="view"&&s.jsxs(s.Fragment,{children:[s.jsx(S,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:s.jsx(_e,{variant:"contained",onClick:ne,startIcon:s.jsx(ve,{}),sx:{backgroundColor:c.blueAccent[700]},children:"Add Class Level and Subclass"})}),$.classLevelSubclasses.map((e,n)=>s.jsxs(S,{sx:{display:"flex",gap:"16px",alignItems:"center",mb:2},children:[s.jsx(H,{select:!0,label:`Class Level ${n+1}`,value:e.classLevel||"",onChange:a=>N(n,"classLevel",a.target.value),required:!0,sx:{flex:1},children:m.map(a=>s.jsx(Q,{value:a._id,children:a.name},a._id))}),s.jsx(H,{select:!0,label:`Subclass ${n+1}`,value:e.subclassLetter||"",onChange:a=>N(n,"subclassLetter",a.target.value),required:!0,sx:{flex:1},disabled:!e.classLevel,children:y(e.classLevel).map(a=>s.jsx(Q,{value:a,children:a},a))}),s.jsx(H,{select:!0,label:`Teachers for Class Level ${n+1}`,value:e.teachers||[],onChange:a=>N(n,"teachers",a.target.value),SelectProps:{multiple:!0,renderValue:a=>a.length>0?a.map(r=>{var t;return((t=T(e.classLevel).find(l=>l._id===r))==null?void 0:t.name)||"Unknown"}).join(", "):"Select teachers"},sx:{flex:1},disabled:!e.classLevel||!e.subclassLetter,children:T(e.classLevel).length>0?T(e.classLevel).map(a=>s.jsx(Q,{value:a._id,children:a.name},a._id)):s.jsx(Q,{disabled:!0,children:"No teachers available"})}),s.jsx($e,{onClick:()=>J(n),children:s.jsx(Te,{})})]},n))]}),p==="view"&&s.jsx(S,{sx:{mt:2},children:s.jsx(_e,{variant:"contained",onClick:()=>I(!0),sx:{backgroundColor:c.blueAccent[700]},children:"View Class Levels, Subclasses, and Teachers"})}),V&&s.jsx(_,{color:"error",children:V})]})}),s.jsx(pe,{open:ie,onClose:()=>I(!1),title:"Class Levels, Subclasses, and Teachers for Subject",styleProps:{padding:"20px"},children:s.jsx(S,{children:((le=j==null?void 0:j.classLevelSubclasses)==null?void 0:le.length)>0?j.classLevelSubclasses.map((e,n)=>{var a,r;return s.jsxs(S,{sx:{mb:2},children:[s.jsxs(_,{variant:"h6",children:[((a=m.find(t=>{var l;return t._id===((l=e.classLevel)==null?void 0:l._id)}))==null?void 0:a.name)||"Unknown Class Level"," ","- Subclass ",e.subclassLetter]}),s.jsx(_,{variant:"subtitle1",children:"Teachers:"}),((r=e.teachers)==null?void 0:r.length)>0?e.teachers.map(t=>{var l;return s.jsxs(_,{sx:{ml:2},children:["- ",t.name||((l=T(e.classLevel).find(o=>o._id===(t._id||t)))==null?void 0:l.name)||"Unknown Teacher"]},t._id||t)}):s.jsx(_,{sx:{ml:2},children:"No teachers assigned"})]},n)}):s.jsx(_,{children:"No class levels or subclasses assigned"})})}),s.jsx(pe,{open:oe,onClose:Z,title:"Delete Subject",onConfirm:U,confirmMessage:"Delete",styleProps:{padding:"20px"},children:s.jsxs(S,{children:[s.jsxs(_,{children:['Are you sure you want to delete the subject "',(q==null?void 0:q.name)||"Unknown",'"? This action cannot be undone.']}),re&&s.jsx(fe,{})]})})]})},na=ye(Oe);export{na as default};
