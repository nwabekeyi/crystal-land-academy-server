import{j as e,a as Qe,r as i,f as de,i as Ke}from"./index-Dia3dXnv.js";import{M as ke,t as Me,r as vt}from"./modal-CRceNtXl.js";import{F as Xe,a as et,b as tt}from"./main-CdGqE39d.js";import{H as st}from"./Header-BKDrWR6o.js";import{v as Z,T as C,j as Se,q as pt,a1 as ee,a3 as te,a2 as ne,y as _e,x as Je}from"./TextField-CiACpH9R.js";import{u as le}from"./useApi-CcDc2KeG.js";import{u as De}from"./useMediaQuery-D2Chhg5w.js";import{C as at}from"./confirmationModal-CIDTnzxs.js";import{A as He}from"./actionButton-BwgkxJSG.js";import{M}from"./MenuItem-9u3wVos-.js";import{w as Ct}from"./dasboardPagesContainer-FR1z_d3q.js";import"./IconButton-BeQuUMyU.js";import"./index-HCkcCK1E.js";import"./index-B_m23NjE.js";import"./loadingButton-Dn6lZ4mI.js";import"./CircularProgress-Du6yAQTu.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-BVdpsmmF.js";const Tt=({open:n,onClose:t,timetable:a,classLevelData:r,subjectNamesCache:s,teacherData:c,showEditButton:u,showAttendance:g,userId:h})=>{var N,z,F;const f=W=>{var T,l;return((l=(T=r==null?void 0:r.data)==null?void 0:T.find(o=>o._id===W))==null?void 0:l.name)||"N/A"},x=W=>s[W]||"Unknown Subject",D=W=>{var l;const T=(l=c==null?void 0:c.data)==null?void 0:l.find(o=>o._id===W);return(T==null?void 0:T.name)||"No Teacher Assigned"},I=()=>{var T,l,o;if(!a||!g)return"N/A";const W=(o=(l=(T=a.periodAttendance)==null?void 0:T[0])==null?void 0:l.attendance)==null?void 0:o.find(J=>J.studentId.toString()===h);return(W==null?void 0:W.status)||"N/A"};return console.log(s),e.jsx(ke,{open:n,onClose:t,title:"Timetable Details",styleProps:{padding:"20px"},noConfirm:!0,children:a?e.jsxs(Z,{sx:{display:"flex",flexDirection:"column",gap:"16px",mt:"10px"},children:[e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Class Level:"})," ",f(((N=a.classLevel)==null?void 0:N._id)||a.classLevel)]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Subject:"})," ",x(((z=a.subject)==null?void 0:z.name)||a.subject)]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Teacher:"})," ",D(((F=a.teacher)==null?void 0:F._id)||a.teacher)]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),g&&e.jsxs(C,{variant:"body1",children:[e.jsx("strong",{children:"Attendance Status:"})," ",I()]})]}):e.jsx(C,{variant:"body1",children:"No timetable details available."})})},yt=6048e5,ht=6e4,bt=36e5,ct=Symbol.for("constructDateFrom");function $e(n,t){return typeof n=="function"?n(t):n&&typeof n=="object"&&ct in n?n[ct](t):n instanceof Date?new n.constructor(t):new Date(t)}function Fe(n,t){return $e(t||n,n)}let Nt={};function rt(){return Nt}function Oe(n,t){var g,h,f,x;const a=rt(),r=(t==null?void 0:t.weekStartsOn)??((h=(g=t==null?void 0:t.locale)==null?void 0:g.options)==null?void 0:h.weekStartsOn)??a.weekStartsOn??((x=(f=a.locale)==null?void 0:f.options)==null?void 0:x.weekStartsOn)??0,s=Fe(n,t==null?void 0:t.in),c=s.getDay(),u=(c<r?7:0)+c-r;return s.setDate(s.getDate()-u),s.setHours(0,0,0,0),s}function Lt(n,t){var x,D,I,N;const a=Fe(n,t==null?void 0:t.in),r=a.getFullYear(),s=rt(),c=(t==null?void 0:t.firstWeekContainsDate)??((D=(x=t==null?void 0:t.locale)==null?void 0:x.options)==null?void 0:D.firstWeekContainsDate)??s.firstWeekContainsDate??((N=(I=s.locale)==null?void 0:I.options)==null?void 0:N.firstWeekContainsDate)??1,u=$e((t==null?void 0:t.in)||n,0);u.setFullYear(r+1,0,c),u.setHours(0,0,0,0);const g=Oe(u,t),h=$e((t==null?void 0:t.in)||n,0);h.setFullYear(r,0,c),h.setHours(0,0,0,0);const f=Oe(h,t);return+a>=+g?r+1:+a>=+f?r:r-1}function Ot(n,t){var g,h,f,x;const a=rt(),r=(t==null?void 0:t.firstWeekContainsDate)??((h=(g=t==null?void 0:t.locale)==null?void 0:g.options)==null?void 0:h.firstWeekContainsDate)??a.firstWeekContainsDate??((x=(f=a.locale)==null?void 0:f.options)==null?void 0:x.firstWeekContainsDate)??1,s=Lt(n,t),c=$e((t==null?void 0:t.in)||n,0);return c.setFullYear(s,0,r),c.setHours(0,0,0,0),Oe(c,t)}function dt(n,t){const a=Fe(n,t==null?void 0:t.in),r=+Oe(a,t)-+Ot(a,t);return Math.round(r/yt)+1}function kt(n,t){const a=()=>$e(t==null?void 0:t.in,NaN),s=At(n);let c;if(s.date){const f=_t(s.date,2);c=Dt(f.restDateString,f.year)}if(!c||isNaN(+c))return a();const u=+c;let g=0,h;if(s.time&&(g=Wt(s.time),isNaN(g)))return a();if(s.timezone){if(h=Pt(s.timezone),isNaN(h))return a()}else{const f=new Date(u+g),x=Fe(0,t==null?void 0:t.in);return x.setFullYear(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate()),x.setHours(f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds(),f.getUTCMilliseconds()),x}return Fe(u+g+h,t==null?void 0:t.in)}const we={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Mt=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,St=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Et=/^([+-])(\d{2})(?::?(\d{2}))?$/;function At(n){const t={},a=n.split(we.dateTimeDelimiter);let r;if(a.length>2)return t;if(/:/.test(a[0])?r=a[0]:(t.date=a[0],r=a[1],we.timeZoneDelimiter.test(t.date)&&(t.date=n.split(we.timeZoneDelimiter)[0],r=n.substr(t.date.length,n.length))),r){const s=we.timezone.exec(r);s?(t.time=r.replace(s[1],""),t.timezone=s[1]):t.time=r}return t}function _t(n,t){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),r=n.match(a);if(!r)return{year:NaN,restDateString:""};const s=r[1]?parseInt(r[1]):null,c=r[2]?parseInt(r[2]):null;return{year:c===null?s:c*100,restDateString:n.slice((r[1]||r[2]).length)}}function Dt(n,t){if(t===null)return new Date(NaN);const a=n.match(Mt);if(!a)return new Date(NaN);const r=!!a[4],s=Ie(a[1]),c=Ie(a[2])-1,u=Ie(a[3]),g=Ie(a[4]),h=Ie(a[5])-1;if(r)return wt(t,g,h)?It(t,g,h):new Date(NaN);{const f=new Date(0);return!Ft(t,c,u)||!Ut(t,s)?new Date(NaN):(f.setUTCFullYear(t,c,Math.max(s,u)),f)}}function Ie(n){return n?parseInt(n):1}function Wt(n){const t=n.match(St);if(!t)return NaN;const a=Ze(t[1]),r=Ze(t[2]),s=Ze(t[3]);return Ht(a,r,s)?a*bt+r*ht+s*1e3:NaN}function Ze(n){return n&&parseFloat(n.replace(",","."))||0}function Pt(n){if(n==="Z")return 0;const t=n.match(Et);if(!t)return 0;const a=t[1]==="+"?-1:1,r=parseInt(t[2]),s=t[3]&&parseInt(t[3])||0;return qt(r,s)?a*(r*bt+s*ht):NaN}function It(n,t,a){const r=new Date(0);r.setUTCFullYear(n,0,4);const s=r.getUTCDay()||7,c=(t-1)*7+a+1-s;return r.setUTCDate(r.getUTCDate()+c),r}const $t=[31,null,31,30,31,30,31,31,30,31,30,31];function gt(n){return n%400===0||n%4===0&&n%100!==0}function Ft(n,t,a){return t>=0&&t<=11&&a>=1&&a<=($t[t]||(gt(n)?29:28))}function Ut(n,t){return t>=1&&t<=(gt(n)?366:365)}function wt(n,t,a){return t>=1&&t<=53&&a>=0&&a<=6}function Ht(n,t,a){return n===24?t===0&&a===0:a>=0&&a<60&&t>=0&&t<60&&n>=0&&n<25}function qt(n,t){return t>=0&&t<=59}const ut=["Monday","Tuesday","Wednesday","Thursday","Friday"],Bt=({userId:n})=>{var S;const t=Se();Me(t.palette.mode);const a=Qe(p=>p.users.user),[r,s]=i.useState([]),[c,u]=i.useState(!1),[g,h]=i.useState(!1),[f,x]=i.useState(""),[D,I]=i.useState(null),[N,z]=i.useState({}),{loading:F,error:W,callApi:T,data:l}=le(),{loading:o,error:J,callApi:A}=le(),G=i.useCallback(async(p,B)=>{var k;if(!p)return"Unknown";if(N[p])return N[p];try{const P=await A(`${de.SUBJECT_NAME}/${p}`,"GET"),b=((k=P==null?void 0:P.data)==null?void 0:k.name)||"Unknown";return B()&&z(Y=>({...Y,[p]:b})),b}catch(P){return console.error(`Error fetching subject name for ID ${p}:`,P),"Unknown"}},[A,N]);i.useEffect(()=>{let p=!0;const B=async()=>{try{const k=await T(`${de.TIMETABLE}/student/${a._id}`,"GET");p&&(k!=null&&k.data)&&k.status==="success"?s(k.data||[]):(console.error("Failed to fetch timetables:",k),p&&(x("Failed to load timetable data"),h(!0)))}catch(k){console.error("Error fetching timetables:",k),p&&(x("Error loading timetable: "+(k.message||"Unknown error")),h(!0))}};return a._id&&B(),()=>{p=!1}},[T,a._id]);const Q=i.useMemo(()=>{if(!r||!r.length)return[];const B=Oe(new Date("2025-07-25T12:13:00+01:00"),{weekStartsOn:1});let k=!0;return Promise.all(r.map(async b=>{var ge,ie,pe,q,se,Ee,xe,Le;if(!b||!b.dayOfWeek)return null;const Y=ut.indexOf(b.dayOfWeek);if(Y===-1)return null;const ce=new Date(B);ce.setDate(B.getDate()+Y);const[je,fe]=(b.startTime||"00:00").split(":").map(Number);ce.setHours(je,fe,0,0);const he=new Date(ce);he.setMinutes(he.getMinutes()+(b.numberOfPeriods||1)*45);const be=((ge=b.subject)==null?void 0:ge.name)||b.subject,ve=await G(be,()=>k);return{id:b._id,title:`${ve} (${b.location||"N/A"})`,start:ce,end:he,extendedProps:{classLevel:((ie=b.classLevel)==null?void 0:ie._id)||b.classLevel||"",classLevelName:((pe=b.classLevel)==null?void 0:pe.name)||"N/A",subclassLetter:b.subclassLetter||"",subject:be||"",subjectName:ve,teacher:((q=b.teacher)==null?void 0:q._id)||b.teacher||null,teacherName:b.teacher&&`${b.teacher.firstName||""} ${b.teacher.lastName||""}`.trim()||"No Teacher Assigned",dayOfWeek:b.dayOfWeek,startTime:b.startTime||"",numberOfPeriods:b.numberOfPeriods||1,location:b.location||"",attendanceStatus:((Le=(xe=(Ee=(se=b.periodAttendance)==null?void 0:se[0])==null?void 0:Ee.attendance)==null?void 0:xe.find(ye=>ye.studentId.toString()===n))==null?void 0:Le.status)||"N/A"}}})).then(b=>b.filter(Y=>Y!==null)).catch(b=>(console.error("Error processing calendar events:",b),x("Failed to process timetable events"),h(!0),[]))},[r,n,G]),ue=i.useCallback(p=>{const B=r.find(k=>k._id===p.event.id);B&&(I(B),u(!0))},[r]),K=F||o,L=(l==null?void 0:l.status)==="failed"?l.message:W||J,V=i.useMemo(()=>{var p;return{data:a.classLevelId?[{_id:a.classLevelId,name:((p=a.currentClassLevel)==null?void 0:p.className)||"N/A"}]:[]}},[a.classLevelId,(S=a.currentClassLevel)==null?void 0:S.className]),v=i.useMemo(()=>!r||!r.length?{data:[]}:{data:r.map(p=>{var B,k;return{_id:((B=p.subject)==null?void 0:B._id)||p.subject,name:N[((k=p.subject)==null?void 0:k._id)||p.subject]||"Unknown"}}).filter((p,B,k)=>k.findIndex(P=>{var b,Y;return((b=P._id)==null?void 0:b.toString())===((Y=p._id)==null?void 0:Y.toString())})===B)},[r,N]),R=i.useMemo(()=>{if(!r||!r.length)return{data:[{_id:null,name:"No Teacher Assigned"}]};const p=r.map(P=>P.teacher?{_id:P.teacher._id||P.teacher,firstName:P.teacher.firstName||"N/A",lastName:P.teacher.lastName||"",name:`${P.teacher.firstName||"N/A"} ${P.teacher.lastName||""}`.trim()||"No Teacher Assigned"}:{_id:null,name:"No Teacher Assigned"}),B=[],k=new Set;for(const P of p){const b=P._id?P._id.toString():"no_teacher";k.has(b)||(k.add(b),B.push(P))}return{data:B}},[r]);return{calendarEvents:Q,viewModalOpen:c,setViewModalOpen:u,confirmationModalOpen:g,setConfirmationModalOpen:h,confirmationMessage:f,setConfirmationMessage:x,selectedTimetable:D,setSelectedTimetable:I,handleEventClick:ue,classLevelData:V,subjectData:v,teacherData:R,subjectNamesCache:N,loading:K,error:L,daysOfWeek:ut}},Yt=({user:n})=>{const t=Se();Me(t.palette.mode);const a=(n==null?void 0:n._id)||"",r=De("(max-width: 768px)"),s=De("(max-width: 375px)"),{calendarEvents:c,viewModalOpen:u,setViewModalOpen:g,confirmationModalOpen:h,setConfirmationModalOpen:f,confirmationMessage:x,selectedTimetable:D,setSelectedTimetable:I,handleEventClick:N,classLevelData:z,teacherData:F,subjectNamesCache:W,loading:T,error:l}=Bt({userId:a}),[o,J]=i.useState([]),[A,G]=i.useState(!0),[Q,ue]=i.useState(null);return n!=null&&n._id?(i.useEffect(()=>{let K=!0;return G(!0),ue(null),c&&typeof c.then=="function"?c.then(L=>{K&&(J(Array.isArray(L)?L:[]),G(!1))}).catch(L=>{console.error("Error resolving calendar events:",L),K&&(ue("Failed to load calendar events"),G(!1))}):K&&(J(Array.isArray(c)?c:[]),G(!1)),()=>{K=!1}},[c]),console.log("calendarEvents (raw):",c),console.log("resolvedEvents:",o),e.jsxs(Z,{py:"20px",children:[e.jsx(st,{title:"STUDENT TIMETABLE",subtitle:"View Your Weekly Schedule",sx:{"& h1":{fontSize:s?"20px":"24px"},"& h2":{fontSize:s?"14px":"16px"}}}),e.jsx(Z,{children:T||A?e.jsx(Ke,{}):l||Q?e.jsx(C,{variant:"h6",color:"error",children:l||Q}):o.length>0?e.jsx(Xe,{height:s?"45vh":r?"50vh":"75vh",plugins:[et,tt],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:o,eventClick:N,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(C,{variant:"h6",children:"No schedule available."})}),e.jsx(Tt,{open:u,onClose:()=>{g(!1),I(null)},timetable:D,classLevelData:z,subjectNamesCache:W,teacherData:F,showEditButton:!1,showAttendance:!0,userId:a}),e.jsx(at,{open:h,onClose:()=>f(!1),title:"Timetable Operation",message:x,isLoading:T})]})):e.jsx(C,{variant:"h6",color:"error",children:"Error: User ID not found"})};var nt={},Vt=pt;Object.defineProperty(nt,"__esModule",{value:!0});var xt=nt.default=void 0,zt=Vt(vt()),Gt=e;xt=nt.default=(0,zt.default)((0,Gt.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle");const Rt=({open:n,onClose:t,onConfirm:a,attendanceChanges:r,handleAttendanceChange:s,studentData:c,isLoading:u})=>{var g;return e.jsx(ke,{open:n,onClose:t,title:"Mark Attendance",onConfirm:a,confirmMessage:"Confirm",styleProps:{padding:"20px"},noConfirm:u,children:e.jsx(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:((g=c==null?void 0:c.data)==null?void 0:g.length)>0?c.data.map(h=>e.jsxs(Z,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(C,{children:[h.firstName," ",h.lastName]}),e.jsx(ee,{sx:{minWidth:100},children:e.jsxs(te,{value:r[h._id]||"Absent",onChange:f=>s(h._id,f.target.value),children:[e.jsx(M,{value:"Present",children:"Present"}),e.jsx(M,{value:"Absent",children:"Absent"}),e.jsx(M,{value:"Late",children:"Late"}),e.jsx(M,{value:"Excused",children:"Excused"})]})})]},h._id)):e.jsx(C,{children:"No students available"})})})},Zt=({open:n,onClose:t,timetable:a,classLevelData:r,subjectData:s,subjectNamesCache:c,showEditButton:u,onMarkAttendance:g})=>{var x,D,I;const h=N=>{var z,F;return((F=(z=r==null?void 0:r.data)==null?void 0:z.find(W=>W._id===N))==null?void 0:F.name)||"N/A"},f=N=>c[N]||"Unknown";return e.jsx(ke,{open:n,onClose:t,title:"Timetable Details",onConfirm:g,confirmMessage:"Mark Attendance",styleProps:{padding:"20px"},noConfirm:!g,additionalButton:g&&e.jsx(He,{content:"Mark Attendance",icon:e.jsx(xt,{}),onClick:g,sx:{mr:2}}),children:a?e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(C,{children:[e.jsx("strong",{children:"Class Level:"})," ",h(((x=a.classLevel)==null?void 0:x._id)||a.classLevel)]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Section:"})," ",((D=a.classLevel)==null?void 0:D.section)||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Subclass:"})," ",a.subclassLetter||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Subject:"})," ",f(((I=a.subject)==null?void 0:I._id)||a.subject)]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Day of Week:"})," ",a.dayOfWeek||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Start Time:"})," ",a.startTime||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"End Time:"})," ",a.endTime||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",a.numberOfPeriods||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Location:"})," ",a.location||"N/A"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Teacher:"})," ",a.teacher&&`${a.teacher.firstName||""} ${a.teacher.lastName||""}`.trim()||"No Teacher"]})]}):e.jsx(C,{children:"No timetable details available"})})},ft=["Monday","Tuesday","Wednesday","Thursday","Friday"],Jt=({userId:n})=>{const t=Se();Me(t.palette.mode);const[a,r]=i.useState([]),[s,c]=i.useState(""),[u,g]=i.useState(""),[h,f]=i.useState(!1),[x,D]=i.useState(!1),[I,N]=i.useState(!1),[z,F]=i.useState(""),[W,T]=i.useState(null),[l,o]=i.useState(null),[J,A]=i.useState({}),[G,Q]=i.useState({}),{loading:ue,error:K,callApi:L,data:V}=le(),{loading:v,error:R,callApi:S,data:p}=le(),{loading:B,error:k,callApi:P}=le(),{loading:b,error:Y,data:ce}=le(),{loading:je,error:fe,data:he}=le(),{loading:be,error:ve,callApi:ge}=le(),ie=i.useCallback(async(E,U)=>{var $;if(!E)return"Unknown";if(G[E])return G[E];try{const O=await ge(`/subject-names/${E}`,"GET"),ae=(($=O==null?void 0:O.data)==null?void 0:$.name)||"Unknown";return U()&&Q(_=>({..._,[E]:ae})),ae}catch(O){return console.error(`Error fetching subject name for ID ${E}:`,O),"Unknown"}},[ge,G]);i.useEffect(()=>{L(`${de.TIMETABLE}/teacher/${n}`,"GET")},[L,n]),i.useEffect(()=>{(V==null?void 0:V.status)==="success"&&r(V.data||[])},[V]);const pe=i.useMemo(()=>{const E=[],U=new Set;return a.forEach($=>{const O=$.classLevel;O&&O._id&&!U.has(O._id)&&(U.add(O._id),E.push({_id:O._id,name:O.name}))}),E},[a]),q=i.useMemo(()=>{if(!s)return[];const E=[],U=new Set;return a.forEach($=>{var O;((O=$.classLevel)==null?void 0:O._id)===s&&$.subclassLetter&&(U.has($.subclassLetter)||(U.add($.subclassLetter),E.push($.subclassLetter)))}),E.sort()},[a,s]),se=i.useMemo(()=>{let E=!0;if(!a||a.length===0)return Promise.resolve([]);const $=Oe(new Date("2025-07-25T16:38:00+01:00"),{weekStartsOn:1}),O=a.filter(_=>{var Ne;const oe=!s||((Ne=_.classLevel)==null?void 0:Ne._id)===s,Ce=!u||_.subclassLetter===u;return oe&&Ce});return Promise.all(O.map(async _=>{var H,me,re,Te;const oe=ft.indexOf(_.dayOfWeek);if(oe===-1)return null;const Ce=new Date($);Ce.setDate($.getDate()+oe);const[Ne,m]=_.startTime.split(":").map(Number);Ce.setHours(Ne,m,0,0);const j=new Date($),[d,y]=_.endTime.split(":").map(Number);j.setDate($.getDate()+oe),j.setHours(d,y,0,0);const w=((H=_.subject)==null?void 0:H._id)||_.subject,X=await ie(w,()=>E);return{id:_._id,title:`${X} (${_.location})`,start:Ce,end:j,extendedProps:{classLevel:((me=_.classLevel)==null?void 0:me._id)||_.classLevel,classLevelName:((re=_.classLevel)==null?void 0:re.name)||"N/A",section:((Te=_.classLevel)==null?void 0:Te.section)||"N/A",subclassLetter:_.subclassLetter||"",subject:w||"",subjectName:X,teacherName:_.teacher&&`${_.teacher.firstName||""} ${_.teacher.lastName||""}`.trim()||"No Teacher",dayOfWeek:_.dayOfWeek,startTime:_.startTime,numberOfPeriods:_.numberOfPeriods,location:_.location}}})).then(_=>_.filter(oe=>oe!==null)).catch(_=>(console.error("Error processing calendar events:",_),F("Failed to process timetable events"),N(!0),[]))},[a,s,u,ie]),[Ee,xe]=i.useState([]),[Le,ye]=i.useState(!0),[Ae,We]=i.useState(null);i.useEffect(()=>{let E=!0;return ye(!0),We(null),se&&typeof se.then=="function"?se.then(U=>{E&&(xe(Array.isArray(U)?U:[]),ye(!1))}).catch(U=>{console.error("Error resolving calendar events:",U),E&&(We("Failed to load calendar events"),ye(!1))}):E&&(xe(Array.isArray(se)?se:[]),ye(!1)),()=>{E=!1}},[se]);const Ue=i.useCallback(async(E,U)=>{var O;const $=await S(`${de.CLASS_LEVEL}/${E}/subclasses/${U}/students`,"GET");return((O=$==null?void 0:$.data)==null?void 0:O.students)||[]},[S]),qe=i.useCallback((E,U)=>{A($=>({...$,[E]:U}))},[]),Be=i.useCallback(async()=>{if(!a.find(O=>O._id===W))return;const U=Object.entries(J).map(([O,ae])=>({studentId:O,status:ae,notes:ae==="Absent"||ae==="Excused"?"Marked by instructor":""})),$={timetableId:W,periodIndex:0,attendanceData:U};try{const O=await P(`${de.TIMETABLE}/${W}/attendance`,"PUT",$);(O==null?void 0:O.status)==="success"?(r(a.map(ae=>ae._id===W?{...ae,periodAttendance:O.data.periodAttendance}:ae)),F("Attendance marked successfully"),f(!1),N(!0),T(null),A({})):(F((O==null?void 0:O.message)||k||"Failed to mark attendance"),N(!0))}catch(O){F(k||O.message||"Failed to mark attendance"),N(!0)}},[a,W,J,P,k]),Ye=i.useCallback(async E=>{const U=a.find($=>$._id===E);if(U){const O=(await Ue(U.classLevel._id,U.subclassLetter)).reduce((ae,_)=>{var Ce,Ne;const oe=(Ne=(Ce=U.periodAttendance)==null?void 0:Ce[0])==null?void 0:Ne.attendance.find(m=>m.studentId.toString()===_._id.toString());return{...ae,[_._id]:(oe==null?void 0:oe.status)||"Absent"}},{});A(O),T(E),f(!0)}},[a,Ue]),Ve=i.useCallback(E=>{const U=a.find($=>$._id===E.event.id);U&&(o(U),D(!0))},[a]),ze=ue||v||B||b||je||be||Le,Ge=(V==null?void 0:V.status)==="failed"?V.message:K||R||k||Y||fe||ve||Ae;return{calendarEvents:Ee,selectedClassLevel:s,setSelectedClassLevel:c,selectedSubclass:u,setSelectedSubclass:g,classLevelOptions:pe,subclassOptions:q,attendanceModalOpen:h,setAttendanceModalOpen:f,viewModalOpen:x,setViewModalOpen:D,confirmationModalOpen:I,setConfirmationModalOpen:N,confirmationMessage:z,selectedScheduleId:W,selectedTimetable:l,attendanceChanges:J,setAttendanceChanges:A,handleAttendanceChange:qe,handleConfirmAttendance:Be,openAttendanceModal:Ye,handleEventClick:Ve,classLevelData:ce,subjectData:he,studentData:p,subjectNamesCache:G,loading:ze,error:Ge,daysOfWeek:ft}},Qt=({user:n})=>{const t=Se();Me(t.palette.mode);const a=(n==null?void 0:n._id)||"",r=De("(max-width: 768px)"),s=De("(max-width: 375px)"),{calendarEvents:c,selectedClassLevel:u,setSelectedClassLevel:g,selectedSubclass:h,setSelectedSubclass:f,classLevelOptions:x,subclassOptions:D,attendanceModalOpen:I,setAttendanceModalOpen:N,viewModalOpen:z,setViewModalOpen:F,confirmationModalOpen:W,setConfirmationModalOpen:T,confirmationMessage:l,selectedTimetable:o,handleAttendanceChange:J,handleConfirmAttendance:A,openAttendanceModal:G,handleEventClick:Q,classLevelData:ue,subjectData:K,subjectNamesCache:L,studentData:V,attendanceChanges:v,loading:R,error:S}=Jt({userId:a});return n!=null&&n._id?e.jsxs(Z,{py:"20px",children:[e.jsx(st,{title:"TEACHER TIMETABLE",subtitle:"View Your Schedule and Mark Attendance",sx:{"& h1":{fontSize:s?"20px":"24px"},"& h2":{fontSize:s?"14px":"16px"}}}),e.jsxs(Z,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ee,{sx:{minWidth:150},children:[e.jsx(ne,{children:"Class Level"}),e.jsxs(te,{value:u||"",onChange:p=>g(p.target.value),label:"Class Level",children:[e.jsx(M,{value:"",children:"All Classes"}),x.map(p=>e.jsx(M,{value:p._id,children:p.name},p._id))]})]}),e.jsxs(ee,{sx:{minWidth:120},children:[e.jsx(ne,{children:"Subclass"}),e.jsxs(te,{value:h||"",onChange:p=>f(p.target.value),label:"Subclass",disabled:!u,children:[e.jsx(M,{value:"",children:"All Subclasses"}),D.map(p=>e.jsx(M,{value:p,children:p},p))]})]})]}),e.jsx(Z,{children:R?e.jsx(Ke,{}):S?e.jsx(C,{color:"error",children:S}):c.length>0?e.jsx(Xe,{height:s?"45vh":r?"50vh":"75vh",plugins:[et,tt],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:c,eventClick:Q,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(C,{children:"No schedule available."})}),e.jsx(Rt,{open:I,onClose:()=>{N(!1),setSelectedScheduleId(null)},onConfirm:A,attendanceChanges:v,handleAttendanceChange:J,studentData:V,isLoading:R}),e.jsx(Zt,{open:z,onClose:()=>{F(!1),setSelectedTimetable(null)},timetable:o,classLevelData:ue,subjectData:K,subjectNamesCache:L,showEditButton:!1,onMarkAttendance:()=>G(o==null?void 0:o._id)}),e.jsx(at,{open:W,onClose:()=>T(!1),title:"Attendance Operation",message:l,isLoading:R})]}):e.jsx(C,{variant:"h6",color:"error",children:"Error: User ID not found"})},Kt=({open:n,onClose:t,onConfirm:a,newSchedule:r,setNewSchedule:s,classLevelData:c,availableSubclasses:u,availableSubjects:g,availableTeachers:h,isLoading:f,daysOfWeek:x,handleClassLevelChange:D,handleSubclassChange:I,setConfirmationMessage:N,setConfirmationModalOpen:z})=>{var T;const F=()=>{const l=W(r);if(l){N(l),z(!0);return}a()},W=l=>l.classLevel?l.subclassLetter?l.subject?l.teacher?l.dayOfWeek?l.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(l.startTime)?!l.numberOfPeriods||l.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(l.numberOfPeriods))?l.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(ke,{open:n,onClose:t,title:"Add New Timetable",onConfirm:F,confirmMessage:"Add",styleProps:{padding:"20px"},noConfirm:f,children:e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(te,{labelId:"class-level-modal-label",value:r.classLevel,label:"Class Level",onChange:l=>{s({...r,classLevel:l.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),D(l.target.value)},disabled:f,children:((T=c==null?void 0:c.data)==null?void 0:T.length)>0?c.data.map(l=>e.jsx(M,{value:l._id,children:l.name},l._id)):e.jsx(M,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(te,{labelId:"subclass-modal-label",value:r.subclassLetter,label:"Subclass",onChange:l=>{s({...r,subclassLetter:l.target.value,subject:"",teacher:"",teacherName:""}),I(l.target.value)},disabled:!r.classLevel||f,children:(u==null?void 0:u.length)>0?u.map(l=>e.jsx(M,{value:l,children:l},l)):e.jsx(M,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"subject-modal-label",children:"Subject"}),e.jsx(te,{labelId:"subject-modal-label",value:r.subject,label:"Subject",onChange:l=>s({...r,subject:l.target.value,teacher:"",teacherName:""}),disabled:f||!r.subclassLetter,children:(g==null?void 0:g.length)>0?g.map(l=>e.jsx(M,{value:l._id,children:l.displayName},l._id)):e.jsx(M,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(te,{labelId:"teacher-modal-label",value:r.teacher,label:"Teacher",onChange:l=>s({...r,teacher:l.target.value}),disabled:f||!r.subject,children:(h==null?void 0:h.length)>0?h.map(l=>e.jsx(M,{value:l._id,children:l.displayName},l._id)):e.jsx(M,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"day-modal-label",children:"Day of Week"}),e.jsx(te,{labelId:"day-modal-label",value:r.dayOfWeek,label:"Day of Week",onChange:l=>s({...r,dayOfWeek:l.target.value}),disabled:f,children:(x==null?void 0:x.length)>0?x.map(l=>e.jsx(M,{value:l,children:l},l)):e.jsx(M,{disabled:!0,children:"No days available"})})]}),e.jsx(_e,{label:"Start Time (HH:MM)",value:r.startTime,onChange:l=>s({...r,startTime:l.target.value}),fullWidth:!0,disabled:f,error:r.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(r.startTime),helperText:r.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(r.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(_e,{label:"Number of Periods",type:"number",value:r.numberOfPeriods,onChange:l=>s({...r,numberOfPeriods:l.target.value}),fullWidth:!0,inputProps:{min:1},disabled:f,error:r.numberOfPeriods&&(!Number.isInteger(Number(r.numberOfPeriods))||Number(r.numberOfPeriods)<1),helperText:r.numberOfPeriods&&(!Number.isInteger(Number(r.numberOfPeriods))||Number(r.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(_e,{label:"Location",value:r.location,onChange:l=>s({...r,location:l.target.value}),fullWidth:!0,disabled:f})]})})},Xt=({open:n,onClose:t,onConfirm:a,onDelete:r,newSchedule:s,setNewSchedule:c,classLevelData:u,availableSubclasses:g,availableSubjects:h,availableTeachers:f,isLoading:x,daysOfWeek:D,handleClassLevelChange:I,handleSubclassChange:N,setConfirmationMessage:z,setConfirmationModalOpen:F})=>{var l;const W=()=>{const o=T(s);if(o){z(o),F(!0);return}a()},T=o=>o.classLevel?o.subclassLetter?o.subject?o.teacher?o.dayOfWeek?o.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(o.startTime)?!o.numberOfPeriods||o.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(o.numberOfPeriods))?o.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required";return e.jsx(ke,{open:n,onClose:t,title:"Edit Timetable",onConfirm:W,confirmMessage:"Update",styleProps:{padding:"20px"},noConfirm:x,additionalButton:e.jsx(Je,{variant:"contained",color:"error",onClick:r,disabled:x,sx:{mr:2},children:"Delete"}),children:e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"class-level-modal-label",children:"Class Level"}),e.jsx(te,{labelId:"class-level-modal-label",value:s.classLevel,label:"Class Level",onChange:o=>{c({...s,classLevel:o.target.value,subclassLetter:"",subject:"",teacher:"",teacherName:""}),I(o.target.value)},disabled:x,children:((l=u==null?void 0:u.data)==null?void 0:l.length)>0?u.data.map(o=>e.jsx(M,{value:o._id,children:o.name},o._id)):e.jsx(M,{disabled:!0,children:"No class levels available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"subclass-modal-label",children:"Subclass"}),e.jsx(te,{labelId:"subclass-modal-label",value:s.subclassLetter,label:"Subclass",onChange:o=>{c({...s,subclassLetter:o.target.value,subject:"",teacher:"",teacherName:""}),N(o.target.value)},disabled:!s.classLevel||x,children:(g==null?void 0:g.length)>0?g.map(o=>e.jsx(M,{value:o,children:o},o)):e.jsx(M,{disabled:!0,children:"No subclasses available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"subject-modal-label",children:"Subject"}),e.jsx(te,{labelId:"subject-modal-label",value:s.subject,label:"Subject",onChange:o=>c({...s,subject:o.target.value,teacher:"",teacherName:""}),disabled:x||!s.subclassLetter,children:(h==null?void 0:h.length)>0?h.map(o=>e.jsx(M,{value:o._id,children:o.displayName},o._id)):e.jsx(M,{disabled:!0,children:"No subjects available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"teacher-modal-label",children:"Teacher"}),e.jsx(te,{labelId:"teacher-modal-label",value:s.teacher,label:"Teacher",onChange:o=>c({...s,teacher:o.target.value}),disabled:x||!s.subject,children:(f==null?void 0:f.length)>0?f.map(o=>e.jsx(M,{value:o._id,children:o.displayName},o._id)):e.jsx(M,{disabled:!0,children:"No teachers available"})})]}),e.jsxs(ee,{fullWidth:!0,children:[e.jsx(ne,{id:"day-modal-label",children:"Day of Week"}),e.jsx(te,{labelId:"day-modal-label",value:s.dayOfWeek,label:"Day of Week",onChange:o=>c({...s,dayOfWeek:o.target.value}),disabled:x,children:(D==null?void 0:D.length)>0?D.map(o=>e.jsx(M,{value:o,children:o},o)):e.jsx(M,{disabled:!0,children:"No days available"})})]}),e.jsx(_e,{label:"Start Time (HH:MM)",value:s.startTime,onChange:o=>c({...s,startTime:o.target.value}),fullWidth:!0,disabled:x,error:s.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(s.startTime),helperText:s.startTime&&!/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(s.startTime)?"Format: HH:MM (00:00-23:59)":""}),e.jsx(_e,{label:"Number of Periods",type:"number",value:s.numberOfPeriods,onChange:o=>c({...s,numberOfPeriods:o.target.value}),fullWidth:!0,inputProps:{min:1},disabled:x,error:s.numberOfPeriods&&(!Number.isInteger(Number(s.numberOfPeriods))||Number(s.numberOfPeriods)<1),helperText:s.numberOfPeriods&&(!Number.isInteger(Number(s.numberOfPeriods))||Number(s.numberOfPeriods)<1)?"Must be a positive integer":""}),e.jsx(_e,{label:"Location",value:s.location,onChange:o=>c({...s,location:o.target.value}),fullWidth:!0,disabled:x})]})})},es=({open:n,onClose:t,onEdit:a,onDelete:r,timetable:s,availableSubjects:c})=>{const u=Se(),g=Me(u.palette.mode),h=f=>{var x;return((x=c==null?void 0:c.find(D=>D._id===f))==null?void 0:x.displayName)||"N/A"};return e.jsxs(ke,{open:n,onClose:t,title:"Timetable Details",noConfirm:!0,confirmMessage:"Edit",styleProps:{padding:"20px"},children:[s?e.jsxs(Z,{display:"flex",flexDirection:"column",gap:"16px",mt:"10px",children:[e.jsxs(C,{children:[e.jsx("strong",{children:"Class Level:"})," ",s.classLevel.name]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Subclass:"})," ",s.subclassLetter]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Subject:"})," ",h(s.subject._id)]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Teacher:"})," ",s.teacher?`${s.teacher.firstName} ${s.teacher.lastName}`:"Unassigned"]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Day of Week:"})," ",s.dayOfWeek]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Start Time:"})," ",s.startTime]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Number of Periods:"})," ",s.numberOfPeriods]}),e.jsxs(C,{children:[e.jsx("strong",{children:"Location:"})," ",s.location]})]}):e.jsx(C,{children:"No timetable details available"}),e.jsxs(Z,{display:"flex",justifyContent:"flex-end",mt:"16px",gap:"10px",children:[e.jsx(He,{content:"Edit Timetable",onClick:a,sx:{backgroundColor:g.greenAccent[500]}}),e.jsx(He,{content:"Delete Timetable",onClick:r,sx:{backgroundColor:g.redAccent[500]}})]})]})},ts=({open:n,onClose:t,onConfirm:a,isLoading:r})=>e.jsx(ke,{open:n,onClose:t,title:"Confirm Deletion",onConfirm:a,confirmMessage:"Delete",styleProps:{padding:"20px"},noConfirm:r,children:e.jsx(C,{children:"Are you sure you want to delete this timetable? This action cannot be undone."})}),mt=["Monday","Tuesday","Wednesday","Thursday","Friday"],ss=({userId:n})=>{const t=Se();Me(t.palette.mode);const[a,r]=i.useState(""),[s,c]=i.useState(""),[u,g]=i.useState(""),[h,f]=i.useState(1),[x,D]=i.useState(!1),[I,N]=i.useState(!1),[z,F]=i.useState(!1),[W,T]=i.useState(!1),[l,o]=i.useState(!1),[J,A]=i.useState(""),[G,Q]=i.useState([]),[ue,K]=i.useState(!1),[L,V]=i.useState(null),[v,R]=i.useState({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),[S,p]=i.useState([]),[B,k]=i.useState([]),[P,b]=i.useState([]),{loading:Y,error:ce,callApi:je}=le(),{loading:fe,error:he,callApi:be}=le(),{loading:ve,error:ge,callApi:ie}=le(),{loading:pe,error:q,callApi:se}=le(),{loading:Ee,error:xe,callApi:Le}=le(),{loading:ye,error:Ae,callApi:We}=le();i.useEffect(()=>{(async()=>{var j,d;try{const y=await be(de.CLASS_LEVEL,"GET");console.log("Class Levels fetched:",(j=y==null?void 0:y.data)==null?void 0:j.data),p(((d=y==null?void 0:y.data)==null?void 0:d.data)||[])}catch(y){console.error("Error loading class levels:",y),A("Failed to load class levels: "+(y.message||"Unknown error")),T(!0)}})()},[be]),i.useEffect(()=>{if(!s||!u){console.log("Skipping subject fetch: missing classLevel or subclass"),k([]);return}(async()=>{var w,X;const j=S.find(H=>H._id===s);if(!j){console.log("Class level not found:",s),k([]);return}const d=j.subclasses.find(H=>H.letter===u);if(!d){console.log("Subclass not found:",u),k([]);return}const y=d.subjects.map(H=>H.subject);console.log("Subject IDs to fetch:",y);try{const H=await ie(`${de.SUBJECT}?ids=${y.join(",")}`,"GET");console.log("Fetched subjects:",(w=H==null?void 0:H.data)==null?void 0:w.data),k(((X=H==null?void 0:H.data)==null?void 0:X.data)||[])}catch(H){console.error("Error fetching subjects:",H),A("Failed to load subjects: "+(H.message||"Unknown error")),T(!0)}})()},[s,u,S,ie]),i.useEffect(()=>{if(!s||!u){console.log("Skipping timetable fetch: missing classLevel or subclass"),b([]);return}(async()=>{try{const j=await je(`${de.TIMETABLE}?classLevel=${s}&subclassLetter=${u}`,"GET");console.log("Timetables fetched:",j==null?void 0:j.data),b((j==null?void 0:j.data)||[])}catch(j){console.error("Error fetching timetables:",j),A("Failed to load timetables: "+(j.message||"Unknown error")),T(!0)}})()},[s,u,je]);const Ue=i.useMemo(()=>{if(console.log("Filtering class levels with:",{classLevels:S,selectedSection:a}),!S.length)return{data:[]};if(!a)return{data:S};const m=S.filter(j=>j.section===a);return console.log("Filtered class levels:",m),{data:m}},[S,a]),qe=i.useMemo(()=>{var d;if(console.log("Computing available subclasses:",{classLevels:S,selectedClassLevel:s}),!S.length||!s)return console.log("No classLevels or selectedClassLevel, returning empty subclasses"),[];const m=S.find(y=>y._id===s);if(!m)return console.log("Selected class level not found in classLevels"),[];const j=[...new Set((d=m.subclasses)==null?void 0:d.map(y=>y.letter).filter(Boolean))];return console.log("Computed subclasses:",j),j},[S,s]);i.useEffect(()=>{(async()=>{if(console.log("Computing available subjects:",{classLevels:S,selectedClassLevel:s,selectedSubclass:u}),!S.length||!s||!u){Q([]);return}const j=S.find(w=>w._id===s);if(!j){console.log("Class level not found:",s),Q([]);return}const d=j.subclasses.find(w=>w.letter===u);if(!d){console.log("Subclass not found:",u),Q([]);return}const y=d.subjects.map(w=>w.subject);console.log("Subject IDs to fetch:",y);try{K(!0);const w=y.map(async me=>{var Te;const re=await ie(`${de.SUBJECT}/${me}`,"GET");return console.log(`Fetched subject ${me}:`,re==null?void 0:re.data),re!=null&&re.data?{_id:re.data._id,displayName:((Te=re.data.name)==null?void 0:Te.name)||"Unknown"}:null}),H=(await Promise.all(w)).filter(Boolean);console.log("Final availableSubjects:",H),Q(H)}catch(w){console.error("Error fetching subjects:",w),Q([])}finally{K(!1)}})()},[S,s,u,ie]);const Be=i.useMemo(()=>{if(console.log("Computing available teachers:",{classLevels:S,selectedClassLevel:s,selectedSubclass:u,subject:v.subject}),!S.length||!s||!u||!v.subject)return console.log("Missing required data for teachers, returning empty teachers"),[];const m=S.find(X=>X._id===s);if(!m)return console.log("Class level not found:",s),[];const j=m.subclasses.find(X=>X.letter===u);if(!j)return console.log("Subclass not found:",u),[];const d=j.subjects.find(X=>X.subject===v.subject);if(!d)return console.log("Subject not found in subclass:",v.subject),[];const w=(d.teachers||[]).map(X=>{const H=m.teachers.find(me=>me.teacherId===X);return H?{_id:H.teacherId,displayName:`${H.firstName} ${H.lastName}`.trim()}:null}).filter(Boolean);return console.log("Computed teachers:",w),w},[S,s,u,v.subject]);i.useEffect(()=>{if(!v.teacher||!S.length){R(y=>({...y,teacherName:""}));return}const m=S.find(y=>y._id===v.classLevel);if(!m){R(y=>({...y,teacherName:""}));return}const j=m.teachers.find(y=>y.teacherId===v.teacher),d=j?`${j.firstName} ${j.lastName}`.trim():"";console.log("Setting teacherName:",{teacherId:v.teacher,teacherName:d}),R(y=>({...y,teacherName:d}))},[v.teacher,S,v.classLevel]);const Ye=i.useMemo(()=>{if(!P.length)return[];const m=new Date("2025-07-24T14:24:00+01:00"),j=Oe(kt("2024-09-01"),{weekStartsOn:1});return dt(m,{weekStartsOn:1})-dt(j,{weekStartsOn:1})+1,P.map(d=>{var it,ot;const y=mt.indexOf(d.dayOfWeek);if(y===-1)return null;const w=new Date(m);w.setDate(m.getDate()-(m.getDay()===0?6:m.getDay()-1)+y),w.setHours(0,0,0,0);const[X,H]=d.startTime.split(":").map(Number);w.setHours(X,H,0,0);const me=new Date(w);me.setMinutes(me.getMinutes()+d.numberOfPeriods*45);const re=S.find(Re=>{var Pe;return Re._id===((Pe=d.classLevel)==null?void 0:Pe._id)||d.classLevel}),Te=G.find(Re=>{var Pe;return Re._id===(((Pe=d.subject)==null?void 0:Pe._id)||d.subject)}),lt=(Te==null?void 0:Te.displayName)||"Unknown",jt=d.teacherName||"Unassigned";return{id:d._id,title:`${lt} (${d.location})`,start:w,end:me,extendedProps:{classLevel:((it=d.classLevel)==null?void 0:it._id)||d.classLevel,classLevelName:(re==null?void 0:re.name)||"N/A",subclassLetter:d.subclassLetter,subject:((ot=d.subject)==null?void 0:ot._id)||d.subject,subjectName:lt,teacher:d.teacher||null,teacherName:jt,dayOfWeek:d.dayOfWeek,startTime:d.startTime,numberOfPeriods:d.numberOfPeriods,location:d.location}}}).filter(d=>d!==null)},[P,B,S]),Ve=i.useCallback(m=>{console.log("Setting section:",m),r(m),c(""),g("")},[]),ze=i.useCallback(m=>{console.log("Setting class level:",m),c(m),g(""),R(j=>({...j,classLevel:m,subclassLetter:"",subject:"",teacher:"",teacherName:""}))},[]),Ge=i.useCallback(m=>{console.log("Setting subclass:",m),g(m),R(j=>({...j,subclassLetter:m,subject:"",teacher:"",teacherName:""}))},[]),E=i.useCallback(()=>n?v.classLevel?v.subclassLetter?v.subject?v.teacher?v.dayOfWeek?v.startTime?/^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]$/.test(v.startTime)?!v.numberOfPeriods||v.numberOfPeriods<1?"Number of periods must be at least 1":Number.isInteger(Number(v.numberOfPeriods))?v.location?"":"Location is required":"Number of periods must be an integer":"Start time must be in HH:MM format (00:00-23:59)":"Start time is required":"Day of week is required":"Teacher is required":"Subject is required":"Subclass is required":"Class level is required":"User not authenticated. Please log in.",[v,n]),U=i.useCallback(async()=>{const m=E();if(m){A(m),T(!0);return}const j={classLevel:v.classLevel,subclassLetter:v.subclassLetter,subject:v.subject,teacher:v.teacher,teacherName:v.teacherName,dayOfWeek:v.dayOfWeek,startTime:v.startTime,numberOfPeriods:parseInt(v.numberOfPeriods,10),location:v.location,createdBy:n};try{const d=await se(de.TIMETABLE,"POST",j);(d==null?void 0:d.status)==="success"?(b(y=>[d.data,...y].slice(0,10)),A("Timetable added successfully"),D(!1),R({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})):A((d==null?void 0:d.message)||q||"Failed to add timetable")}catch(d){console.error("Error adding timetable:",d),A(q||d.message||"Failed to add timetable")}T(!0)},[se,q,E,n]),$=i.useCallback(async()=>{if(!L){A("No timetable selected for update"),T(!0);return}const m=E();if(m){A(m),T(!0);return}const j={classLevel:v.classLevel,subclassLetter:v.subclassLetter,subject:v.subject,teacher:v.teacher,teacherName:v.teacherName,dayOfWeek:v.dayOfWeek,startTime:v.startTime,numberOfPeriods:parseInt(v.numberOfPeriods,10),location:v.location,createdBy:n};try{const d=await Le(`${de.TIMETABLE}/${L._id}`,"PUT",j);(d==null?void 0:d.status)==="success"?(b(y=>y.map(w=>w._id===L._id?{...w,...d.data}:w)),A("Timetable updated successfully"),N(!1),F(!1),R({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""}),V(null)):A((d==null?void 0:d.message)||xe||"Failed to update timetable")}catch(d){console.error("Error updating timetable:",d),A(xe||d.message||"Failed to update timetable")}T(!0)},[Le,xe,L,E,n]),O=i.useCallback(()=>{if(!L){A("No timetable selected for deletion"),T(!0);return}o(!0)},[L]),ae=i.useCallback(async()=>{try{const m=await We(`${de.TIMETABLE}/${L._id}`,"DELETE");(m==null?void 0:m.status)==="success"?(b(j=>j.filter(d=>d._id!==L._id)),A("Timetable deleted successfully"),N(!1),F(!1),o(!1),V(null)):A((m==null?void 0:m.message)||Ae||"Failed to delete timetable")}catch(m){console.error("Error deleting timetable:",m),A(Ae||m.message||"Failed to delete timetable")}T(!0)},[We,Ae,L]),_=i.useCallback(m=>{const j=P.find(d=>d._id===m.event.id);j&&(V(j),F(!0))},[P]),oe=i.useCallback(()=>{var m,j;L&&(R({classLevel:((m=L.classLevel)==null?void 0:m._id)||L.classLevel,subclassLetter:L.subclassLetter,subject:((j=L.subject)==null?void 0:j._id)||L.subject,teacher:L.teacher||"",teacherName:L.teacherName||"",dayOfWeek:L.dayOfWeek,startTime:L.startTime,numberOfPeriods:L.numberOfPeriods,location:L.location}),F(!1),N(!0))},[L]);return{calendarEvents:Ye,selectedSection:a,setSelectedSection:Ve,selectedClassLevel:s,setSelectedClassLevel:ze,selectedSubclass:u,setSelectedSubclass:Ge,selectedWeek:h,setSelectedWeek:f,addModalOpen:x,setAddModalOpen:D,editModalOpen:I,setEditModalOpen:N,viewModalOpen:z,setViewModalOpen:F,confirmationModalOpen:W,setConfirmationModalOpen:T,deleteConfirmationOpen:l,setDeleteConfirmationOpen:o,confirmationMessage:J,setConfirmationMessage:A,newSchedule:v,setNewSchedule:R,selectedTimetable:L,handleAddSchedule:U,handleUpdateSchedule:$,handleInitiateDelete:O,handleDeleteSchedule:ae,handleEventClick:_,handleOpenEditModal:oe,classLevelData:Ue,availableSubclasses:qe,availableSubjects:G,availableTeachers:Be,loading:Y||fe||ve||pe||Ee||ye,error:ce||he||ge||q||xe||Ae,daysOfWeek:mt,weeksPerTerm:12,setSelectedTimetable:V}},as=()=>{var ie,pe;const n=Se(),t=Me(n.palette.mode),a=Qe(q=>{var se;return(se=q.users.user)==null?void 0:se._id})||"",r=De("(max-width: 768px)"),s=De("(max-width: 375px)"),{calendarEvents:c,selectedSection:u,setSelectedSection:g,selectedClassLevel:h,setSelectedClassLevel:f,selectedSubclass:x,setSelectedSubclass:D,selectedWeek:I,setSelectedWeek:N,addModalOpen:z,setAddModalOpen:F,editModalOpen:W,setEditModalOpen:T,viewModalOpen:l,setViewModalOpen:o,confirmationModalOpen:J,setConfirmationModalOpen:A,deleteConfirmationOpen:G,setDeleteConfirmationOpen:Q,confirmationMessage:ue,setConfirmationMessage:K,newSchedule:L,setNewSchedule:V,selectedTimetable:v,handleAddSchedule:R,handleUpdateSchedule:S,handleInitiateDelete:p,handleDeleteSchedule:B,handleEventClick:k,handleOpenEditModal:P,classLevelData:b,availableSubclasses:Y,availableSubjects:ce,availableTeachers:je,loading:fe,error:he,daysOfWeek:be,weeksPerTerm:ve,setSelectedTimetable:ge}=ss({userId:a});return e.jsxs(Z,{py:"20px",children:[e.jsx(st,{title:"ADMIN TIMETABLE",subtitle:"Manage Class and Subclass Timetables",sx:{"& h1":{fontSize:s?"20px":"24px"},"& h2":{fontSize:s?"14px":"16px"}}}),e.jsxs(Z,{mb:"20px",display:"flex",gap:"20px",alignItems:"center",flexWrap:"wrap",children:[e.jsxs(ee,{sx:{minWidth:150},children:[e.jsx(ne,{id:"section-select-label",children:"Section"}),e.jsxs(te,{labelId:"section-select-label",value:u,label:"Section",onChange:q=>g(q.target.value),children:[e.jsx(M,{value:"",children:"All"}),e.jsx(M,{value:"Primary",children:"Primary"}),e.jsx(M,{value:"Secondary",children:"Secondary"})]})]}),e.jsxs(ee,{sx:{minWidth:150},children:[e.jsx(ne,{id:"class-level-select-label",children:"Class Level"}),e.jsxs(te,{labelId:"class-level-select-label",value:h,label:"Class Level",onChange:q=>f(q.target.value),disabled:!((ie=b==null?void 0:b.data)!=null&&ie.length),children:[e.jsx(M,{value:"",children:"Select Class Level"}),(pe=b==null?void 0:b.data)==null?void 0:pe.map(q=>e.jsx(M,{value:q._id,children:q.name},q._id))]})]}),e.jsxs(ee,{sx:{minWidth:150},children:[e.jsx(ne,{id:"subclass-select-label",children:"Subclass"}),e.jsxs(te,{labelId:"subclass-select-label",value:x,label:"Subclass",onChange:q=>D(q.target.value),disabled:!h||!(Y!=null&&Y.length),children:[e.jsx(M,{value:"",children:"Select Subclass"}),(Y==null?void 0:Y.length)>0?Y.map(q=>e.jsx(M,{value:q,children:q},q)):e.jsx(M,{disabled:!0,children:"No subclasses available"})]})]}),e.jsxs(Z,{display:"flex",alignItems:"center",gap:"10px",children:[e.jsx(Je,{variant:"contained",onClick:()=>I>1&&N(I-1),disabled:I===1,sx:{backgroundColor:t.blueAccent[700]},children:"Previous Week"}),e.jsxs(C,{variant:"h6",children:["Week ",I]}),e.jsx(Je,{variant:"contained",onClick:()=>I<ve&&N(I+1),disabled:I===ve,sx:{backgroundColor:t.blueAccent[700]},children:"Next Week"})]}),e.jsx(He,{content:"Add Timetable",onClick:()=>F(!0),disabled:!h||!x,sx:{backgroundColor:t.greenAccent[500]}})]}),e.jsx(Z,{children:fe?e.jsx(Ke,{}):he?e.jsx(C,{color:"error",children:he}):c.length>0?e.jsx(Xe,{height:s?"45vh":r?"50vh":"75vh",plugins:[et,tt],headerToolbar:{left:"prev,next today",center:"title",right:""},initialView:"timeGridWeek",editable:!1,selectable:!1,dayMaxEvents:!0,events:c,eventClick:k,slotMinTime:"07:00:00",slotMaxTime:"18:00:00",allDaySlot:!1}):e.jsx(C,{children:"No timetable available for selected filters."})}),e.jsx(Kt,{open:z,onClose:()=>{F(!1),V({classLevel:"",subclassLetter:"",subject:"",teacher:"",teacherName:"",dayOfWeek:"",startTime:"",numberOfPeriods:1,location:""})},onConfirm:R,newSchedule:L,setNewSchedule:V,classLevelData:b,availableSubclasses:Y,availableSubjects:ce,availableTeachers:je,isLoading:fe,daysOfWeek:be,handleClassLevelChange:f,handleSubclassChange:D,setConfirmationMessage:K,setConfirmationModalOpen:A}),e.jsx(Xt,{open:W,onClose:()=>{T(!1),ge(null)},onConfirm:S,onDelete:p,newSchedule:L,setNewSchedule:V,classLevelData:b,availableSubclasses:Y,availableSubjects:ce,availableTeachers:je,isLoading:fe,daysOfWeek:be,handleClassLevelChange:f,handleSubclassChange:D,setConfirmationMessage:K,setConfirmationModalOpen:A}),e.jsx(es,{open:l,onClose:()=>{o(!1),ge(null)},onEdit:P,onDelete:p,timetable:v,classLevelData:b,availableSubjects:ce}),e.jsx(ts,{open:G,onClose:()=>Q(!1),onConfirm:B,isLoading:fe}),e.jsx(at,{open:J,onClose:()=>A(!1),title:"Timetable Operation",message:ue,isLoading:fe})]})},rs=()=>{const n=Qe(a=>a.users.user),t=n.role;return e.jsx("div",{children:t==="student"?e.jsx(Yt,{user:n}):t==="teacher"?e.jsx(Qt,{user:n}):e.jsx(as,{})})},ys=Ct(rs);export{ys as default};
