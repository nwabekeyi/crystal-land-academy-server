import{j as e,r,a as Q,f as U}from"./index-BO-TmkzE.js";import{T as Pe}from"./table-vaeRJyjp.js";import{r as je,M as X,t as Se}from"./modal-CG0C6vpP.js";import{D as de,G as p,h as Ce,E as be}from"./index-BJVcWxQk.js";import{c as ve,v as j,T as s,x as Ae,q as Ne,y as Ie,a1 as we,a2 as De,a3 as Ee,j as Re}from"./TextField-CigEBK4R.js";import{H as me}from"./Header-DSApfQWn.js";import{w as Me}from"./dasboardPagesContainer-DENYBOMz.js";import{A as ke}from"./actionButton-BApjawRI.js";import{u as ge}from"./useApi-bPe3HYn1.js";import{C as Oe}from"./CircularProgress-oo0vmEJK.js";import{M as ue}from"./MenuItem-Cm8_Zc8l.js";import{L as _e}from"./LinearProgress-NhNd7THY.js";import{I as Ye}from"./IconButton-DnpiNGo6.js";import"./useMediaQuery-CPLNVO1b.js";import"./index-nsUM-GnQ.js";import"./loadingButton-CiJH9dFC.js";import"./confirmationModal-DjrrgVpa.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-DtaxXO1z.js";const Te=ve(e.jsx("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility"),Fe=({receipt:a})=>{var k,g,B,S,c,O,h;const o=r.useRef();if(console.log("Receipt prop:",JSON.stringify(a,null,2)),!a)return e.jsx(j,{sx:{padding:"20px",maxWidth:"500px",margin:"auto"},children:e.jsx(s,{color:"error",children:"Error: Receipt data is missing."})});const L=async()=>{if(o.current)try{const P=await Ce(o.current,{useCORS:!0}),_=P.toDataURL("image/png"),x=new be("portrait","px","a4"),Y=x.internal.pageSize.getWidth(),T=P.height*Y/P.width;x.addImage(_,"PNG",0,0,Y,T),x.save(`receipt_${a.reference||"unknown"}.pdf`)}catch(P){console.error("Error generating PDF:",P)}},m=a.reference||"N/A",u=` ${(g=(k=a==null?void 0:a.originalReceipt)==null?void 0:k.studentId)==null?void 0:g.firstName} ${(S=(B=a==null?void 0:a.originalReceipt)==null?void 0:B.studentId)==null?void 0:S.lastName}`||"Unknown Student",N=((h=(O=(c=a==null?void 0:a.originalReceipt)==null?void 0:c.studentId)==null?void 0:O.currentClassLevel)==null?void 0:h.section)||"N/A",D=a.amountPaid?(a.amountPaid/100).toFixed(2):"0.00",$=a.status?a.status.charAt(0).toUpperCase()+a.status.slice(1):"N/A",E=a.datePaid?new Date(a.datePaid).toLocaleDateString():"N/A";return e.jsxs(j,{ref:o,sx:{padding:"20px",maxWidth:"500px",margin:"auto",backgroundColor:"#fff",color:"#000",borderRadius:"10px",boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",fontFamily:"Arial, sans-serif"},children:[e.jsx(s,{variant:"h6",align:"center",gutterBottom:!0,children:"Crystal Land Academy"}),e.jsx(s,{variant:"subtitle2",align:"center",gutterBottom:!0,children:"Payment Receipt"}),e.jsx(de,{sx:{my:2}}),e.jsxs(p,{container:!0,spacing:2,children:[e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Transaction ID:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:m})}),e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Student Name:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:u})}),e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Program:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:N})}),e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Amount Paid:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsxs(s,{children:["â‚¦",D]})}),e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Status:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:$})}),e.jsx(p,{item:!0,xs:6,children:e.jsx(s,{fontWeight:"bold",children:"Date:"})}),e.jsx(p,{item:!0,xs:6,align:"right",children:e.jsx(s,{children:E})})]}),e.jsx(de,{sx:{my:2}}),e.jsx(s,{variant:"body2",align:"center",children:"Thank you for your payment!"}),e.jsx(Ae,{variant:"contained",color:"primary",fullWidth:!0,onClick:L,sx:{mt:2},children:"Download Receipt"})]})};var Z={},Le=Ne;Object.defineProperty(Z,"__esModule",{value:!0});var fe=Z.default=void 0,$e=Le(je()),Be=e;fe=Z.default=(0,$e.default)((0,Be.jsx)("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"}),"Payment");const We=({onSuccess:a=()=>{},studentId:o,classLevelId:L,academicYears:m=[],defaultAcademicYear:u,termName:N,subclassLetter:D,section:$,email:E})=>{const[k,g]=r.useState(!1),[B,S]=r.useState(!1),[c,O]=r.useState(""),[h,P]=r.useState(u||""),[_,x]=r.useState("Current Academic Year"),Y="pk_test_8293ca0c4f5b0e4b8da1dad753cbc602cebade30",{callApi:T}=ge(),C=Q(d=>d.adminData.currentAcademicYear);if(r.useEffect(()=>{const d=async()=>{var b;if(!m.length&&u)try{const i=await T(`${U.ACADEMICYEARS_ID}/${u}`,"GET");console.log("Default academic year response:",JSON.stringify(i,null,2)),i&&i.data&&i.data.name?x(i.data.name):(console.warn("Invalid default academic year response:",i),x("Current Academic Year"))}catch(i){console.error("Error fetching default academic year name:",((b=i.response)==null?void 0:b.data)||i.message),x("Current Academic Year")}};!m.length&&u&&(C==null?void 0:C._id)===u?x(C.name||"Current Academic Year"):!m.length&&u&&d()},[m,u,C,T]),console.log("PaystackButton props:",JSON.stringify({studentId:o,classLevelId:L,academicYears:m,defaultAcademicYear:u,defaultAcademicYearName:_,selectedAcademicYear:h,termName:N,subclassLetter:D,section:$,email:E},null,2)),!m.length&&!u)return console.error("PaystackButton: academicYears prop is empty and no defaultAcademicYear"),e.jsx(s,{color:"error",children:"Error: No academic years available"});const H=()=>{S(!0)},F=()=>{S(!1)},I=()=>{if(!c||parseFloat(c)<=0){alert("Please enter a valid amount");return}if(!h){alert("Please select an academic year");return}G(),F()},G=()=>{var d;g(!0);try{window.PaystackPop.setup({key:Y,email:E||"user@example.com",currency:"NGN",amount:parseFloat(c)*100,metadata:{custom_fields:[{display_name:"Payment Purpose",variable_name:"payment_purpose",value:"School Fees"},{display_name:"Academic Year",variable_name:"academic_year",value:((d=m.find(i=>i.academicYearId===h))==null?void 0:d.name)||_||"Unknown"}]},onClose:()=>{console.log("Payment dialog closed"),g(!1)},callback:i=>{console.log("Paystack callback triggered:",i);const v=i.reference;if(!c||isNaN(c)){console.error("Invalid payment amount:",c),alert("Invalid payment amount"),g(!1);return}if(!v){console.error("Missing transaction reference:",i),alert("Missing transaction reference"),g(!1);return}if(!h){console.error("Missing selected academic year"),alert("Please select an academic year"),g(!1);return}const W={studentId:o,classLevelId:L,academicYear:h,section:$,termPayments:[{termName:N,subclassLetter:D,payments:[{amountPaid:parseFloat(c)*100,method:"Card",reference:v,status:"success",datePaid:new Date().toISOString()}]}]};console.log("Payload being sent to backend:",JSON.stringify(W,null,2)),console.log("Payload academicYear:",W.academicYear),T(U.PAYMENT,"POST",W).then(A=>{if(console.log("Transaction registered successfully:",A),A&&A.data)a({...A.data,amount:parseFloat(c)*100,reference:v,academicYear:h});else throw new Error("Invalid backend response")}).catch(A=>{var w,J,z;console.error("Failed to register transaction:",((w=A.response)==null?void 0:w.data)||A.message),alert(`Payment failed: ${((z=(J=A.response)==null?void 0:J.data)==null?void 0:z.message)||"Unknown error"}`)}).finally(()=>{g(!1),O(""),P(u||"")})}}).openIframe()}catch(b){console.error("Error initializing Paystack payment:",b),alert("Failed to initialize payment. Please try again."),g(!1)}};return e.jsxs(j,{children:[e.jsx(ke,{icon:e.jsx(fe,{}),disabled:k,onClick:H,content:k?e.jsx(Oe,{size:24}):"Pay Now"}),e.jsxs(X,{open:B,onClose:F,title:"Enter Payment Details",onConfirm:I,confirmMessage:"Proceed with Payment",children:[e.jsx(Ie,{label:"Amount (Naira)",type:"number",value:c,onChange:d=>O(d.target.value),fullWidth:!0,error:!c||parseFloat(c)<=0,helperText:c?parseFloat(c)<=0?"Amount must be greater than 0":"":"Amount is required",sx:{mb:2}}),e.jsxs(we,{fullWidth:!0,children:[e.jsx(De,{id:"academic-year-label",children:"Academic Year"}),e.jsx(Ee,{labelId:"academic-year-label",value:h,label:"Academic Year",onChange:d=>P(d.target.value),children:m.length>0?m.map(d=>e.jsx(ue,{value:d.academicYearId,children:d.name},d.academicYearId)):e.jsx(ue,{value:u,children:_})})]})]})]})},Je=()=>{var ae,te,se,re,ne;const a=Q(t=>t.users.user),o=Q(t=>t.adminData.currentAcademicYear),L=Re(),m=Se(L.palette.mode),[u,N]=r.useState([]),[D,$]=r.useState(0),[E,k]=r.useState(10),[g,B]=r.useState("datePaid"),[S,c]=r.useState("asc"),[O,h]=r.useState(!1),[P,_]=r.useState(null),[x,Y]=r.useState(!1),[T,C]=r.useState(0),[H,F]=r.useState(0),[I,G]=r.useState([]),[d,b]=r.useState("Current Academic Year"),[i,v]=r.useState(""),[W,A]=r.useState(!1),{callApi:w}=ge();r.useEffect(()=>{console.log("User object:",JSON.stringify(a,null,2)),console.log("Current academic year from Redux:",JSON.stringify(o,null,2)),console.log("Academic years endpoint:",U.ACADEMICYEARS_ID),(async()=>{var n,R,M;try{const l=await w(U.ACADEMICYEARS_ID,"GET");console.log("Academic years response:",JSON.stringify(l,null,2)),l&&Array.isArray(l.data)?(G(l.data),l.data.length===0&&(console.warn("Academic years response is empty"),v("No academic years available. Using default academic year."))):(console.warn("Invalid academic years response:",l),v("Failed to load academic years. Using default academic year."),G([]))}catch(l){console.error("Error fetching academic years:",((n=l.response)==null?void 0:n.data)||l.message),v(`Error fetching academic years: ${((M=(R=l.response)==null?void 0:R.data)==null?void 0:M.message)||l.message}`),G([])}})()},[w]),r.useEffect(()=>{const t=async()=>{var R,M,l,f;const n=((R=I.find(y=>y.isCurrent))==null?void 0:R.academicYearId)||(o==null?void 0:o._id)||((l=(M=a==null?void 0:a.currentClassLevel)==null?void 0:M.academicYear)==null?void 0:l.academicYearId)||"";if(!I.length&&n)try{const y=await w(`${U.ACADEMICYEARS_ID}/${n}`,"GET");console.log("Default academic year response:",JSON.stringify(y,null,2)),y&&y.data&&y.data.name?b(y.data.name):b("Current Academic Year")}catch(y){console.error("Error fetching default academic year name:",((f=y.response)==null?void 0:f.data)||y.message),b("Current Academic Year")}};!I.length&&(o!=null&&o.name)?b(o.name):!I.length&&V&&t()},[I,o,a,w]),r.useEffect(()=>{(async()=>{var R,M,l;if(!(a!=null&&a._id)){console.warn("No user ID available, skipping payment records fetch"),v("User not authenticated. Please log in again.");return}const n=`${U.PAYMENT}?studentId=${a._id}&page=${D+1}&limit=${E}&sortBy=${g}&sortDirection=${S}`;console.log(`Fetching payment records from: ${n}`);try{const f=await w(n,"GET");if(console.log("Payment records response:",JSON.stringify(f,null,2)),f&&Array.isArray(f.data)){const y=f.data.flatMap(K=>{var oe;return((((oe=K.termPayments)==null?void 0:oe[0])||{}).payments||[]).map(q=>{var ie,ce,le;return{reference:q.reference,amountPaid:q.amountPaid,datePaid:q.datePaid,status:q.status||K.status,userName:(a==null?void 0:a.fullName)||(a!=null&&a.firstName&&(a!=null&&a.lastName)?`${a.firstName} ${a.lastName}`:"Unknown Student"),program:((ie=a==null?void 0:a.currentClassLevel)==null?void 0:ie.program)||((ce=a==null?void 0:a.currentClassLevel)==null?void 0:ce.name)||((le=a==null?void 0:a.currentClassLevel)==null?void 0:le.course)||"N/A",originalReceipt:K}})});N(y),C(f.totalOutstanding||0),F(f.totalPaid||0)}else console.warn("Invalid payment records response:",f),v("No payment records found."),N([]),C(0),F(0)}catch(f){console.error("Error fetching payment records:",((R=f.response)==null?void 0:R.data)||f.message),v(`Error fetching payment records: ${((l=(M=f.response)==null?void 0:M.data)==null?void 0:l.message)||f.message}`),N([]),C(0),F(0)}})()},[D,E,g,S,w,a]),r.useEffect(()=>{!x&&W&&(console.log("Success modal closed, reloading page"),window.location.reload())},[x,W]);const J=T+H,z=J>0?H/J*100:0,he=t=>{const n=g===t&&S==="asc";B(t),c(n?"desc":"asc")},pe=t=>{console.log("Selected row for receipt:",JSON.stringify(t,null,2)),_(t),h(!0)},xe=t=>{console.log("Payment details:",JSON.stringify(t,null,2)),N(n=>[t,...n]),F(n=>n+t.amount),C(n=>n-t.amount),Y(!0),A(!0)},V=((ae=I.find(t=>t.isCurrent))==null?void 0:ae.academicYearId)||(o==null?void 0:o._id)||((se=(te=a==null?void 0:a.currentClassLevel)==null?void 0:te.academicYear)==null?void 0:se.academicYearId)||"";if(!V)return console.error("Cannot render PaystackButton: No default academicYearId found"),e.jsxs(j,{children:[e.jsx(me,{title:"Payment History",subtitle:"Overview of Payments Made"}),e.jsx(s,{color:"error",children:i||"Error: Academic year information is missing. Please contact support."})]});const ee={onSuccess:xe,studentId:a._id,classLevelId:a.classLevelId,academicYears:I,defaultAcademicYear:V,defaultAcademicYearName:d,section:(re=a.currentClassLevel)==null?void 0:re.section,termName:"1st Term",subclassLetter:(ne=a.currentClassLevel)==null?void 0:ne.subclass,email:a.email||"user@example.com"};console.log("PaystackButton props:",JSON.stringify(ee,null,2));const ye={columns:[{id:"sn",label:"S/N",flex:.3,renderCell:(t,n)=>e.jsx(s,{children:n+1})},{id:"reference",label:"Transaction ID",flex:1,renderCell:t=>e.jsx(s,{children:t.reference||"N/A"})},{id:"amountPaid",label:"Amount (â‚¦)",flex:1,renderCell:t=>e.jsxs(s,{children:["â‚¦",(t.amountPaid/100).toFixed(2)]})},{id:"status",label:"Status",flex:1,renderCell:t=>e.jsx(s,{children:t.status?t.status.charAt(0).toUpperCase()+t.status.slice(1):"N/A"})},{id:"datePaid",label:"Date",flex:1,renderCell:t=>e.jsx(s,{children:t.datePaid?new Date(t.datePaid).toLocaleDateString():"N/A"})},{id:"actions",label:"Actions",flex:1,renderCell:t=>e.jsx(j,{display:"flex",gap:"10px",children:e.jsx(Ye,{onClick:()=>pe(t),children:e.jsx(Te,{})})})}],tableHeader:"Payment Records",data:u,sortBy:g,sortDirection:S,onSortChange:he,page:D,rowsPerPage:E,onPageChange:(t,n)=>$(n),onRowsPerPageChange:t=>k(parseInt(t.target.value,10)),onRowClick:t=>console.log("Row clicked:",t),hiddenColumnsSmallScreen:["status","reference"]};return e.jsxs(j,{children:[e.jsx(me,{title:"Payment History",subtitle:"Overview of Payments Made"}),e.jsxs(j,{backgroundColor:m.primary[400],p:"20px",borderRadius:"4px",children:[e.jsx(s,{variant:"h5",fontWeight:"600",mb:"15px",children:"Payment Summary"}),i&&e.jsx(s,{color:"error",mb:"15px",children:i}),e.jsxs(j,{mb:"20px",children:[e.jsxs(j,{sx:{display:"flex",alignItems:"end",marginBottom:"15px",justifyContent:"space-between",width:"100%"},children:[e.jsxs(j,{children:[e.jsxs(s,{variant:"h6",mb:"5px",children:["Total Amount Due: â‚¦",(J/100).toFixed(2)]}),e.jsxs(s,{variant:"h6",mb:"5px",children:["Total Paid: â‚¦",(H/100).toFixed(2)]}),e.jsxs(s,{variant:"h6",children:["Payment Percentage: ",z.toFixed(2),"%"]})]}),e.jsx(j,{children:e.jsx(We,{...ee})})]}),e.jsx(_e,{variant:"determinate",value:z,sx:{height:10,borderRadius:5,backgroundColor:m.grey[300],"& .MuiLinearProgress-bar":{backgroundColor:m.greenAccent[500]}}})]}),e.jsx(Pe,{...ye}),e.jsx(X,{open:x,onClose:()=>Y(!1),title:"Payment Successful",noConfirm:!0,children:e.jsx(s,{variant:"h6",align:"center",color:"green",children:"Your payment was successful!"})}),e.jsx(X,{open:O,onClose:()=>h(!1),title:"Receipt Details",noConfirm:!0,children:P?e.jsx(Fe,{receipt:P}):e.jsx(s,{color:"error",children:"No receipt data available."})})]})]})},ma=Me(Je);export{ma as default};
