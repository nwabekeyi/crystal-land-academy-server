import{r as n,f as v,j as e,a as Ge,i as Ne}from"./index-CUx_BIfb.js";import{t as Ie,M as Se}from"./modal-D-FEyCwe.js";import{H as We}from"./Header-C6ewtNOz.js";import{T as Re}from"./table-SVpfRggE.js";import{u as R}from"./useApi-B5A5LOF2.js";import{C as fe}from"./customIconButton-EX4Xi4Si.js";import{l as He,j as Ve,m as Te,n as ge}from"./index-BCg1p7hM.js";import{w as Ze}from"./dasboardPagesContainer-MMQB9i4e.js";import{A as Ae}from"./actionButton-CH_DOheE.js";import{j as ze,v as N,a1 as pe,a2 as ve,a3 as Ce,T as C,y as H,x as Ee}from"./TextField-CnJy6qLH.js";import{M as y}from"./MenuItem-Y8p8i8nN.js";import"./IconButton-CSIbz2lV.js";import"./index-Ci-mqblD.js";import"./confirmationModal-C7esu7_Z.js";import"./CircularProgress-BgN2WNYl.js";import"./index-Dn2bJmhV.js";import"./loadingButton-BcWtTSRw.js";import"./crystal-land-log-removebg-DVF-nlbN.js";import"./useSlot-BurnVOpP.js";import"./useMediaQuery-BkgNzubS.js";const Ke=({userId:A})=>{var ye;const[D,V]=n.useState(!1),[U,X]=n.useState("create"),[w,E]=n.useState(null),[u,T]=n.useState({name:"",description:"",classLevelSubclasses:[]}),[Z,Y]=n.useState(!1),[$,ee]=n.useState({id:"",name:"",description:""}),[M,d]=n.useState(""),[ce,x]=n.useState(!1),[O,J]=n.useState(null),[m,z]=n.useState(""),[j,oe]=n.useState(""),[b,F]=n.useState(0),[g,B]=n.useState(5),[se,K]=n.useState(0),[f,ae]=n.useState([]),[q,G]=n.useState([]),{data:i,loading:_,error:I,callApi:k}=R(),{data:a,loading:o,error:r,callApi:L}=R(),{data:S,loading:p,error:ie,callApi:Me}=R(),{data:W,loading:$e,error:de,callApi:le}=R(),{callApi:Q,loading:ke,error:ue}=R(),{callApi:te,loading:Pe,error:me}=R(),ne=s=>{var l;const t=f.find(c=>c._id===s);return((l=t==null?void 0:t.name)==null?void 0:l.startsWith("SS"))||!1};n.useEffect(()=>{L(v.CLASS_LEVEL,"GET"),Me(v.TEACHERS,"GET")},[]),n.useEffect(()=>{var s;if((s=a==null?void 0:a.data)!=null&&s.data||a!=null&&a.data){const t=a.data.data||a.data||[];ae(t),console.log("classLevels set:",JSON.stringify(t,null,2))}},[a]),n.useEffect(()=>{if(S!=null&&S.data){const s=Array.isArray(S.data)?S.data:[];G(s),console.log("teachers set:",JSON.stringify(s,null,2))}},[S]),n.useEffect(()=>{const s=new URLSearchParams({page:(b+1).toString(),limit:g.toString(),populate:"name",...m&&{classLevelId:m},...m&&ne(m)&&j&&{subclassLetter:j}}).toString();k(`${v.SUBJECT}/subclass/filter?${s}`,"GET"),le(v.SUBJECT_NAME,"GET")},[k,le,b,g,m,j]),n.useEffect(()=>{d(I||r||ie||de||ue||me||"")},[I,r,ie,de,ue,me]),n.useEffect(()=>{i&&console.log("subjectData:",JSON.stringify(i,null,2)),W&&console.log("subjectNamesData:",JSON.stringify(W,null,2)),f&&console.log("classLevels:",JSON.stringify(f,null,2)),q&&console.log("teachers:",JSON.stringify(q,null,2))},[i,W,f,q]),n.useEffect(()=>{var s,t;(s=i==null?void 0:i.data)!=null&&s.totalPages?(K(i.data.totalPages),b>=i.data.totalPages&&F(0)):(t=i==null?void 0:i.data)!=null&&t.length&&K(1)},[i,b]);const be=((ye=i==null?void 0:i.data)==null?void 0:ye.data)||(i==null?void 0:i.data)||[],we=(W==null?void 0:W.data)||[],re=n.useCallback((s,t=null)=>{var l;console.log("Opening modal with mode:",s),X(s),E(t),s==="create"?T({name:"",description:"",classLevelSubclasses:[]}):t&&T({name:((l=t.name)==null?void 0:l._id)||t.name||"",description:t.description||"",classLevelSubclasses:Array.isArray(t.classLevelSubclasses)?t.classLevelSubclasses.map(c=>{var h;return{classLevel:((h=c.classLevel)==null?void 0:h._id)||c.classLevel||"",subclassLetter:c.subclassLetter||"",teachers:Array.isArray(c.teachers)?c.teachers.map(P=>P._id||P):[]}}):[]}),V(!0)},[]);n.useEffect(()=>{console.log("formData:",JSON.stringify(u,null,2))},[u]);const xe=n.useCallback(s=>{J(s),x(!0)},[]),he=n.useCallback(()=>{J(null),x(!1)},[]),Fe=n.useCallback(async()=>{if(!O||!A){d("User not authenticated or no subject selected for deletion");return}try{await Q(`${v.SUBJECT}/${O._id}`,"DELETE");const s=new URLSearchParams({page:(b+1).toString(),limit:g.toString(),populate:"name",...m&&{classLevelId:m},...m&&ne(m)&&j&&{subclassLetter:j}}).toString();await k(`${v.SUBJECT}?${s}`,"GET"),d(""),he()}catch(s){d(s.statusCode===404?"Subject not found":s.statusCode===409?"Subject cannot be deleted due to dependencies":s.message||"Failed to delete subject")}},[O,A,Q,k,b,g,m,j,he]),_e=n.useCallback(s=>{const{name:t,value:l}=s.target;T(c=>({...c,[t]:l}))},[]),De=n.useCallback((s,t,l)=>{T(c=>{const h=[...c.classLevelSubclasses||[]];return h[s]={...h[s],[t]:l},t==="classLevel"?(h[s].subclassLetter="",h[s].teachers=[]):t==="subclassLetter"&&(h[s].teachers=[]),{...c,classLevelSubclasses:h}})},[]),Ue=n.useCallback(()=>{T(s=>({...s,classLevelSubclasses:[...s.classLevelSubclasses||[],{classLevel:"",subclassLetter:"",teachers:[]}]}))},[]),Oe=n.useCallback(s=>{T(t=>({...t,classLevelSubclasses:(t.classLevelSubclasses||[]).filter((l,c)=>c!==s)}))},[]),Je=n.useCallback(s=>{const{name:t,value:l}=s.target;ee(c=>({...c,[t]:l}))},[]),Be=n.useCallback(async(s="create",t=null)=>{if(!A){d("User not authenticated");return}try{if(s==="create"||s==="edit"){if(!$.name){d("Subject name is required");return}const l={name:$.name,description:$.description||""};s==="create"?await te(v.SUBJECT_NAME,"POST",l):s==="edit"&&$.id&&await te(`${v.SUBJECT_NAME}/${$.id}`,"PATCH",l)}else s==="delete"&&t&&await te(`${v.SUBJECT_NAME}/${t}`,"DELETE");await le(v.SUBJECT_NAME,"GET"),ee({id:"",name:"",description:""}),d(""),Y(!1)}catch(l){d(l.statusCode===409?"Subject name already exists":l.statusCode===400?l.message||"Invalid data provided":l.message||"Failed to process subject name")}},[A,te,le,$]),je=n.useCallback(()=>{var s,t;if(console.log("Validating formData:",JSON.stringify(u,null,2)),!A)return"User not authenticated. Please log in.";if(!u.name)return"Subject name is required";if(!Array.isArray(u.classLevelSubclasses)||u.classLevelSubclasses.length===0)return"At least one class level is required";for(const l of u.classLevelSubclasses){if(!l.classLevel)return"Class level is required for all entries";const c=f.find(h=>h._id===l.classLevel);if(!c)return`Class level ID ${l.classLevel} does not exist`;if(["SS 1","SS 2","SS 3"].includes(c.name)){if(!l.subclassLetter)return`Subclass letter required for ${c.name}`;if(!/^[A-Z]$/.test(l.subclassLetter))return`Subclass ${l.subclassLetter} must be a single capital letter (A-Z)`;if(!((s=c.subclasses)==null?void 0:s.some(P=>P.letter===l.subclassLetter)))return`Subclass ${l.subclassLetter} does not exist in class level ${c.name}`}else if(l.subclassLetter)return`Subclass letter not allowed for ${c.name}`;if(((t=l.teachers)==null?void 0:t.length)>0){const h=(c.teachers||[]).map(P=>P.teacherId);console.log("Validating teachers for classLevel:",c.name,"teacherIds:",h);for(const P of l.teachers)if(!h.includes(P))return`Teacher ID ${P} is not assigned to class level ${c.name}`}}return""},[u,f,A]),qe=n.useCallback(async()=>{console.log("handleSubmit called with formData:",JSON.stringify(u,null,2));const s=je();if(s){console.log("Validation failed:",s),d(s);return}const t={name:u.name,description:u.description,classLevelSubclasses:u.classLevelSubclasses.map(l=>({classLevel:l.classLevel,subclassLetter:ne(l.classLevel)?l.subclassLetter:null,teachers:l.teachers||[]})),createdBy:A};console.log("Submitting payload:",JSON.stringify(t,null,2));try{U==="create"?await Q(v.SUBJECT,"POST",t):U==="edit"&&(w!=null&&w._id)&&await Q(`${v.SUBJECT}/${w._id}`,"PATCH",t);const l=new URLSearchParams({page:(b+1).toString(),limit:g.toString(),populate:"name",...m&&{classLevelId:m},...m&&ne(m)&&j&&{subclassLetter:j}}).toString();await k(`${v.SUBJECT}?${l}`,"GET"),V(!1),d(""),console.log("Submission successful")}catch(l){const c=l.statusCode===409?"Subject already exists":l.statusCode===400?l.message||"Invalid data provided":l.message||"Failed to process request";console.log("Submission failed:",c),d(c)}},[U,u,w,Q,k,je,A,b,g,m,j]),Le=n.useMemo(()=>Array.isArray(be)?be.map((s,t)=>{const l=s.name&&typeof s.name=="object"&&s.name.name?s.name.name:s.name||"Unknown";return console.log(`Row ${t+1} name:`,s.name),{...s,sn:t+1+b*g,displayName:l,classLevelSubclassesCount:Array.isArray(s.classLevelSubclasses)?s.classLevelSubclasses.length:0,teacherCount:Array.isArray(s.classLevelSubclasses)?s.classLevelSubclasses.reduce((c,h)=>c+(Array.isArray(h.teachers)?h.teachers.length:0),0):0}}):[],[be,b,g]);return{tableProps:{columns:n.useMemo(()=>[{id:"sn",label:"S/N",width:90},{id:"displayName",label:"Subject Name",flex:1,renderCell:s=>s.displayName},{id:"description",label:"Description",flex:1},{id:"classLevelSubclassesCount",label:"Classes Assigned",flex:1,renderCell:s=>s.classLevelSubclassesCount},{id:"teacherCount",label:"Teachers Assigned",flex:1,renderCell:s=>s.teacherCount},{id:"actions",label:"Actions",flex:1,renderCell:s=>e.jsxs(e.Fragment,{children:[e.jsx(fe,{icon:e.jsx(He,{}),title:"View Subject",onClick:()=>re("view",s),sx:{mx:.5}}),e.jsx(fe,{icon:e.jsx(Ve,{}),title:"Edit Subject",onClick:()=>re("edit",s),sx:{mx:.5}}),e.jsx(fe,{icon:e.jsx(Te,{}),title:"Delete Subject",onClick:()=>xe(s),sx:{mx:.5}})]})}],[re,xe]),tableHeader:"Subject Management",data:Le,sortBy:"name",sortDirection:"asc",onSortChange:()=>{},hiddenColumnsSmallScreen:["description"],hiddenColumnsTabScreen:[],page:b,rowsPerPage:g,count:se*g||Le.length,onPageChange:(s,t)=>F(t),onRowsPerPageChange:s=>{B(parseInt(s.target.value,10)),F(0)}},modalOpen:D,setModalOpen:V,modalMode:U,setModalMode:X,formData:u,setFormData:T,handleFormChange:_e,handleClassLevelChange:De,addClassLevel:Ue,removeClassLevel:Oe,handleSubmit:qe,error:M,loading:_||o||p||$e||ke||Pe,openModal:re,classLevels:f,teachers:q,subjectNames:we,selectedSubject:w,deleteConfirmOpen:ce,subjectToDelete:O,handleDelete:Fe,closeDeleteConfirm:he,classLevelFilter:m,setClassLevelFilter:z,subclassLetterFilter:j,setSubclassLetterFilter:oe,subjectNameModalOpen:Z,setSubjectNameModalOpen:Y,subjectNameFormData:$,handleSubjectNameFormChange:Je,handleSubjectNameSubmit:Be,page:b,setPage:F,rowsPerPage:g,setRowsPerPage:B,totalPages:se}},Qe=()=>{var I,k;const A=ze(),D=Ie(A.palette.mode),V=Ge(a=>{var o;return(o=a.users.user)==null?void 0:o._id})||"",{tableProps:U,modalOpen:X,setModalOpen:w,modalMode:E,formData:u,handleFormChange:T,handleClassLevelChange:Z,addClassLevel:Y,removeClassLevel:$,handleSubmit:ee,error:M,loading:d,openModal:ce,classLevels:x,subjectNames:O,selectedSubject:J,deleteConfirmOpen:m,subjectToDelete:z,handleDelete:j,closeDeleteConfirm:oe,classLevelFilter:b,setClassLevelFilter:F,subclassLetterFilter:g,setSubclassLetterFilter:B,subjectNameModalOpen:se,setSubjectNameModalOpen:K,subjectNameFormData:f,handleSubjectNameFormChange:ae,handleSubjectNameSubmit:q}=Ke({userId:V});n.useEffect(()=>{F(""),B("")},[F,B]);const G=a=>{var r;const o=x.find(L=>L._id===a);return((r=o==null?void 0:o.subclasses)==null?void 0:r.map(L=>L.letter))||[]},i=a=>{var r;const o=x.find(L=>L._id===a);return((r=o==null?void 0:o.name)==null?void 0:r.startsWith("SS"))||!1},_=a=>{const o=x.find(r=>r._id===a);return(o==null?void 0:o.teachers)||[]};return e.jsxs(N,{children:[e.jsx(We,{title:"Subject Management",subtitle:"Manage subjects and their details"}),e.jsxs(N,{sx:{mt:3,mb:3},children:[e.jsxs(N,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(Ae,{icon:e.jsx(ge,{}),content:"Add Subject",onClick:()=>ce("create"),sx:{mb:2}}),e.jsx(Ae,{icon:e.jsx(ge,{}),content:"Manage Subject Names",onClick:()=>K(!0),sx:{mb:2}}),e.jsxs(pe,{sx:{minWidth:200},disabled:d||x.length===0,children:[e.jsx(ve,{children:"Class Level"}),e.jsxs(Ce,{value:b,onChange:a=>{F(a.target.value),B("")},label:"Class Level",children:[e.jsx(y,{value:"",children:"All Class Levels"}),x.map(a=>e.jsx(y,{value:a._id,children:a.name||"Unknown Class"},a._id))]})]}),i(b)&&e.jsxs(pe,{sx:{minWidth:120},disabled:!b||G(b).length===0,children:[e.jsx(ve,{children:"Subclass"}),e.jsxs(Ce,{value:g,onChange:a=>B(a.target.value),label:"Subclass",children:[e.jsx(y,{value:"",children:"All Subclasses"}),G(b).map(a=>e.jsx(y,{value:a,children:a},a))]})]})]}),d?e.jsx(Ne,{}):M?e.jsx(C,{color:"error",children:M}):U.data.length===0?e.jsx(C,{children:"No subjects available"}):e.jsx(N,{height:"75vh",sx:{"& .MuiDataGrid-root":{border:"none"},"& .MuiDataGrid-cell":{borderBottom:"none"},"& .MuiDataGrid-columnHeaders":{backgroundColor:D.blueAccent[700],borderBottom:"none"},"& .MuiDataGrid-virtualScroller":{backgroundColor:D.primary[400]},"& .MuiDataGrid-footerContainer":{borderTop:"none",backgroundColor:D.blueAccent[700]},"& .MuiCheckbox-root":{color:`${D.blueAccent[200]} !important`}},children:e.jsx(Re,{...U,tableHeader:"Subjects"})})]}),e.jsx(Se,{open:X,onClose:()=>w(!1),title:E==="create"?"Create Subject":E==="edit"?"Edit Subject":"View Subject",onConfirm:E!=="view"?ee:null,confirmMessage:E==="create"?"Create":"Save",styleProps:{padding:"20px"},children:e.jsxs(N,{sx:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsxs(pe,{fullWidth:!0,required:!0,disabled:E==="view"||O.length===0,children:[e.jsx(ve,{children:"Subject Name"}),e.jsxs(Ce,{name:"name",value:u.name||"",onChange:T,label:"Subject Name",children:[e.jsx(y,{value:"",children:e.jsx("em",{children:"Select a subject name"})}),O.map(a=>e.jsx(y,{value:a._id,children:a.name||"Unknown"},a._id))]})]}),e.jsx(H,{label:"Description",name:"description",value:u.description||"",onChange:T,multiline:!0,rows:4,fullWidth:!0,disabled:E==="view"}),E!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx(N,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(Ee,{variant:"contained",onClick:Y,startIcon:e.jsx(ge,{}),sx:{backgroundColor:D.blueAccent[700]},disabled:x.length===0,children:"Add Class Level and Subclass"})}),Array.isArray(u.classLevelSubclasses)&&u.classLevelSubclasses.length>0?u.classLevelSubclasses.map((a,o)=>e.jsxs(N,{sx:{display:"flex",gap:"16px",alignItems:"center",mb:2,flexWrap:"wrap"},children:[e.jsxs(H,{select:!0,label:`Class Level ${o+1}`,value:a.classLevel||"",onChange:r=>Z(o,"classLevel",r.target.value),required:!0,sx:{flex:1},disabled:x.length===0,children:[e.jsx(y,{value:"",children:e.jsx("em",{children:"Select a class level"})}),x.map(r=>e.jsx(y,{value:r._id,children:r.name||"Unknown Class"},r._id))]}),i(a.classLevel)&&e.jsxs(H,{select:!0,label:`Subclass ${o+1}`,value:a.subclassLetter||"",onChange:r=>Z(o,"subclassLetter",r.target.value),required:!0,sx:{flex:1},disabled:!a.classLevel||G(a.classLevel).length===0,children:[e.jsx(y,{value:"",children:e.jsx("em",{children:"Select a subclass"})}),G(a.classLevel).map(r=>e.jsx(y,{value:r,children:r},r))]}),e.jsx(H,{select:!0,label:`Teachers for Class Level ${o+1}`,value:a.teachers||[],onChange:r=>Z(o,"teachers",r.target.value),SelectProps:{multiple:!0,renderValue:r=>r.length>0?r.map(L=>{const S=_(a.classLevel).find(p=>p.teacherId===L);return S?`${S.firstName} ${S.lastName}`:"Unknown"}).join(", "):"Select teachers"},sx:{flex:1},disabled:!a.classLevel||i(a.classLevel)&&!a.subclassLetter,children:_(a.classLevel).length>0?_(a.classLevel).map(r=>e.jsx(y,{value:r.teacherId,children:`${r.firstName} ${r.lastName}`},r.teacherId)):e.jsx(y,{disabled:!0,children:"No teachers available for this class level"})}),e.jsx(Ee,{variant:"contained",color:"error",onClick:()=>$(o),startIcon:e.jsx(Te,{}),children:"Remove"})]},o)):e.jsx(C,{children:'No class levels assigned. Click "Add Class Level and Subclass" to assign.'})]}),E==="view"&&e.jsxs(N,{sx:{mt:2},children:[e.jsx(C,{variant:"h6",children:"Assigned Class Levels and Subclasses"}),((I=J==null?void 0:J.classLevelSubclasses)==null?void 0:I.length)>0?J.classLevelSubclasses.map((a,o)=>{var r,L;return e.jsxs(N,{sx:{mb:2},children:[e.jsxs(C,{variant:"subtitle1",children:[((r=x.find(S=>{var p;return S._id===(((p=a.classLevel)==null?void 0:p._id)||a.classLevel)}))==null?void 0:r.name)||"Unknown Class Level",a.subclassLetter?` - Subclass ${a.subclassLetter}`:""]}),e.jsx(C,{variant:"subtitle2",children:"Teachers:"}),((L=a.teachers)==null?void 0:L.length)>0?a.teachers.map(S=>e.jsxs(C,{sx:{ml:2},children:["- ",_(a.classLevel).find(p=>p.teacherId===S)?`${_(a.classLevel).find(p=>p.teacherId===p.teacherId).firstName} ${_(a.classLevel).find(p=>p.teacherId===S).lastName}`:"Unknown Teacher"]},S)):e.jsx(C,{sx:{ml:2},children:"No teachers assigned"})]},o)}):e.jsx(C,{children:"No class levels or subclasses assigned"})]}),M&&e.jsx(C,{color:"error",children:M})]})}),e.jsx(Se,{open:se,onClose:()=>K(!1),title:f.id?"Edit Subject Name":"Create Subject Name",onConfirm:()=>q(f.id?"edit":"create",f.id),confirmMessage:f.id?"Save":"Create",styleProps:{padding:"20px"},children:e.jsxs(N,{sx:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsx(H,{label:"Subject Name",name:"name",value:f.name||"",onChange:ae,required:!0,fullWidth:!0}),e.jsx(H,{label:"Description",name:"description",value:f.description||"",onChange:ae,multiline:!0,rows:4,fullWidth:!0}),M&&e.jsx(C,{color:"error",children:M})]})}),e.jsx(Se,{open:m,onClose:oe,title:"Delete Subject",onConfirm:j,confirmMessage:"Delete",styleProps:{padding:"20px"},children:e.jsxs(N,{children:[e.jsxs(C,{children:['Are you sure you want to delete the subject "',((k=z==null?void 0:z.name)==null?void 0:k.name)||"Unknown",'"? This action cannot be undone.']}),d&&e.jsx(Ne,{}),M&&e.jsx(C,{color:"error",children:M})]})})]})},Cs=Ze(Qe);export{Cs as default};
