import{a as be,P as he,r as l,e as Y,O as xe,j as e,i as Ce}from"./index-NZEBDXxQ.js";import{t as ge,M as oe}from"./modal-BenOPica.js";import{H as fe}from"./Header-CPkEzEIh.js";import{a as je,b as ve,T as Se}from"./table-D4jZ3nya.js";import{u as ie}from"./useApi-BVJLWYD8.js";import{C as se}from"./customIconButton-6QQ-t_eg.js";import{h as Le,e as De,g as ue,i as ce}from"./index.esm-B9M-GExh.js";import{u as Te,M as te}from"./MenuItem-BvkakO0W.js";import{w as we}from"./dasboardPagesContainer-BdOZP967.js";import{A as Me,C as _e}from"./confirmationModal-PWKEq3Qt.js";import{j as Pe,v as f,T as M,y as H,x as de}from"./TextField-DNvuwNON.js";import{I as ke}from"./IconButton-DuKgt8V1.js";import"./index-D2Mru0Qa.js";import"./index-C379hBbb.js";import"./loadingButton-B5aAP40a.js";import"./CircularProgress-BwrrL3V1.js";import"./useSlot-wOToS5I0.js";import"./useMediaQuery-BPlChv1n.js";const ye=()=>{const _=Te(),{subjects:c,academicYears:p,classLevels:v,usersData:O}=be(he),[b,P]=l.useState("name"),[T,N]=l.useState("asc"),[Q,$]=l.useState(!1),[k,q]=l.useState("create"),[G,X]=l.useState(null),[u,d]=l.useState({name:"",description:"",academicYear:"",classLevels:[]}),[J,S]=l.useState(""),[y,W]=l.useState(!1),[L,R]=l.useState(null),[Z,z]=l.useState(!1),{data:w,loading:I,callApi:h}=ie(),{callApi:g,loading:ee,error:A}=ie();l.useEffect(()=>{h(Y.SUBJECT,"GET")},[h]),l.useEffect(()=>{w&&Array.isArray(w.data)&&_(xe(w.data))},[w,_]);const ae=l.useCallback(s=>{b===s?N(T==="asc"?"desc":"asc"):(P(s),N("asc"))},[b,T]),B=l.useCallback((s,r=null)=>{var m,x,F;q(s),X(r),s==="create"?d({name:"",description:"",academicYear:((m=p.find(U=>U.isCurrent))==null?void 0:m._id)||"",classLevels:[]}):r&&d({name:r.name||"",description:r.description||"",academicYear:((x=r.academicYear)==null?void 0:x._id)||"",classLevels:((F=r.classLevels)==null?void 0:F.map(U=>{var ne,re;return{classLevel:((ne=U.classLevel)==null?void 0:ne._id)||U.classLevel,teachers:((re=U.teachers)==null?void 0:re.map(pe=>pe._id))||[]}}))||[]}),$(!0)},[p]),K=l.useCallback(s=>{R(s),W(!0)},[]),E=l.useCallback(()=>{R(null),W(!1)},[]),a=l.useCallback(async()=>{if(L)try{await g(`${Y.SUBJECT}/${L._id}`,"DELETE"),h(Y.SUBJECT,"GET"),S("")}catch{S(A||"Failed to delete subject")}finally{E()}},[L,g,h,A,E]),n=l.useCallback(s=>{const{name:r,value:m}=s.target;d(x=>({...x,[r]:m}))},[]),t=l.useCallback((s,r,m)=>{d(x=>{const F=[...x.classLevels];return F[s]={...F[s],[r]:m},{...x,classLevels:F}})},[]),o=l.useCallback(()=>{d(s=>({...s,classLevels:[...s.classLevels,{classLevel:"",teachers:[]}]}))},[]),i=l.useCallback(s=>{d(r=>({...r,classLevels:r.classLevels.filter((m,x)=>x!==s)}))},[]),C=l.useCallback(()=>{if(!u.name)return"Subject name is required";if(!u.description)return"Description is required";if(!u.academicYear)return"Academic year is required";if(u.classLevels.length===0)return"At least one class level is required";for(const s of u.classLevels)if(!s.classLevel)return"Class level is required for all entries";return""},[u]),D=l.useCallback(async()=>{const s=C();if(s){S(s);return}const r={name:u.name,description:u.description,academicYear:u.academicYear,classLevels:u.classLevels};try{k==="create"?await g(`${Y.SUBJECT}/create`,"POST",r):k==="edit"&&await g(`${Y.SUBJECT}/${G._id}`,"PATCH",r),h(Y.SUBJECT,"GET"),$(!1),S("")}catch{S(A||"Failed to process request")}},[k,u,G,g,h,A,C]),j=l.useMemo(()=>Array.isArray(c)?c.map(s=>({...s,displayName:s.name})):[],[c]),le=l.useMemo(()=>{const s={};return p.forEach(r=>{s[r._id]=j.filter(m=>{var x;return((x=m.academicYear)==null?void 0:x._id)===r._id})}),s},[j,p]);return{tableProps:{columns:l.useMemo(()=>[{id:"sn",label:"S/N",width:90},{id:"displayName",label:"Subject Name",flex:1,renderCell:s=>s.displayName},{id:"description",label:"Description",flex:1},{id:"actions",label:"Actions",flex:1,renderCell:s=>e.jsxs(e.Fragment,{children:[e.jsx(se,{icon:e.jsx(Le,{}),title:"View Subject",onClick:()=>B("view",s),sx:{mx:.5}}),e.jsx(se,{icon:e.jsx(De,{}),title:"Edit Subject",onClick:()=>B("edit",s),sx:{mx:.5}}),e.jsx(se,{icon:e.jsx(ue,{}),title:"Delete Subject",onClick:()=>K(s),sx:{mx:.5}})]})}],[B,K]),tableHeader:"Subject Management",data:j,subjects:le,sortBy:b,sortDirection:T,onSortChange:ae,hiddenColumnsSmallScreen:["description"],hiddenColumnsTabScreen:[],academicYears:p},modalOpen:Q,setModalOpen:$,modalMode:k,setModalMode:q,formData:u,setFormData:d,handleFormChange:n,handleClassLevelChange:t,addClassLevel:o,removeClassLevel:i,handleSubmit:D,error:J,loadingSubjects:I,loadingSubmit:ee,openModal:B,academicYears:p,classLevels:v,teachers:O.teachers||[],selectedSubject:G,deleteConfirmOpen:y,subjectToDelete:L,handleDelete:a,closeDeleteConfirm:E,classLevelsModalOpen:Z,setClassLevelsModalOpen:z}};function Ae(_){const{children:c,value:p,index:v,...O}=_;return e.jsx("div",{role:"tabpanel",hidden:p!==v,id:`academic-year-tabpanel-${v}`,"aria-labelledby":`academic-year-tab-${v}`,...O,children:p===v&&e.jsx(f,{sx:{p:3},children:c})})}const Be=()=>{var E;const _=Pe(),c=ge(_.palette.mode),{tableProps:p,modalOpen:v,setModalOpen:O,modalMode:b,formData:P,handleFormChange:T,handleClassLevelChange:N,addClassLevel:Q,removeClassLevel:$,handleSubmit:k,error:q,loadingSubjects:G,loadingSubmit:X,openModal:u,academicYears:d,classLevels:J,teachers:S,selectedSubject:y,deleteConfirmOpen:W,subjectToDelete:L,closeDeleteConfirm:R,classLevelsModalOpen:Z,setClassLevelsModalOpen:z}=ye(),[w,I]=l.useState(0),[h,g]=l.useState(d.reduce((a,n)=>({...a,[n._id]:{page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"}}),{}));l.useEffect(()=>{g(a=>d.reduce((t,o)=>({...t,[o._id]:a[o._id]||{page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"}}),{}))},[d]);const ee=(a,n)=>{I(n)},A=(a,n)=>{g(t=>({...t,[a]:{...t[a],page:n}}))},ae=(a,n)=>{g(t=>({...t,[a]:{...t[a],page:0,rowsPerPage:parseInt(n.target.value,10)}}))},B=(a,n)=>{g(t=>{const o=t[a],i=o.sortBy===n&&o.sortDirection==="asc"?"desc":"asc";return{...t,[a]:{...o,sortBy:n,sortDirection:i}}})},K=a=>{const{page:n,rowsPerPage:t,sortBy:o,sortDirection:i}=h[a]||{page:0,rowsPerPage:5,sortBy:"name",sortDirection:"asc"},D=[...p.subjects[a]||[]].sort((V,s)=>{let r=V[o]??"",m=s[o]??"";return o==="displayName"&&(r=V.displayName||"",m=s.displayName||""),r<m?i==="asc"?-1:1:r>m?i==="asc"?1:-1:0}),j=n*t;return D.slice(j,j+t).map((V,s)=>({...V,sn:j+s+1}))};return e.jsxs(f,{children:[e.jsx(fe,{title:"Subject Management",subtitle:"Manage subjects and their details"}),e.jsxs(f,{sx:{mt:3,mb:3},children:[e.jsx(Me,{icon:e.jsx(ce,{}),content:"Add Subject",onClick:()=>u("create"),sx:{mb:2}}),G?e.jsx(Ce,{}):e.jsx(f,{height:"75vh",sx:{"& .MuiDataGrid-root":{border:"none"},"& .MuiDataGrid-cell":{borderBottom:"none"},"& .MuiDataGrid-columnHeaders":{backgroundColor:c.blueAccent[700],borderBottom:"none"},"& .MuiDataGrid-virtualScroller":{backgroundColor:c.primary[400]},"& .MuiDataGrid-footerContainer":{borderTop:"none",backgroundColor:c.blueAccent[700]},"& .MuiCheckbox-root":{color:`${c.blueAccent[200]} !important`}},children:d.length>0?e.jsxs(e.Fragment,{children:[e.jsx(je,{value:w,onChange:ee,"aria-label":"academic year tabs",sx:{backgroundColor:c.primary[400],"& .MuiTabs-indicator":{backgroundColor:c.blueAccent[700]}},children:d.map((a,n)=>e.jsx(ve,{label:a.name,sx:{color:"white !important",textTransform:"none",fontWeight:"bold","&.Mui-selected":{color:"white !important",boxShadow:"0px 2px 8px rgba(0, 0, 0, 0.3)",backgroundColor:c.blueAccent[700]},boxShadow:"0px 1px 4px rgba(0, 0, 0, 0.1)",backgroundColor:c.primary[400]}},a._id))}),d.map((a,n)=>{var t,o,i,C;return e.jsx(Ae,{value:w,index:n,children:e.jsx(Se,{...p,data:K(a._id),tableHeader:`Subjects for ${a.name}`,page:((t=h[a._id])==null?void 0:t.page)||0,rowsPerPage:((o=h[a._id])==null?void 0:o.rowsPerPage)||5,sortBy:((i=h[a._id])==null?void 0:i.sortBy)||"name",sortDirection:((C=h[a._id])==null?void 0:C.sortDirection)||"asc",onSortChange:D=>B(a._id,D),onPageChange:(D,j)=>A(a._id,j),onRowsPerPageChange:D=>ae(a._id,D)})},a._id)})]}):e.jsx(M,{children:"No academic years available"})})]}),e.jsx(oe,{open:v,onClose:()=>O(!1),title:{create:"Create Subject",edit:"Edit Subject",view:"View Subject"}[b],onConfirm:b!=="view"?k:null,confirmMessage:b==="create"?"Create":"Save",styleProps:{padding:"20px"},children:e.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:"16px"},children:[e.jsx(H,{label:"Subject Name",name:"name",value:P.name,onChange:T,required:!0,fullWidth:!0,disabled:b==="view"}),e.jsx(H,{label:"Description",name:"description",value:P.description,onChange:T,multiline:!0,rows:4,fullWidth:!0,disabled:b==="view"}),e.jsx(H,{select:!0,label:"Academic Year",name:"academicYear",value:P.academicYear,onChange:T,required:!0,fullWidth:!0,disabled:b==="view",children:d.map(a=>e.jsx(te,{value:a._id,children:a.name},a._id))}),b!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx(f,{sx:{display:"flex",justifyContent:"flex-end",mb:2},children:e.jsx(de,{variant:"contained",onClick:Q,startIcon:e.jsx(ce,{}),sx:{backgroundColor:c.blueAccent[700]},children:"Add Class Level"})}),P.classLevels.map((a,n)=>e.jsxs(f,{sx:{display:"flex",gap:"16px",alignItems:"center",mb:2},children:[e.jsx(H,{select:!0,label:`Class Level ${n+1}`,value:a.classLevel,onChange:t=>N(n,"classLevel",t.target.value),required:!0,sx:{flex:1},children:J.map(t=>e.jsx(te,{value:t._id,children:t.name},t._id))}),e.jsx(H,{select:!0,label:`Teachers for Class Level ${n+1}`,value:a.teachers,onChange:t=>N(n,"teachers",t.target.value),SelectProps:{multiple:!0,renderValue:t=>t.map(o=>{var i;return((i=S.find(C=>C._id===o))==null?void 0:i.name)||""}).filter(Boolean).join(", ")},sx:{flex:1},children:S.map(t=>e.jsx(te,{value:t._id,children:t.name},t._id))}),e.jsx(ke,{onClick:()=>$(n),children:e.jsx(ue,{})})]},n))]}),b==="view"&&e.jsx(f,{sx:{mt:2},children:e.jsx(de,{variant:"contained",onClick:()=>z(!0),sx:{backgroundColor:c.blueAccent[700]},children:"View Class Levels and Teachers"})}),q&&e.jsx(M,{color:"error",children:q})]})}),e.jsx(oe,{open:Z,onClose:()=>z(!1),title:"Class Levels and Teachers for Subject",styleProps:{padding:"20px"},children:e.jsx(f,{children:((E=y==null?void 0:y.classLevels)==null?void 0:E.length)>0?y.classLevels.map((a,n)=>{var t,o;return e.jsxs(f,{sx:{mb:2},children:[e.jsx(M,{variant:"h6",children:((t=J.find(i=>{var C;return i._id===((C=a.classLevel)==null?void 0:C._id)}))==null?void 0:t.name)||"Unknown Class Level"}),e.jsx(M,{variant:"subtitle1",children:"Teachers:"}),((o=a.teachers)==null?void 0:o.length)>0?a.teachers.map(i=>e.jsxs(M,{sx:{ml:2},children:["- ",i.name]},i._id)):e.jsx(M,{sx:{ml:2},children:"No teachers assigned"})]},n)}):e.jsx(M,{children:"No class levels assigned"})})}),e.jsx(_e,{open:W,onClose:R,title:"Confirm Deletion",message:`Are you sure you want to delete the subject "${L==null?void 0:L.name}"? This action cannot be undone.`,isLoading:X})]})},Ze=we(Be);export{Ze as default};
