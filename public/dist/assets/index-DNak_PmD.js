import{r as A,a as Y,e as K,F as ge,G as fe,j as g,i as he}from"./index-BdybpPeh.js";import{u as Ne}from"./useApi-BtG_FYeQ.js";import{u as Ae,M as k}from"./MenuItem-DmfVB64U.js";import{A as ve,C as Se}from"./confirmationModal-v5YzOX-t.js";import{t as qe}from"./modal-DeXGtVHz.js";import{j as Ce,v as U,T as xe,Z as De,$ as je,a0 as Le,y as Be}from"./TextField-kKLYiU0N.js";import{A as ee}from"./Alert-D2uT5B4D.js";const y=m=>/^[0-9a-fA-F]{24}$/.test(m),Ee=({role:m,selectedUser:t})=>{const[_,h]=A.useState(""),{error:Q,callApi:w}=Ne(),[H,W]=A.useState(!1),[T,z]=A.useState(""),[D,N]=A.useState(!1),V=Ae(),M=Y(l=>{var n;return((n=l.adminData)==null?void 0:n.usersData)||{students:[],teachers:[],admins:[]}}),S=Y(l=>{var n;return((n=l.adminData)==null?void 0:n.classLevels)||[]}),O=Y(l=>{var n;return((n=l.adminData)==null?void 0:n.subjects)||[]}),[E,R]=A.useState({sections:[],classNames:[],subclasses:[]}),[se,o]=A.useState([]),[e,p]=A.useState({}),[I,ae]=A.useState(null),pe=A.useRef(null),[te,ne]=A.useState([]);A.useEffect(()=>{o(O.map(l=>({value:l._id,label:l.name})))},[O]),A.useEffect(()=>{var l,n,d,v,b,a,s;if(m==="teacher"&&((n=(l=e.teachingAssignments)==null?void 0:l[0])!=null&&n.section)&&((v=(d=e.teachingAssignments)==null?void 0:d[0])!=null&&v.className)&&((s=(a=(b=e.teachingAssignments)==null?void 0:b[0])==null?void 0:a.subclasses)!=null&&s[0])){const u=S.find(q=>q.section===e.teachingAssignments[0].section&&q.name===e.teachingAssignments[0].className),c=e.teachingAssignments[0].subclasses[0],f=u==null?void 0:u.subclasses.find(q=>q.letter===c),j=(f==null?void 0:f.subjects)||[];ne(j.map(q=>({value:q._id.toString(),label:q.name})))}else ne([])},[e.teachingAssignments,S,O,m]);const x=(l={},n="currentClassLevel")=>{var c,f,j,q,$,G;console.log("getClassLevelOptions called with:",{formData:l,parentKey:n,classLevels:S});const d=[...new Set(S.map(L=>L.section))],v=L=>S.filter(B=>B.section===L).map(B=>B.name),b=(L,B)=>{const F=S.find(P=>P.section===L&&P.name===B);return console.log("getSubclasses:",{section:L,className:B,classLevel:F}),(F==null?void 0:F.subclasses.map(P=>P.letter))||[]},a=n==="currentClassLevel"?((c=l.currentClassLevel)==null?void 0:c.section)||d[0]||"":((j=(f=l.teachingAssignments)==null?void 0:f[0])==null?void 0:j.section)||d[0]||"",s=n==="currentClassLevel"?((q=l.currentClassLevel)==null?void 0:q.className)||v(a)[0]||"":((G=($=l.teachingAssignments)==null?void 0:$[0])==null?void 0:G.className)||v(a)[0]||"",u={sections:d,classNames:v(a),subclasses:b(a,s)};return console.log("getClassLevelOptions result:",u),u};A.useEffect(()=>{console.log("selectedUser:",t),t&&!y(t)&&(console.warn("Invalid selectedUser ID format:",t),h("Invalid user ID format"))},[t]);const ie=l=>{var d,v,b;const n={};if(!J[l])return console.error("Invalid role:",l),n;if(J[l].forEach(a=>{if(a.name.includes("currentClassLevel")||a.name.includes("guardians")||a.name.includes("bankAccountDetails")||a.name.includes("teachingAssignments")){const[s,u,c]=a.name.split(/\.|\[|\]/).filter(Boolean);s==="guardians"||s==="teachingAssignments"?(n[s]=n[s]||[{}],n[s][0][u]=""):(n[s]=n[s]||{},n[s][u]="")}else n[a.name]=(a.type==="select","")}),l==="student"){const{sections:a,classNames:s,subclasses:u}=x(n,"currentClassLevel");n.currentClassLevel={section:a[0]||"",className:s[0]||"",subclass:u[0]||""},n.boardingStatus="Day Student"}else if(l==="teacher"){const{sections:a,classNames:s,subclasses:u}=x(n,"teachingAssignments");n.teachingAssignments=[{section:a[0]||"",className:s[0]||"",subclasses:[u[0]||""],subject:""}]}if(t&&M&&y(t)){const a=l==="student"?(d=M.students)==null?void 0:d.find(s=>s._id===t):l==="teacher"?(v=M.teachers)==null?void 0:v.find(s=>s._id===t):(b=M.admins)==null?void 0:b.find(s=>s._id===t);a&&Object.keys(n).forEach(s=>{var u,c,f;s==="currentClassLevel"&&a[s]?n[s]={section:a[s].section||n.currentClassLevel.section,className:a[s].className||n.currentClassLevel.className,subclass:a[s].subclass||n.currentClassLevel.subclass}:s==="boardingDetails"&&a[s]?n[s]={hall:a[s].hall||"",roomNumber:a[s].roomNumber||"",bedNumber:a[s].bedNumber||"",houseMaster:a[s].houseMaster||""}:s==="guardians"&&((u=a[s])!=null&&u.length)?n[s]=[{name:a[s][0].name||"",relationship:a[s][0].relationship||"",phone:a[s][0].phone||"",email:a[s][0].email||"",address:a[s][0].address||""}]:s==="bankAccountDetails"&&a[s]?n[s]={accountName:a[s].accountName||"",accountNumber:a[s].accountNumber||"",bank:a[s].bank||""}:s==="teachingAssignments"&&((c=a[s])!=null&&c.length)?n[s]=[{section:a[s][0].section||n.teachingAssignments[0].section,className:a[s][0].className||n.teachingAssignments[0].className,subclasses:a[s][0].subclasses||n.teachingAssignments[0].subclasses,subject:((f=a[s][0].subject)==null?void 0:f._id)||""}]:n[s]=a[s]||n[s]})}return n};A.useEffect(()=>{if(S.length===0){console.log("classLevels not loaded yet");return}console.log("Initializing formData with classLevels:",S);const l=ie(m);p(l),R(m==="student"?x(l,"currentClassLevel"):x(l,"teachingAssignments"))},[m,t,S,O]),A.useEffect(()=>{console.log("formData updated:",e),e&&R(m==="student"?x(e,"currentClassLevel"):x(e,"teachingAssignments"))},[e,m,S]);const J={student:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t},{label:"Gender",name:"gender",type:"select",required:!t,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!1},{label:"Tribe",name:"tribe",type:"text",required:!1},{label:"Religion",name:"religion",type:"text",required:!1},{label:"Formal School",name:"formalSchool",type:"text",required:!1},{label:"Class Section",name:"currentClassLevel.section",type:"select",required:!t,options:E.sections},{label:"Class Name",name:"currentClassLevel.className",type:"select",required:!t,options:E.classNames},{label:"Subclass",name:"currentClassLevel.subclass",type:"select",required:!t,options:E.subclasses},{label:"Boarding Status",name:"boardingStatus",type:"select",required:!t,options:["Boarder","Day Student"]},{label:"Boarding Hall",name:"boardingDetails.hall",type:"text",required:!1},{label:"Room Number",name:"boardingDetails.roomNumber",type:"text",required:!1},{label:"Bed Number",name:"boardingDetails.bedNumber",type:"text",required:!1},{label:"House Master",name:"boardingDetails.houseMaster",type:"text",required:!1},{label:"Guardian Name",name:"guardians[0].name",type:"text",required:!t},{label:"Guardian Relationship",name:"guardians[0].relationship",type:"text",required:!t},{label:"Guardian Phone",name:"guardians[0].phone",type:"text",required:!t},{label:"Guardian Email",name:"guardians[0].email",type:"email",required:!1},{label:"Guardian Address",name:"guardians[0].address",type:"text",required:!1}].filter(Boolean),teacher:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Middle Name",name:"middleName",type:"text",required:!1},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t},{label:"Gender",name:"gender",type:"select",required:!t,options:["Male","Female","Other"]},{label:"NIN",name:"NIN",type:"text",required:!t},{label:"Address",name:"address",type:"text",required:!t},{label:"Qualification",name:"qualification",type:"select",required:!t,options:["SSCE","OND","HND","BSc","MBA","BTech","MSc","PhD","Other"]},{label:"Phone Number",name:"phoneNumber",type:"tel",required:!t},{label:"Tribe",name:"tribe",type:"text",required:!t},{label:"Religion",name:"religion",type:"select",required:!t,options:["Christianity","Islam","Hinduism","Buddhism","Atheism","Other"]},{label:"Teaching Section",name:"teachingAssignments[0].section",type:"select",required:!t,options:E.sections},{label:"Teaching Class Name",name:"teachingAssignments[0].className",type:"select",required:!t,options:E.classNames},{label:"Teaching Subclass",name:"teachingAssignments[0].subclasses[0]",type:"select",required:!t,options:E.subclasses},{label:"Subclass Subject",name:"teachingAssignments[0].subject",type:"select",required:!1,options:te},{label:"Bank Account Name",name:"bankAccountDetails.accountName",type:"text",required:!t},{label:"Bank Account Number",name:"bankAccountDetails.accountNumber",type:"text",required:!t},{label:"Bank Name",name:"bankAccountDetails.bank",type:"text",required:!t},{label:"LinkedIn Profile",name:"linkedInProfile",type:"text",required:!1}].filter(Boolean),admin:[{label:"First Name",name:"firstName",type:"text",required:!t},{label:"Last Name",name:"lastName",type:"text",required:!t},{label:"Email",name:"email",type:"email",required:!t},{label:"Profile Picture",name:"profilePicture",type:"file",required:!t}].filter(Boolean)};return{formRef:pe,formData:e,error:_,loading:D,handleChange:l=>{const{name:n,value:d,files:v}=l.target;if(n==="profilePicture")ae(v[0]);else if(n.includes("currentClassLevel")){const[,b]=n.split(".");p(a=>{const s={...a.currentClassLevel,[b]:d};if(b==="section"){const{classNames:u,subclasses:c}=x({currentClassLevel:s},"currentClassLevel");s.className=u[0]||"",s.subclass=c[0]||""}else if(b==="className"){const{subclasses:u}=x({currentClassLevel:s},"currentClassLevel");s.subclass=u[0]||""}return{...a,currentClassLevel:s}})}else if(n.includes("teachingAssignments")){const[,b,a,s]=n.split(/\.|\[|\]/).filter(Boolean);p(u=>{const c=[...u.teachingAssignments||[{}]];if(a==="subclasses"&&s==="0"?c[0]={...c[0],subclasses:[d],subject:""}:a==="subject"?c[0]={...c[0],subject:d}:c[0]={...c[0],[a]:d},a==="section"){const{classNames:f,subclasses:j}=x({teachingAssignments:[{...c[0],section:d}]},"teachingAssignments");c[0].className=f[0]||"",c[0].subclasses=[j[0]||""],c[0].subject=""}else if(a==="className"){const{subclasses:f}=x({teachingAssignments:[{...c[0],className:d}]},"teachingAssignments");c[0].subclasses=[f[0]||""],c[0].subject=""}return{...u,teachingAssignments:c}})}else if(n.includes("boardingDetails")){const[,b]=n.split(".");p(a=>({...a,boardingDetails:{...a.boardingDetails,[b]:d}}))}else if(n.includes("guardians")){const[,b,a]=n.split(/\.|\[|\]/).filter(Boolean);p(s=>{const u=[...s.guardians||[{}]];return u[0]={...u[0],[a]:d},{...s,guardians:u}})}else if(n.includes("bankAccountDetails")){const[,b]=n.split(".");p(a=>({...a,bankAccountDetails:{...a.bankAccountDetails,[b]:d}}))}else p(n==="boardingStatus"?b=>({...b,boardingStatus:d,boardingDetails:d==="Boarder"?b.boardingDetails||{}:void 0}):b=>({...b,[n]:d}))},handleSubmit:async l=>{var n,d,v,b,a,s,u,c,f,j,q,$,G,L,B,F,P,le,re,ue,ce,oe;if(l.preventDefault(),N(!0),h(""),t&&!y(t)){h("Invalid user ID format"),N(!1);return}if(!t){if(!e.firstName||!e.lastName||!e.email||!e.gender){h("First name, last name, email, and gender are required"),N(!1);return}if(m==="student"){if(!((n=e.currentClassLevel)!=null&&n.section)||!((d=e.currentClassLevel)!=null&&d.className)||!((v=e.currentClassLevel)!=null&&v.subclass)){h("Class level section, class name, and subclass are required"),N(!1);return}if(!((a=(b=e.guardians)==null?void 0:b[0])!=null&&a.name)||!((u=(s=e.guardians)==null?void 0:s[0])!=null&&u.relationship)||!((f=(c=e.guardians)==null?void 0:c[0])!=null&&f.phone)){h("Guardian name, relationship, and phone are required"),N(!1);return}if(!["Boarder","Day Student"].includes(e.boardingStatus)){h("Boarding status must be 'Boarder' or 'Day Student'"),N(!1);return}if(e.boardingStatus==="Boarder"&&(!((j=e.boardingDetails)!=null&&j.hall)||!((q=e.boardingDetails)!=null&&q.roomNumber))){h("Boarding Hall and Room Number are required for Boarder students"),N(!1);return}}else if(m==="teacher"){if(!e.NIN||!e.address||!e.qualification||!e.phoneNumber||!e.tribe||!e.religion||!(($=e.bankAccountDetails)!=null&&$.accountName)||!((G=e.bankAccountDetails)!=null&&G.accountNumber)||!((L=e.bankAccountDetails)!=null&&L.bank)||!((F=(B=e.teachingAssignments)==null?void 0:B[0])!=null&&F.section)||!((le=(P=e.teachingAssignments)==null?void 0:P[0])!=null&&le.className)||!((ce=(ue=(re=e.teachingAssignments)==null?void 0:re[0])==null?void 0:ue.subclasses)!=null&&ce.length)){h("All required teacher fields must be filled"),N(!1);return}if(!/^\d{11}$/.test(e.NIN)){h("NIN must be 11 digits"),N(!1);return}if(!/^\d{10}$/.test(e.bankAccountDetails.accountNumber)){h("Bank account number must be 10 digits"),N(!1);return}if(!e.teachingAssignments[0].subclasses.every(r=>/^[A-Z]$/.test(r))){h("Subclasses must be single uppercase letters"),N(!1);return}}if(!I){h("Profile picture is required"),N(!1);return}}try{const r=new FormData;Object.keys(e).forEach(i=>{var Z,me;if(i==="currentClassLevel"&&e[i])r.append("currentClassLevel[section]",e[i].section||""),r.append("currentClassLevel[className]",e[i].className||""),r.append("currentClassLevel[subclass]",e[i].subclass||"");else if(i==="boardingDetails"&&e[i]&&e.boardingStatus==="Boarder")r.append("boardingDetails[hall]",e[i].hall||""),r.append("boardingDetails[roomNumber]",e[i].roomNumber||""),r.append("boardingDetails[bedNumber]",e[i].bedNumber||""),r.append("boardingDetails[houseMaster]",e[i].houseMaster||"");else if(i==="guardians"&&((Z=e[i])!=null&&Z.length))r.append("guardians[0][name]",e[i][0].name||""),r.append("guardians[0][relationship]",e[i][0].relationship||""),r.append("guardians[0][phone]",e[i][0].phone||""),r.append("guardians[0][email]",e[i][0].email||""),r.append("guardians[0][address]",e[i][0].address||"");else if(i==="bankAccountDetails"&&e[i])r.append("bankAccountDetails[accountName]",e[i].accountName||""),r.append("bankAccountDetails[accountNumber]",e[i].accountNumber||""),r.append("bankAccountDetails[bank]",e[i].bank||"");else if(i==="teachingAssignments"&&((me=e[i])!=null&&me.length)&&e[i][0].section){if(r.append("section",e[i][0].section||""),r.append("className",e[i][0].className||""),r.append("subclassLetter",e[i][0].subclasses[0]||""),e[i][0].subject){r.append("subject",e[i][0].subject);const de=S.find(be=>be.section===e[i][0].section&&be.name===e[i][0].className);de&&r.append("classLevel",de._id||"")}}else i==="isWithdrawn"||i==="isSuspended"?r.append(i,value==="true"):i==="applicationStatus"&&value?r.append(i,value):(!t||e[i]&&e[i]!==""&&i!=="boardingDetails")&&r.append(i,e[i])}),I&&r.append("profilePicture",I);for(let[i,Z]of r.entries())console.log(`${i}: ${Z}`);let X;t&&y(t)?X=m==="student"?`/api/students/${t}/update/admin`:`/api/teachers/subject/${t}/update`:X=m==="student"?K.CREATE_STUDENT:m==="teacher"?K.CREATE_TEACHER:K.CREATE_ADMIN;const C=await w(X,t?"PATCH":"POST",r,{"Content-Type":"multipart/form-data"});C&&C.status==="success"?(V(t?ge({id:t,user:C.data,role:m}):fe({user:C.data,role:m})),z(`${C.data.firstName} ${C.data.lastName} has been successfully ${t?"updated":"registered"}`),p(ie(m)),ae(null)):C&&C.status==="failed"&&(console.log(Q),z((C==null?void 0:C.message)||"An error occurred")),W(!0)}catch(r){console.error("Error submitting form:",r),h(((oe=r.response)==null?void 0:oe.message)||"Failed to submit the form. Please try again.")}finally{N(!1)}},roleFields:J,profilePicture:I,modalOpen:H,modalMessage:T,setModalOpen:W,subclassSubjectOptions:te}},_e=({role:m,selectedUser:t,studentReg:_,offline:h})=>{const Q=Ce();qe(Q.palette.mode);const{roleFields:w,error:H,loading:W,handleChange:T,handleSubmit:z,formData:D,formRef:N,modalOpen:V,modalMessage:M,setModalOpen:S,subclassSubjectOptions:O}=Ee({role:m,selectedUser:t});console.log("SignUpForm - role:",m,"selectedUser:",t,"studentReg:",_,"formData:",D,"subclassSubjectOptions:",O);const E=()=>{S(!1)};if(W)return g.jsx(he,{});if(!D||Object.keys(D).length===0)return g.jsx(ee,{severity:"error",children:"Form data is not initialized. Please try again or check Redux configuration."});const R=o=>{if(!D)return"";if(o.includes(".")){const e=o.split(/\.|\[|\]/).filter(Boolean);let p=D;for(const I of e)if(Array.isArray(p)&&I.match(/^\d+$/)?p=p[parseInt(I)]:p=p==null?void 0:p[I],p==null)return"";return p}return D[o]||""};if(!w[m])return g.jsx(ee,{severity:"error",children:"Invalid role specified"});const se=w[m].filter(o=>m==="student"&&o.name.includes("boardingDetails")?D.boardingStatus==="Boarder":!0);return g.jsxs(U,{sx:{paddingBottom:_&&"20px"},children:[g.jsxs(xe,{variant:"h4",children:[t?"Update":"Sign Up"," (",m.charAt(0).toUpperCase()+m.slice(1),")"]}),g.jsxs("form",{onSubmit:z,ref:N,children:[se.map(o=>g.jsx(U,{mb:2,children:o.type==="select"?g.jsxs(De,{fullWidth:!0,children:[g.jsx(je,{children:o.label}),g.jsxs(Le,{name:o.name,value:R(o.name)||"",onChange:T,required:o.required,children:[!o.required&&g.jsx(k,{value:"",children:"None"}),o.name==="teachingAssignments[0].subject"?O.map(e=>g.jsx(k,{value:e.value,children:e.label},e.value)):o.options.map(e=>g.jsx(k,{value:e,children:e},e))]})]}):o.type==="file"?g.jsx(U,{children:g.jsx("input",{type:"file",name:o.name,id:o.name,onChange:T,required:o.required,accept:"image/*",style:{display:"block",width:"100%"}})}):g.jsx(Be,{label:o.label,name:o.name,type:o.type,value:R(o.name),onChange:T,required:o.required,fullWidth:!0})},o.name)),H&&g.jsx(ee,{severity:"error",children:H}),g.jsx(ve,{content:t?"Update":"Sign Up",submit:!0})]}),g.jsx(Se,{open:V,message:M,title:"User Registration Confirmation",onClose:E})]})};export{_e as S};
